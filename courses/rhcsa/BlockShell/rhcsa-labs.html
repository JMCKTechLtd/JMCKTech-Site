<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BlockShell-RH: Red Hat Linux Labs</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #2c3e50;
    }
    #header {
      background: #CC0000;
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #menu {
      background: white;
      padding: 10px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
    }
    button {
      background: #CC0000;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
      transition: all 0.2s;
    }
    button:hover {
      background: #990000;
    }
    .tab-button {
      background: #e9ecef;
      color: #495057;
      margin: 0 2px;
      border-radius: 4px 4px 0 0;
    }
    .tab-button.active {
      background: white;
      color: #CC0000;
      border-bottom: 3px solid #CC0000;
    }
    #container {
      display: flex;
      height: calc(100vh - 160px);
    }
    #tutorial-panel {
      width: 300px;
      background: white;
      padding: 15px;
      border-right: 1px solid #eaecef;
      overflow-y: auto;
    }
    #blocklyDiv {
      flex: 1;
      height: 100%;
      min-width: 0;
    }
    .task {
      background: #f1f5f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 3px solid #CC0000;
      font-size: 14px;
    }
    .task.completed {
      background: #e6f7e6;
      border-left-color: #0fbd8c;
    }
    #feedback {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Red Hat Linux Administration Labs</h1>
    <p>RHCSA hands-on block-based scripting</p>
  </div>

  <div id="menu">
    <div style="flex-grow: 1; display: flex; justify-content: center;">
      <button class="tab-button active" onclick="switchTab('lab1')">Lab 1: User Management</button>
      <button class="tab-button" onclick="switchTab('lab2')">Lab 2: Filesystems</button>
      <button class="tab-button" onclick="switchTab('lab3')">Lab 3: Services</button>
      <button class="tab-button" onclick="switchTab('lab4')">Lab 4: Networking</button>
    </div>
    <div>
      <button onclick="showScript()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
          <polyline points="9 10 4 15 9 20"></polyline>
          <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
        </svg>
        Show Script
      </button>
      <button onclick="downloadScript()">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 5px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        Download Script
      </button>
      <button onclick="checkProgress()">Check Progress</button>
    </div>
  </div>

  <div id="container">
    <div id="tutorial-panel">
      <!-- Lab 1: User Management -->
      <div id="lab1-content" class="tab-content active">
        <h3>üîê Lab 1: User & Group Management</h3>
        <div class="task" id="lab1-task1">
          <strong>Task 1: Create a new user</strong>
          <p>Use the <em>"Add User"</em> block to create a user named <code>devuser</code> with home directory <code>/home/devuser</code> and shell <code>/bin/bash</code>.</p>
        </div>
        <div class="task" id="lab1-task2">
          <strong>Task 2: Create a group</strong>
          <p>Create a group named <code>developers</code> with GID <code>2001</code> using the <em>"Add Group"</em> block.</p>
        </div>
        <div class="task" id="lab1-task3">
          <strong>Task 3: Add user to group</strong>
          <p>Add <code>devuser</code> to the <code>developers</code> group using the <em>"Add User to Group"</em> block.</p>
        </div>
        <div class="task" id="lab1-task4">
          <strong>Task 4: Set password policy</strong>
          <p>Configure password policy with minimum 7 days, maximum 90 days, and warning 7 days using the <em>"Set Password Policy"</em> block.</p>
        </div>
      </div>

      <!-- Lab 2: Filesystems -->
      <div id="lab2-content" class="tab-content">
        <h3>üíæ Lab 2: Filesystem Management</h3>
        <div class="task" id="lab2-task1">
          <strong>Task 1: Create filesystem</strong>
          <p>Create an <code>ext4</code> filesystem on <code>/dev/sdb1</code> with label <code>DATA</code> using the <em>"Create Filesystem"</em> block.</p>
        </div>
        <div class="task" id="lab2-task2">
          <strong>Task 2: Mount filesystem</strong>
          <p>Mount <code>/dev/sdb1</code> to <code>/mnt/data</code> with type <code>ext4</code> and make it persistent using the <em>"Mount Filesystem"</em> block.</p>
        </div>
        <div class="task" id="lab2-task3">
          <strong>Task 3: Analyze disk usage</strong>
          <p>Analyze disk usage for <code>/var</code> with depth <code>2</code> using the <em>"Analyze Disk"</em> block.</p>
        </div>
        <div class="task" id="lab2-task4">
          <strong>Task 4: Create LVM</strong>
          <p>Create an LVM volume group named <code>vg_data</code> with physical volume <code>/dev/sdc1</code> using the <em>"Create LVM"</em> block.</p>
        </div>
      </div>

      <!-- Lab 3: Services -->
      <div id="lab3-content" class="tab-content">
        <h3>‚öôÔ∏è Lab 3: Service Management</h3>
        <div class="task" id="lab3-task1">
          <strong>Task 1: Manage service</strong>
          <p>Start and enable the <code>httpd</code> service using the <em>"Service Action"</em> block.</p>
        </div>
        <div class="task" id="lab3-task2">
          <strong>Task 2: Create service</strong>
          <p>Create a custom service named <code>myapp</code> that runs <code>/usr/local/bin/myapp</code> as user <code>appuser</code> using the <em>"Create Service"</em> block.</p>
        </div>
        <div class="task" id="lab3-task3">
          <strong>Task 3: Schedule task</strong>
          <p>Schedule a daily backup at 2 AM running <code>/usr/local/bin/backup.sh</code> using the <em>"Schedule Task"</em> block.</p>
        </div>
        <div class="task" id="lab3-task4">
          <strong>Task 4: Check resources</strong>
          <p>Check memory usage using the <em>"Check Resources"</em> block.</p>
        </div>
      </div>

      <!-- Lab 4: Networking -->
      <div id="lab4-content" class="tab-content">
        <h3>üåê Lab 4: Networking & Security</h3>
        <div class="task" id="lab4-task1">
          <strong>Task 1: Configure network</strong>
          <p>Configure interface <code>eth0</code> with IP <code>192.168.1.100/24</code> and gateway <code>192.168.1.1</code> using the <em>"Configure Network"</em> block.</p>
        </div>
        <div class="task" id="lab4-task2">
          <strong>Task 2: Firewall rule</strong>
          <p>Allow HTTP traffic (port 80/tcp) through the firewall using the <em>"Configure Firewall"</em> block.</p>
        </div>
        <div class="task" id="lab4-task3">
          <strong>Task 3: SELinux mode</strong>
          <p>Set SELinux to <code>enforcing</code> mode using the <em>"Set SELinux Mode"</em> block.</p>
        </div>
        <div class="task" id="lab4-task4">
          <strong>Task 4: SSH configuration</strong>
          <p>Disable root login via SSH using the <em>"Configure SSHD"</em> block.</p>
        </div>
      </div>

      <div id="feedback"></div>
    </div>

    <div id="blocklyDiv"></div>
  </div>

  <!-- Toolbox definitions for all labs -->
  <xml id="toolbox" style="display:none">
    <!-- Lab 1: User Management -->
    <category name="User Management" colour="180">
      <block type="add_user"></block>
      <block type="add_group"></block>
      <block type="add_user_to_group"></block>
      <block type="set_password_policy"></block>
      <block type="lock_account"></block>
    </category>

    <!-- Lab 2: Filesystems -->
    <category name="Filesystems" colour="210">
      <block type="create_filesystem"></block>
      <block type="mount_filesystem"></block>
      <block type="analyze_disk"></block>
      <block type="create_lvm"></block>
      <block type="backup_files"></block>
    </category>

    <!-- Lab 3: Services -->
    <category name="Services" colour="230">
      <block type="service_action"></block>
      <block type="create_service"></block>
      <block type="schedule_task"></block>
      <block type="check_resources"></block>
      <block type="kill_process"></block>
    </category>

    <!-- Lab 4: Networking -->
    <category name="Networking" colour="290">
      <block type="configure_network"></block>
      <block type="configure_firewall"></block>
      <block type="set_selinux_mode"></block>
      <block type="configure_sshd"></block>
      <block type="test_connectivity"></block>
    </category>
  </xml>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const workspace = Blockly.inject('blocklyDiv', {
        toolbox: document.getElementById('toolbox'),
        trashcan: true,
        grid: { spacing: 25, length: 3, colour: '#e0e0e0', snap: true },
        zoom: { controls: true, wheel: true }
      });

      // Define all blocks used in the toolbox
      Blockly.defineBlocksWithJsonArray([
        // User Management
        {
          "type": "add_user",
          "message0": "Add User %1 Home: %2 Shell: %3",
          "args0": [
            { "type": "field_input", "name": "USERNAME", "text": "devuser" },
            { "type": "field_input", "name": "HOME", "text": "/home/devuser" },
            {
              "type": "field_dropdown",
              "name": "SHELL",
              "options": [
                ["/bin/bash", "/bin/bash"],
                ["/bin/sh", "/bin/sh"],
                ["/sbin/nologin", "/sbin/nologin"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
          "tooltip": "Create a new user with specified home directory and shell"
        },
        {
          "type": "add_group",
          "message0": "Add Group %1 GID: %2",
          "args0": [
            { "type": "field_input", "name": "GROUP", "text": "developers" },
            { "type": "field_number", "name": "GID", "value": 2001 }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
          "tooltip": "Create a new group with optional GID"
        },
        {
          "type": "add_user_to_group",
          "message0": "Add User %1 to Group %2",
          "args0": [
            { "type": "field_input", "name": "USERNAME", "text": "devuser" },
            { "type": "field_input", "name": "GROUP", "text": "developers" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
          "tooltip": "Add user to group"
        },
        {
          "type": "set_password_policy",
          "message0": "Set Password Policy Min: %1 Max: %2 Warn: %3",
          "args0": [
            { "type": "field_number", "name": "MIN", "value": 7 },
            { "type": "field_number", "name": "MAX", "value": 90 },
            { "type": "field_number", "name": "WARN", "value": 7 }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
          "tooltip": "Configure password aging policy"
        },
        {
          "type": "lock_account",
          "message0": "Lock/Unlock Account %1 Action: %2",
          "args0": [
            { "type": "field_input", "name": "USERNAME", "text": "user" },
            {
              "type": "field_dropdown",
              "name": "ACTION",
              "options": [
                ["Lock", "LOCK"],
                ["Unlock", "UNLOCK"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 180,
          "tooltip": "Lock or unlock a user account"
        },

        // Filesystems
        {
          "type": "create_filesystem",
          "message0": "Create Filesystem on %1 Type: %2 Label: %3",
          "args0": [
            { "type": "field_input", "name": "DEVICE", "text": "/dev/sdb1" },
            {
              "type": "field_dropdown",
              "name": "FSTYPE",
              "options": [
                ["ext4", "ext4"],
                ["xfs", "xfs"]
              ]
            },
            { "type": "field_input", "name": "LABEL", "text": "DATA" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 210,
          "tooltip": "Format a partition with a specific filesystem type"
        },
        {
          "type": "mount_filesystem",
          "message0": "Mount %1 To: %2 Type: %3 Persist: %4",
          "args0": [
            { "type": "field_input", "name": "DEVICE", "text": "/dev/sdb1" },
            { "type": "field_input", "name": "MOUNTPOINT", "text": "/mnt/data" },
            { "type": "field_input", "name": "FSTYPE", "text": "ext4" },
            { "type": "field_checkbox", "name": "PERSIST", "checked": true }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 210,
          "tooltip": "Mount a filesystem and optionally add to /etc/fstab"
        },
        {
          "type": "analyze_disk",
          "message0": "Analyze Disk Usage Path: %1 Depth: %2",
          "args0": [
            { "type": "field_input", "name": "PATH", "text": "/var" },
            { "type": "field_number", "name": "DEPTH", "value": 2 }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 210,
          "tooltip": "Analyze disk usage with specified depth"
        },
        {
          "type": "create_lvm",
          "message0": "Create LVM PV: %1 VG: %2",
          "args0": [
            { "type": "field_input", "name": "PV", "text": "/dev/sdc1" },
            { "type": "field_input", "name": "VG", "text": "vg_data" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 210,
          "tooltip": "Create a physical volume and volume group"
        },
        {
          "type": "backup_files",
          "message0": "Backup %1 To: %2 Method: %3",
          "args0": [
            { "type": "field_input", "name": "SOURCE", "text": "/important/data" },
            { "type": "field_input", "name": "DEST", "text": "/backup/location" },
            {
              "type": "field_dropdown",
              "name": "METHOD",
              "options": [
                ["rsync", "rsync"],
                ["tar", "tar"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 210,
          "tooltip": "Backup files using various methods"
        },

        // Services
        {
          "type": "service_action",
          "message0": "Service %1 Action: %2",
          "args0": [
            { "type": "field_input", "name": "SERVICE", "text": "httpd" },
            {
              "type": "field_dropdown",
              "name": "ACTION",
              "options": [
                ["Start", "start"],
                ["Stop", "stop"],
                ["Restart", "restart"],
                ["Enable", "enable"],
                ["Disable", "disable"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 230,
          "tooltip": "Manage systemd services"
        },
        {
          "type": "create_service",
          "message0": "Create Service %1 Exec: %2 User: %3",
          "args0": [
            { "type": "field_input", "name": "NAME", "text": "myapp" },
            { "type": "field_input", "name": "EXEC", "text": "/usr/local/bin/myapp" },
            { "type": "field_input", "name": "USER", "text": "appuser" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 230,
          "tooltip": "Create a new systemd service unit"
        },
        {
          "type": "schedule_task",
          "message0": "Schedule Task %1 Command: %2 Schedule: %3",
          "args0": [
            { "type": "field_input", "name": "NAME", "text": "backup" },
            { "type": "field_input", "name": "COMMAND", "text": "/usr/local/bin/backup.sh" },
            { "type": "field_input", "name": "SCHEDULE", "text": "0 2 * * *" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 230,
          "tooltip": "Schedule a cron job"
        },
        {
          "type": "check_resources",
          "message0": "Check Resources Type: %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "TYPE",
              "options": [
                ["CPU", "cpu"],
                ["Memory", "memory"],
                ["Disk", "disk"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 230,
          "tooltip": "Check system resource usage"
        },
        {
          "type": "kill_process",
          "message0": "Kill Process %1 Signal: %2",
          "args0": [
            { "type": "field_input", "name": "PID", "text": "1234" },
            {
              "type": "field_dropdown",
              "name": "SIGNAL",
              "options": [
                ["TERM (15)", "15"],
                ["KILL (9)", "9"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 230,
          "tooltip": "Send signal to a process"
        },

        // Networking
        {
          "type": "configure_network",
          "message0": "Configure Interface %1 IP: %2 Prefix: %3 Gateway: %4",
          "args0": [
            { "type": "field_input", "name": "IFACE", "text": "eth0" },
            { "type": "field_input", "name": "IP", "text": "192.168.1.100" },
            { "type": "field_number", "name": "PREFIX", "value": 24 },
            { "type": "field_input", "name": "GATEWAY", "text": "192.168.1.1" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 290,
          "tooltip": "Configure a network interface using nmcli"
        },
        {
          "type": "configure_firewall",
          "message0": "Firewall Action: %1 Port: %2 Protocol: %3",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "ACTION",
              "options": [
                ["Add", "add"],
                ["Remove", "remove"]
              ]
            },
            { "type": "field_input", "name": "PORT", "text": "80" },
            {
              "type": "field_dropdown",
              "name": "PROTO",
              "options": [
                ["tcp", "tcp"],
                ["udp", "udp"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 290,
          "tooltip": "Manage firewall rules with firewall-cmd"
        },
        {
          "type": "set_selinux_mode",
          "message0": "Set SELinux Mode: %1",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "MODE",
              "options": [
                ["enforcing", "enforcing"],
                ["permissive", "permissive"]
              ]
            }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 290,
          "tooltip": "Change the SELinux runtime mode"
        },
        {
          "type": "configure_sshd",
          "message0": "Configure SSHD %1 Value: %2",
          "args0": [
            {
              "type": "field_dropdown",
              "name": "OPTION",
              "options": [
                ["PermitRootLogin", "PermitRootLogin"],
                ["PasswordAuthentication", "PasswordAuthentication"]
              ]
            },
            { "type": "field_input", "name": "VALUE", "text": "no" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 290,
          "tooltip": "Modify SSHD configuration"
        },
        {
          "type": "test_connectivity",
          "message0": "Test Connectivity to %1",
          "args0": [
            { "type": "field_input", "name": "TARGET", "text": "8.8.8.8" }
          ],
          "previousStatement": null,
          "nextStatement": null,
          "colour": 290,
          "tooltip": "Ping a host to test connectivity"
        }
      ]);

      // Pre-load example block for first lab
      const exampleBlock = `
        <xml xmlns="https://developers.google.com/blockly/xml">
          <block type="add_user" x="50" y="50">
            <field name="USERNAME">devuser</field>
            <field name="HOME">/home/devuser</field>
            <field name="SHELL">/bin/bash</field>
          </block>
        </xml>
      `;
      Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(exampleBlock), workspace);
    });

    // Tab switching function
    function switchTab(tabId) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabId + '-content').classList.add('active');
      
      // Update tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Clear feedback when switching tabs
      document.getElementById('feedback').innerHTML = '';
    }

    // Generate Bash code
    function generateBashCode() {
      const blocks = Blockly.getMainWorkspace().getAllBlocks();
      let code = "#!/bin/bash\n\n# Red Hat Linux Administration Script\nset -euo pipefail\n\n";
      
      blocks.forEach(block => {
        switch(block.type) {
          // User Management
          case "add_user":
            code += `sudo useradd -m -d "${block.getFieldValue('HOME')}" -s "${block.getFieldValue('SHELL')}" "${block.getFieldValue('USERNAME')}"\n`;
            break;
          case "add_group":
            const gidOpt = block.getFieldValue('GID') ? `-g ${block.getFieldValue('GID')}` : "";
            code += `sudo groupadd ${gidOpt} "${block.getFieldValue('GROUP')}"\n`;
            break;
          case "add_user_to_group":
            code += `sudo usermod -aG "${block.getFieldValue('GROUP')}" "${block.getFieldValue('USERNAME')}"\n`;
            break;
          case "set_password_policy":
            code += `sudo chage -m ${block.getFieldValue('MIN')} -M ${block.getFieldValue('MAX')} -W ${block.getFieldValue('WARN')} "${block.getFieldValue('USERNAME')}"\n`;
            break;
          case "lock_account":
            const lockCmd = block.getFieldValue('ACTION') === 'LOCK' ? "-L" : "-U";
            code += `sudo passwd ${lockCmd} "${block.getFieldValue('USERNAME')}"\n`;
            break;

          // Filesystems
          case "create_filesystem":
            code += `sudo mkfs -t ${block.getFieldValue('FSTYPE')} -L "${block.getFieldValue('LABEL')}" "${block.getFieldValue('DEVICE')}"\n`;
            break;
          case "mount_filesystem":
            code += `sudo mkdir -p "${block.getFieldValue('MOUNTPOINT')}"\n`;
            code += `sudo mount -t ${block.getFieldValue('FSTYPE')} "${block.getFieldValue('DEVICE')}" "${block.getFieldValue('MOUNTPOINT')}"\n`;
            if (block.getFieldValue('PERSIST') === 'TRUE') {
              code += `echo "${block.getFieldValue('DEVICE')} ${block.getFieldValue('MOUNTPOINT')} ${block.getFieldValue('FSTYPE')} defaults 0 0" | sudo tee -a /etc/fstab\n`;
            }
            break;
          case "analyze_disk":
            code += `du -h --max-depth=${block.getFieldValue('DEPTH')} "${block.getFieldValue('PATH')}" | sort -h\n`;
            break;
          case "create_lvm":
            code += `sudo pvcreate "${block.getFieldValue('PV')}"\n`;
            code += `sudo vgcreate "${block.getFieldValue('VG')}" "${block.getFieldValue('PV')}"\n`;
            break;
          case "backup_files":
            if (block.getFieldValue('METHOD') === 'rsync') {
              code += `rsync -a "${block.getFieldValue('SOURCE')}" "${block.getFieldValue('DEST')}"\n`;
            } else {
              code += `tar -cvzf "${block.getFieldValue('DEST')}/backup-$(date +%F).tar.gz" "${block.getFieldValue('SOURCE')}"\n`;
            }
            break;

          // Services
          case "service_action":
            code += `sudo systemctl ${block.getFieldValue('ACTION')} ${block.getFieldValue('SERVICE')}\n`;
            break;
          case "create_service":
            code += `cat <<EOF | sudo tee /etc/systemd/system/${block.getFieldValue('NAME')}.service\n`;
            code += `[Unit]\nDescription=${block.getFieldValue('NAME')} Service\nAfter=network.target\n\n`;
            code += `[Service]\nUser=${block.getFieldValue('USER')}\nExecStart=${block.getFieldValue('EXEC')}\nRestart=always\n\n`;
            code += `[Install]\nWantedBy=multi-user.target\nEOF\n`;
            code += `sudo systemctl daemon-reload\nsudo systemctl enable ${block.getFieldValue('NAME')}\n`;
            break;
          case "schedule_task":
            code += `(crontab -l 2>/dev/null; echo "${block.getFieldValue('SCHEDULE')} ${block.getFieldValue('COMMAND')}") | crontab -\n`;
            break;
          case "check_resources":
            if (block.getFieldValue('TYPE') === 'cpu') {
              code += `mpstat 1 1 | awk '/all/ {print "CPU Usage: " 100-$12 "%"}'`;
            } else if (block.getFieldValue('TYPE') === 'memory') {
              code += `free -m | awk 'NR==2{printf "Memory Usage: %.2f%%", $3*100/$2 }'`;
            } else {
              code += `df -h | awk '$NF=="/"{printf "Disk Usage: %s", $5}'`;
            }
            code += '\n';
            break;
          case "kill_process":
            code += `sudo kill -${block.getFieldValue('SIGNAL')} ${block.getFieldValue('PID')}\n`;
            break;

          // Networking
          case "configure_network":
            code += `sudo nmcli connection modify "${block.getFieldValue('IFACE')}" ipv4.addresses ${block.getFieldValue('IP')}/${block.getFieldValue('PREFIX')} ipv4.gateway ${block.getFieldValue('GATEWAY')} ipv4.method manual\n`;
            code += `sudo nmcli connection up "${block.getFieldValue('IFACE')}"\n`;
            break;
          case "configure_firewall":
            if (block.getFieldValue('ACTION') === 'add') {
              code += `sudo firewall-cmd --permanent --add-port=${block.getFieldValue('PORT')}/${block.getFieldValue('PROTO')}\n`;
              code += `sudo firewall-cmd --reload\n`;
            } else {
              code += `sudo firewall-cmd --permanent --remove-port=${block.getFieldValue('PORT')}/${block.getFieldValue('PROTO')}\n`;
              code += `sudo firewall-cmd --reload\n`;
            }
            break;
          case "set_selinux_mode":
            code += `sudo setenforce ${block.getFieldValue('MODE')}\n`;
            code += `sudo sed -i 's/^SELINUX=.*/SELINUX=${block.getFieldValue('MODE')}/' /etc/selinux/config\n`;
            break;
          case "configure_sshd":
            code += `sudo sed -i 's/^${block.getFieldValue('OPTION')}.*/${block.getFieldValue('OPTION')} ${block.getFieldValue('VALUE')}/' /etc/ssh/sshd_config\n`;
            code += `sudo systemctl restart sshd\n`;
            break;
          case "test_connectivity":
            code += `ping -c 4 ${block.getFieldValue('TARGET')}\n`;
            break;
        }
      });
      
      return code || "# No valid blocks detected";
    }

    // Menu functions
    function showScript() {
      const code = generateBashCode();
      alert("Generated Bash Script:\n\n" + code);
    }

    function downloadScript() {
      const code = generateBashCode();
      const blob = new Blob([code], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'rh-admin-script.sh';
      a.click();
    }

    // Progress checking
    function checkProgress() {
      const blocks = Blockly.getMainWorkspace().getAllBlocks();
      const activeTab = document.querySelector('.tab-content.active').id.replace('-content', '');
      const feedback = document.getElementById('feedback');
      
      let tasks = {};
      
      // Define tasks for each lab
      if (activeTab === 'lab1') {
        tasks = {
          task1: blocks.some(b => b.type === "add_user" && 
                 b.getFieldValue('USERNAME') === 'devuser' && 
                 b.getFieldValue('HOME') === '/home/devuser' &&
                 b.getFieldValue('SHELL') === '/bin/bash'),
          task2: blocks.some(b => b.type === "add_group" && 
                 b.getFieldValue('GROUP') === 'developers' && 
                 b.getFieldValue('GID') === '2001'),
          task3: blocks.some(b => b.type === "add_user_to_group" && 
                 b.getFieldValue('USERNAME') === 'devuser' && 
                 b.getFieldValue('GROUP') === 'developers'),
          task4: blocks.some(b => b.type === "set_password_policy" && 
                 b.getFieldValue('MIN') === '7' && 
                 b.getFieldValue('MAX') === '90' &&
                 b.getFieldValue('WARN') === '7')
        };
      } else if (activeTab === 'lab2') {
        tasks = {
          task1: blocks.some(b => b.type === "create_filesystem" && 
                 b.getFieldValue('DEVICE') === '/dev/sdb1' && 
                 b.getFieldValue('FSTYPE') === 'ext4' &&
                 b.getFieldValue('LABEL') === 'DATA'),
          task2: blocks.some(b => b.type === "mount_filesystem" && 
                 b.getFieldValue('DEVICE') === '/dev/sdb1' && 
                 b.getFieldValue('MOUNTPOINT') === '/mnt/data' &&
                 b.getFieldValue('FSTYPE') === 'ext4' &&
                 b.getFieldValue('PERSIST') === 'TRUE'),
          task3: blocks.some(b => b.type === "analyze_disk" && 
                 b.getFieldValue('PATH') === '/var' && 
                 b.getFieldValue('DEPTH') === '2'),
          task4: blocks.some(b => b.type === "create_lvm" && 
                 b.getFieldValue('PV') === '/dev/sdc1' && 
                 b.getFieldValue('VG') === 'vg_data')
        };
      } else if (activeTab === 'lab3') {
        tasks = {
          task1: blocks.some(b => b.type === "service_action" && 
                 b.getFieldValue('SERVICE') === 'httpd' && 
                 (b.getFieldValue('ACTION') === 'start' || b.getFieldValue('ACTION') === 'enable')),
          task2: blocks.some(b => b.type === "create_service" && 
                 b.getFieldValue('NAME') === 'myapp' && 
                 b.getFieldValue('EXEC') === '/usr/local/bin/myapp' &&
                 b.getFieldValue('USER') === 'appuser'),
          task3: blocks.some(b => b.type === "schedule_task" && 
                 b.getFieldValue('COMMAND') === '/usr/local/bin/backup.sh' && 
                 b.getFieldValue('SCHEDULE') === '0 2 * * *'),
          task4: blocks.some(b => b.type === "check_resources" && 
                 b.getFieldValue('TYPE') === 'memory')
        };
      } else if (activeTab === 'lab4') {
        tasks = {
          task1: blocks.some(b => b.type === "configure_network" && 
                 b.getFieldValue('IFACE') === 'eth0' && 
                 b.getFieldValue('IP') === '192.168.1.100' &&
                 b.getFieldValue('PREFIX') === '24' &&
                 b.getFieldValue('GATEWAY') === '192.168.1.1'),
          task2: blocks.some(b => b.type === "configure_firewall" && 
                 b.getFieldValue('PORT') === '80' && 
                 b.getFieldValue('PROTO') === 'tcp' &&
                 b.getFieldValue('ACTION') === 'add'),
          task3: blocks.some(b => b.type === "set_selinux_mode" && 
                 b.getFieldValue('MODE') === 'enforcing'),
          task4: blocks.some(b => b.type === "configure_sshd" && 
                 b.getFieldValue('OPTION') === 'PermitRootLogin' && 
                 b.getFieldValue('VALUE') === 'no')
        };
      }
      
      // Update UI
      Object.keys(tasks).forEach(taskId => {
        document.getElementById(activeTab + '-' + taskId).classList.toggle('completed', tasks[taskId]);
      });
      
      // Show feedback
      const completed = Object.values(tasks).filter(Boolean).length;
      if (completed === 4) {
        feedback.innerHTML = '<div style="color:green;">‚úÖ All tasks completed! Ready to generate your script.</div>';
      } else {
        feedback.innerHTML = `<div style="color:#d35400;">‚è≥ Progress: ${completed}/4 tasks done</div>`;
      }
    }
  </script>
</body>
</html>