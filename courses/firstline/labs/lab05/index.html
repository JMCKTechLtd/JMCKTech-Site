<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lab 5: ServiceNow ITSM - Ticket Resolution & Closure</title>
  <style>
    :root {
      --primary-color:#2e51bb; --secondary-color:#71a8fc; --dark-text:#2a3e4c; --light-text:#6c757d;
      --border-color:#d8dbe0; --bg-light:#f8f9fa; --bg-lighter:#ffffff; --hover-bg:rgba(113,168,252,.07);
      --low-color:#6ed051; --medium-color:#ffcb3d; --high-color:#ff9e3d; --critical-color:#ec5050;
      --open-color:#71a8fc; --in-progress-color:#ffcb3d; --pending-color:#9c9c9c; --resolved-color:#6ed051; --closed-color:#6c757d;
    }
    *{box-sizing:border-box;font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;margin:0;padding:0}
    body{background:#f2f2f2;min-height:100vh;display:flex;flex-direction:column}
    .app-container{flex:1;display:flex;flex-direction:column;max-width:1920px;margin:0 auto;box-shadow:0 0 20px rgba(0,0,0,.1)}

    /* Instructions (kept) */
    .task-instructions{background:linear-gradient(135deg,#e3f2fd 0%,#f1f8e9 100%);border:1px solid #90caf9;border-radius:8px;padding:16px;margin:20px;position:sticky;top:0;z-index:10}
    .task-title{font-weight:600;color:var(--primary-color);margin-bottom:8px;font-size:16px}
    .task-description{color:var(--dark-text);line-height:1.4}

    /* Header */
    .header{background:linear-gradient(135deg,var(--primary-color) 0%,#1e40a0 100%);color:#fff;display:flex;align-items:center;padding:0 20px;height:50px}
    .logo{font-weight:700;font-size:18px}
    .header-controls{margin-left:auto}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:#e0e0e0;display:grid;place-items:center;color:var(--primary-color);font-weight:700;border:2px solid #fff}

    /* Nav + Subnav (added to match Lab 1) */
    .navbar{background:#fff;border-bottom:1px solid var(--border-color);display:flex;padding:0 10px;height:40px;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.03)}
    .nav-item{padding:0 12px;height:40px;display:flex;align-items:center;font-size:14px;color:var(--dark-text);border-bottom:3px solid transparent;cursor:pointer;transition:.2s}
    .nav-item:hover{background:rgba(0,0,0,.05)}
    .nav-item.active{border-bottom:3px solid var(--primary-color);font-weight:600;background:rgba(113,168,252,.1)}
    .subnav{background:var(--bg-light);border-bottom:1px solid var(--border-color);padding:0 20px;display:flex;height:45px;align-items:center;gap:8px}
    .view-button{padding:6px 12px;background:#fff;border:1px solid var(--border-color);border-radius:4px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .view-button.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);box-shadow:0 2px 4px rgba(46,81,187,.3)}
    .tickets-count{margin-left:auto;color:var(--primary-color);font-weight:600;font-size:14px}

    .content-wrapper{display:flex;flex:1;overflow:hidden}
    .main-content{flex:1;display:flex;flex-direction:column;background:#fff;overflow:hidden}

    /* Stats bar (kept) */
    .stats-bar{background:var(--bg-light);padding:12px 20px;display:flex;gap:30px;font-size:14px;border-bottom:1px solid var(--border-color)}
    .stat-item{display:flex;align-items:center;gap:8px}
    .stat-dot{width:12px;height:12px;border-radius:50%}
    .stat-open{background:var(--open-color)} .stat-progress{background:var(--in-progress-color)}
    .stat-resolved{background:var(--resolved-color)} .stat-closed{background:var(--closed-color)}

    /* Toolbar (kept) */
    .toolbar{padding:12px 15px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px;background:#fff}
    .btn{padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:none;display:flex;align-items:center;gap:6px;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.15)}
        .btn-primary{background:var(--primary-color);color:#fff}
.btn-success{background:var(--resolved-color);color:#fff}
    .btn-secondary{background:#fff;border:1px solid var(--border-color);color:var(--dark-text)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

    /* List */
    .list-container{flex:1;overflow:auto;background:#fff}
    .list-header{display:grid;grid-template-columns:40px 100px minmax(280px,1fr) 120px 120px 120px 100px;border-bottom:2px solid var(--border-color);font-size:12px;font-weight:600;color:var(--light-text);padding:12px 15px;position:sticky;top:0;background:var(--bg-light);z-index:1}
    .list-item{display:grid;grid-template-columns:40px 100px minmax(280px,1fr) 120px 120px 120px 100px;border-bottom:1px solid var(--border-color);padding:14px 15px;font-size:13px;color:var(--dark-text);cursor:pointer;transition:.2s}
    .list-item:hover{background:var(--hover-bg);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .list-item.selected{background:rgba(113,168,252,.15);border-left:4px solid var(--primary-color)}
    .list-item.resolved{background:rgba(110,208,81,.06)} .list-item.closed{background:rgba(108,117,125,.06);opacity:.9}
    .row-checkbox{display:flex;align-items:center;justify-content:center}
    .list-cell{display:flex;align-items:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .list-cell.ticket-number{color:var(--primary-color);font-weight:600}
    .status-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .status-open{background:rgba(113,168,252,.15);color:var(--open-color)}
    .status-in-progress{background:rgba(255,203,61,.15);color:#b8860b}
    .status-pending{background:rgba(156,156,156,.15);color:var(--pending-color)}
    .status-resolved{background:rgba(110,208,81,.15);color:var(--resolved-color)}
    .status-closed{background:rgba(108,117,125,.15);color:var(--closed-color)}
    .priority-badge{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500}
    .priority-dot{width:10px;height:10px;border-radius:50%}
    .priority-low{background:var(--low-color)} .priority-medium{background:var(--medium-color)} .priority-high{background:var(--high-color)} .priority-critical{background:var(--critical-color)}

    /* Read-only lists for non-incidents */
    .ro-list{padding:16px}
    .ro-item{border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:12px}
    .empty{padding:40px;text-align:center;color:var(--light-text)}

    /* Dashboard */
    .dashboard{display:none;padding:16px;background:#fff;overflow:auto}
    .dashboard.show{display:block}
    .kpi-grid{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:12px;margin-bottom:16px}
    .kpi{background:linear-gradient(135deg,#f8f9fa 0%,#eef3ff 100%);border:1px solid var(--border-color);border-radius:10px;padding:14px}
    .kpi .label{font-size:12px;color:var(--light-text)} .kpi .value{font-size:22px;font-weight:700;color:var(--dark-text)}
    .charts{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:16px}
    .chart-card{border:1px solid var(--border-color);border-radius:10px;padding:12px;background:#fff}
    .chart-title{font-size:14px;color:var(--dark-text);margin-bottom:8px;font-weight:600}
    canvas{width:100%;height:260px}

    /* Modals (kept) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .modal-backdrop.show{opacity:1;visibility:visible}
    .modal{background:#fff;border-radius:8px;width:700px;max-width:95%;max-height:95vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3);transform:translateY(30px) scale(.95);transition:transform .3s}
    .modal-backdrop.show .modal{transform:translateY(0) scale(1)}
    .modal-header{padding:20px 24px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%)}
    .modal-title{font-size:18px;font-weight:600;color:var(--dark-text)}
    .modal-close{background:none;border:none;font-size:24px;color:var(--light-text);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.2s}
    .modal-close:hover{color:var(--dark-text);background:rgba(0,0,0,.1)}
    .modal-body{padding:24px;overflow:auto}
    .modal-footer{padding:20px 24px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:12px;background:var(--bg-light)}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:var(--dark-text)}
    .form-control,.form-select{width:100%;padding:10px 14px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;background:#fff;transition:.2s}
    .form-control:focus,.form-select:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(113,168,252,.2)}
    textarea.form-control{min-height:100px;resize:vertical}

    /* Notification (kept) */
    .notification{position:fixed;top:20px;right:20px;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.2);padding:16px 20px;display:flex;align-items:center;gap:12px;width:350px;z-index:1010;transform:translateX(400px);transition:transform .3s;border-left:4px solid var(--resolved-color)}
    .notification.show{transform:translateX(0)}
    .notification-content{flex:1}
    .notification-title{font-size:14px;font-weight:600;margin-bottom:4px}
    .notification-message{font-size:13px;color:var(--light-text)}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- KEEP ORIGINAL INSTRUCTIONS -->
    <div class="task-instructions">
      <div class="task-title">Lab 5: Ticket Resolution & Closure</div>
      <div class="task-description">
        <strong>Task:</strong> Practice resolving and closing tickets. Select in-progress tickets and use the Resolve button to mark them as resolved with a solution. Then practice closing resolved tickets after confirming user satisfaction. Watch how tickets move through the resolution lifecycle.
      </div>
    </div>

    <header class="header">
      <div class="logo">ServiceNow</div>
      <div class="header-controls"><div class="user-avatar">JS</div></div>
    </header>

    <!-- Lab-1 style nav + view toggle -->
    <nav class="navbar">
      <div class="nav-item active" data-tab="incidents">Incidents</div>
      <div class="nav-item" data-tab="requests">Service Requests</div>
      <div class="nav-item" data-tab="reports">Reports</div>
    </nav>
    <div class="subnav">
      <button class="view-button active" data-view="list">ðŸ“‹ List</button>
      <button class="view-button" data-view="dashboard">ðŸ“Š Dashboard</button>
      <div class="tickets-count" id="ticketsCount">â€”</div>
    </div>

    <!-- Kept stats bar from original -->
    <div class="stats-bar">
      <div class="stat-item"><div class="stat-dot stat-open"></div><span id="openCount">â€” Open</span></div>
      <div class="stat-item"><div class="stat-dot stat-progress"></div><span id="progressCount">â€” In Progress</span></div>
      <div class="stat-item"><div class="stat-dot stat-resolved"></div><span id="resolvedCount">â€” Resolved</span></div>
      <div class="stat-item"><div class="stat-dot stat-closed"></div><span id="closedCount">â€” Closed</span></div>
    </div>

    <div class="content-wrapper">
      <div class="main-content">
        <div class="toolbar">
          <!-- PRIMARY BUTTONS UNCHANGED -->
          <button class="btn btn-success" id="resolveBtn" disabled>âœ“ Resolve</button>
          <button class="btn btn-secondary" id="closeBtn" disabled>ðŸ”’ Close</button>
          <div style="margin-left:auto;color:var(--primary-color);font-weight:600"><span id="selectedCount">0 selected</span></div>
          <div class="list-controls" id="labControls" style="margin-left:10px">
            <button class="btn btn-secondary" id="resetLab" type="button">Reset Lab</button>
            <button class="btn btn-primary" id="closeLab" type="button">Close Lab</button>
          </div>
        </div>

        <!-- LIST VIEW -->
        <div class="list-container" id="listView">
          <div class="list-header" id="listHeader">
            <div><input type="checkbox" id="selectAll"></div>
            <div>Number</div><div>Short description</div><div>Caller</div><div>Assigned to</div><div>Status</div><div>Priority</div>
          </div>
          <div id="ticketList"></div>
          <div id="roList" class="ro-list" style="display:none"></div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div class="dashboard" id="dashboardView">
          <div class="kpi-grid" id="kpiGrid"></div>
          <div class="charts">
            <div class="chart-card"><div class="chart-title">Records by State</div><canvas id="stateChart"></canvas></div>
            <div class="chart-card"><div class="chart-title">Records by Priority</div><canvas id="priorityChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resolution Modal (kept) -->
  <div class="modal-backdrop" id="resolveModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Resolve Tickets</div><button class="modal-close" id="resolveModalClose">&times;</button></div>
      <div class="modal-body">
        <div class="form-group"><div class="form-label">Resolution code</div>
          <select class="form-select" id="resolutionCode">
            <option value="Solved (Work Around)">Solved (Work Around)</option>
            <option value="Solved (Permanently)">Solved (Permanently)</option>
            <option value="Solved (Customer)">Solved (Customer)</option>
            <option value="Not Solved (Not Reproducible)">Not Solved (Not Reproducible)</option>
            <option value="Not Solved (Too Costly)">Not Solved (Too Costly)</option>
          </select>
        </div>
        <div class="form-group"><div class="form-label">Resolution notes</div>
          <textarea class="form-control" id="resolutionNotes" placeholder="Describe how the issue was resolved..."></textarea>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" id="resolveCancel">Cancel</button><button class="btn btn-success" id="resolveConfirm">Mark as Resolved</button></div>
    </div>
  </div>

  <!-- Closure Modal (kept) -->
  <div class="modal-backdrop" id="closeModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Close Tickets</div><button class="modal-close" id="closeModalClose">&times;</button></div>
      <div class="modal-body">
        <div style="background:rgba(108,117,125,.1);border:1px solid var(--closed-color);border-radius:8px;padding:12px;margin-bottom:12px;display:flex;gap:10px;align-items:center">
          <div style="font-size:22px;color:var(--closed-color)">ðŸ”’</div>
          <div><strong>Closure Confirmation:</strong> This will close the selected resolved tickets. Closed tickets cannot be reopened without supervisor approval. Ensure user satisfaction has been confirmed.</div>
        </div>
        <div class="form-group"><div class="form-label">Closure code</div>
          <select class="form-select" id="closureCode">
            <option value="Resolved">Resolved</option><option value="Resolved by Caller">Resolved by Caller</option><option value="Duplicate">Duplicate</option><option value="Not an Incident">Not an Incident</option>
          </select>
        </div>
        <div class="form-group"><div class="form-label">Closure notes</div>
          <textarea class="form-control" id="closureNotes" placeholder="Add any final notes before closing..."></textarea>
        </div>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" id="closeCancel">Cancel</button><button class="btn btn-secondary" id="closeConfirm">Close Tickets</button></div>
    </div>
  </div>

  <!-- Notification (kept) -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <div class="notification-title" id="notificationTitle">Success</div>
      <div class="notification-message" id="notificationMessage">Operation completed</div>
    </div>
  </div>

  <script>
    // ---------- DATA (original incidents + read-only data for other tabs) ----------
    const tickets=[
      {id:1,number:"INC0010025",shortDescription:"Printer issue in Marketing department",caller:"Sarah Johnson",assignedTo:"John Smith",priority:"Medium",state:"In Progress",resolutionCode:"",resolutionNotes:""},
      {id:2,number:"INC0010024",shortDescription:"Email synchronization problems",caller:"Michael Chen",assignedTo:"Lisa Brown",priority:"High",state:"In Progress"},
      {id:3,number:"INC0010023",shortDescription:"VPN connection issues",caller:"Robert Williams",assignedTo:"Mike Wilson",priority:"High",state:"In Progress"},
      {id:4,number:"INC0010022",shortDescription:"Software installation completed",caller:"HR Department",assignedTo:"John Smith",priority:"Low",state:"Resolved",resolutionCode:"Solved (Permanently)",resolutionNotes:"Successfully installed required software on all workstations. Tested functionality with user."},
      {id:5,number:"INC0010021",shortDescription:"Password reset request",caller:"David Miller",assignedTo:"Help Desk",priority:"Low",state:"Open"},
      {id:6,number:"INC0010020",shortDescription:"Monitor display issue",caller:"Finance Team",assignedTo:"Unassigned",priority:"Medium",state:"Open"}
    ];
    const requests=[
      {id:101,number:"REQ0010501",shortDescription:"Access to Finance drive",requester:"Anna Patel",assignmentGroup:"IT Support",assignedTo:"Unassigned",updated:"Today, 10:10 AM",priority:"Low",state:"Open"},
      {id:102,number:"REQ0010500",shortDescription:"Laptop Replacement",requester:"James Parker",assignmentGroup:"Hardware Team",assignedTo:"Tom Reed",updated:"Yesterday, 4:20 PM",priority:"Medium",state:"In Progress"}
    ];
    const reports=[{id:201,title:"Weekly Incident Summary",owner:"Service Desk",updated:"2025-08-20"},{id:202,title:"Monthly SLA Breach Report",owner:"IT Manager",updated:"2025-08-31"}];

    // ---------- STATE ----------
    let tab='incidents'; let view='list'; let selectedTickets=new Set();

    // ---------- UTIL ----------
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const sclass=s=>`status-${String(s||'').toLowerCase().replaceAll(' ','-')}`;
    const pclass=p=>`priority-${String(p||'').toLowerCase()}`;
    const labelFor=t=>t==='incidents'?'tickets':(t==='requests'?'requests':'reports');
    function updateCountsBar(){
      const stats={open:tickets.filter(t=>t.state==='Open').length,progress:tickets.filter(t=>t.state==='In Progress').length,resolved:tickets.filter(t=>t.state==='Resolved').length,closed:tickets.filter(t=>t.state==='Closed').length};
      $('#openCount').textContent=`${stats.open} Open`; $('#progressCount').textContent=`${stats.progress} In Progress`; $('#resolvedCount').textContent=`${stats.resolved} Resolved`; $('#closedCount').textContent=`${stats.closed} Closed`;
    }

    // ---------- INIT ----------
    function init(){ bind(); render(); }
    function bind(){
      // Tabs + view
      $$('.nav-item').forEach(i=>i.addEventListener('click',()=>{ tab=i.dataset.tab; view='list'; selectedTickets.clear(); render(); }));
      $$('.view-button').forEach(b=>b.addEventListener('click',()=>{ view=b.dataset.view; render(); }));
      // Buttons (primary flows unchanged)
      $('#resolveBtn').addEventListener('click',()=>$('#resolveModal').classList.add('show'));
      $('#closeBtn').addEventListener('click',()=>$('#closeModal').classList.add('show'));
      $('#resolveModalClose').onclick=$('#resolveCancel').onclick=()=>$('#resolveModal').classList.remove('show');
      $('#closeModalClose').onclick=$('#closeCancel').onclick=()=>$('#closeModal').classList.remove('show');
      $('#resolveConfirm').addEventListener('click',resolveTickets);
      $('#closeConfirm').addEventListener('click',closeTickets);
      // Select all applies to incidents list only
      $('#selectAll').addEventListener('change',e=>{ selectedTickets.clear(); if(e.target.checked && tab==='incidents'){ tickets.forEach(t=>selectedTickets.add(t.id)); } renderList(); updateButtons(); updateSelectedCount(); });
      // Esc key closes modals
      document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ $('#resolveModal').classList.remove('show'); $('#closeModal').classList.remove('show'); }});
      // Resize -> redraw charts
      window.addEventListener('resize',()=>{ if(view==='dashboard') drawDashboard(); });
    }

    // ---------- RENDER ----------
    function render(){
      // active states
      $$('.nav-item').forEach(n=>n.classList.toggle('active', n.dataset.tab===tab));
      $$('.view-button').forEach(b=>b.classList.toggle('active', b.dataset.view===view));
      // count label
      const len = (tab==='incidents'?tickets:tab==='requests'?requests:reports).length;
      $('#ticketsCount').textContent = `${len} ${labelFor(tab)}`;
      // views
      $('#listView').style.display = view==='list' ? 'block' : 'none';
      $('#dashboardView').classList.toggle('show', view==='dashboard');
      // list/dashboard
      if(view==='list') renderList(); else drawDashboard();
      // stats
      updateCountsBar();
      updateButtons(); updateSelectedCount();
    }

    function renderList(){
      const list=$('#ticketList'); const ro=$('#roList');
      if(tab!=='incidents'){
        $('#listHeader').style.display='none'; list.innerHTML=''; ro.style.display='block'; ro.innerHTML='';
        if(tab==='requests'){
          requests.forEach(r=>{
            const d=document.createElement('div'); d.className='ro-item';
            d.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><strong style="color:var(--primary-color)">${r.number}</strong><span style="margin-left:auto" class="status-badge ${sclass(r.state)}">${r.state}</span></div>
            <div style="font-weight:600;margin-top:6px">${r.shortDescription}</div>
            <div style="color:var(--light-text);font-size:12px;margin-top:4px">Requester: ${r.requester} â€¢ Group: ${r.assignmentGroup} â€¢ Assigned: ${r.assignedTo} â€¢ Updated: ${r.updated} â€¢ Priority: ${r.priority}</div>`;
            ro.appendChild(d);
          });
        } else { // reports
          reports.forEach(k=>{
            const d=document.createElement('div'); d.className='ro-item';
            d.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><strong style="color:var(--primary-color)">${k.title}</strong><span style="margin-left:auto;color:var(--light-text);font-size:12px">Updated: ${k.updated}</span></div>
            <div style="color:var(--light-text);font-size:12px;margin-top:4px">Owner: ${k.owner}</div>`;
            ro.appendChild(d);
          });
        }
        if(!(tab==='requests'?requests:reports).length) ro.innerHTML='<div class="empty">No records found.</div>';
        return;
      }
      // incidents full list
      $('#listHeader').style.display='grid'; ro.style.display='none'; list.innerHTML='';
      tickets.forEach(t=>list.appendChild(row(t)));
    }

    function row(t){
      const div=document.createElement('div'); div.className='list-item'; if(selectedTickets.has(t.id)) div.classList.add('selected');
      if(t.state==='Resolved') div.classList.add('resolved'); else if(t.state==='Closed') div.classList.add('closed');
      const sc=sclass(t.state), pc=pclass(t.priority);
      div.dataset.ticketId=t.id;
      div.innerHTML=`
        <div class="row-checkbox"><input type="checkbox" class="ticket-checkbox" data-ticket-id="${t.id}" ${selectedTickets.has(t.id)?'checked':''}></div>
        <div class="list-cell ticket-number">${t.number}</div>
        <div class="list-cell" title="${t.shortDescription}">${t.shortDescription}</div>
        <div class="list-cell">${t.caller}</div>
        <div class="list-cell">${t.assignedTo}</div>
        <div class="list-cell"><span class="status-badge ${sc}">${t.state}</span></div>
        <div class="list-cell"><div class="priority-badge"><div class="priority-dot ${pc}"></div>${t.priority}</div></div>`;
      const cb=div.querySelector('.ticket-checkbox');
      cb.addEventListener('change',e=>{ e.stopPropagation(); handleTicketSelection(t.id, e.target.checked); });
      div.addEventListener('click',e=>{ if(e.target.classList.contains('ticket-checkbox')) return; cb.checked=!cb.checked; handleTicketSelection(t.id, cb.checked); });
      return div;
    }

    // ---------- PRIMARY FLOW LOGIC (unchanged from original) ----------
    function handleTicketSelection(ticketId, isSelected){
      if(isSelected) selectedTickets.add(ticketId); else selectedTickets.delete(ticketId);
      updateButtons(); updateRowSelection(); updateSelectedCount();
    }
    function updateButtons(){
      const selectedObjs = Array.from(selectedTickets).map(id=>tickets.find(t=>t.id===id));
      const canResolve = selectedObjs.some(t=>t && t.state==='In Progress'); // unchanged
      const canClose   = selectedObjs.some(t=>t && t.state==='Resolved');    // unchanged
      $('#resolveBtn').disabled=!canResolve; $('#closeBtn').disabled=!canClose;
    }
    function updateRowSelection(){
      document.querySelectorAll('.list-item').forEach(row=>{ const tid=parseInt(row.dataset.ticketId); row.classList.toggle('selected', selectedTickets.has(tid)); });
    }
    function updateSelectedCount(){ $('#selectedCount').textContent = `${selectedTickets.size} selected`; }

    function resolveTickets(){
      const code=$('#resolutionCode').value; const notes=$('#resolutionNotes').value.trim();
      if(!notes){ alert('Please provide resolution notes'); return; }
      let count=0;
      Array.from(selectedTickets).forEach(id=>{ const t=tickets.find(x=>x.id===id); if(t && t.state==='In Progress'){ t.state='Resolved'; t.resolutionCode=code; t.resolutionNotes=notes; count++; } });
      selectedTickets.clear(); $('#resolutionNotes').value=''; $('#resolveModal').classList.remove('show');
      renderList(); updateButtons(); updateCountsBar(); updateSelectedCount(); notify('Success', `${count} ticket(s) resolved successfully`);
    }
    function closeTickets(){
      const code=$('#closureCode').value; const notes=$('#closureNotes').value.trim();
      let count=0;
      Array.from(selectedTickets).forEach(id=>{ const t=tickets.find(x=>x.id===id); if(t && t.state==='Resolved'){ t.state='Closed'; t.closureCode=code; t.closureNotes=notes; count++; } });
      selectedTickets.clear(); $('#closureNotes').value=''; $('#closeModal').classList.remove('show');
      renderList(); updateButtons(); updateCountsBar(); updateSelectedCount(); notify('Success', `${count} ticket(s) closed successfully`);
    }

    // ---------- DASHBOARD ----------
    function drawDashboard(){
      const list = tab==='incidents'?tickets:tab==='requests'?requests:reports;
      // KPIs
      const totals={
        total:list.length,
        open:list.filter(r=>(r.state||'')==='Open').length,
        inprog:list.filter(r=>(r.state||'')==='In Progress').length,
        pending:list.filter(r=>(r.state||'')==='Pending').length,
        resolved:list.filter(r=>(r.state||'')==='Resolved').length
      };
      $('#kpiGrid').innerHTML=`
        <div class="kpi"><div class="label">Total ${labelFor(tab)}</div><div class="value">${totals.total}</div></div>
        <div class="kpi"><div class="label">Open</div><div class="value">${totals.open}</div></div>
        <div class="kpi"><div class="label">In Progress</div><div class="value">${totals.inprog}</div></div>
        <div class="kpi"><div class="label">Pending</div><div class="value">${totals.pending}</div></div>
        <div class="kpi"><div class="label">Resolved</div><div class="value">${totals.resolved}</div></div>`;
      drawBar('stateChart', countBy(list,'state'));
      drawBar('priorityChart', countBy(list,'priority'));
    }
    function countBy(list,key){ const m={}; (list||[]).forEach(r=>{ const k=r[key]||'Unknown'; m[k]=(m[k]||0)+1; }); return m; }
    function drawBar(id,map){
      const c=document.getElementById(id),ctx=c.getContext('2d');
      const labels=Object.keys(map), vals=Object.values(map);
      const w=c.width=c.clientWidth, h=c.height=c.clientHeight;
      ctx.clearRect(0,0,w,h);
      const pad=30, slot=(w-pad*2)/(labels.length||1), bw=slot*0.6, gap=slot*0.4;
      ctx.strokeStyle='#d8dbe0'; ctx.beginPath(); ctx.moveTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.stroke();
      const maxVal=Math.max(1,...vals,1);
      labels.forEach((lab,i)=>{ const x=pad+i*slot+gap/2; const bh=(h-pad*2)*(vals[i]/maxVal); const y=h-pad-bh;
        ctx.fillStyle='#2e51bb'; ctx.fillRect(x,y,bw,bh);
        ctx.fillStyle='#2a3e4c'; ctx.font='12px Segoe UI'; ctx.textAlign='center'; ctx.fillText(vals[i], x+bw/2, y-6);
        ctx.save(); ctx.translate(x+bw/2, h-pad+14); ctx.rotate(-Math.PI/8); ctx.fillStyle='#6c757d'; ctx.fillText(lab,0,0); ctx.restore();
      });
    }

    // ---------- NOTIFICATION ----------
    function notify(title,msg){ $('#notificationTitle').textContent=title; $('#notificationMessage').textContent=msg; const n=$('#notification'); n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),2800); }

    // ---------- START ----------
    init();
  </script>

<script>
(function () {
  function wireLabButtons() {
    var resetBtn = document.querySelector('#resetLab');
    var closeBtn = document.querySelector('#closeLab');
    if (resetBtn && !resetBtn.dataset._wired) {
      resetBtn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        window.location.reload();
      });
      resetBtn.dataset._wired = '1';
    }
    if (closeBtn && !closeBtn.dataset._wired) {
      closeBtn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        window.close();
        setTimeout(function(){ window.location.href = 'about:blank'; }, 300);
      });
      closeBtn.dataset._wired = '1';
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', wireLabButtons);
  } else {
    wireLabButtons();
  }
  try { new MutationObserver(wireLabButtons).observe(document.body || document.documentElement, { subtree: true, childList: true }); } catch (e) {}
})();
</script>

</body>
</html>
