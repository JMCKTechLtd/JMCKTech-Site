<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lab 5: Ticket Resolution & Closure</title>
  <style>
    :root {
      --primary-color:#2e51bb; --secondary-color:#71a8fc; --dark-text:#2a3e4c; --light-text:#6c757d;
      --border-color:#d8dbe0; --bg-light:#f8f9fa; --bg-lighter:#ffffff; --hover-bg:rgba(113,168,252,.07);
      --low-color:#6ed051; --medium-color:#ffcb3d; --high-color:#ff9e3d; --critical-color:#ec5050;
      --open-color:#71a8fc; --in-progress-color:#ffcb3d; --pending-color:#9c9c9c; --resolved-color:#6ed051; --closed-color:#6c757d;
      --warning-color:#ffc107; --success-color:#28a745;
    }
    *{box-sizing:border-box;font-family:'Segoe UI','Helvetica Neue',Arial,sans-serif;margin:0;padding:0}
    body{background:#f2f2f2;min-height:100vh;display:flex;flex-direction:column}
    .app-container{flex:1;display:flex;flex-direction:column;max-width:1920px;margin:0 auto;box-shadow:0 0 20px rgba(0,0,0,.1)}

    /* Instructions (updated) */
    .task-instructions{background:linear-gradient(135deg,#e3f2fd 0%,#f1f8e9 100%);border:1px solid #90caf9;border-radius:8px;padding:16px;margin:20px;position:sticky;top:0;z-index:10}
    .task-title{font-weight:600;color:var(--primary-color);margin-bottom:8px;font-size:16px}
    .task-description{color:var(--dark-text);line-height:1.4}

    /* Header */
    .header{background:linear-gradient(135deg,var(--primary-color) 0%,#1e40a0 100%);color:#fff;display:flex;align-items:center;padding:0 20px;height:50px}
    .logo{font-weight:700;font-size:18px}
    .header-controls{margin-left:auto}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:#e0e0e0;display:grid;place-items:center;color:var(--primary-color);font-weight:700;border:2px solid #fff}

    /* Nav + Subnav */
    .navbar{background:#fff;border-bottom:1px solid var(--border-color);display:flex;padding:0 10px;height:40px;align-items:center;box-shadow:0 2px 4px rgba(0,0,0,.03)}
    .nav-item{padding:0 12px;height:40px;display:flex;align-items:center;font-size:14px;color:var(--dark-text);border-bottom:3px solid transparent;cursor:pointer;transition:.2s}
    .nav-item:hover{background:rgba(0,0,0,.05)}
    .nav-item.active{border-bottom:3px solid var(--primary-color);font-weight:600;background:rgba(113,168,252,.1)}
    .subnav{background:var(--bg-light);border-bottom:1px solid var(--border-color);padding:0 20px;display:flex;height:45px;align-items:center;gap:8px}
    .view-button{padding:6px 12px;background:#fff;border:1px solid var(--border-color);border-radius:4px;font-size:13px;cursor:pointer;display:flex;align-items:center;gap:6px}
    .view-button.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color);box-shadow:0 2px 4px rgba(46,81,187,.3)}
    .tickets-count{margin-left:auto;color:var(--primary-color);font-weight:600;font-size:14px}

    .content-wrapper{display:flex;flex:1;overflow:hidden}
    .main-content{flex:1;display:flex;flex-direction:column;background:#fff;overflow:hidden}

    /* Stats bar */
    .stats-bar{background:var(--bg-light);padding:12px 20px;display:flex;gap:30px;font-size:14px;border-bottom:1px solid var(--border-color)}
    .stat-item{display:flex;align-items:center;gap:8px}
    .stat-dot{width:12px;height:12px;border-radius:50%}
    .stat-open{background:var(--open-color)} .stat-progress{background:var(--in-progress-color)}
    .stat-resolved{background:var(--resolved-color)} .stat-closed{background:var(--closed-color)}

    /* Toolbar */
    .toolbar{padding:12px 15px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px;background:#fff}
    .btn{padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:none;display:flex;align-items:center;gap:6px;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.15)}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-success{background:var(--resolved-color);color:#fff}
    .btn-warning{background:var(--warning-color);color:#000}
    .btn-secondary{background:#fff;border:1px solid var(--border-color);color:var(--dark-text)}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

    /* List */
    .list-container{flex:1;overflow:auto;background:#fff}
    .list-header{display:grid;grid-template-columns:40px 100px minmax(280px,1fr) 120px 120px 120px 100px;border-bottom:2px solid var(--border-color);font-size:12px;font-weight:600;color:var(--light-text);padding:12px 15px;position:sticky;top:0;background:var(--bg-light);z-index:1}
    .list-item{display:grid;grid-template-columns:40px 100px minmax(280px,1fr) 120px 120px 120px 100px;border-bottom:1px solid var(--border-color);padding:14px 15px;font-size:13px;color:var(--dark-text);cursor:pointer;transition:.2s}
    .list-item:hover{background:var(--hover-bg);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .list-item.selected{background:rgba(113,168,252,.15);border-left:4px solid var(--primary-color)}
    .list-item.resolved{background:rgba(110,208,81,.06)} .list-item.closed{background:rgba(108,117,125,.06);opacity:.9}
    .row-checkbox{display:flex;align-items:center;justify-content:center}
    .list-cell{display:flex;align-items:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .list-cell.ticket-number{color:var(--primary-color);font-weight:600}
    .status-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .status-open{background:rgba(113,168,252,.15);color:var(--open-color)}
    .status-in-progress{background:rgba(255,203,61,.15);color:#b8860b}
    .status-pending{background:rgba(156,156,156,.15);color:var(--pending-color)}
    .status-resolved{background:rgba(110,208,81,.15);color:var(--resolved-color)}
    .status-closed{background:rgba(108,117,125,.15);color:var(--closed-color)}
    .priority-badge{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:500}
    .priority-dot{width:10px;height:10px;border-radius:50%}
    .priority-low{background:var(--low-color)} .priority-medium{background:var(--medium-color)} .priority-high{background:var(--high-color)} .priority-critical{background:var(--critical-color)}

    /* Read-only lists for non-incidents */
    .ro-list{padding:16px}
    .ro-item{border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:12px}
    .empty{padding:40px;text-align:center;color:var(--light-text)}

    /* Dashboard */
    .dashboard{display:none;padding:16px;background:#fff;overflow:auto}
    .dashboard.show{display:block}
    .kpi-grid{display:grid;grid-template-columns:repeat(5,minmax(160px,1fr));gap:12px;margin-bottom:16px}
    .kpi{background:linear-gradient(135deg,#f8f9fa 0%,#eef3ff 100%);border:1px solid var(--border-color);border-radius:10px;padding:14px}
    .kpi .label{font-size:12px;color:var(--light-text)} .kpi .value{font-size:22px;font-weight:700;color:var(--dark-text)}
    .charts{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:16px}
    .chart-card{border:1px solid var(--border-color);border-radius:10px;padding:12px;background:#fff}
    .chart-title{font-size:14px;color:var(--dark-text);margin-bottom:8px;font-weight:600}
    canvas{width:100%;height:260px}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .modal-backdrop.show{opacity:1;visibility:visible}
    .modal{background:#fff;border-radius:8px;width:700px;max-width:95%;max-height:95vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 10px 30px rgba(0,0,0,.3);transform:translateY(30px) scale(.95);transition:transform .3s}
    .modal-backdrop.show .modal{transform:translateY(0) scale(1)}
    .modal-header{padding:20px 24px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%)}
    .modal-title{font-size:18px;font-weight:600;color:var(--dark-text)}
    .modal-close{background:none;border:none;font-size:24px;color:var(--light-text);cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:.2s}
    .modal-close:hover{color:var(--dark-text);background:rgba(0,0,0,.1)}
    .modal-body{padding:24px;overflow:auto}
    .modal-footer{padding:20px 24px;border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;gap:12px;background:var(--bg-light)}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:var(--dark-text)}
    .form-control,.form-select{width:100%;padding:10px 14px;border:1px solid var(--border-color);border-radius:6px;font-size:14px;background:#fff;transition:.2s}
    .form-control:focus,.form-select:focus{outline:none;border-color:var(--secondary-color);box-shadow:0 0 0 3px rgba(113,168,252,.2)}
    textarea.form-control{min-height:100px;resize:vertical}
    .form-check{display:flex;align-items:center;gap:8px;margin-bottom:12px}
    .form-check-input{width:16px;height:16px}

    /* Notification */
    .notification{position:fixed;top:20px;right:20px;background:#fff;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.2);padding:16px 20px;display:flex;align-items:center;gap:12px;width:350px;z-index:1010;transform:translateX(400px);transition:transform .3s;border-left:4px solid var(--resolved-color)}
    .notification.show{transform:translateX(0)}
    .notification-content{flex:1}
    .notification-title{font-size:14px;font-weight:600;margin-bottom:4px}
    .notification-message{font-size:13px;color:var(--light-text)}

    /* Audit trail */
    .audit-trail{margin-top:20px;border:1px solid var(--border-color);border-radius:8px;overflow:hidden}
    .audit-header{background:var(--bg-light);padding:12px 16px;font-weight:600;border-bottom:1px solid var(--border-color)}
    .audit-item{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;gap:12px}
    .audit-item:last-child{border-bottom:none}
    .audit-time{color:var(--light-text);font-size:12px;min-width:120px}
    .audit-action{flex:1;font-size:13px}
    .audit-user{color:var(--primary-color);font-weight:600}

    /* Warning banners */
    .warning-banner{background:rgba(255,193,7,.1);border:1px solid var(--warning-color);border-radius:8px;padding:12px;margin-bottom:16px;display:flex;gap:12px;align-items:center}
    .warning-banner.critical{background:rgba(236,80,80,.1);border-color:var(--critical-color)}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- UPDATED INSTRUCTIONS -->
    <div class="task-instructions">
      <div class="task-title">Lab 5: Enhanced Ticket Resolution & Closure</div>
      <div class="task-description">
        <strong>Task:</strong> Practice the complete ticket resolution lifecycle. Resolve tickets with proper documentation, confirm user satisfaction, handle different closure scenarios (duplicates, not incidents), and understand business rules like SLA compliance and supervisor approvals.
      </div>
    </div>

    <header class="header">
      <div class="logo">ServiceNow</div>
      <div class="header-controls"><div class="user-avatar">JS</div></div>
    </header>

    <nav class="navbar">
      <div class="nav-item active" data-tab="incidents">Incidents</div>
      <div class="nav-item" data-tab="requests">Service Requests</div>
      <div class="nav-item" data-tab="reports">Reports</div>
    </nav>
    <div class="subnav">
      <button class="view-button active" data-view="list">📋 List</button>
      <button class="view-button" data-view="dashboard">📊 Dashboard</button>
      <div class="tickets-count" id="ticketsCount">—</div>
    </div>

    <div class="stats-bar">
      <div class="stat-item"><div class="stat-dot stat-open"></div><span id="openCount">— Open</span></div>
      <div class="stat-item"><div class="stat-dot stat-progress"></div><span id="progressCount">— In Progress</span></div>
      <div class="stat-item"><div class="stat-dot stat-resolved"></div><span id="resolvedCount">— Resolved</span></div>
      <div class="stat-item"><div class="stat-dot stat-closed"></div><span id="closedCount">— Closed</span></div>
    </div>

    <div class="content-wrapper">
      <div class="main-content">
        <div class="toolbar">
          <button class="btn btn-success" id="resolveBtn" disabled>✓ Resolve</button>
          <button class="btn btn-warning" id="satisfactionBtn" disabled>👤 Confirm Satisfaction</button>
          <button class="btn btn-secondary" id="closeBtn" disabled>🔒 Close</button>
          <div style="margin-left:auto;color:var(--primary-color);font-weight:600"><span id="selectedCount">0 selected</span></div>
          <div class="list-controls" id="labControls" style="margin-left:10px">
            <button class="btn btn-secondary" id="resetLab" type="button">Reset Lab</button>
            <button class="btn btn-primary" id="closeLab" type="button">Close Lab</button>
          </div>
        </div>

        <!-- LIST VIEW -->
        <div class="list-container" id="listView">
          <div class="list-header" id="listHeader">
            <div><input type="checkbox" id="selectAll"></div>
            <div>Number</div><div>Short description</div><div>Caller</div><div>Assigned to</div><div>Status</div><div>Priority</div>
          </div>
          <div id="ticketList"></div>
          <div id="roList" class="ro-list" style="display:none"></div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div class="dashboard" id="dashboardView">
          <div class="kpi-grid" id="kpiGrid"></div>
          <div class="charts">
            <div class="chart-card"><div class="chart-title">Records by State</div><canvas id="stateChart"></canvas></div>
            <div class="chart-card"><div class="chart-title">Records by Priority</div><canvas id="priorityChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resolution Modal (enhanced) -->
  <div class="modal-backdrop" id="resolveModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Resolve Tickets</div><button class="modal-close" id="resolveModalClose">&times;</button></div>
      <div class="modal-body">
        <div class="warning-banner" id="slaWarning" style="display:none">
          ⚠️ <strong>SLA Warning:</strong> One or more selected tickets are approaching their resolution deadline.
        </div>
        
        <div class="form-group">
          <div class="form-label">Resolution code *</div>
          <select class="form-select" id="resolutionCode">
            <option value="">-- Select resolution code --</option>
            <option value="Solved (Work Around)">Solved (Work Around)</option>
            <option value="Solved (Permanently)">Solved (Permanently)</option>
            <option value="Solved (Customer)">Solved (Customer)</option>
            <option value="Not Solved (Not Reproducible)">Not Solved (Not Reproducible)</option>
            <option value="Not Solved (Too Costly)">Not Solved (Too Costly)</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Resolution notes *</div>
          <textarea class="form-control" id="resolutionNotes" placeholder="Describe how the issue was resolved, steps taken, and any workarounds implemented..."></textarea>
        </div>
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="notifyUser">
            <label class="form-label" for="notifyUser" style="margin:0">Send resolution notification to user</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="resolveCancel">Cancel</button>
        <button class="btn btn-success" id="resolveConfirm">Mark as Resolved</button>
      </div>
    </div>
  </div>

  <!-- User Satisfaction Modal (NEW) -->
  <div class="modal-backdrop" id="satisfactionModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Confirm User Satisfaction</div><button class="modal-close" id="satisfactionModalClose">&times;</button></div>
      <div class="modal-body">
        <div style="background:rgba(40,167,69,.1);border:1px solid var(--success-color);border-radius:8px;padding:12px;margin-bottom:16px;">
          <strong>User Satisfaction Check:</strong> Contact the user to confirm the resolution meets their needs before closing the ticket.
        </div>
        
        <div class="form-group">
          <div class="form-label">Satisfaction confirmation *</div>
          <select class="form-select" id="satisfactionLevel">
            <option value="">-- Select satisfaction level --</option>
            <option value="Very Satisfied">Very Satisfied</option>
            <option value="Satisfied">Satisfied</option>
            <option value="Neutral">Neutral</option>
            <option value="Dissatisfied">Dissatisfied</option>
            <option value="Very Dissatisfied">Very Dissatisfied</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Feedback notes</div>
          <textarea class="form-control" id="satisfactionNotes" placeholder="Record any user feedback or comments..."></textarea>
        </div>
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="followUpRequired">
            <label class="form-label" for="followUpRequired" style="margin:0">Follow-up action required</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="satisfactionCancel">Cancel</button>
        <button class="btn btn-warning" id="satisfactionConfirm">Confirm Satisfaction</button>
      </div>
    </div>
  </div>

  <!-- Closure Modal (enhanced) -->
  <div class="modal-backdrop" id="closeModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Close Tickets</div><button class="modal-close" id="closeModalClose">&times;</button></div>
      <div class="modal-body">
        <div style="background:rgba(108,117,125,.1);border:1px solid var(--closed-color);border-radius:8px;padding:12px;margin-bottom:12px;display:flex;gap:10px;align-items:center">
          <div style="font-size:22px;color:var(--closed-color)">🔒</div>
          <div><strong>Closure Confirmation:</strong> This will close the selected resolved tickets. Closed tickets cannot be reopened without supervisor approval.</div>
        </div>

        <div id="closureRulesCheck" style="margin-bottom:16px"></div>
        
        <div class="form-group">
          <div class="form-label">Closure code *</div>
          <select class="form-select" id="closureCode">
            <option value="">-- Select closure code --</option>
            <option value="Resolved">Resolved</option>
            <option value="Resolved by Caller">Resolved by Caller</option>
            <option value="Duplicate">Duplicate</option>
            <option value="Not an Incident">Not an Incident</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
        
        <div id="duplicateFields" style="display:none">
          <div class="form-group">
            <div class="form-label">Original incident number *</div>
            <input type="text" class="form-control" id="originalIncident" placeholder="INC0010001">
          </div>
        </div>
        
        <div id="notIncidentFields" style="display:none">
          <div class="form-group">
            <div class="form-label">Convert to service request</div>
            <select class="form-select" id="convertToRequest">
              <option value="">-- No conversion --</option>
              <option value="Hardware Request">Hardware Request</option>
              <option value="Access Request">Access Request</option>
              <option value="Software Request">Software Request</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <div class="form-label">Closure notes</div>
          <textarea class="form-control" id="closureNotes" placeholder="Add any final notes before closing..."></textarea>
        </div>
        
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="slaMet">
            <label class="form-label" for="slaMet" style="margin:0">SLA compliance confirmed</label>
          </div>
        </div>
        
        <!-- Audit Trail -->
        <div class="audit-trail">
          <div class="audit-header">Recent Activity</div>
          <div id="closureAuditTrail"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="closeCancel">Cancel</button>
        <button class="btn btn-secondary" id="closeConfirm" disabled>Close Tickets</button>
      </div>
    </div>
  </div>

  <!-- Supervisor Approval Modal (NEW) -->
  <div class="modal-backdrop" id="approvalModal">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">Supervisor Approval Required</div><button class="modal-close" id="approvalModalClose">&times;</button></div>
      <div class="modal-body">
        <div class="warning-banner critical">
          ⚠️ <strong>Approval Required:</strong> The following tickets require supervisor approval before closure due to SLA breaches or special circumstances.
        </div>
        <div id="approvalList" style="margin:16px 0"></div>
        <div class="form-group">
          <div class="form-label">Approval notes</div>
          <textarea class="form-control" id="approvalNotes" placeholder="Add approval comments..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="approvalCancel">Cancel</button>
        <button class="btn btn-primary" id="approvalConfirm">Approve Closure</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div class="notification-content">
      <div class="notification-title" id="notificationTitle">Success</div>
      <div class="notification-message" id="notificationMessage">Operation completed</div>
    </div>
  </div>

  <script>
    // ---------- ENHANCED DATA ----------
    const tickets = [
      {id:1, number:"INC0010025", shortDescription:"Printer issue in Marketing department", caller:"Sarah Johnson", assignedTo:"John Smith", priority:"High", state:"In Progress", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"Breached", userSatisfaction:"", createdDate:"2025-08-20 09:15", dueDate:"2025-08-20 17:00", audit:[]},
      
      {id:2, number:"INC0010024", shortDescription:"Email synchronization problems", caller:"Michael Chen", assignedTo:"Lisa Brown", priority:"High", state:"In Progress", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"At Risk", userSatisfaction:"", createdDate:"2025-08-21 14:30", dueDate:"2025-08-22 14:30", audit:[]},
      
      {id:3, number:"INC0010023", shortDescription:"VPN connection issues", caller:"Robert Williams", assignedTo:"Mike Wilson", priority:"Medium", state:"In Progress", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"On Track", userSatisfaction:"", createdDate:"2025-08-22 10:00", dueDate:"2025-08-23 16:00", audit:[]},
      
      {id:4, number:"INC0010022", shortDescription:"Software installation completed", caller:"HR Department", assignedTo:"John Smith", priority:"Low", state:"Resolved", 
       resolutionCode:"Solved (Permanently)", resolutionNotes:"Successfully installed required software on all workstations. Tested functionality with user.", 
       slaStatus:"Met", userSatisfaction:"", createdDate:"2025-08-19 11:00", dueDate:"2025-08-22 11:00", audit:[]},
      
      {id:5, number:"INC0010021", shortDescription:"Password reset request", caller:"David Miller", assignedTo:"Help Desk", priority:"Low", state:"Open", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"On Track", userSatisfaction:"", createdDate:"2025-08-23 08:45", dueDate:"2025-08-23 12:45", audit:[]},
      
      {id:6, number:"INC0010020", shortDescription:"Monitor display issue", caller:"Finance Team", assignedTo:"Unassigned", priority:"Medium", state:"Open", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"On Track", userSatisfaction:"", createdDate:"2025-08-22 16:20", dueDate:"2025-08-23 16:20", audit:[]},
      
      {id:7, number:"INC0010019", shortDescription:"Duplicate of INC0010015", caller:"Anna Patel", assignedTo:"Unassigned", priority:"Low", state:"Resolved", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"On Track", userSatisfaction:"", createdDate:"2025-08-23 09:00", dueDate:"2025-08-24 09:00", audit:[]},
      
      {id:8, number:"INC0010018", shortDescription:"Application access request", caller:"James Wilson", assignedTo:"Unassigned", priority:"Low", state:"Resolved", 
       resolutionCode:"", resolutionNotes:"", slaStatus:"Met", userSatisfaction:"Satisfied", createdDate:"2025-08-20 13:15", dueDate:"2025-08-22 13:15", audit:[]}
    ];

    const requests = [
      {id:101, number:"REQ0010501", shortDescription:"Access to Finance drive", requester:"Anna Patel", assignmentGroup:"IT Support", assignedTo:"Unassigned", updated:"Today, 10:10 AM", priority:"Low", state:"Open"},
      {id:102, number:"REQ0010500", shortDescription:"Laptop Replacement", requester:"James Parker", assignmentGroup:"Hardware Team", assignedTo:"Tom Reed", updated:"Yesterday, 4:20 PM", priority:"Medium", state:"In Progress"}
    ];

    const reports = [
      {id:201, title:"Weekly Incident Summary", owner:"Service Desk", updated:"2025-08-20"},
      {id:202, title:"Monthly SLA Breach Report", owner:"IT Manager", updated:"2025-08-31"}
    ];

    // ---------- STATE ----------
    let tab = 'incidents';
    let view = 'list';
    let selectedTickets = new Set();
    let requiresApproval = false;

    // ---------- UTIL ----------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sclass = s => `status-${String(s || '').toLowerCase().replaceAll(' ', '-')}`;
    const pclass = p => `priority-${String(p || '').toLowerCase()}`;
    const labelFor = t => t === 'incidents' ? 'tickets' : (t === 'requests' ? 'requests' : 'reports');

    function updateCountsBar() {
      const stats = {
        open: tickets.filter(t => t.state === 'Open').length,
        progress: tickets.filter(t => t.state === 'In Progress').length,
        resolved: tickets.filter(t => t.state === 'Resolved').length,
        closed: tickets.filter(t => t.state === 'Closed').length
      };
      $('#openCount').textContent = `${stats.open} Open`;
      $('#progressCount').textContent = `${stats.progress} In Progress`;
      $('#resolvedCount').textContent = `${stats.resolved} Resolved`;
      $('#closedCount').textContent = `${stats.closed} Closed`;
    }

    function addAuditEntry(ticketId, action, details) {
      const ticket = tickets.find(t => t.id === ticketId);
      if (ticket && ticket.audit) {
        ticket.audit.push({
          timestamp: new Date().toLocaleString(),
          action: action,
          details: details,
          user: 'John Smith'
        });
      }
    }

    // ---------- INIT ----------
    function init() {
      bind();
      render();
      // Add initial audit entries
      tickets.forEach(ticket => {
        addAuditEntry(ticket.id, 'Created', `Ticket created by ${ticket.caller}`);
        if (ticket.assignedTo !== 'Unassigned') {
          addAuditEntry(ticket.id, 'Assigned', `Assigned to ${ticket.assignedTo}`);
        }
      });
    }

    function bind() {
      // Tabs + view
      $$('.nav-item').forEach(i => i.addEventListener('click', () => {
        tab = i.dataset.tab;
        view = 'list';
        selectedTickets.clear();
        render();
      }));
      $$('.view-button').forEach(b => b.addEventListener('click', () => {
        view = b.dataset.view;
        render();
      }));

      // Buttons
      $('#resolveBtn').addEventListener('click', () => {
        checkSLAWarnings();
        $('#resolveModal').classList.add('show');
      });
      $('#satisfactionBtn').addEventListener('click', () => $('#satisfactionModal').classList.add('show'));
      $('#closeBtn').addEventListener('click', () => {
        checkClosureRules();
        $('#closeModal').classList.add('show');
      });

      // Modal closes
      $('#resolveModalClose').onclick = $('#resolveCancel').onclick = () => $('#resolveModal').classList.remove('show');
      $('#satisfactionModalClose').onclick = $('#satisfactionCancel').onclick = () => $('#satisfactionModal').classList.remove('show');
      $('#closeModalClose').onclick = $('#closeCancel').onclick = () => $('#closeModal').classList.remove('show');
      $('#approvalModalClose').onclick = $('#approvalCancel').onclick = () => $('#approvalModal').classList.remove('show');

      // Modal confirms
      $('#resolveConfirm').addEventListener('click', resolveTickets);
      $('#satisfactionConfirm').addEventListener('click', confirmSatisfaction);
      $('#closeConfirm').addEventListener('click', closeTickets);
      $('#approvalConfirm').addEventListener('click', approveClosure);

      // Dynamic form changes
      $('#closureCode').addEventListener('change', handleClosureCodeChange);
      $('#closureCode').addEventListener('change', validateClosureForm);
      $('#slaMet').addEventListener('change', validateClosureForm);

      // Select all
      $('#selectAll').addEventListener('change', e => {
        selectedTickets.clear();
        if (e.target.checked && tab === 'incidents') {
          tickets.forEach(t => selectedTickets.add(t.id));
        }
        renderList();
        updateButtons();
        updateSelectedCount();
      });

      // Esc key closes modals
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          $$('.modal-backdrop').forEach(m => m.classList.remove('show'));
        }
      });

      window.addEventListener('resize', () => {
        if (view === 'dashboard') drawDashboard();
      });
    }

    // ---------- ENHANCED RENDER ----------
    function render() {
      $$('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.tab === tab));
      $$('.view-button').forEach(b => b.classList.toggle('active', b.dataset.view === view));

      const len = (tab === 'incidents' ? tickets : tab === 'requests' ? requests : reports).length;
      $('#ticketsCount').textContent = `${len} ${labelFor(tab)}`;

      $('#listView').style.display = view === 'list' ? 'block' : 'none';
      $('#dashboardView').classList.toggle('show', view === 'dashboard');

      if (view === 'list') renderList();
      else drawDashboard();

      updateCountsBar();
      updateButtons();
      updateSelectedCount();
    }

    function renderList() {
      const list = $('#ticketList');
      const ro = $('#roList');
      
      if (tab !== 'incidents') {
        $('#listHeader').style.display = 'none';
        list.innerHTML = '';
        ro.style.display = 'block';
        ro.innerHTML = '';
        
        if (tab === 'requests') {
          requests.forEach(r => {
            const d = document.createElement('div');
            d.className = 'ro-item';
            d.innerHTML = `
              <div style="display:flex;gap:8px;align-items:center">
                <strong style="color:var(--primary-color)">${r.number}</strong>
                <span style="margin-left:auto" class="status-badge ${sclass(r.state)}">${r.state}</span>
              </div>
              <div style="font-weight:600;margin-top:6px">${r.shortDescription}</div>
              <div style="color:var(--light-text);font-size:12px;margin-top:4px">
                Requester: ${r.requester} • Group: ${r.assignmentGroup} • Assigned: ${r.assignedTo} • Updated: ${r.updated} • Priority: ${r.priority}
              </div>`;
            ro.appendChild(d);
          });
        } else {
          reports.forEach(k => {
            const d = document.createElement('div');
            d.className = 'ro-item';
            d.innerHTML = `
              <div style="display:flex;gap:8px;align-items:center">
                <strong style="color:var(--primary-color)">${k.title}</strong>
                <span style="margin-left:auto;color:var(--light-text);font-size:12px">Updated: ${k.updated}</span>
              </div>
              <div style="color:var(--light-text);font-size:12px;margin-top:4px">Owner: ${k.owner}</div>`;
            ro.appendChild(d);
          });
        }
        
        if (!(tab === 'requests' ? requests : reports).length) {
          ro.innerHTML = '<div class="empty">No records found.</div>';
        }
        return;
      }

      $('#listHeader').style.display = 'grid';
      ro.style.display = 'none';
      list.innerHTML = '';
      tickets.forEach(t => list.appendChild(row(t)));
    }

    function row(t) {
      const div = document.createElement('div');
      div.className = 'list-item';
      if (selectedTickets.has(t.id)) div.classList.add('selected');
      if (t.state === 'Resolved') div.classList.add('resolved');
      else if (t.state === 'Closed') div.classList.add('closed');

      const sc = sclass(t.state);
      const pc = pclass(t.priority);
      
      div.dataset.ticketId = t.id;
      div.innerHTML = `
        <div class="row-checkbox">
          <input type="checkbox" class="ticket-checkbox" data-ticket-id="${t.id}" ${selectedTickets.has(t.id) ? 'checked' : ''}>
        </div>
        <div class="list-cell ticket-number">${t.number}</div>
        <div class="list-cell" title="${t.shortDescription}">${t.shortDescription}</div>
        <div class="list-cell">${t.caller}</div>
        <div class="list-cell">${t.assignedTo}</div>
        <div class="list-cell">
          <span class="status-badge ${sc}">${t.state}</span>
          ${t.slaStatus === 'Breached' ? ' ⚠️' : t.slaStatus === 'At Risk' ? ' 🔸' : ''}
        </div>
        <div class="list-cell">
          <div class="priority-badge">
            <div class="priority-dot ${pc}"></div>${t.priority}
          </div>
        </div>`;

      const cb = div.querySelector('.ticket-checkbox');
      cb.addEventListener('change', e => {
        e.stopPropagation();
        handleTicketSelection(t.id, e.target.checked);
      });
      
      div.addEventListener('click', e => {
        if (e.target.classList.contains('ticket-checkbox')) return;
        cb.checked = !cb.checked;
        handleTicketSelection(t.id, cb.checked);
      });
      
      return div;
    }

    // ---------- ENHANCED BUSINESS LOGIC ----------
    function handleTicketSelection(ticketId, isSelected) {
      if (isSelected) selectedTickets.add(ticketId);
      else selectedTickets.delete(ticketId);
      updateButtons();
      updateRowSelection();
      updateSelectedCount();
    }

    function updateButtons() {
      const selectedObjs = Array.from(selectedTickets).map(id => tickets.find(t => t.id === id));
      const canResolve = selectedObjs.some(t => t && t.state === 'In Progress');
      const canConfirmSatisfaction = selectedObjs.some(t => t && t.state === 'Resolved' && !t.userSatisfaction);
      const canClose = selectedObjs.some(t => t && t.state === 'Resolved' && t.userSatisfaction);
      
      $('#resolveBtn').disabled = !canResolve;
      $('#satisfactionBtn').disabled = !canConfirmSatisfaction;
      $('#closeBtn').disabled = !canClose;
    }

    function updateRowSelection() {
      document.querySelectorAll('.list-item').forEach(row => {
        const tid = parseInt(row.dataset.ticketId);
        row.classList.toggle('selected', selectedTickets.has(tid));
      });
    }

    function updateSelectedCount() {
      $('#selectedCount').textContent = `${selectedTickets.size} selected`;
    }

    function checkSLAWarnings() {
      const hasSLAIssues = Array.from(selectedTickets).some(id => {
        const t = tickets.find(x => x.id === id);
        return t && (t.slaStatus === 'Breached' || t.slaStatus === 'At Risk');
      });
      
      $('#slaWarning').style.display = hasSLAIssues ? 'flex' : 'none';
    }

    function resolveTickets() {
      const code = $('#resolutionCode').value;
      const notes = $('#resolutionNotes').value.trim();
      const notifyUser = $('#notifyUser').checked;

      if (!code) {
        alert('Please select a resolution code');
        return;
      }
      if (!notes) {
        alert('Please provide resolution notes');
        return;
      }

      let count = 0;
      Array.from(selectedTickets).forEach(id => {
        const t = tickets.find(x => x.id === id);
        if (t && t.state === 'In Progress') {
          t.state = 'Resolved';
          t.resolutionCode = code;
          t.resolutionNotes = notes;
          t.resolvedDate = new Date().toLocaleString();
          
          addAuditEntry(t.id, 'Resolved', 
            `Resolved with code: ${code}. ${notifyUser ? 'User notified.' : ''}`);
          
          count++;
        }
      });

      selectedTickets.clear();
      $('#resolutionCode').value = '';
      $('#resolutionNotes').value = '';
      $('#notifyUser').checked = false;
      $('#resolveModal').classList.remove('show');
      
      renderList();
      updateButtons();
      updateCountsBar();
      updateSelectedCount();
      notify('Success', `${count} ticket(s) resolved successfully${notifyUser ? ' - user notified' : ''}`);
    }

    function confirmSatisfaction() {
      const level = $('#satisfactionLevel').value;
      const notes = $('#satisfactionNotes').value.trim();
      const followUp = $('#followUpRequired').checked;

      if (!level) {
        alert('Please select a satisfaction level');
        return;
      }

      let count = 0;
      Array.from(selectedTickets).forEach(id => {
        const t = tickets.find(x => x.id === id);
        if (t && t.state === 'Resolved') {
          t.userSatisfaction = level;
          t.satisfactionNotes = notes;
          t.followUpRequired = followUp;
          
          addAuditEntry(t.id, 'Satisfaction Confirmed', 
            `User satisfaction: ${level}. ${followUp ? 'Follow-up required.' : ''}`);
          
          count++;
        }
      });

      selectedTickets.clear();
      $('#satisfactionLevel').value = '';
      $('#satisfactionNotes').value = '';
      $('#followUpRequired').checked = false;
      $('#satisfactionModal').classList.remove('show');
      
      renderList();
      updateButtons();
      updateSelectedCount();
      notify('Success', `User satisfaction confirmed for ${count} ticket(s)`);
    }

    function checkClosureRules() {
      const selectedObjs = Array.from(selectedTickets).map(id => tickets.find(t => t.id === id));
      const needsApproval = selectedObjs.filter(t => 
        t && (t.slaStatus === 'Breached' || t.priority === 'High')
      );
      
      requiresApproval = needsApproval.length > 0;
      
      if (requiresApproval) {
        $('#approvalList').innerHTML = needsApproval.map(t => 
          `<div style="padding:8px;border:1px solid var(--border-color);border-radius:4px;margin-bottom:8px">
            <strong>${t.number}</strong>: ${t.shortDescription} (${t.priority} priority, SLA: ${t.slaStatus})
          </div>`
        ).join('');
        $('#closeModal').classList.remove('show');
        $('#approvalModal').classList.add('show');
        return;
      }
      
      // Show closure rules check
      const rulesHtml = selectedObjs.map(t => {
        if (!t) return '';
        const rules = [];
        if (t.slaStatus !== 'Met') rules.push(`SLA ${t.slaStatus}`);
        if (!t.userSatisfaction) rules.push('User satisfaction not confirmed');
        if (t.followUpRequired) rules.push('Follow-up required');
        
        return rules.length ? 
          `<div style="color:var(--warning-color);font-size:12px;margin-top:4px">${t.number}: ${rules.join(', ')}</div>` : 
          `<div style="color:var(--success-color);font-size:12px;margin-top:4px">${t.number}: Ready for closure</div>`;
      }).join('');
      
      $('#closureRulesCheck').innerHTML = rulesHtml || '<div style="color:var(--success-color)">All selected tickets are ready for closure</div>';
      
      // Load audit trail
      loadClosureAuditTrail();
    }

    function loadClosureAuditTrail() {
      const auditEntries = [];
      Array.from(selectedTickets).forEach(id => {
        const t = tickets.find(x => x.id === id);
        if (t && t.audit) {
          t.audit.forEach(entry => {
            auditEntries.push(`
              <div class="audit-item">
                <div class="audit-time">${entry.timestamp}</div>
                <div class="audit-action">
                  <span class="audit-user">${entry.user}</span> ${entry.action}: ${entry.details}
                </div>
              </div>
            `);
          });
        }
      });
      
      $('#closureAuditTrail').innerHTML = auditEntries.slice(-5).join('') || '<div class="audit-item">No recent activity</div>';
    }

    function handleClosureCodeChange() {
      const code = $('#closureCode').value;
      $('#duplicateFields').style.display = code === 'Duplicate' ? 'block' : 'none';
      $('#notIncidentFields').style.display = code === 'Not an Incident' ? 'block' : 'none';
      validateClosureForm();
    }

    function validateClosureForm() {
      const code = $('#closureCode').value;
      const slaConfirmed = $('#slaMet').checked;
      let isValid = !!code && slaConfirmed;
      
      if (code === 'Duplicate') {
        isValid = isValid && !!$('#originalIncident').value.trim();
      }
      
      $('#closeConfirm').disabled = !isValid;
    }

    function closeTickets() {
      const code = $('#closureCode').value;
      const notes = $('#closureNotes').value.trim();
      const slaConfirmed = $('#slaMet').checked;
      const originalIncident = $('#originalIncident').value;
      const convertTo = $('#convertToRequest').value;

      if (!slaConfirmed) {
        alert('Please confirm SLA compliance before closing tickets');
        return;
      }

      let count = 0;
      Array.from(selectedTickets).forEach(id => {
        const t = tickets.find(x => x.id === id);
        if (t && t.state === 'Resolved') {
          t.state = 'Closed';
          t.closureCode = code;
          t.closureNotes = notes;
          t.closedDate = new Date().toLocaleString();
          
          let closureDetails = `Closed with code: ${code}`;
          if (code === 'Duplicate' && originalIncident) closureDetails += `, duplicate of ${originalIncident}`;
          if (code === 'Not an Incident' && convertTo) closureDetails += `, converted to ${convertTo}`;
          
          addAuditEntry(t.id, 'Closed', closureDetails);
          count++;
        }
      });

      selectedTickets.clear();
      $('#closureCode').value = '';
      $('#closureNotes').value = '';
      $('#originalIncident').value = '';
      $('#convertToRequest').value = '';
      $('#slaMet').checked = false;
      $('#closeModal').classList.remove('show');
      
      renderList();
      updateButtons();
      updateCountsBar();
      updateSelectedCount();
      notify('Success', `${count} ticket(s) closed successfully`);
    }

    function approveClosure() {
      const notes = $('#approvalNotes').value.trim();
      
      addAuditEntry(Array.from(selectedTickets)[0], 'Approval Granted', 
        `Supervisor approved closure. Notes: ${notes || 'No notes'}`);
      
      $('#approvalNotes').value = '';
      $('#approvalModal').classList.remove('show');
      $('#closeModal').classList.add('show');
    }

    // ---------- DASHBOARD (unchanged) ----------
    function drawDashboard() {
      const list = tab === 'incidents' ? tickets : tab === 'requests' ? requests : reports;
      const totals = {
        total: list.length,
        open: list.filter(r => (r.state || '') === 'Open').length,
        inprog: list.filter(r => (r.state || '') === 'In Progress').length,
        pending: list.filter(r => (r.state || '') === 'Pending').length,
        resolved: list.filter(r => (r.state || '') === 'Resolved').length
      };
      
      $('#kpiGrid').innerHTML = `
        <div class="kpi"><div class="label">Total ${labelFor(tab)}</div><div class="value">${totals.total}</div></div>
        <div class="kpi"><div class="label">Open</div><div class="value">${totals.open}</div></div>
        <div class="kpi"><div class="label">In Progress</div><div class="value">${totals.inprog}</div></div>
        <div class="kpi"><div class="label">Pending</div><div class="value">${totals.pending}</div></div>
        <div class="kpi"><div class="label">Resolved</div><div class="value">${totals.resolved}</div></div>`;
      
      drawBar('stateChart', countBy(list, 'state'));
      drawBar('priorityChart', countBy(list, 'priority'));
    }

    function countBy(list, key) {
      const m = {};
      (list || []).forEach(r => {
        const k = r[key] || 'Unknown';
        m[k] = (m[k] || 0) + 1;
      });
      return m;
    }

    function drawBar(id, map) {
      const c = document.getElementById(id);
      const ctx = c.getContext('2d');
      const labels = Object.keys(map);
      const vals = Object.values(map);
      const w = c.width = c.clientWidth;
      const h = c.height = c.clientHeight;
      
      ctx.clearRect(0, 0, w, h);
      const pad = 30;
      const slot = (w - pad * 2) / (labels.length || 1);
      const bw = slot * 0.6;
      const gap = slot * 0.4;
      
      ctx.strokeStyle = '#d8dbe0';
      ctx.beginPath();
      ctx.moveTo(pad, h - pad);
      ctx.lineTo(w - pad, h - pad);
      ctx.moveTo(pad, pad);
      ctx.lineTo(pad, h - pad);
      ctx.stroke();
      
      const maxVal = Math.max(1, ...vals, 1);
      labels.forEach((lab, i) => {
        const x = pad + i * slot + gap / 2;
        const bh = (h - pad * 2) * (vals[i] / maxVal);
        const y = h - pad - bh;
        
        ctx.fillStyle = '#2e51bb';
        ctx.fillRect(x, y, bw, bh);
        
        ctx.fillStyle = '#2a3e4c';
        ctx.font = '12px Segoe UI';
        ctx.textAlign = 'center';
        ctx.fillText(vals[i], x + bw / 2, y - 6);
        
        ctx.save();
        ctx.translate(x + bw / 2, h - pad + 14);
        ctx.rotate(-Math.PI / 8);
        ctx.fillStyle = '#6c757d';
        ctx.fillText(lab, 0, 0);
        ctx.restore();
      });
    }

    // ---------- NOTIFICATION ----------
    function notify(title, msg) {
      $('#notificationTitle').textContent = title;
      $('#notificationMessage').textContent = msg;
      const n = $('#notification');
      n.classList.add('show');
      setTimeout(() => n.classList.remove('show'), 2800);
    }

    // ---------- START ----------
    init();
  </script>

  <script>
    (function () {
      function wireLabButtons() {
        var resetBtn = document.querySelector('#resetLab');
        var closeBtn = document.querySelector('#closeLab');
        if (resetBtn && !resetBtn.dataset._wired) {
          resetBtn.addEventListener('click', function(e){
            e.preventDefault(); e.stopPropagation();
            window.location.reload();
          });
          resetBtn.dataset._wired = '1';
        }
        if (closeBtn && !closeBtn.dataset._wired) {
          closeBtn.addEventListener('click', function(e){
            e.preventDefault(); e.stopPropagation();
            window.close();
            setTimeout(function(){ window.location.href = 'about:blank'; }, 300);
          });
          closeBtn.dataset._wired = '1';
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', wireLabButtons);
      } else {
        wireLabButtons();
      }
      try { new MutationObserver(wireLabButtons).observe(document.body || document.documentElement, { subtree: true, childList: true }); } catch (e) {}
    })();
  </script>

</body>
</html>