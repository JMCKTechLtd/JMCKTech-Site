<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 1: Ticket Viewing & Navigation</title>
    <style>
        :root {
            --primary-color: #2e51bb;
            --secondary-color: #71a8fc;
            --dark-text: #2a3e4c;
            --light-text: #6c757d;
            --border-color: #d8dbe0;
            --bg-light: #f8f9fa;
            --bg-lighter: #ffffff;
            --low-color: #6ed051;
            --medium-color: #ffcb3d;
            --high-color: #ff9e3d;
            --critical-color: #ec5050;
            --open-color: #71a8fc;
            --in-progress-color: #ffcb3d;
            --pending-color: #9c9c9c;
            --resolved-color: #6ed051;
            --closed-color: #6c757d;
            --hover-bg: rgba(113, 168, 252, 0.07);
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            background-color: #f2f2f2;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1920px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e40a0 100%);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            height: 50px;
            z-index: 100;
        }
        
        .logo {
            font-weight: 700;
            font-size: 18px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }
        
        .header-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-weight: bold;
            border: 2px solid white;
        }

        /* Navigation */
        .navbar {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            padding: 0 10px;
            height: 40px;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        
        .nav-item {
            padding: 0 12px;
            height: 40px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--dark-text);
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .nav-item.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
            background-color: rgba(113, 168, 252, 0.1);
        }
        
        .subnav {
            background-color: var(--bg-light);
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            display: flex;
            height: 45px;
            align-items: center;
            gap: 12px;
        }
        
        .view-controls {
            display: flex;
            gap: 4px;
        }
        
        .view-button {
            padding: 6px 12px;
            background-color: var(--bg-lighter);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        
        .view-button:hover {
            background-color: #f0f0f0;
        }
        
        .view-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(46, 81, 187, 0.3);
        }

        /* Main Content */
        .content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-lighter);
            overflow: hidden;
        }
        
        .toolbar {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .list-controls {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .tickets-count {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }

        /* Enhanced Search & Filter */
        .search-filter-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 8px 36px 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background-color: white;
        }
        
        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-text);
        }
        
        .filter-button {
            padding: 8px 12px;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .filter-panel {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 250px;
            display: none;
        }
        
        .filter-panel.show {
            display: block;
        }
        
        .filter-group {
            margin-bottom: 12px;
        }
        
        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark-text);
            margin-bottom: 6px;
        }
        
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-option {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        /* Ticket/List */
        .list-container {
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }
        
        .list-header {
            display: grid;
            grid-template-columns: var(--grid-cols, 100px minmax(300px, 1fr) 150px 150px 150px 120px 100px);
            border-bottom: 2px solid var(--border-color);
            font-size: 12px;
            font-weight: 600;
            color: var(--light-text);
            padding: 12px 15px;
            position: sticky;
            top: 0;
            background-color: var(--bg-light);
            z-index: 1;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .sortable-header:hover {
            color: var(--primary-color);
        }
        
        .sort-indicator {
            font-size: 10px;
            opacity: 0.6;
        }
        
        .list-item {
            display: grid;
            grid-template-columns: var(--grid-cols, 100px minmax(300px, 1fr) 150px 150px 150px 120px 100px);
            border-bottom: 1px solid var(--border-color);
            padding: 14px 15px;
            font-size: 13px;
            color: var(--dark-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .list-item:hover {
            background-color: var(--hover-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .list-cell {
            display: flex;
            align-items: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .list-cell.ticket-number {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-open { background-color: rgba(113, 168, 252, 0.15); color: var(--open-color); }
        .status-in-progress { background-color: rgba(255, 203, 61, 0.15); color: #b8860b; }
        .status-pending { background-color: rgba(156, 156, 156, 0.15); color: var(--pending-color); }
        .status-resolved { background-color: rgba(110, 208, 81, 0.15); color: var(--resolved-color); }
        .status-closed { background-color: rgba(108, 117, 125, 0.15); color: var(--closed-color); }
        
        .priority-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .priority-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .priority-low { background-color: var(--low-color); }
        .priority-medium { background-color: var(--medium-color); }
        .priority-high { background-color: var(--high-color); }
        .priority-critical { background-color: var(--critical-color); }

        /* Dashboard */
        .dashboard {
            display: none;
            padding: 16px;
            background: white;
            overflow-y: auto;
        }
        .dashboard.show { display: block; }
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .kpi {
            background: linear-gradient(135deg, #f8f9fa 0%, #eef3ff 100%);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .kpi:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .kpi .label { font-size: 12px; color: var(--light-text); }
        .kpi .value { font-size: 22px; font-weight: 700; color: var(--dark-text); }
        .charts {
            display: grid;
            grid-template-columns: repeat(2, minmax(280px, 1fr));
            gap: 16px;
        }
        .chart-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            background: #fff;
            cursor: pointer;
        }
        .chart-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .chart-title { font-size: 14px; color: var(--dark-text); margin-bottom: 8px; font-weight: 600; }
        canvas { width: 100%; height: 260px; }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal {
            background-color: white;
            border-radius: 8px;
            width: 900px;
            max-width: 95%;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: translateY(30px) scale(0.95);
            transition: transform 0.3s ease;
        }
        
        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-backdrop.show .modal {
            transform: translateY(0) scale(1);
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark-text);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--light-text);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: var(--dark-text);
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .modal-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(95vh - 200px);
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background-color: var(--bg-light);
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .btn-secondary {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--dark-text);
        }
        
        .btn-secondary:hover {
            background-color: #f8f9fa;
        }
        .btn-primary { background: var(--primary-color); color: #fff; }

        .info-row {
            display: flex;
            margin-bottom: 16px;
            padding: 12px;
            background-color: var(--bg-light);
            border-radius: 6px;
            gap: 16px;
            align-items: center;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--dark-text);
            width: 180px;
            flex-shrink: 0;
        }
        
        .info-value {
            color: var(--dark-text);
            flex: 1;
        }

        .info-value select, .info-value input, .info-value textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
        }

        .description-section {
            margin-top: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--dark-text);
        }
        
        .description-text {
            background-color: var(--bg-light);
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            line-height: 1.5;
        }

        .task-instructions {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border: 1px solid #90caf9;
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .task-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .task-description {
            color: var(--dark-text);
            line-height: 1.4;
        }

        /* Empty state */
        .empty {
            padding: 40px;
            text-align: center;
            color: var(--light-text);
        }

        /* Related Records */
        .related-records {
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .related-header {
            background-color: var(--bg-light);
            padding: 12px 16px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
        }
        
        .related-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .related-item {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .related-item:hover {
            background-color: var(--hover-bg);
        }
        
        .related-item:last-child {
            border-bottom: none;
        }

        /* Attachments */
        .attachments-section {
            margin-top: 20px;
        }
        
        .attachment-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background-color: var(--bg-light);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .attachment-icon {
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .attachment-name {
            flex: 1;
            font-size: 13px;
        }
        
        .attachment-actions {
            display: flex;
            gap: 8px;
        }
        
        .attachment-action {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 12px;
        }

        /* Activity Log */
        .activity-log {
            margin-top: 20px;
        }
        
        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-meta {
            font-size: 12px;
            color: var(--light-text);
            margin-bottom: 4px;
        }
        
        .activity-text {
            font-size: 13px;
            color: var(--dark-text);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="task-instructions">
            <div class="task-title">Lab 1: Ticket Viewing & Navigation - Enhanced</div>
            <div class="task-description">
                <strong>Task:</strong> Practice navigating the different modules, switch between <em>List</em> and <em>Dashboard</em>, and view/update record details. Your changes persist while the page is open.
            </div>
        </div>

        <!-- Header -->
        <header class="header">
            <div class="logo">ServiceNow</div>
            <div class="header-controls">
                <div class="user-avatar">JS</div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-item active" data-tab="incidents">Incidents</div>
            <div class="nav-item" data-tab="requests">Service Requests</div>
            <div class="nav-item" data-tab="knowledge">Knowledge Base</div>
            <div class="nav-item" data-tab="problems">Problems</div>
        </nav>
        
        <div class="subnav">
            <div class="view-controls">
                <div class="view-button active" data-view="list">üìã List</div>
                <div class="view-button" data-view="dashboard">üìä Dashboard</div>
            </div>
            
            <!-- Enhanced Search & Filter -->
            <div class="search-filter-bar">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search...">
                    <div class="search-icon">üîç</div>
                </div>
                <div class="filter-container" style="position: relative;">
                    <button class="filter-button" id="filterButton">
                        üîß Filter
                    </button>
                    <div class="filter-panel" id="filterPanel">
                        <div class="filter-group">
                            <div class="filter-label">Status</div>
                            <div class="filter-options" id="statusFilters"></div>
                        </div>
                        <div class="filter-group">
                            <div class="filter-label">Priority</div>
                            <div class="filter-options" id="priorityFilters"></div>
                        </div>
                        <div class="filter-group">
                            <div class="filter-label">Assignment Group</div>
                            <div class="filter-options" id="groupFilters"></div>
                        </div>
                        <button class="btn btn-primary" id="applyFilters" style="width: 100%; margin-top: 12px;">Apply Filters</button>
                    </div>
                </div>
            </div>
            
            <div class="tickets-count" id="ticketsCount">‚Äî</div>
        </div>
        
        <div class="content-wrapper">
            <div class="main-content">
                <div class="toolbar" id="toolbar">
                    <div id="toolbarHint" class="light-text"></div>
                    <div class="list-controls" id="labControls">
                        <button class="btn btn-secondary" id="resetLab" type="button">Reset Lab</button>
                        <button class="btn btn-primary" id="closeLab" type="button">Close Lab</button>
                    </div>
                </div>
                
                <!-- LIST VIEW -->
                <div class="list-container" id="listView">
                    <div class="list-header" id="listHeader"></div>
                    <div id="listBody"></div>
                </div>

                <!-- DASHBOARD VIEW -->
                <div class="dashboard" id="dashboardView">
                    <div class="kpi-grid" id="kpiGrid"></div>
                    <div class="charts">
                        <div class="chart-card">
                            <div class="chart-title">Records by State</div>
                            <canvas id="stateChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Records by Priority</div>
                            <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div class="modal-backdrop" id="recordModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Details</div>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeBtn">Close</button>
                <button class="btn btn-primary" id="saveBtn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // ------------------ ENHANCED DATA ------------------
        const db = {
            incidents: [
                {
                    number: "INC0010023",
                    shortDescription: "Printer not working in Marketing department",
                    caller: "Sarah Johnson",
                    assignmentGroup: "IT Support",
                    assignedTo: "John Smith",
                    updated: "Today, 10:45 AM",
                    priority: "High",
                    state: "In Progress",
                    description: "Users in the Marketing department on the 3rd floor are unable to print to the shared HP LaserJet printer. The printer appears to be powered on but jobs are stuck in the queue. This issue started this morning and affects multiple users.",
                    created: "2025-01-15 08:30 AM",
                    category: "Hardware",
                    subcategory: "Printers",
                    attachments: [
                        { name: "printer_error.png", type: "image", size: "2.4 MB" },
                        { name: "error_log.txt", type: "document", size: "15 KB" }
                    ],
                    relatedRecords: ["INC0010015", "PRB0000760"],
                    activity: [
                        { user: "John Smith", action: "Work notes updated", timestamp: "Today, 10:45 AM", details: "Checked printer queue and found multiple stuck jobs" },
                        { user: "System", action: "Assigned to", timestamp: "Today, 09:15 AM", details: "Assigned to John Smith" },
                        { user: "Sarah Johnson", action: "Incident created", timestamp: "Today, 08:30 AM", details: "Initial description provided" }
                    ]
                },
                {
                    number: "INC0010022", 
                    shortDescription: "Email access issues on mobile device",
                    caller: "Michael Chen",
                    assignmentGroup: "IT Support", 
                    assignedTo: "Unassigned",
                    updated: "Today, 9:30 AM",
                    priority: "Medium",
                    state: "Open",
                    description: "Unable to access company email on iPhone. Authentication keeps failing despite correct credentials.",
                    created: "2025-01-15 09:00 AM",
                    category: "Email",
                    subcategory: "Mobile Access",
                    attachments: [
                        { name: "screenshot.jpg", type: "image", size: "1.8 MB" }
                    ],
                    relatedRecords: [],
                    activity: [
                        { user: "Michael Chen", action: "Incident created", timestamp: "Today, 09:00 AM", details: "Reported email access issue" }
                    ]
                },
                {
                    number: "INC0010021",
                    shortDescription: "VPN connection drops frequently", 
                    caller: "Robert Williams",
                    assignmentGroup: "Network Team",
                    assignedTo: "Lisa Brown",
                    updated: "Today, 8:30 AM",
                    priority: "High", 
                    state: "In Progress",
                    description: "VPN connection drops every 10-15 minutes requiring reconnection. Issue started yesterday.",
                    created: "2025-01-14 03:45 PM",
                    category: "Network",
                    subcategory: "VPN",
                    attachments: [],
                    relatedRecords: ["PRB0000761"],
                    activity: [
                        { user: "Lisa Brown", action: "Work notes updated", timestamp: "Today, 08:30 AM", details: "Checking VPN server logs for connection issues" },
                        { user: "Robert Williams", action: "Incident created", timestamp: "Yesterday, 03:45 PM", details: "Initial report of VPN disconnections" }
                    ]
                },
                {
                    number: "INC0010020",
                    shortDescription: "New employee account setup",
                    caller: "HR Department", 
                    assignmentGroup: "IT Support",
                    assignedTo: "John Smith", 
                    updated: "Today, 9:00 AM",
                    priority: "Low",
                    state: "Resolved", 
                    description: "Set up new employee with company accounts and access permissions.",
                    created: "2025-01-14 02:00 PM",
                    category: "User Management",
                    subcategory: "Account Creation",
                    attachments: [
                        { name: "onboarding_form.pdf", type: "document", size: "3.2 MB" }
                    ],
                    relatedRecords: ["REQ0010501"],
                    activity: [
                        { user: "John Smith", action: "Resolved incident", timestamp: "Today, 09:00 AM", details: "All accounts created and permissions set" },
                        { user: "John Smith", action: "Work notes updated", timestamp: "Yesterday, 04:30 PM", details: "Started account setup process" }
                    ]
                },
                {
                    number: "INC0010019",
                    shortDescription: "Monitor not displaying correctly",
                    caller: "David Miller",
                    assignmentGroup: "IT Support", 
                    assignedTo: "IT Support",
                    updated: "Yesterday, 3:15 PM", 
                    priority: "Medium",
                    state: "Pending",
                    description: "External monitor shows distorted colors and flickering. Issue intermittent.",
                    created: "2025-01-13 10:20 AM",
                    category: "Hardware",
                    subcategory: "Monitors",
                    attachments: [
                        { name: "monitor_issue.mp4", type: "video", size: "8.7 MB" }
                    ],
                    relatedRecords: [],
                    activity: [
                        { user: "David Miller", action: "Incident created", timestamp: "Yesterday, 03:15 PM", details: "Reported monitor display issues" }
                    ]
                }
            ],
            requests: [
                { 
                    number: "REQ0010501", 
                    shortDescription: "Request access to Shared Drive - Finance", 
                    requester: "Anna Patel", 
                    assignmentGroup: "IT Support", 
                    assignedTo: "Unassigned", 
                    updated: "Today, 10:10 AM", 
                    priority: "Low", 
                    state: "Open", 
                    description: "Needs read-only access to Finance shared drive.",
                    created: "2025-01-15 09:45 AM",
                    category: "Access Request",
                    attachments: [],
                    relatedRecords: [],
                    activity: []
                },
                { 
                    number: "REQ0010500", 
                    shortDescription: "Laptop Replacement", 
                    requester: "James Parker", 
                    assignmentGroup: "Hardware Team", 
                    assignedTo: "Tom Reed", 
                    updated: "Yesterday, 4:20 PM", 
                    priority: "Medium", 
                    state: "In Progress", 
                    description: "Old laptop out of warranty, replacement approved.",
                    created: "2025-01-14 11:30 AM",
                    category: "Hardware Request",
                    attachments: [
                        { name: "approval_form.pdf", type: "document", size: "1.1 MB" }
                    ],
                    relatedRecords: [],
                    activity: []
                },
                { 
                    number: "REQ0010499", 
                    shortDescription: "Software Installation - Visio", 
                    requester: "Maria Gomez", 
                    assignmentGroup: "Software Team", 
                    assignedTo: "Unassigned", 
                    updated: "Today, 8:05 AM", 
                    priority: "Low", 
                    state: "Pending", 
                    description: "Install Microsoft Visio Standard.",
                    created: "2025-01-14 04:15 PM",
                    category: "Software Request",
                    attachments: [],
                    relatedRecords: [],
                    activity: []
                }
            ],
            knowledge: [
                { 
                    number: "KB0001201", 
                    title: "Resetting your VPN credentials", 
                    category: "Network", 
                    updated: "2025-08-20", 
                    views: 214, 
                    state: "Published", 
                    description: "Step-by-step guide to reset VPN credentials and troubleshoot login.",
                    author: "Lisa Brown",
                    attachments: [
                        { name: "vpn_reset_guide.pdf", type: "document", size: "4.2 MB" }
                    ],
                    relatedRecords: ["KB0001198"]
                },
                { 
                    number: "KB0001200", 
                    title: "Fixing printer queue issues", 
                    category: "Hardware", 
                    updated: "2025-08-18", 
                    views: 356, 
                    state: "Published", 
                    description: "How to clear stuck jobs and reset print spooler.",
                    author: "John Smith",
                    attachments: [],
                    relatedRecords: ["INC0010023"]
                },
                { 
                    number: "KB0001199", 
                    title: "Configure email on iOS", 
                    category: "Email", 
                    updated: "2025-08-10", 
                    views: 489, 
                    state: "Draft", 
                    description: "Screenshots and steps for adding corporate email to iPhone/iPad.",
                    author: "IT Support",
                    attachments: [
                        { name: "ios_setup_screenshots.zip", type: "archive", size: "12.3 MB" }
                    ],
                    relatedRecords: []
                }
            ],
            problems: [
                { 
                    number: "PRB0000761", 
                    shortDescription: "Intermittent VPN drops for remote staff", 
                    openedBy: "Lisa Brown", 
                    assignmentGroup: "Network Team", 
                    assignedTo: "Network Queue", 
                    updated: "Today, 11:00 AM", 
                    priority: "High", 
                    state: "Open", 
                    description: "Multiple incidents linked showing frequent VPN disconnections.",
                    created: "2025-01-14 10:00 AM",
                    category: "Network",
                    attachments: [],
                    relatedRecords: ["INC0010021", "INC0010018", "INC0010015"],
                    activity: []
                },
                { 
                    number: "PRB0000760", 
                    shortDescription: "Print server spooler crashes", 
                    openedBy: "IT Ops", 
                    assignmentGroup: "Infrastructure", 
                    assignedTo: "Ian Cole", 
                    updated: "Yesterday, 1:40 PM", 
                    priority: "Critical", 
                    state: "In Progress", 
                    description: "Spooler service crashes under load; root cause under investigation.",
                    created: "2025-01-13 09:15 AM",
                    category: "Infrastructure",
                    attachments: [
                        { name: "spooler_logs.zip", type: "archive", size: "45.2 MB" }
                    ],
                    relatedRecords: ["INC0010023", "INC0010012"],
                    activity: []
                }
            ]
        };

        // ------------------ ENHANCED STATE ------------------
        let currentTab = "incidents";
        let currentView = "list";
        let editedRecord = null;
        let currentFilters = {
            status: [],
            priority: [],
            assignmentGroup: []
        };
        let currentSearch = "";
        let currentSort = { field: null, direction: 'asc' };

        // ------------------ UTIL ------------------
        const el = sel => document.querySelector(sel);
        const els = sel => Array.from(document.querySelectorAll(sel));
        const statusClass = s => `status-${s.toLowerCase().replaceAll(" ", "-")}`;
        const priorityClass = p => `priority-${p.toLowerCase()}`;
        const setGrid = cols => {
            el(":root").style.setProperty("--grid-cols", cols);
        };

        // ------------------ ENHANCED RENDER ------------------
        function init() {
            setupEventListeners();
            renderFilterOptions();
            render();
        }

        function render() {
            // Update active nav
            els(".nav-item").forEach(n => n.classList.toggle("active", n.dataset.tab === currentTab));
            els(".view-button").forEach(b => b.classList.toggle("active", b.dataset.view === currentView));

            // Toolbar hint
            el("#toolbarHint").textContent = currentView === "list"
              ? "Tip: Click a row to view and update details. Use search and filters to find specific records."
              : "Tip: Hover bars for values. Click KPIs and charts to filter records.";

            // Count
            const filteredData = getFilteredData();
            const count = filteredData.length;
            const total = db[currentTab].length;
            el("#ticketsCount").textContent = `${count} of ${total} ${labelFor(currentTab)}`;

            // Views
            el("#listView").style.display = currentView === "list" ? "block" : "none";
            el("#dashboardView").classList.toggle("show", currentView === "dashboard");

            if (currentView === "list") renderList();
            else renderDashboard();
        }

        function getFilteredData() {
            let data = [...db[currentTab]];
            
            // Apply search
            if (currentSearch) {
                const searchLower = currentSearch.toLowerCase();
                data = data.filter(record => {
                    return Object.values(record).some(value => 
                        String(value).toLowerCase().includes(searchLower)
                    );
                });
            }
            
            // Apply filters
            if (currentFilters.status.length > 0) {
                data = data.filter(record => currentFilters.status.includes(record.state));
            }
            if (currentFilters.priority.length > 0) {
                data = data.filter(record => currentFilters.priority.includes(record.priority));
            }
            if (currentFilters.assignmentGroup.length > 0) {
                data = data.filter(record => currentFilters.assignmentGroup.includes(record.assignmentGroup));
            }
            
            // Apply sorting
            if (currentSort.field) {
                data.sort((a, b) => {
                    let aVal = a[currentSort.field];
                    let bVal = b[currentSort.field];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            return data;
        }

        function renderFilterOptions() {
            const statusSet = new Set();
            const prioritySet = new Set();
            const groupSet = new Set();
            
            db[currentTab].forEach(record => {
                if (record.state) statusSet.add(record.state);
                if (record.priority) prioritySet.add(record.priority);
                if (record.assignmentGroup) groupSet.add(record.assignmentGroup);
            });
            
            renderFilterCheckboxes('statusFilters', Array.from(statusSet), 'status');
            renderFilterCheckboxes('priorityFilters', Array.from(prioritySet), 'priority');
            renderFilterCheckboxes('groupFilters', Array.from(groupSet), 'assignmentGroup');
        }
        
        function renderFilterCheckboxes(containerId, options, filterType) {
            const container = el(`#${containerId}`);
            container.innerHTML = options.map(option => `
                <label class="filter-option">
                    <input type="checkbox" value="${option}" data-filter="${filterType}" ${currentFilters[filterType].includes(option) ? 'checked' : ''}>
                    ${option}
                </label>
            `).join('');
        }

        function labelFor(tab) {
            switch(tab) {
                case "incidents": return "tickets";
                case "requests": return "requests";
                case "knowledge": return "articles";
                case "problems": return "problems";
                default: return "items";
            }
        }

        function renderList() {
            const listHeader = el("#listHeader");
            const listBody = el("#listBody");
            listBody.innerHTML = "";

            const filteredData = getFilteredData();

            if (currentTab === "incidents") {
                setGrid("120px minmax(280px,1fr) 160px 160px 160px 140px 120px");
                listHeader.innerHTML = `
                    <div class="sortable-header" data-field="number">Number ${sortIndicator('number')}</div>
                    <div class="sortable-header" data-field="shortDescription">Short description ${sortIndicator('shortDescription')}</div>
                    <div class="sortable-header" data-field="caller">Caller ${sortIndicator('caller')}</div>
                    <div class="sortable-header" data-field="assignmentGroup">Assignment group ${sortIndicator('assignmentGroup')}</div>
                    <div class="sortable-header" data-field="assignedTo">Assigned to ${sortIndicator('assignedTo')}</div>
                    <div class="sortable-header" data-field="updated">Updated ${sortIndicator('updated')}</div>
                    <div class="sortable-header" data-field="priority">Priority ${sortIndicator('priority')}</div>`;
                filteredData.forEach(rec => listBody.appendChild(rowIncident(rec)));
            } else if (currentTab === "requests") {
                setGrid("120px minmax(320px,1fr) 160px 160px 160px 140px 120px");
                listHeader.innerHTML = `
                    <div class="sortable-header" data-field="number">Number ${sortIndicator('number')}</div>
                    <div class="sortable-header" data-field="shortDescription">Short description ${sortIndicator('shortDescription')}</div>
                    <div class="sortable-header" data-field="requester">Requester ${sortIndicator('requester')}</div>
                    <div class="sortable-header" data-field="assignmentGroup">Assignment group ${sortIndicator('assignmentGroup')}</div>
                    <div class="sortable-header" data-field="assignedTo">Assigned to ${sortIndicator('assignedTo')}</div>
                    <div class="sortable-header" data-field="updated">Updated ${sortIndicator('updated')}</div>
                    <div class="sortable-header" data-field="priority">Priority ${sortIndicator('priority')}</div>`;
                filteredData.forEach(rec => listBody.appendChild(rowRequest(rec)));
            } else if (currentTab === "knowledge") {
                setGrid("120px minmax(360px,1fr) 160px 160px 140px 160px");
                listHeader.innerHTML = `
                    <div class="sortable-header" data-field="number">Number ${sortIndicator('number')}</div>
                    <div class="sortable-header" data-field="title">Title ${sortIndicator('title')}</div>
                    <div class="sortable-header" data-field="category">Category ${sortIndicator('category')}</div>
                    <div class="sortable-header" data-field="updated">Updated ${sortIndicator('updated')}</div>
                    <div class="sortable-header" data-field="views">Views ${sortIndicator('views')}</div>
                    <div class="sortable-header" data-field="state">State ${sortIndicator('state')}</div>`;
                filteredData.forEach(rec => listBody.appendChild(rowKnowledge(rec)));
            } else if (currentTab === "problems") {
                setGrid("120px minmax(320px,1fr) 160px 160px 160px 140px 120px");
                listHeader.innerHTML = `
                    <div class="sortable-header" data-field="number">Number ${sortIndicator('number')}</div>
                    <div class="sortable-header" data-field="shortDescription">Short description ${sortIndicator('shortDescription')}</div>
                    <div class="sortable-header" data-field="openedBy">Opened by ${sortIndicator('openedBy')}</div>
                    <div class="sortable-header" data-field="assignmentGroup">Assignment group ${sortIndicator('assignmentGroup')}</div>
                    <div class="sortable-header" data-field="assignedTo">Assigned to ${sortIndicator('assignedTo')}</div>
                    <div class="sortable-header" data-field="updated">Updated ${sortIndicator('updated')}</div>
                    <div class="sortable-header" data-field="priority">Priority ${sortIndicator('priority')}</div>`;
                filteredData.forEach(rec => listBody.appendChild(rowProblem(rec)));
            }

            if (!filteredData.length) {
                listBody.innerHTML = '<div class="empty">No records found. Try adjusting your search or filters.</div>';
            }
        }

        function sortIndicator(field) {
            if (currentSort.field === field) {
                return `<span class="sort-indicator">${currentSort.direction === 'asc' ? '‚Üë' : '‚Üì'}</span>`;
            }
            return '<span class="sort-indicator">‚Üï</span>';
        }

        function rowIncident(ticket) {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `
                <div class="list-cell ticket-number">${ticket.number}</div>
                <div class="list-cell" title="${ticket.shortDescription}">${ticket.shortDescription}</div>
                <div class="list-cell">${ticket.caller}</div>
                <div class="list-cell">${ticket.assignmentGroup}</div>
                <div class="list-cell">${ticket.assignedTo}</div>
                <div class="list-cell">${ticket.updated}</div>
                <div class="list-cell">
                    <div class="priority-badge">
                        <div class="priority-dot ${priorityClass(ticket.priority)}"></div>
                        ${ticket.priority}
                    </div>
                </div>`;
            row.addEventListener('click', () => openModal("incidents", ticket));
            return row;
        }

        function rowRequest(r) {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `
                <div class="list-cell ticket-number">${r.number}</div>
                <div class="list-cell" title="${r.shortDescription}">${r.shortDescription}</div>
                <div class="list-cell">${r.requester}</div>
                <div class="list-cell">${r.assignmentGroup}</div>
                <div class="list-cell">${r.assignedTo}</div>
                <div class="list-cell">${r.updated}</div>
                <div class="list-cell">
                    <div class="priority-badge">
                        <div class="priority-dot ${priorityClass(r.priority)}"></div>
                        ${r.priority}
                    </div>
                </div>`;
            row.addEventListener('click', () => openModal("requests", r));
            return row;
        }

        function rowKnowledge(k) {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `
                <div class="list-cell ticket-number">${k.number}</div>
                <div class="list-cell" title="${k.title}">${k.title}</div>
                <div class="list-cell">${k.category}</div>
                <div class="list-cell">${k.updated}</div>
                <div class="list-cell">${k.views}</div>
                <div class="list-cell"><span class="status-badge ${statusClass(k.state)}">${k.state}</span></div>`;
            row.addEventListener('click', () => openModal("knowledge", k));
            return row;
        }

        function rowProblem(p) {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `
                <div class="list-cell ticket-number">${p.number}</div>
                <div class="list-cell" title="${p.shortDescription}">${p.shortDescription}</div>
                <div class="list-cell">${p.openedBy}</div>
                <div class="list-cell">${p.assignmentGroup}</div>
                <div class="list-cell">${p.assignedTo}</div>
                <div class="list-cell">${p.updated}</div>
                <div class="list-cell">
                    <div class="priority-badge">
                        <div class="priority-dot ${priorityClass(p.priority)}"></div>
                        ${p.priority}
                    </div>
                </div>`;
            row.addEventListener('click', () => openModal("problems", p));
            return row;
        }

        // ------------------ ENHANCED MODAL ------------------
        function openModal(type, record) {
            editedRecord = { type, record };
            el("#modalTitle").textContent = `${record.number || record.title} ‚Äî ${type.charAt(0).toUpperCase()+type.slice(1)}`;

            const fields = [];
            if (type === "incidents" || type === "requests" || type === "problems") {
                fields.push(
                    field("State", select("state", record.state, ["Open","In Progress","Pending","Resolved","Closed"])),
                    field("Priority", select("priority", record.priority, ["Low","Medium","High","Critical"])),
                    field("Assignment Group", input("assignmentGroup", record.assignmentGroup)),
                    field("Assigned To", input("assignedTo", record.assignedTo)),
                    field("Updated", input("updated", record.updated))
                );
                if (type === "incidents") fields.unshift(field("Caller", input("caller", record.caller)));
                if (type === "requests") fields.unshift(field("Requester", input("requester", record.requester)));
                if (type === "problems") fields.unshift(field("Opened By", input("openedBy", record.openedBy)));
                
                // Additional fields
                if (record.created) fields.push(field("Created", `<span>${record.created}</span>`));
                if (record.category) fields.push(field("Category", input("category", record.category)));
                if (record.subcategory) fields.push(field("Subcategory", input("subcategory", record.subcategory)));
            } else if (type === "knowledge") {
                fields.push(
                    field("Title", input("title", record.title)),
                    field("Category", input("category", record.category)),
                    field("State", select("state", record.state, ["Draft","Published"])),
                    field("Updated", input("updated", record.updated)),
                    field("Views", input("views", record.views))
                );
                if (record.author) fields.push(field("Author", input("author", record.author)));
            }

            const descSection = `
                <div class="description-section">
                    <div class="section-title">Description</div>
                    <div class="info-value">
                        <textarea id="descField" rows="5">${record.description || ""}</textarea>
                    </div>
                </div>`;

            // Attachments section
            let attachmentsSection = '';
            if (record.attachments && record.attachments.length > 0) {
                attachmentsSection = `
                    <div class="attachments-section">
                        <div class="section-title">Attachments</div>
                        <div class="attachment-list">
                            ${record.attachments.map(att => `
                                <div class="attachment-item">
                                    <div class="attachment-icon">${getFileIcon(att.type)}</div>
                                    <div class="attachment-name">${att.name}</div>
                                    <div class="attachment-size">${att.size}</div>
                                    <div class="attachment-actions">
                                        <button class="attachment-action">Download</button>
                                        <button class="attachment-action">Remove</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }

            // Related records section
            let relatedSection = '';
            if (record.relatedRecords && record.relatedRecords.length > 0) {
                relatedSection = `
                    <div class="related-records">
                        <div class="related-header">Related Records</div>
                        <div class="related-list">
                            ${record.relatedRecords.map(rel => `
                                <div class="related-item" data-record="${rel}">
                                    ${rel} - ${getRecordTitle(rel)}
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }

            // Activity log section
            let activitySection = '';
            if (record.activity && record.activity.length > 0) {
                activitySection = `
                    <div class="activity-log">
                        <div class="section-title">Activity Log</div>
                        ${record.activity.map(act => `
                            <div class="activity-item">
                                <div class="activity-meta">
                                    <strong>${act.user}</strong> - ${act.timestamp}
                                </div>
                                <div class="activity-text">
                                    <strong>${act.action}:</strong> ${act.details}
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            }

            el("#modalBody").innerHTML = fields.join("") + descSection + attachmentsSection + relatedSection + activitySection;
            el("#recordModal").classList.add("show");
        }

        function getFileIcon(type) {
            const icons = {
                'image': 'üñºÔ∏è',
                'document': 'üìÑ',
                'video': 'üé•',
                'archive': 'üì¶'
            };
            return icons[type] || 'üìé';
        }

        function getRecordTitle(recordNumber) {
            // Simple lookup for demonstration
            for (const tab in db) {
                const record = db[tab].find(r => r.number === recordNumber);
                if (record) {
                    return record.shortDescription || record.title || 'Unknown Record';
                }
            }
            return 'Unknown Record';
        }

        function field(label, controlHtml) {
            return `<div class="info-row"><div class="info-label">${label}:</div><div class="info-value">${controlHtml}</div></div>`;
        }
        function input(name, value) {
            return `<input data-field="${name}" value="${escapeHtml(value ?? "")}"/>`;
        }
        function select(name, value, options) {
            const opts = options.map(o => `<option ${o===value?"selected":""}>${o}</option>`).join("");
            return `<select data-field="${name}">${opts}</select>`;
        }
        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
        }

        function saveModal() {
            if (!editedRecord) return;
            const { type, record } = editedRecord;
            const container = el("#modalBody");
            container.querySelectorAll("[data-field]").forEach(inp => {
                const key = inp.getAttribute("data-field");
                record[key] = inp.value;
            });
            const desc = el("#descField");
            if (desc) record.description = desc.value;

            // Add activity log entry
            if (!record.activity) record.activity = [];
            record.activity.unshift({
                user: "Current User",
                action: "Record updated",
                timestamp: new Date().toLocaleString(),
                details: "Fields modified through the interface"
            });

            // Simple updated stamp
            record.updated = new Date().toLocaleString();

            // Re-render list and dashboard
            render();
            closeModal();
        }

        function closeModal() {
            el("#recordModal").classList.remove("show");
            editedRecord = null;
        }

        // ------------------ ENHANCED DASHBOARD ------------------
        function renderDashboard() {
            const list = getFilteredData();
            
            // KPIs
            const kpiGrid = el("#kpiGrid");
            const totals = {
                total: list.length,
                open: list.filter(r => (r.state||"").startsWith("Open")).length + list.filter(r => (r.state||"") === "Open").length,
                inprog: list.filter(r => (r.state||"") === "In Progress").length,
                pending: list.filter(r => (r.state||"") === "Pending").length,
                resolved: list.filter(r => (r.state||"") === "Resolved").length,
                critical: list.filter(r => (r.priority||"") === "Critical").length
            };
            kpiGrid.innerHTML = `
                <div class="kpi" data-filter="all"><div class="label">Total ${labelFor(currentTab)}</div><div class="value">${totals.total}</div></div>
                <div class="kpi" data-filter="open"><div class="label">Open</div><div class="value">${totals.open}</div></div>
                <div class="kpi" data-filter="inprogress"><div class="label">In Progress</div><div class="value">${totals.inprog}</div></div>
                <div class="kpi" data-filter="pending"><div class="label">Pending</div><div class="value">${totals.pending}</div></div>
                <div class="kpi" data-filter="resolved"><div class="label">Resolved</div><div class="value">${totals.resolved}</div></div>
            `;

            // Charts
            drawBarChart("stateChart", countBy(list, "state"));
            drawBarChart("priorityChart", countBy(list, "priority"));
        }

        function countBy(list, key) {
            const map = {};
            list.forEach(r => {
                const k = (r[key] || "Unknown");
                map[k] = (map[k] || 0) + 1;
            });
            return map;
        }

        function drawBarChart(canvasId, dataMap) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext("2d");
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);
            const w = canvas.width = canvas.clientWidth;
            const h = canvas.height = canvas.clientHeight;
            ctx.clearRect(0,0,w,h);

            // padding
            const pad = 30;
            const maxVal = Math.max(1, ...values);
            const barW = (w - pad*2) / (labels.length || 1) * 0.6;
            const gap = (w - pad*2) / (labels.length || 1) * 0.4;

            // axes
            ctx.strokeStyle = "#d8dbe0";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(pad, h - pad);
            ctx.lineTo(w - pad, h - pad);
            ctx.moveTo(pad, pad);
            ctx.lineTo(pad, h - pad);
            ctx.stroke();

            // bars
            labels.forEach((lab, i) => {
                const x = pad + i * (barW + gap) + gap/2;
                const barH = (h - pad*2) * (values[i] / maxVal);
                const y = h - pad - barH;
                ctx.fillStyle = "#2e51bb";
                ctx.fillRect(x, y, barW, barH);

                // value
                ctx.fillStyle = "#2a3e4c";
                ctx.font = "12px Segoe UI";
                ctx.textAlign = "center";
                ctx.fillText(values[i], x + barW/2, y - 6);

                // label
                ctx.save();
                ctx.translate(x + barW/2, h - pad + 14);
                ctx.rotate(-Math.PI/8);
                ctx.fillStyle = "#6c757d";
                ctx.fillText(lab, 0, 0);
                ctx.restore();
            });
        }

        // ------------------ ENHANCED EVENTS ------------------
        function setupEventListeners() {
            // Modal buttons
            el("#modalClose").addEventListener("click", closeModal);
            el("#closeBtn").addEventListener("click", closeModal);
            el("#saveBtn").addEventListener("click", saveModal);

            // Navigation tabs
            els(".nav-item").forEach(item => {
                item.addEventListener("click", () => {
                    currentTab = item.dataset.tab;
                    currentView = "list";
                    currentFilters = { status: [], priority: [], assignmentGroup: [] };
                    currentSearch = "";
                    currentSort = { field: null, direction: 'asc' };
                    renderFilterOptions();
                    render();
                });
            });

            // View buttons
            els(".view-button").forEach(btn => {
                btn.addEventListener("click", () => {
                    currentView = btn.dataset.view;
                    render();
                });
            });

            // Search functionality
            el("#searchInput").addEventListener("input", (e) => {
                currentSearch = e.target.value;
                render();
            });

            // Filter functionality
            el("#filterButton").addEventListener("click", (e) => {
                e.stopPropagation();
                el("#filterPanel").classList.toggle("show");
            });

            document.addEventListener("click", () => {
                el("#filterPanel").classList.remove("show");
            });

            el("#filterPanel").addEventListener("click", (e) => {
                e.stopPropagation();
            });

            el("#applyFilters").addEventListener("click", () => {
                currentFilters.status = [];
                currentFilters.priority = [];
                currentFilters.assignmentGroup = [];
                
                els('#filterPanel input[type="checkbox"]:checked').forEach(checkbox => {
                    const filterType = checkbox.dataset.filter;
                    currentFilters[filterType].push(checkbox.value);
                });
                
                render();
                el("#filterPanel").classList.remove("show");
            });

            // Sort functionality
            document.addEventListener("click", (e) => {
                if (e.target.closest('.sortable-header')) {
                    const header = e.target.closest('.sortable-header');
                    const field = header.dataset.field;
                    
                    if (currentSort.field === field) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.field = field;
                        currentSort.direction = 'asc';
                    }
                    
                    render();
                }
            });

            // Dashboard interactivity
            document.addEventListener("click", (e) => {
                if (e.target.closest('.kpi')) {
                    const kpi = e.target.closest('.kpi');
                    const filterType = kpi.dataset.filter;
                    // In a real app, this would filter the view
                    alert(`Clicked on ${filterType} KPI - this would filter the records in a real ServiceNow instance`);
                }
                
                if (e.target.closest('.chart-card')) {
                    alert('Clicked on chart - this would provide drill-down capabilities in a real ServiceNow instance');
                }
            });

            // Close modal with escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeModal();
            });

            // Handle resize for crisp canvas
            window.addEventListener("resize", () => {
                if (currentView === "dashboard") renderDashboard();
            });
        }

        // ------------------ START ------------------
        init();
    
        function hookLabControls() {
          const resetBtn = document.querySelector("#resetLab");
          const closeBtn = document.querySelector("#closeLab");

          if (resetBtn) {
            resetBtn.addEventListener("click", () => {
              window.location.reload();
            });
          }

          if (closeBtn) {
            closeBtn.addEventListener("click", () => {
              window.close();
              setTimeout(() => { window.location.href = "about:blank"; }, 300);
            });
          }
        }

        // Initialize lab controls
        hookLabControls();
    </script>
</body>
</html>