<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Windows Lab 7 – Tray Aesthetic Upgrade</title>
<style>
/* ==== Desktop background ==== */
html,body{height:100%;margin:0;font-family:Segoe UI, Roboto, Arial, Helvetica, sans-serif;}
body{background:linear-gradient(120deg,#1976d2,#0d47a1);color:#111;overflow:hidden;}
#desktop{position:absolute;inset:0 0 48px 0;padding:14px;}

/* ==== Icons on desktop ==== */
.desktop-icon{width:80px;text-align:center;color:#fff;cursor:default;user-select:none;}
.desktop-icon img{width:48px;height:48px;display:block;margin:0 auto 6px;}
.desktop-icon .label{font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,.4)}

/* ==== Windows (simulation windows) ==== */
.window{
  position:absolute;background:#fff;border:1px solid #c9c9c9;border-radius:10px;
  box-shadow:0 14px 40px rgba(0,0,0,.35);display:none;flex-direction:column;overflow:hidden;
}
.window-header{
  background:#e9e9e9;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:move;
  border-bottom:1px solid #cfcfcf;user-select:none;
}
.window-title{font-weight:600;flex:1}
.window-controls{display:flex;gap:6px}
.window-control{width:24px;height:24px;border-radius:6px;background:#dcdcdc;display:grid;place-items:center;cursor:pointer}
.window-control:hover{background:#cfcfcf}
.window-body{padding:10px;overflow:auto;background:#fff;flex:1}

/* Computer Management layout */
.layout{display:grid;grid-template-columns:240px 1fr;gap:0;height:100%}
.left-pane{background:#fafafa;border-right:1px solid #e8e8e8;padding:10px}
.tree-item{padding:6px 8px;border-radius:6px;cursor:pointer}
.tree-item:hover{background:#eee}
.right-pane{padding:10px}
.services-table{width:100%;border-collapse:collapse;font-size:14px}
.services-table th,.services-table td{padding:8px;border-bottom:1px solid #e8e8e8;text-align:left}
.services-table tr.selected{background:#e3f2fd}
.btnbar{display:flex;gap:8px;margin-bottom:10px}
button{border:1px solid #c9c9c9;background:#efefef;padding:6px 10px;border-radius:6px;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

/* Context menu */
.context-menu{position:absolute;display:none;background:rgba(30,30,30,0.97);color:#fff;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.4);z-index:400;overflow:hidden;backdrop-filter:blur(16px);min-width:220px;}
.context-menu-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;color:white;font-size:14px;transition:all .2s ease;border-bottom:1px solid rgba(255,255,255,0.05);user-select:none;}
.context-menu-item:last-child{border-bottom:none;}
.context-menu-item:hover{background:rgba(255,255,255,0.08);}

/* Toast */
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:500}

/* ==== Taskbar + refined tray ==== */
.taskbar {
  position: absolute; bottom: 0; width: 100%; height: 48px;
  background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px);
  display: flex; align-items: center; padding: 0 12px; z-index: 100;
  border-top: 1px solid rgba(255,255,255,0.1);
}
.start-button {
  color: white; font-weight: 600; display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 8px; transition: all 0.2s ease; font-size: 14px;
  background: rgba(255,255,255,0.22); border: 1px solid rgba(255,255,255,0.35); cursor:pointer;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
}
.start-button:hover { background-color: rgba(255,255,255,0.32); border-color: rgba(255,255,255,0.5); }
.windows-logo { width: 20px; height: 20px; margin-right: 2px; display:inline-block; }

/* Pinned apps (left of tray) */
.taskbar-icons { display: flex; gap: 8px; margin-left: 10px; }
.taskbar-icon { cursor: pointer; padding: 8px; width: 40px; height: 32px; display:flex; align-items:center; justify-content:center; user-select:none; color:#fff; border-radius:6px; }
.taskbar-icon:hover { background-color: rgba(255,255,255,0.1); }

/* === Refined System Tray (Time/Date only) === */
.system-tray { display: flex; align-items: center; color: white; font-size: 13px; padding: 0 6px; white-space: nowrap; gap: 6px; margin-left:auto; }
.tray-chip {
  display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 10px;
  background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2);
  border-radius:10px; cursor:pointer; user-select:none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);
  transition: transform .12s ease, background .15s ease, border-color .15s ease;
}
.tray-chip:hover { background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.35); transform: translateY(-1px); }

/* Time/date compact chip */
.tray-time { min-width: 92px; justify-content:center; font-variant-numeric: tabular-nums; }

/* Start Menu */
.start-menu {
  position: absolute;
  bottom: 52px;
  left: 12px;
  width: 520px;
  height: 360px;
  background: rgba(30,30,30,0.97);
  color: white;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
  backdrop-filter: blur(16px);
  display: none;
  overflow: hidden;
  z-index: 200;
}

.start-menu-header {
  padding: 16px 20px;
  background: rgba(255,255,255,0.06);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-weight: 600;
  font-size: 16px;
}

.start-menu-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  height: calc(100% - 60px);
}

.start-menu-left {
  padding: 16px;
  background: rgba(255,255,255,0.02);
  border-right: 1px solid rgba(255,255,255,0.08);
}

.start-menu-right {
  padding: 16px;
}

.app-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
  margin-bottom: 8px;
}

.app-item:hover {
  background: rgba(255,255,255,0.08);
}

.app-item .icon {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  background: #0078d4;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.instructions-icon {
  background: linear-gradient(45deg, #ff6b35, #f7931e) !important;
}

.app-list {
  max-height: 100%;
  overflow-y: auto;
}

/* Popovers */
.tray-popover {
  position: absolute; display: none; min-width: 300px;
  background: rgba(30,30,30,0.97); color: white;
  border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4); z-index: 400; overflow: hidden; backdrop-filter: blur(16px);
}
.tray-popover .pop-header { padding: 12px 16px; background: rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 13px; }
.tray-popover .pop-body { padding: 14px 16px; font-size: 13px; max-height: 380px; overflow:auto; }
.row { display:flex; align-items:center; gap:10px; }
.muted { opacity:0.85; }

/* Calendar styling */
.calendar{ width:100%; user-select:none; }
.calendar .big-clock{ font-size:28px; font-weight:700; margin-bottom:6px; }
.calendar .small-date{ opacity:.9; margin-bottom:10px; }
.calendar .cal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.calendar .month{ font-weight:600; }
.calendar .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px; }
.calendar .dow{ text-align:center; opacity:.8; padding:4px 0; }
.calendar .day{ text-align:center; padding:6px 0; border-radius:6px; }
.calendar .day.today{ background:#1976d2; color:#fff; }
.calendar .day.other{ opacity:.35; }
</style>
</head>
<body>
  <div id="desktop">
    <!-- Desktop icon -->
    <div class="desktop-icon" id="thisPcIcon">
      <img alt="This PC" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='48' height='48'><rect width='46' height='34' x='1' y='4' rx='6' ry='6' fill='%23ffffff' stroke='%23000' stroke-width='0.5'/><rect x='8' y='40' width='32' height='4' fill='%23ffffff' stroke='%23000' stroke-width='0.5'/></svg>"/>
      <div class="label">This PC</div>
    </div>

    <!-- Instructions window -->
    <div class="window" id="instructionsWindow" style="left:20px;top:20px;width:420px;height:340px;display:flex;">
      <div class="window-header">
        <div class="window-title">Lab 7: Restart Print Spooler – Instructions</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">−</div>
          <div class="window-control" data-maximize title="Maximize">⬜</div>
          <div class="window-control" data-close title="Close">✕</div>
        </div>
      </div>
      <div class="window-body">
        <ol>
          <li>Right-click <strong>This PC</strong> and choose <strong>Manage</strong>.</li>
          <li>Open <strong>Services</strong> and select <strong>Print Spooler</strong>.</li>
          <li>Click <strong>Restart</strong> to stop and start the service.</li>
          <li>Observe status changes and the success message.</li>
          <li>Use <strong>Reset Lab</strong> to restore the initial state.</li>
        </ol>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="resetLab">Reset Lab</button>
          <button id="closeBrowser">Close Lab</button>
        </div>
      </div>
    </div>

    <!-- Computer Management -->
    <div class="window" id="compMgmt" style="left:260px;top:90px;width:760px;height:500px;">
      <div class="window-header">
        <div class="window-title">Computer Management</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">−</div>
          <div class="window-control" data-maximize title="Maximize">⬜</div>
          <div class="window-control" data-close title="Close">✕</div>
        </div>
      </div>
      <div class="window-body">
        <div class="layout">
          <div class="left-pane">
            <div class="tree-item" id="servicesNode">Services</div>
            <div id="servicesChildren" style="display:none;padding-left:10px">
              <div class="tree-item" id="servicesChild">Services (Local)</div>
            </div>
          </div>
          <div class="right-pane">
            <div id="panelBlank">
              <p>Select <strong>Services</strong> to view available services.</p>
            </div>
            <div id="panelServices" style="display:none">
              <div class="btnbar">
                <button id="btnStart" disabled>Start</button>
                <button id="btnStop" disabled>Stop</button>
                <button id="btnRestart" disabled>Restart</button>
              </div>
              <table class="services-table">
                <thead>
                  <tr><th>Name</th><th>Description</th><th>Status</th></tr>
                </thead>
                <tbody>
                  <tr data-svc="spooler"><td>Print Spooler</td><td>Loads files to memory for printing</td><td class="status">Running</td></tr>
                  <tr data-svc="wuauserv"><td>Windows Update</td><td>Enables detection and install of updates</td><td class="status">Running</td></tr>
                  <tr data-svc="bits"><td>Background Intelligent Transfer</td><td>Transfers files in the background</td><td class="status">Stopped</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context menu (right-click This PC) -->
    <div class="context-menu" id="pcContext">
      <div class="context-menu-item" data-action="manage">Manage</div>
      <div class="context-menu-item">Open</div>
      <div class="context-menu-item">Pin to Start</div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start-button" id="startButton" title="Start">
      <span class="windows-logo">
        <!-- 4 blue squares -->
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="1" y="11" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="11" width="8" height="8" fill="#00BCF9"/>
        </svg>
      </span>
      Start
    </div>

    <!-- Empty taskbar icons area -->
    <div class="taskbar-icons">
    </div>

    <!-- Refined System Tray: Time/Date only -->
    <div class="system-tray" id="systemTray">
      <div class="tray-chip tray-time" id="trayTimeChip" title="Date and time">
        <span id="trayTime">--:--</span>
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">Start</div>
    <div class="start-menu-body">
      <div class="start-menu-left">
        <div class="app-item" data-app="instructions">
          <div class="icon instructions-icon">📋</div>
          <span>Instructions</span>
        </div>
      </div>
      <div class="start-menu-right">
        <div class="app-list">
          <div class="app-item" data-app="openCompMgmt">
            <div class="icon">⚙️</div>
            <span>Computer Management</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
/* ===== Utilities ===== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

/* ===== DOM Elements ===== */
const startButton = $('#startButton');
const startMenu = $('#startMenu');
const thisPcIcon = $('#thisPcIcon');
const pcContext = $('#pcContext');
const compWin = $('#compMgmt');
const instructionsWindow = $('#instructionsWindow');
const resetLab = $('#resetLab');
const closeBrowser = $('#closeBrowser');
const toast = $('#toast');
const desktop = $('#desktop');

/* ===== Start menu behavior ===== */
startButton.addEventListener('click', (e) => {
  e.stopPropagation();
  startMenu.style.display = (startMenu.style.display === 'block') ? 'none' : 'block';
  pcContext.style.display = 'none';
});
startButton.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); startMenu.style.display = 'none'; });
document.addEventListener('click', (e) => {
  if (!startMenu.contains(e.target) && e.target !== startButton) startMenu.style.display = 'none';
  if (!pcContext.contains(e.target)) pcContext.style.display = 'none';
});

/* ===== CompMgmt window ===== */
function openCompMgmt() {
  document.querySelectorAll('.window').forEach(w => { if (w.id !== 'instructionsWindow') w.style.display='none'; });
  compWin.style.display = 'flex';
  $('#servicesChildren').style.display = 'none';
  $('#panelBlank').style.display = 'block';
  $('#panelServices').style.display = 'none';
}
$('#servicesNode')?.addEventListener('click', () => { $('#servicesChildren').style.display = 'block'; });
$('#servicesChild')?.addEventListener('click', () => { $('#panelBlank').style.display = 'none'; $('#panelServices').style.display = 'block'; });

/* Start menu apps */
$$('.app-item').forEach(el => {
  el.addEventListener('click', () => {
    const app = el.dataset.app;
    startMenu.style.display = 'none';
    if (app === 'openCompMgmt') openCompMgmt();
    if (app === 'instructions') { instructionsWindow.style.display = 'flex'; }
  });
});

/* ===== Services table selection/actions ===== */
$$('.services-table tbody tr').forEach(row => {
  row.addEventListener('click', () => {
    $$('.services-table tbody tr').forEach(r => r.classList.remove('selected'));
    row.classList.add('selected');
    const status = (row.querySelector('.status')||row.children[2]).textContent.trim();
    $('#btnStart').disabled   = status !== 'Stopped';
    $('#btnStop').disabled    = status !== 'Running';
    $('#btnRestart').disabled = row.dataset.svc !== 'spooler';
  });
});

function setServiceStatus(row, st){
  (row.querySelector('.status')||row.children[2]).textContent = st;
  $('#btnStart').disabled   = st === 'Running' || st.endsWith('...');
  $('#btnStop').disabled    = st === 'Stopped' || st.endsWith('...');
  $('#btnRestart').disabled = row.dataset.svc !== 'spooler' || st.endsWith('...');
}

function simulateAction(row, seq, finalSt, toastMsg){
  let i=0; const step=()=>{ setServiceStatus(row, seq[i]); i++; if(i<seq.length){ setTimeout(step, 700);} else{ flashToast(toastMsg);} };
  step(); setTimeout(()=>setServiceStatus(row, finalSt), 700*seq.length);
}

$('#btnStart')?.addEventListener('click', ()=>{
  const row = document.querySelector('.services-table tbody tr.selected'); if(!row) return;
  simulateAction(row, ['Starting...','Running'], 'Running', 'Service started');
});
$('#btnStop')?.addEventListener('click', ()=>{
  const row = document.querySelector('.services-table tbody tr.selected'); if(!row) return;
  simulateAction(row, ['Stopping...','Stopped'], 'Stopped', 'Service stopped');
});
$('#btnRestart')?.addEventListener('click', ()=>{
  const row = document.querySelector('.services-table tbody tr.selected'); if(!row||row.dataset.svc!=='spooler') return;
  simulateAction(row, ['Stopping...','Stopped','Starting...','Running'], 'Running', 'Print Spooler restarted');
});

/* ===== Reset and Close Lab buttons ===== */
resetLab.addEventListener('click', () => {
  // Reset service statuses and selection
  const spoolerRow = document.querySelector('tr[data-svc="spooler"]');
  const wuauservRow = document.querySelector('tr[data-svc="wuauserv"]');
  const bitsRow = document.querySelector('tr[data-svc="bits"]');
  
  if (spoolerRow) setServiceStatus(spoolerRow, 'Running');
  if (wuauservRow) setServiceStatus(wuauservRow, 'Running');
  if (bitsRow) setServiceStatus(bitsRow, 'Stopped');
  
  $$('.services-table tbody tr').forEach(r => r.classList.remove('selected'));
  $('#btnStart').disabled = true;
  $('#btnStop').disabled = true;
  $('#btnRestart').disabled = true;

  // Collapse Computer Management view to initial state
  $('#servicesChildren').style.display = 'none';
  $('#panelBlank').style.display = 'block';
  $('#panelServices').style.display = 'none';

  // Close Computer Management window and menus
  compWin.style.display = 'none';
  startMenu.style.display = 'none';
  pcContext.style.display = 'none';

  // Restore instructions window to its initial position/size/visibility
  instructionsWindow.style.display = 'flex';
  instructionsWindow.style.width = '420px';
  instructionsWindow.style.height = '340px';
  instructionsWindow.style.left = '20px';
  instructionsWindow.style.top = '20px';
  
  flashToast('Lab reset to initial state');
});

closeBrowser.addEventListener('click', () => {
  flashToast('Closing lab...');
  // Try to close the browser tab/window
  window.close();
  // Fallback redirect if blocked
  setTimeout(() => {
    window.location.href = 'about:blank';
  }, 300);
});

/* ===== Context menu for This PC ===== */
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
thisPcIcon.addEventListener('contextmenu', (e) => {
  e.preventDefault(); e.stopPropagation();
  const deskRect = desktop.getBoundingClientRect();
  const menuW = 220, menuH = 160, taskbarH = 48, margin = 8;
  let x = e.clientX - deskRect.left;
  let y = e.clientY - deskRect.top;
  x = clamp(x, margin, desktop.clientWidth - menuW - margin);
  y = clamp(y, margin, desktop.clientHeight - taskbarH - menuH - margin);
  pcContext.style.left = x + 'px';
  pcContext.style.top = y + 'px';
  pcContext.style.display = 'block';
});
pcContext.addEventListener('click', (e) => {
  const act = e.target.closest('.context-menu-item')?.dataset.action;
  if (!act) return;
  pcContext.style.display = 'none';
  if (act === 'manage') openCompMgmt();
});

/* ===== Window controls & dragging ===== */
document.querySelectorAll('[data-close]').forEach(btn => {
  btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.window').style.display='none'; });
});
document.querySelectorAll('[data-minimize]').forEach(btn => {
  btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.window').style.display='none'; });
});
document.querySelectorAll('[data-maximize]').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const w = btn.closest('.window');
    if (w.style.width === '100%') {
      if (w.id === 'instructionsWindow') { w.style.width='420px'; w.style.height='340px'; w.style.top='20px'; w.style.left='20px'; }
      else { w.style.width='760px'; w.style.height='500px'; w.style.top='90px'; w.style.left='260px'; }
    } else { w.style.width='100%'; w.style.height='calc(100% - 48px)'; w.style.top='0'; w.style.left='0'; }
  });
});
let dragWin=null, sx=0, sy=0, ix=0, iy=0, dragging=false;
document.querySelectorAll('.window-header').forEach(h => {
  h.addEventListener('mousedown', e => {
    if (e.target.closest('.window-control')) return;
    e.preventDefault();
    dragWin = h.closest('.window'); dragging=true;
    sx=e.clientX; sy=e.clientY;
    ix=parseInt(dragWin.style.left || getComputedStyle(dragWin).left);
    iy=parseInt(dragWin.style.top  || getComputedStyle(dragWin).top);
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
  });
});
function onDrag(e){ if(!dragging||!dragWin) return; dragWin.style.left=(ix + (e.clientX-sx))+'px'; dragWin.style.top=(iy + (e.clientY-sy))+'px'; }
function stopDrag(){ dragging=false; dragWin=null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }

/* ===== Refined Tray: Time ===== */
const systemTray = document.getElementById('systemTray');
const trayTimeChip = document.getElementById('trayTimeChip');

// Popover factory
function makePopover(html){
  const el = document.createElement('div'); el.className='tray-popover'; el.innerHTML=html; document.body.appendChild(el); return el;
}
function togglePopover(popover, anchor){
  const r = anchor.getBoundingClientRect();
  popover.style.right  = (window.innerWidth - r.right) + 'px';
  popover.style.bottom = (window.innerHeight - r.top + 8) + 'px';
  const open = popover.style.display==='block';
  document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  if(!open) popover.style.display='block';
}

// Time / Calendar
const timePopover = makePopover(`
  <div class="pop-header">Date & time</div>
  <div class="pop-body">
    <div class="calendar">
      <div class="big-clock" id="bigClock">--:--</div>
      <div class="small-date" id="smallDate">-- ---, ----</div>
      <div class="cal-header">
        <span id="prevMonth" style="cursor:pointer">‹</span>
        <span class="month" id="monthLabel">Month Year</span>
        <span id="nextMonth" style="cursor:pointer">›</span>
      </div>
      <div class="grid" id="calGrid">
        <div class="dow">Su</div><div class="dow">Mo</div><div class="dow">Tu</div>
        <div class="dow">We</div><div class="dow">Th</div><div class="dow">Fr</div><div class="dow">Sa</div>
      </div>
    </div>
  </div>
`);

trayTimeChip.addEventListener('click', (e)=>{
  e.stopPropagation();
  updateClockAndDate();
  ensureCalendarRendered();
  togglePopover(timePopover, trayTimeChip);
});

// Click-away hide
document.addEventListener('click', (e)=>{
  if (!systemTray.contains(e.target) && !e.target.closest('.tray-popover')) {
    document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  }
});
document.querySelectorAll('.tray-popover').forEach(p => p.addEventListener('click', e => e.stopPropagation()));

/* ===== Tray time format (HH:MM) + UK-style compact date in popover ===== */
function updateTrayTime(){
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  document.getElementById('trayTime').textContent = `${hh}:${mm}`;
}
updateTrayTime(); setInterval(updateTrayTime, 30000);

function updateClockAndDate(){
  const now = new Date();
  const hh = now.getHours().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  document.getElementById('bigClock').textContent = `${hh}:${mm}`;
  const opts = { weekday:'short', day:'2-digit', month:'short', year:'numeric' };
  document.getElementById('smallDate').textContent = now.toLocaleDateString(undefined, opts);
}

/* ===== Calendar renderer ===== */
let calRef = new Date(); // current month
function ensureCalendarRendered(){ renderCalendar(calRef); }
function renderCalendar(refDate){
  const monthLabel = document.getElementById('monthLabel');
  const grid = document.getElementById('calGrid');
  Array.from(grid.querySelectorAll('.day')).forEach(d=>d.remove());

  const y = refDate.getFullYear(), m = refDate.getMonth();
  monthLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, {month:'long', year:'numeric'});

  const first = new Date(y, m, 1), startDow = first.getDay();
  const daysIn = new Date(y, m+1, 0).getDate();
  const prevDays = new Date(y, m, 0).getDate();

  for(let i=startDow-1;i>=0;i--){ const el=document.createElement('div'); el.className='day other'; el.textContent=(prevDays - i); grid.appendChild(el); }
  const today = new Date(); const highlight = (today.getFullYear()===y && today.getMonth()===m) ? today.getDate() : -1;
  for(let d=1; d<=daysIn; d++){ const el=document.createElement('div'); el.className='day'; el.textContent=d; if(d===highlight) el.classList.add('today'); grid.appendChild(el); }
  const totalCells = grid.querySelectorAll('.dow').length + grid.querySelectorAll('.day').length;
  const rem = totalCells % 7; if(rem!==0){ const need=7-rem; for(let d=1; d<=need; d++){ const el=document.createElement('div'); el.className='day other'; el.textContent=d; grid.appendChild(el); } }
}
document.addEventListener('click', (e)=>{
  if (e.target.id==='prevMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1); ensureCalendarRendered(); }
  if (e.target.id==='nextMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1); ensureCalendarRendered(); }
});

/* ===== Initial window visibility ===== */
instructionsWindow.style.display='flex';
instructionsWindow.style.left='20px'; instructionsWindow.style.top='20px';
});

/* ===== Toast helper ===== */
function flashToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{ t.style.display='none'; }, 2200); }
</script>
</body>
</html>
