<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lab 21: Exchange Admin Center ‚Äî Send As</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ms: {
              brand: '#0078d4',
              brandDark: '#106ebe',
              canvas: '#f3f2f1',
              text: '#323130',
              sub: '#605e5c',
              line: '#edebe9',
              tableHover: '#faf9f8',
              badgeBg: '#eef2f8',
              badgeText: '#004e8c',
              successBg: '#dff6dd',
              successText: '#107c10',
              errorBg: '#fde7e9',
              errorText: '#a80000',
              warningBg: '#fff4ce',
              warningText: '#8a5500'
            }
          },
          boxShadow: {
            ms: '0 1.6px 3.6px 0 rgba(0,0,0,.132),0 0.3px 0.9px 0 rgba(0,0,0,.108)',
          },
          fontFamily: {
            ui: ["Segoe UI", "Tahoma", "Geneva", "Verdana", "sans-serif"]
          }
        }
      }
    }
  </script>
  <style>
    html, body { height: 100%; }
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; color:#323130; background:#f3f2f1; }
    .focus-ring:focus { outline: 3px solid #aad7ff; outline-offset: 2px; }
    .loading { opacity: 0.6; pointer-events: none; }
    .powershell { font-family: "Cascadia Code", "Consolas", monospace; background: #012456; color: #ffffff; }
  </style>
</head>
<body class="bg-ms-canvas">

  <!-- ===================== -->
  <!-- SIGN-IN SCREEN -->
  <!-- ===================== -->
  <section id="loginScreen" class="min-h-screen flex items-center justify-center px-4">
    <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-[260px,1fr] bg-white shadow-ms rounded-md overflow-hidden">
      <!-- Left rail (brand) -->
      <div class="bg-ms-brand text-white p-8 flex flex-col items-start justify-between">
        <div class="space-y-6">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded bg-white/10 flex items-center justify-center text-white font-semibold">O</div>
            <div class="text-lg font-semibold">Outlook</div>
          </div>
          <div>
            <div class="text-2xl font-semibold leading-tight">Exchange Admin Center</div>
            <p class="mt-2 text-white/90">Sign in to manage blockshell.app mailboxes.</p>
          </div>
        </div>
        <div class="text-xs text-white/80">¬© blockshell.app</div>
      </div>

      <!-- Form -->
      <div class="p-8">
        <h1 class="text-2xl font-semibold mb-6">Exchange Admin Center</h1>

        <div class="space-y-5">
          <label class="block">
            <span class="block text-sm font-semibold mb-1">Domain\user name</span>
            <input id="loginUser" class="w-full border border-ms-line rounded px-3 py-2 focus-ring"
                   placeholder="blockshell\administrator" value="blockshell\administrator" autocomplete="off">
          </label>

          <label class="block">
            <span class="block text-sm font-semibold mb-1">Password</span>
            <input id="loginPass" type="password" class="w-full border border-ms-line rounded px-3 py-2 focus-ring"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="P@ssw0rd!" autocomplete="off">
          </label>

          <div class="flex items-center gap-3">
            <button id="loginBtn"
                    class="inline-flex items-center justify-center px-4 py-2 rounded bg-ms-brand text-white hover:bg-ms-brandDark focus-ring">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M3 4a1 1 0 011-1h6a1 1 0 110 2H5v10h5a1 1 0 110 2H4a1 1 0 01-1-1V4z"/><path d="M13.293 9.293a1 1 0 011.414 0L18 12.586l-3.293 3.293a1 1 0 01-1.414-1.414L14.586 13H9a1 1 0 110-2h5.586l-1.293-1.293a1 1 0 010-1.414z"/></svg>
              Sign in
            </button>

            <button id="loginResetBtn"
                    class="px-4 py-2 rounded border border-ms-line hover:bg-ms-canvas focus-ring">
              Reset form
            </button>
          </div>

          <p id="loginHint" class="text-sm text-ms-sub">Hint: use <span class="font-semibold">blockshell\\administrator</span> and any password.</p>
          <p id="loginError" class="hidden text-sm text-red-600">Sign-in failed. Try again.</p>
        </div>

        <!-- Mini instructions (pre-login) -->
        <div class="mt-8 p-4 bg-ms-tableHover border border-ms-line rounded">
          <div class="font-semibold mb-2">Lab Goal</div>
          <ul class="list-disc ml-5 text-sm leading-6">
            <li>Sign in to the Exchange Admin Center (simulated).</li>
            <li>Open <strong>Recipients ‚Üí Mailboxes</strong> and select a shared mailbox.</li>
            <li>Grant <strong>Send As</strong> permission and verify the update.</li>
            <li>Learn PowerShell equivalents for real-world administration.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== -->
  <!-- EAC APP (POST LOGIN) -->
  <!-- ===================== -->
  <section id="app" class="hidden min-h-screen">
    <!-- Top header -->
    <header class="bg-ms-brand text-white px-5 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="font-semibold">Exchange admin center</div>
        <span class="text-white/90 hidden sm:inline">|</span>
        <span class="text-white/90 hidden sm:inline text-sm">blockshell.app</span>
      </div>
      <div class="flex items-center space-x-2">
        <button id="showPowerShellBtn" class="text-sm px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 focus-ring">PowerShell</button>
        <button id="resetBtnHeader" class="text-sm px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 focus-ring">Reset lab</button>
        <button id="closeBtnHeader" class="text-sm px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 focus-ring">Close lab</button>
        <span class="text-sm hidden sm:block ml-2">Admin User</span>
        <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center text-sm font-semibold">AU</div>
      </div>
    </header>

    <div class="grid grid-cols-[240px,1fr]">
      <!-- Left nav -->
      <aside class="bg-white h-[calc(100vh-48px)] shadow-[1px_0_5px_rgba(0,0,0,0.08)]">
        <nav class="py-2">
          <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Dashboard</a>
          <div class="mt-2">
            <div class="px-4 py-2 text-xs uppercase tracking-wide text-ms-sub">Recipients</div>
            <a class="block px-4 py-2 text-sm bg-ms-canvas border-l-4 border-ms-brand">Mailboxes</a>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Groups</a>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Resources</a>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Contacts</a>
          </div>
          <div class="mt-2">
            <div class="px-4 py-2 text-xs uppercase tracking-wide text-ms-sub">Mail flow</div>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Rules</a>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Message trace</a>
          </div>
          <div class="mt-2">
            <div class="px-4 py-2 text-xs uppercase tracking-wide text-ms-sub">Organization</div>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Sharing</a>
            <a class="block px-4 py-2 text-sm hover:bg-ms-canvas">Add-ins</a>
          </div>
        </nav>
      </aside>

      <!-- Main -->
      <main class="p-5">
        <div class="text-sm text-ms-sub mb-3">Home &gt; Recipients &gt; Mailboxes</div>

        <!-- Search and filters -->
        <div class="bg-white shadow-ms rounded p-4 mb-4">
          <div class="flex flex-wrap gap-4 items-center">
            <div class="flex-1 min-w-[300px]">
              <input type="text" id="searchMailboxes" placeholder="Search mailboxes..." class="w-full border border-ms-line rounded px-3 py-2 focus-ring">
            </div>
            <select id="mailboxTypeFilter" class="border border-ms-line rounded px-3 py-2 focus-ring">
              <option value="all">All mailbox types</option>
              <option value="shared">Shared mailboxes</option>
              <option value="user">User mailboxes</option>
              <option value="room">Room mailboxes</option>
            </select>
            <button id="refreshBtn" class="px-4 py-2 rounded border border-ms-line hover:bg-ms-canvas focus-ring">Refresh</button>
          </div>
        </div>

        <!-- Toasts -->
        <div id="toast" class="hidden mb-4 rounded border border-green-200 bg-ms-successBg text-ms-successText px-4 py-3" aria-live="polite">
          <span id="toastText" class="font-semibold"></span>
        </div>
        <div id="toastError" class="hidden mb-4 rounded border border-red-200 bg-ms-errorBg text-ms-errorText px-4 py-3" aria-live="polite">
          <span id="toastErrorText" class="font-semibold"></span>
        </div>
        <div id="toastWarning" class="hidden mb-4 rounded border border-yellow-200 bg-ms-warningBg text-ms-warningText px-4 py-3" aria-live="polite">
          <span id="toastWarningText" class="font-semibold"></span>
        </div>

        <!-- Instructions panel -->
        <div class="bg-white shadow-ms rounded p-4 mb-4">
          <div class="font-semibold text-lg mb-1">Lab Instructions ‚Äî Grant "Send As" Permission</div>
          <ol class="list-decimal ml-5 text-sm leading-7">
            <li>Select a shared mailbox (e.g., <strong>Support Team</strong>).</li>
            <li>Click <strong>Manage permissions</strong>.</li>
            <li>Choose a user and tick <strong>Send As</strong> (optionally Full Access / Send on Behalf).</li>
            <li>Click <strong>Add</strong>. Confirm the success banner and see counts update in the table.</li>
            <li>Use the <strong>PowerShell</strong> button to see equivalent Exchange Online commands.</li>
          </ol>
        </div>

        <!-- Mailbox table -->
        <div class="bg-white shadow-ms rounded overflow-hidden">
          <div class="px-4 py-3 border-b border-ms-line font-semibold flex justify-between items-center">
            <span>Mailboxes</span>
            <span id="mailboxCount" class="text-sm font-normal text-ms-sub">3 mailboxes</span>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead class="bg-ms-canvas text-sm">
                <tr>
                  <th class="px-4 py-2">Display name</th>
                  <th class="px-4 py-2">Email address</th>
                  <th class="px-4 py-2">Type</th>
                  <th class="px-4 py-2">Permissions</th>
                  <th class="px-4 py-2">Actions</th>
                </tr>
              </thead>
              <tbody id="mailboxTable" class="text-sm">
                <!-- Mailboxes will be populated dynamically -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- PowerShell Modal -->
        <div id="powershellModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/30" onclick="closePowerShellModal()"></div>
          <div class="relative z-10 w-full max-w-4xl bg-black rounded shadow-ms max-h-[85vh] overflow-hidden powershell">
            <div class="px-5 py-4 border-b border-gray-700 flex items-center justify-between">
              <div class="font-semibold text-white">Exchange Online PowerShell</div>
              <button class="text-sm px-3 py-1.5 rounded border border-gray-600 hover:bg-gray-800 text-white" onclick="closePowerShellModal()">Close</button>
            </div>
            <div class="p-5 overflow-auto">
              <div class="mb-4">
                <div class="text-green-400 mb-2"># Connect to Exchange Online</div>
                <div class="text-gray-300 ml-4">Connect-ExchangeOnline -UserPrincipalName admin@blockshell.app</div>
              </div>
              <div class="mb-4">
                <div class="text-green-400 mb-2"># Get current Send As permissions for a mailbox</div>
                <div class="text-gray-300 ml-4" id="psGetPermissions">Get-RecipientPermission "support@blockshell.app" | Where-Object {$_.AccessRights -contains "SendAs"}</div>
              </div>
              <div class="mb-4">
                <div class="text-green-400 mb-2"># Add Send As permission</div>
                <div class="text-gray-300 ml-4" id="psAddPermission">Add-RecipientPermission "support@blockshell.app" -AccessRights "SendAs" -Trustee "user@blockshell.app"</div>
              </div>
              <div class="mb-4">
                <div class="text-green-400 mb-2"># Remove Send As permission</div>
                <div class="text-gray-300 ml-4" id="psRemovePermission">Remove-RecipientPermission "support@blockshell.app" -AccessRights "SendAs" -Trustee "user@blockshell.app" -Confirm:$false</div>
              </div>
              <div class="mt-6 p-4 bg-gray-800 rounded">
                <div class="text-yellow-400 mb-2">üí° Real-world considerations:</div>
                <ul class="text-gray-300 text-sm list-disc ml-5 space-y-1">
                  <li>Permissions may take 15-60 minutes to propagate in production</li>
                  <li>Use <code class="text-blue-300">Get-Mailbox</code> to verify mailbox existence first</li>
                  <li>Consider using security groups for permission management at scale</li>
                  <li>Always test permissions with <code class="text-blue-300">Send-As</code> verification tools</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Permissions Modal -->
        <div id="permissionModal" class="hidden fixed inset-0 z-40 flex items-center justify-center p-4">
          <div class="absolute inset-0 bg-black/30" onclick="closeModal()"></div>
          <div class="relative z-10 w-full max-w-5xl bg-white rounded shadow-ms max-h-[85vh] overflow-auto">
            <div class="px-5 py-4 border-b border-ms-line flex items-center justify-between">
              <div class="font-semibold" id="modalTitle">Manage permissions</div>
              <button class="text-sm px-3 py-1.5 rounded border border-ms-line hover:bg-ms-canvas" onclick="closeModal()">Close</button>
            </div>

            <div class="p-5 grid gap-5 md:grid-cols-2">
              <div class="space-y-4">
                <div id="modalMsg" class="hidden px-3 py-2 rounded border border-red-200 bg-ms-errorBg text-ms-errorText text-sm"></div>

                <label class="block">
                  <span class="block text-sm font-semibold mb-1">Add permissions</span>
                  <select id="userSelect" class="w-full border border-ms-line rounded px-3 py-2">
                    <option value="">Select a user‚Ä¶</option>
                    <option value="jdoe@blockshell.app">John Doe (jdoe@blockshell.app) - Sales</option>
                    <option value="asmith@blockshell.app">Alice Smith (asmith@blockshell.app) - IT</option>
                    <option value="bjohnson@blockshell.app">Bob Johnson (bjohnson@blockshell.app) - HR</option>
                    <option value="mwilson@blockshell.app">Mary Wilson (mwilson@blockshell.app) - Support</option>
                    <option value="kwong@blockshell.app">Kevin Wong (kwong@blockshell.app) - Engineering</option>
                    <option value="lchen@blockshell.app">Lisa Chen (lchen@blockshell.app) - Marketing</option>
                  </select>
                </label>

                <div>
                  <div class="text-sm font-semibold mb-2">Permission type</div>
                  <label class="flex items-center space-x-2 mb-2">
                    <input id="fullAccess" type="checkbox" class="h-4 w-4">
                    <span class="text-sm">Full Access ‚Äî open the mailbox and view contents</span>
                  </label>
                  <label class="flex items-center space-x-2 mb-2">
                    <input id="sendAs" type="checkbox" class="h-4 w-4">
                    <span class="text-sm">Send As ‚Äî send messages as this mailbox</span>
                  </label>
                  <label class="flex items-center space-x-2">
                    <input id="sendOnBehalf" type="checkbox" class="h-4 w-4">
                    <span class="text-sm">Send on Behalf ‚Äî send on behalf of this mailbox</span>
                  </label>
                </div>

                <div class="bg-ms-warningBg border border-ms-warningText/30 rounded p-3">
                  <div class="text-sm font-semibold text-ms-warningText mb-1">‚ö†Ô∏è Permission Propagation</div>
                  <p class="text-xs text-ms-warningText">In real Exchange Online, permissions may take 15-60 minutes to fully propagate across all servers.</p>
                </div>

                <div class="flex items-center space-x-2">
                  <button id="addPermissionBtn" class="px-4 py-2 rounded bg-ms-brand text-white hover:bg-ms-brandDark focus-ring">Add</button>
                  <button class="px-4 py-2 rounded border border-ms-line hover:bg-ms-canvas" onclick="closeModal()">Cancel</button>
                </div>
              </div>

              <div class="md:border-l md:border-ms-line md:pl-5">
                <div class="text-sm font-semibold mb-2">Current permissions</div>
                <div class="border border-ms-line rounded overflow-hidden">
                  <table class="w-full text-sm">
                    <thead class="bg-ms-canvas">
                      <tr>
                        <th class="px-3 py-2 text-left">User</th>
                        <th class="px-3 py-2 text-left">Permissions</th>
                        <th class="px-3 py-2 text-left w-28">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="currentPermissions"></tbody>
                  </table>
                </div>
                
                <div class="mt-4 p-3 bg-ms-canvas rounded border border-ms-line">
                  <div class="text-sm font-semibold mb-2">Permission Summary</div>
                  <div class="text-xs space-y-1">
                    <div>Full Access: <span id="fullAccessCount">0</span> users</div>
                    <div>Send As: <span id="sendAsCount">0</span> users</div>
                    <div>Send on Behalf: <span id="sendOnBehalfCount">0</span> users</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Close blocked modal -->
        <div id="closeBlocked" class="hidden fixed inset-0 z-50 items-center justify-center p-4" role="dialog" aria-modal="true">
          <div class="absolute inset-0 bg-black/30"></div>
          <div class="relative z-10 w-full max-w-lg bg-white rounded shadow-ms">
            <div class="px-5 py-4 border-b border-ms-line font-semibold">Close lab</div>
            <div class="p-5">
              <p class="text-sm">
                Your browser blocked automatic tab closing. Please close this tab manually.
              </p>
              <div class="mt-4 text-right">
                <button id="closeBlockedOk"
                        class="px-4 py-2 rounded bg-ms-brand text-white hover:bg-ms-brandDark">OK</button>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </section>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      let currentMailbox = null;
      let currentDisplayName = null;

      const initialPermissions = {
        'support@blockshell.app': [
          { user: 'asmith@blockshell.app', name: 'Alice Smith', permissions: ['Full Access','Send As'] },
          { user: 'bjohnson@blockshell.app', name: 'Bob Johnson', permissions: ['Full Access','Send As'] },
          { user: 'mwilson@blockshell.app', name: 'Mary Wilson', permissions: ['Full Access'] }
        ],
        'sales@blockshell.app': [
          { user: 'jdoe@blockshell.app', name: 'John Doe', permissions: ['Full Access','Send As'] },
          { user: 'asmith@blockshell.app', name: 'Alice Smith', permissions: ['Full Access','Send As'] },
          { user: 'mwilson@blockshell.app', name: 'Mary Wilson', permissions: ['Full Access','Send As'] }
        ],
        'hr@blockshell.app': [
          { user: 'bjohnson@blockshell.app', name: 'Bob Johnson', permissions: ['Full Access'] },
          { user: 'mwilson@blockshell.app', name: 'Mary Wilson', permissions: ['Full Access'] }
        ]
      };

      const mailboxes = [
        { displayName: 'Support Team', email: 'support@blockshell.app', type: 'Shared', aliases: ['help@blockshell.app'] },
        { displayName: 'Sales Department', email: 'sales@blockshell.app', type: 'Shared', aliases: [] },
        { displayName: 'HR Team', email: 'hr@blockshell.app', type: 'Shared', aliases: ['humanresources@blockshell.app'] },
        { displayName: 'John Doe', email: 'jdoe@blockshell.app', type: 'User', aliases: [] },
        { displayName: 'Alice Smith', email: 'asmith@blockshell.app', type: 'User', aliases: [] },
        { displayName: 'Conference Room A', email: 'conferenceroom-a@blockshell.app', type: 'Room', aliases: [] }
      ];

      let permissionsData = JSON.parse(JSON.stringify(initialPermissions));
      let filteredMailboxes = [...mailboxes];

      function showToast(text, type = 'success') {
        const toast = document.getElementById('toast');
        const toastError = document.getElementById('toastError');
        const toastWarning = document.getElementById('toastWarning');
        
        // Hide all toasts first
        toast.classList.add('hidden');
        toastError.classList.add('hidden');
        toastWarning.classList.add('hidden');
        
        // Show appropriate toast
        if (type === 'success') {
          document.getElementById('toastText').textContent = text;
          toast.classList.remove('hidden');
        } else if (type === 'error') {
          document.getElementById('toastErrorText').textContent = text;
          toastError.classList.remove('hidden');
        } else if (type === 'warning') {
          document.getElementById('toastWarningText').textContent = text;
          toastWarning.classList.remove('hidden');
        }
        
        setTimeout(() => {
          toast.classList.add('hidden');
          toastError.classList.add('hidden');
          toastWarning.classList.add('hidden');
        }, 4000);
      }

      function renderMailboxTable() {
        const tbody = document.getElementById('mailboxTable');
        tbody.innerHTML = '';
        
        filteredMailboxes.forEach(mailbox => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-ms-line hover:bg-ms-tableHover';
          tr.setAttribute('data-email', mailbox.email);
          tr.setAttribute('data-type', mailbox.type.toLowerCase());

          const permissions = permissionsData[mailbox.email] || [];
          const fullAccessCount = permissions.filter(p => p.permissions.includes('Full Access')).length;
          const sendAsCount = permissions.filter(p => p.permissions.includes('Send As')).length;

          tr.innerHTML = `
            <td class="px-4 py-2">
              <div class="font-medium">${mailbox.displayName}</div>
              ${mailbox.aliases.length > 0 ? `<div class="text-xs text-ms-sub">${mailbox.aliases.join(', ')}</div>` : ''}
            </td>
            <td class="px-4 py-2">${mailbox.email}</td>
            <td class="px-4 py-2">
              <span class="inline-block text-xs px-2 py-1 rounded ${
                mailbox.type === 'Shared' ? 'bg-blue-100 text-blue-800' :
                mailbox.type === 'User' ? 'bg-green-100 text-green-800' :
                'bg-purple-100 text-purple-800'
              }">${mailbox.type}</span>
            </td>
            <td class="px-4 py-2">
              ${fullAccessCount > 0 ? `<span class="inline-block text-xs px-2 py-1 rounded bg-ms-badgeBg text-ms-badgeText mr-2">Full Access (${fullAccessCount})</span>` : ''}
              ${sendAsCount > 0 ? `<span class="inline-block text-xs px-2 py-1 rounded bg-ms-badgeBg text-ms-badgeText">Send As (${sendAsCount})</span>` : ''}
              ${fullAccessCount === 0 && sendAsCount === 0 ? '<span class="text-xs text-ms-sub">No permissions</span>' : ''}
            </td>
            <td class="px-4 py-2">
              <button class="text-sm px-3 py-1.5 rounded border border-ms-line hover:bg-ms-canvas focus-ring manage-perms-btn"
                      data-email="${mailbox.email}" data-displayname="${mailbox.displayName}">
                Manage permissions
              </button>
            </td>
          `;
          
          tbody.appendChild(tr);
        });

        // Update mailbox count
        document.getElementById('mailboxCount').textContent = `${filteredMailboxes.length} mailboxes`;
        
        // Add event listeners to manage permission buttons
        document.querySelectorAll('.manage-perms-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const email = e.target.getAttribute('data-email');
            const displayName = e.target.getAttribute('data-displayname');
            managePermissions(email, displayName);
          });
        });
      }

      function filterMailboxes() {
        const searchTerm = document.getElementById('searchMailboxes').value.toLowerCase();
        const typeFilter = document.getElementById('mailboxTypeFilter').value;
        
        filteredMailboxes = mailboxes.filter(mailbox => {
          const matchesSearch = mailbox.displayName.toLowerCase().includes(searchTerm) || 
                               mailbox.email.toLowerCase().includes(searchTerm) ||
                               mailbox.aliases.some(alias => alias.toLowerCase().includes(searchTerm));
          const matchesType = typeFilter === 'all' || 
                             (typeFilter === 'shared' && mailbox.type === 'Shared') ||
                             (typeFilter === 'user' && mailbox.type === 'User') ||
                             (typeFilter === 'room' && mailbox.type === 'Room');
          
          return matchesSearch && matchesType;
        });
        
        renderMailboxTable();
      }

      function setModalMessage(msg, type = 'error') {
        const box = document.getElementById('modalMsg');
        box.textContent = msg;
        box.className = `px-3 py-2 rounded border text-sm ${
          type === 'error' ? 'border-red-200 bg-ms-errorBg text-ms-errorText' :
          'border-yellow-200 bg-ms-warningBg text-ms-warningText'
        }`;
        box.classList.remove('hidden');
      }

      function clearModalMessage() {
        const box = document.getElementById('modalMsg');
        box.classList.add('hidden');
      }

      function updatePermissionSummary() {
        if (!currentMailbox || !permissionsData[currentMailbox]) {
          document.getElementById('fullAccessCount').textContent = '0';
          document.getElementById('sendAsCount').textContent = '0';
          document.getElementById('sendOnBehalfCount').textContent = '0';
          return;
        }

        const perms = permissionsData[currentMailbox];
        document.getElementById('fullAccessCount').textContent = perms.filter(p => p.permissions.includes('Full Access')).length;
        document.getElementById('sendAsCount').textContent = perms.filter(p => p.permissions.includes('Send As')).length;
        document.getElementById('sendOnBehalfCount').textContent = perms.filter(p => p.permissions.includes('Send on Behalf')).length;
      }

      window.managePermissions = (mailbox, displayName) => {
        currentMailbox = mailbox;
        currentDisplayName = displayName;
        document.getElementById('modalTitle').textContent = `Manage permissions for ${displayName} (${mailbox})`;
        document.getElementById('permissionModal').classList.remove('hidden');
        clearModalMessage();
        updateCurrentPermissions();
        updatePermissionSummary();
        
        // Update PowerShell commands
        document.getElementById('psGetPermissions').textContent = `Get-RecipientPermission "${mailbox}" | Where-Object {$_.AccessRights -contains "SendAs"}`;
      };

      window.closeModal = () => {
        document.getElementById('permissionModal').classList.add('hidden');
        currentMailbox = null;
        currentDisplayName = null;
        document.getElementById('userSelect').value = '';
        document.getElementById('fullAccess').checked = false;
        document.getElementById('sendAs').checked = false;
        document.getElementById('sendOnBehalf').checked = false;
        clearModalMessage();
      };

      function updateCurrentPermissions() {
        const tbody = document.getElementById('currentPermissions');
        tbody.innerHTML = '';
        if (!currentMailbox || !permissionsData[currentMailbox]) return;

        permissionsData[currentMailbox].forEach(perm => {
          const tr = document.createElement('tr');
          tr.className = 'border-t border-ms-line hover:bg-ms-tableHover';

          const tdUser = document.createElement('td');
          tdUser.className = 'px-3 py-2 align-top break-all';
          tdUser.textContent = `${perm.name} (${perm.user})`;

          const tdPerms = document.createElement('td');
          tdPerms.className = 'px-3 py-2';
          perm.permissions.forEach(p => {
            const chip = document.createElement('span');
            chip.className = 'inline-block text-xs px-2 py-1 mr-2 mb-1 rounded bg-ms-badgeBg text-ms-badgeText';
            chip.textContent = p;
            tdPerms.appendChild(chip);
          });

          const tdAct = document.createElement('td');
          tdAct.className = 'px-3 py-2';
          const rm = document.createElement('button');
          rm.className = 'text-sm px-3 py-1.5 rounded border border-ms-line hover:bg-ms-canvas focus-ring';
          rm.textContent = 'Remove';
          rm.onclick = () => removePermission(perm.user);
          tdAct.appendChild(rm);

          tr.append(tdUser, tdPerms, tdAct);
          tbody.appendChild(tr);
        });
      }

      window.addPermission = () => {
        if (!currentMailbox) return;

        const user = document.getElementById('userSelect').value;
        const fullAccess = document.getElementById('fullAccess').checked;
        const sendAs = document.getElementById('sendAs').checked;
        const sendOnBehalf = document.getElementById('sendOnBehalf').checked;

        if (!user) { 
          setModalMessage('Please select a user.'); 
          return; 
        }
        if (!fullAccess && !sendAs && !sendOnBehalf) {
          setModalMessage('Select at least one permission type.'); 
          return;
        }

        // Check if user already has these permissions
        if (permissionsData[currentMailbox]) {
          const existingUser = permissionsData[currentMailbox].find(p => p.user === user);
          if (existingUser) {
            const newPerms = [];
            if (fullAccess && !existingUser.permissions.includes('Full Access')) newPerms.push('Full Access');
            if (sendAs && !existingUser.permissions.includes('Send As')) newPerms.push('Send As');
            if (sendOnBehalf && !existingUser.permissions.includes('Send on Behalf')) newPerms.push('Send on Behalf');
            
            if (newPerms.length === 0) {
              setModalMessage('User already has all selected permissions.', 'warning');
              return;
            }
          }
        }

        clearModalMessage();

        const userOption = document.querySelector(`#userSelect option[value="${user}"]`);
        const userName = userOption.textContent.split(' (')[0];

        if (!permissionsData[currentMailbox]) permissionsData[currentMailbox] = [];

        const idx = permissionsData[currentMailbox].findIndex(p => p.user === user);
        const toAdd = [];
        if (fullAccess) toAdd.push('Full Access');
        if (sendAs) toAdd.push('Send As');
        if (sendOnBehalf) toAdd.push('Send on Behalf');

        if (idx >= 0) {
          permissionsData[currentMailbox][idx].permissions =
            [...new Set([...permissionsData[currentMailbox][idx].permissions, ...toAdd])];
        } else {
          permissionsData[currentMailbox].push({ user, name: userName, permissions: toAdd });
        }

        if (sendAs) {
          showToast(`Successfully granted "Send As" to "${userName}" on "${currentMailbox}". Permissions may take time to propagate in production.`, 'success');
        } else {
          showToast(`Permissions updated for "${userName}" on "${currentMailbox}".`, 'success');
        }

        document.getElementById('userSelect').value = '';
        document.getElementById('fullAccess').checked = false;
        document.getElementById('sendAs').checked = false;
        document.getElementById('sendOnBehalf').checked = false;

        updateCurrentPermissions();
        updatePermissionSummary();
        renderMailboxTable();
      };

      function removePermission(user) {
        if (!currentMailbox || !permissionsData[currentMailbox]) return;
        permissionsData[currentMailbox] =
          permissionsData[currentMailbox].filter(p => p.user !== user);
        updateCurrentPermissions();
        updatePermissionSummary();
        renderMailboxTable();
        showToast(`Permissions removed for user.`, 'warning');
      }

      window.closePowerShellModal = () => {
        document.getElementById('powershellModal').classList.add('hidden');
      };

      window.openPowerShellModal = () => {
        document.getElementById('powershellModal').classList.remove('hidden');
      };

      // Login + header controls
      document.getElementById('loginBtn').addEventListener('click', (e) => {
        e.preventDefault();
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        if (u !== '' && p !== '') {
          document.getElementById('loginScreen').classList.add('hidden');
          document.getElementById('app').classList.remove('hidden');
          showToast('Signed in as ' + u + '. Welcome to Exchange Admin Center.', 'success');
          window.scrollTo({ top: 0, behavior: 'smooth' });
          renderMailboxTable();
        } else {
          document.getElementById('loginError').classList.remove('hidden');
          setTimeout(()=>document.getElementById('loginError').classList.add('hidden'), 2000);
        }
      });

      document.getElementById('loginResetBtn').addEventListener('click', () => {
        document.getElementById('loginUser').value = 'blockshell\\administrator';
        document.getElementById('loginPass').value = 'P@ssw0rd!';
      });

      function hardReset() {
        window.closeModal();
        window.closePowerShellModal();
        permissionsData = JSON.parse(JSON.stringify(initialPermissions));
        document.getElementById('searchMailboxes').value = '';
        document.getElementById('mailboxTypeFilter').value = 'all';
        filteredMailboxes = [...mailboxes];
        renderMailboxTable();
        document.getElementById('app').classList.add('hidden');
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('loginUser').value = 'blockshell\\administrator';
        document.getElementById('loginPass').value = 'P@ssw0rd!';
        showToast('Lab has been reset.', 'success');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function tryCloseWindow() {
        window.open('', '_self');
        window.close();
        setTimeout(() => {
          if (!document.hidden) {
            const d = document.getElementById('closeBlocked');
            d.classList.remove('hidden');
            d.classList.add('flex');
          }
        }, 300);
      }

      // Event listeners for new features
      document.getElementById('searchMailboxes').addEventListener('input', filterMailboxes);
      document.getElementById('mailboxTypeFilter').addEventListener('change', filterMailboxes);
      document.getElementById('refreshBtn').addEventListener('click', () => {
        showToast('Mailbox list refreshed.', 'success');
        filterMailboxes();
      });
      document.getElementById('showPowerShellBtn').addEventListener('click', openPowerShellModal);
      document.getElementById('addPermissionBtn').addEventListener('click', addPermission);
      document.getElementById('resetBtnHeader').addEventListener('click', hardReset);
      document.getElementById('closeBtnHeader').addEventListener('click', tryCloseWindow);
      document.getElementById('closeBlockedOk').addEventListener('click', () => {
        const d = document.getElementById('closeBlocked');
        d.classList.add('hidden');
        d.classList.remove('flex');
      });

      // Initialize
      renderMailboxTable();
    });
  </script>
</body>
</html>