<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lab 23: Add User to Security Group</title>
  <!-- Match dev lab: Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f0f0; }
    .sidebar { background-color:#ffffff; border-right:1px solid #d1d5db; height:calc(100vh - 6rem); overflow-y:auto; }
    .tree-node { padding:4px 8px; cursor:pointer; user-select:none; }
    .tree-node:hover { background-color:#e5f0ff; }
    .tree-node.active { background-color:#0078d4; color:white; }
    .table-header { background-color:#f8f9fa; border-bottom:1px solid #d1d5db; }
    .table-row:hover { background-color:#f1f5f9; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);
             justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background-color:white; padding:20px; border-radius:6px; width:520px; max-width:95vw; }
    .small-modal .modal-content { width:420px; }
    .large-modal .modal-content { width:640px; }
    .toast { display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
             background-color:#16a34a; color:white; padding:10px 16px; border-radius:6px; z-index:1100; }
    .instructions-panel { background-color:#ffffff; border:1px solid #d1d5db; border-radius:6px; padding:16px; margin:16px; }
    .task-list li { margin-bottom:10px; }
    .context-menu { position:absolute; background-color:white; border:1px solid #d1d5db; 
                    box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1050; min-width:160px; display:none; }
    .context-menu-item { padding:8px 12px; cursor:pointer; }
    .context-menu-item:hover { background-color:#e5f0ff; }
    /* Tabs (Properties) */
    .tabs { display:flex; gap:8px; border-bottom:1px solid #e5e7eb; margin-top:8px; }
    .tab { padding:6px 10px; border-radius:6px 6px 0 0; border:1px solid transparent; cursor:pointer; font-size:14px; }
    .tab.active { border-color:#e5e7eb; border-bottom-color:white; background:white; }
    .tabpanel { display:none; }
    .tabpanel.active { display:block; }
    .listbox { border:1px solid #e5e7eb; border-radius:6px; padding:6px; max-height:220px; overflow:auto; }
    .row-between { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .object-picker-item { padding:4px 8px; cursor:pointer; }
    .object-picker-item:hover { background-color:#e5f0ff; }
    .object-picker-item.selected { background-color:#0078d4; color:white; }
    .nav-button { padding:4px 12px; border:1px solid #d1d5db; background:white; cursor:pointer; }
    .nav-button:disabled { opacity:0.5; cursor:not-allowed; }
    .nav-button:hover:not(:disabled) { background-color:#f1f5f9; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm p-3">
    <h1 class="text-lg font-semibold text-gray-800">Active Directory Users and Computers - Blockshell.app</h1>
  </header>

  <!-- Enhanced Toolbar (like real ADUC) -->
  <div class="bg-gray-100 p-2 border-b border-gray-300 flex items-center gap-2">
    <div class="flex gap-1">
      <button class="nav-button" id="backBtn" title="Back" disabled>‚Üê</button>
      <button class="nav-button" id="forwardBtn" title="Forward" disabled>‚Üí</button>
      <button class="nav-button" id="upBtn" title="Up One Level" disabled>‚Üë</button>
    </div>
    <div class="flex-1"></div>
    <button class="nav-button" title="Find Objects...">üîç Find...</button>
  </div>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar: Instructions (match dev lab look) -->
    <aside class="w-96 sidebar">
      <div class="instructions-panel">
        <h2 class="text-lg font-semibold mb-3">Lab Instructions ‚Äî Add User to Security Group</h2>
        <p class="mb-4">Use <strong>Active Directory Users and Computers (ADUC)</strong> to add <strong>Liam Carter</strong> to the security group <strong>GRP-Sales-Share-RW</strong>.</p>
        <ul class="task-list list-disc pl-5">
          <li>Click <strong>Blockshell.app</strong> to expand the domain structure.</li>
          <li>Expand <strong>Corporate &gt; Finance</strong> in the tree view.</li>
          <li>Right-click <strong>Liam Carter</strong> in the object list and select <em>Properties</em>.</li>
          <li>Open the <strong>Member Of</strong> tab ‚Üí click <strong>Add‚Ä¶</strong>, enter <code>GRP-Sales-Share-RW</code>, and confirm.</li>
          <li>Click <strong>Apply</strong> ‚Üí <strong>OK</strong>. Verify the group appears in the list.</li>
        </ul>
        <div class="flex justify-between mt-4">
          <button id="resetLab" class="bg-blue-600 text-white px-4 py-2 rounded">Reset Lab</button>
          <button id="closeLab" class="bg-gray-300 px-4 py-2 rounded">Close Lab</button>
        </div>
        <p class="mt-3 text-xs text-gray-600">Tip: Click the time at the bottom-right to open the popup calendar.</p>
      </div>
    </aside>

    <!-- AD App Panel -->
    <main class="flex-1 p-4 bg-white">
      <div class="flex h-full">
        <!-- AD Tree -->
        <div class="w-1/3 border-r border-gray-300 pr-4 overflow-y-auto" id="treeContainer">
          <div id="treeView" class="select-none">
            <div class="tree-node active" data-path="" data-expand-root="1">üìÅ Blockshell.app</div>
            <div class="pl-4 hidden" data-child="">
              <div class="tree-node" data-path="Administration">üìÅ Administration</div>
              <div class="pl-8 hidden" data-child="Administration">
                <div class="tree-node" data-path="Administration/Service Accounts">üìÅ Service Accounts</div>
              </div>

              <div class="tree-node" data-path="Corporate">üìÅ Corporate</div>
              <div class="pl-8 hidden" data-child="Corporate">
                <div class="tree-node" data-path="Corporate/Finance">üìÅ Finance</div>
                <div class="tree-node" data-path="Corporate/Human Resources">üìÅ Human Resources</div>
              </div>

              <div class="tree-node" data-path="Builtin">üìÅ Builtin</div>

              <div class="tree-node" data-path="Computers">üìÅ Computers</div>
              <div class="pl-8 hidden" data-child="Computers">
                <div class="tree-node" data-path="Computers/Workstations">üìÅ Workstations</div>
                <div class="tree-node" data-path="Computers/Servers">üìÅ Servers</div>
              </div>

              <div class="tree-node" data-path="Domain Controllers">üìÅ Domain Controllers</div>
              <div class="tree-node" data-path="ForeignSecurityPrincipals">üìÅ ForeignSecurityPrincipals</div>

              <div class="tree-node" data-path="ITEC_Import">üìÅ ITEC_Import</div>
              <div class="pl-8 hidden" data-child="ITEC_Import">
                <div class="tree-node" data-path="ITEC_Import/Development">üìÅ Development</div>
              </div>

              <div class="tree-node" data-path="Managed Service Accounts">üìÅ Managed Service Accounts</div>
              <div class="tree-node" data-path="Users">üìÅ Users</div>
            </div>
          </div>
        </div>

        <!-- Object List -->
        <div class="flex-1 pl-4 overflow-y-auto">
          <table id="objectTable" class="w-full text-sm text-left text-gray-700">
            <thead class="table-header">
              <tr>
                <th class="p-2">Name</th>
                <th class="p-2">Type</th>
                <th class="p-2">Description</th>
              </tr>
            </thead>
            <tbody id="objectTableBody"></tbody>
          </table>
          <div id="objectCount" class="mt-2 text-sm text-gray-600">Select a container to view its contents.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Enhanced Context Menu -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" data-action="properties">Properties‚Ä¶</div>
    <div class="context-menu-item" data-action="addToGroup">Add to a group‚Ä¶</div>
    <hr class="my-1">
    <div class="context-menu-item" data-action="disableAccount">Disable Account</div>
    <div class="context-menu-item" data-action="resetPassword">Reset Password‚Ä¶</div>
  </div>

  <!-- Enhanced Properties Modal with more tabs -->
  <div id="propertiesModal" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Properties ‚Äî <span id="propUser">User</span></h2>
        <button class="px-2 py-1 bg-gray-200 rounded" id="propCloseX">‚úï</button>
      </div>

      <!-- More tabs like real ADUC -->
      <div class="tabs">
        <div class="tab active" data-tab="general">General</div>
        <div class="tab" data-tab="account">Account</div>
        <div class="tab" data-tab="memberof">Member Of</div>
        <div class="tab" data-tab="profile">Profile</div>
      </div>

      <!-- General Tab -->
      <div id="tab-general" class="tabpanel active">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div class="text-gray-600">First name:</div>
          <div id="genFirstName" class="font-medium">‚Äî</div>
          <div class="text-gray-600">Last name:</div>
          <div id="genLastName" class="font-medium">‚Äî</div>
          <div class="text-gray-600">Display name:</div>
          <div id="genDisplayName" class="font-medium">‚Äî</div>
          <div class="text-gray-600">Description:</div>
          <div id="genDescription" class="font-medium">‚Äî</div>
          <div class="text-gray-600">Office:</div>
          <div id="genOffice">‚Äî</div>
          <div class="text-gray-600">Telephone number:</div>
          <div id="genPhone">‚Äî</div>
          <div class="text-gray-600">Email:</div>
          <div id="genEmail">‚Äî</div>
          <div class="text-gray-600">Department:</div>
          <div id="genDept">‚Äî</div>
        </div>
      </div>

      <!-- Account Tab -->
      <div id="tab-account" class="tabpanel">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div class="text-gray-600">User logon name:</div>
          <div id="accLogonName" class="font-medium">‚Äî</div>
          <div class="text-gray-600">User logon name (pre-Windows 2000):</div>
          <div id="accPreWinLogon" class="font-medium">‚Äî</div>
          <div class="text-gray-600">Logon Hours‚Ä¶</div>
          <div><button class="text-blue-600 text-sm">Logon Hours‚Ä¶</button></div>
          <div class="text-gray-600">Log On To‚Ä¶</div>
          <div><button class="text-blue-600 text-sm">Log On To‚Ä¶</button></div>
          <div class="text-gray-600">Account is locked out</div>
          <div><input type="checkbox" id="accLocked" disabled> <label for="accLocked">Account is locked out</label></div>
          <div class="text-gray-600">Account options</div>
          <div class="text-sm">
            <div><input type="checkbox" checked disabled> User must change password at next logon</div>
            <div><input type="checkbox" disabled> User cannot change password</div>
            <div><input type="checkbox" disabled> Password never expires</div>
            <div><input type="checkbox" disabled> Store password using reversible encryption</div>
          </div>
          <div class="text-gray-600">Account expires</div>
          <div>
            <div><input type="radio" name="accExpire" checked disabled> Never</div>
            <div><input type="radio" name="accExpire" disabled> End of:</div>
          </div>
        </div>
      </div>

      <!-- Member Of Tab -->
      <div id="tab-memberof" class="tabpanel">
        <div class="row-between mt-3">
          <div class="font-semibold">Group memberships</div>
          <div class="flex gap-2">
            <button id="removeGroup" class="bg-gray-200 px-3 py-1 rounded text-sm" disabled>Remove</button>
            <button id="addGroup" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Add‚Ä¶</button>
          </div>
        </div>
        <div class="listbox mt-2" id="memberList"></div>
        <p class="text-xs text-gray-500 mt-2">Target: <code>GRP-Sales-Share-RW</code></p>
        <div class="mt-3 text-sm">
          <div>Primary group: <span id="primaryGroup" class="font-medium">Domain Users</span></div>
          <button class="text-blue-600 text-sm mt-1" id="setPrimaryBtn">Set Primary Group‚Ä¶</button>
        </div>
      </div>

      <!-- Profile Tab -->
      <div id="tab-profile" class="tabpanel">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div class="text-gray-600">Profile path:</div>
          <div id="profilePath">\\blockshell\profiles\%username%</div>
          <div class="text-gray-600">Logon script:</div>
          <div id="logonScript">‚Äî</div>
          <div class="text-gray-600">Home folder</div>
          <div class="text-sm">
            <div><input type="radio" name="homeFolder" checked disabled> Local path:</div>
            <div><input type="radio" name="homeFolder" disabled> Connect: [ ] To: \\server\share\%username%</div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="propCancel" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
        <button id="propApply" class="bg-blue-600 text-white px-4 py-2 rounded" disabled>Apply</button>
        <button id="propOK" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <!-- Enhanced Object Picker Modal (like real ADUC) -->
  <div id="objectPickerModal" class="modal large-modal">
    <div class="modal-content">
      <h3 class="text-md font-semibold mb-3">Select Groups</h3>
      
      <div class="flex gap-4 mb-3">
        <div class="flex-1">
          <label class="block text-sm mb-1">Enter the object names to select (examples):</label>
          <textarea id="groupInput" class="w-full border border-gray-300 rounded px-2 py-1 h-20" placeholder="GRP-Sales-Share-RW"></textarea>
        </div>
        <div class="flex-1">
          <label class="block text-sm mb-1">From this location:</label>
          <div class="border border-gray-300 rounded px-2 py-1 bg-gray-50">Blockshell.app</div>
          <button class="text-blue-600 text-sm mt-1" id="browseLocations">Locations‚Ä¶</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="block text-sm mb-1">Advanced:</label>
        <div class="flex gap-2">
          <button class="text-blue-600 text-sm" id="advancedFindBtn">Advanced‚Ä¶</button>
          <button class="text-blue-600 text-sm" id="objectTypesBtn">Object Types‚Ä¶</button>
        </div>
      </div>

      <div class="border border-gray-300 rounded mb-3">
        <div class="bg-gray-100 p-2 font-semibold">Selected groups:</div>
        <div class="p-2 min-h-12" id="selectedGroupsList"></div>
      </div>

      <div id="groupError" class="text-red-600 text-sm mb-3 hidden">The following objects are not found: <span id="notFoundNames"></span>. Check the names and try again.</div>

      <div class="flex justify-between text-sm text-gray-600">
        <div>Object Types: Users, Groups, Built-in security principals</div>
        <div id="selectedCount">0 item(s) selected</div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="pickerCancel" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
        <button id="pickerOK" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <!-- Advanced Find Modal -->
  <div id="advancedFindModal" class="modal large-modal">
    <div class="modal-content">
      <h3 class="text-md font-semibold mb-3">Advanced Find for Groups</h3>
      <div class="grid grid-cols-2 gap-4 mb-3">
        <div>
          <label class="block text-sm mb-1">Name:</label>
          <input type="text" class="w-full border border-gray-300 rounded px-2 py-1" placeholder="e.g., GRP-Sales*">
        </div>
        <div>
          <label class="block text-sm mb-1">Description:</label>
          <input type="text" class="w-full border border-gray-300 rounded px-2 py-1">
        </div>
      </div>
      <div class="border border-gray-300 rounded max-h-40 overflow-auto mb-3">
        <div class="object-picker-item" data-group="GRP-Sales-Share-RO">GRP-Sales-Share-RO</div>
        <div class="object-picker-item" data-group="GRP-Sales-Share-RW">GRP-Sales-Share-RW</div>
        <div class="object-picker-item" data-group="Domain Admins">Domain Admins</div>
        <div class="object-picker-item" data-group="Domain Users">Domain Users</div>
      </div>
      <div class="flex justify-end gap-2">
        <button class="bg-gray-200 px-4 py-2 rounded" onclick="document.getElementById('advancedFindModal').style.display='none'">Cancel</button>
        <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="addFromAdvancedFind()">Add</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">User added to group</div>

  <!-- Date/Time (match dev placement) -->
  <div class="fixed bottom-4 right-4 text-sm text-gray-600 cursor-pointer select-none" id="timeWidget">
    <span id="currentTime">--:--</span>
    <span id="currentDate">-- ---, ----</span>
  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between mb-4">
        <button id="prevMonthBtn">‚Äπ</button>
        <span id="calendarMonthYear">Month Year</span>
        <button id="nextMonthBtn">‚Ä∫</button>
      </div>
      <table class="w-full text-sm">
        <thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead>
        <tbody id="calendarBody"></tbody>
      </table>
      <div class="flex justify-end mt-4">
        <button class="bg-gray-300 px-4 py-2 rounded" id="closeCalendar">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- ENHANCED DATA ----------
    let currentPath = '';
    let history = [''];
    let historyIndex = 0;

    const objects = [
      { name:'Administration', type:'Organizational Unit', description:'Administrative accounts and groups', path:'Administration' },
      { name:'Service Accounts', type:'Organizational Unit', description:'Service account management', path:'Administration/Service Accounts' },

      { name:'Corporate', type:'Organizational Unit', description:'Corporate Domain Objects', path:'Corporate' },
      { name:'Finance', type:'Organizational Unit', description:'Finance department objects', path:'Corporate/Finance' },
      { name:'Liam Carter', type:'User', description:'Finance Director', path:'Corporate/Finance/Liam Carter', 
        firstName:'Liam', lastName:'Carter', displayName:'Liam Carter', email:'liam.carter@blockshell.app', phone:'+1-555-0101' },
      { name:'Amelia Hughes', type:'User', description:'Finance Manager', path:'Corporate/Finance/Amelia Hughes',
        firstName:'Amelia', lastName:'Hughes', displayName:'Amelia Hughes', email:'amelia.hughes@blockshell.app', phone:'+1-555-0102' },
      { name:'Finance Admins', type:'Security Group', description:'Finance department administrators', path:'Corporate/Finance/Finance Admins' },

      { name:'Human Resources', type:'Organizational Unit', description:'HR department objects', path:'Corporate/Human Resources' },
      { name:'Noah Patel', type:'User', description:'HR Director', path:'Corporate/Human Resources/Noah Patel',
        firstName:'Noah', lastName:'Patel', displayName:'Noah Patel', email:'noah.patel@blockshell.app', phone:'+1-555-0103' },
      { name:'HR Staff', type:'Security Group', description:'HR department staff group', path:'Corporate/Human Resources/HR Staff' },

      { name:'Builtin', type:'builtinDomain', description:'Built-in security principals', path:'Builtin' },
      { name:'Administrators', type:'Security Group', description:'Built-in Administrators group', path:'Builtin/Administrators' },
      { name:'Users', type:'Security Group', description:'Built-in Users group', path:'Builtin/Users' },
      { name:'Backup Operators', type:'Security Group', description:'Built-in Backup Operators group', path:'Builtin/Backup Operators' },

      { name:'Computers', type:'Container', description:'Default container for upgraded computer accounts', path:'Computers' },
      { name:'Workstations', type:'Organizational Unit', description:'Workstation computers', path:'Computers/Workstations' },
      { name:'Servers', type:'Organizational Unit', description:'Server computers', path:'Computers/Servers' },

      { name:'Domain Controllers', type:'Organizational Unit', description:'Default container for domain controllers', path:'Domain Controllers' },
      { name:'ForeignSecurityPrincipals', type:'Container', description:'Default container for security principals', path:'ForeignSecurityPrincipals' },

      { name:'ITEC_Import', type:'Organizational Unit', description:'Imported IT objects', path:'ITEC_Import' },
      { name:'Development', type:'Organizational Unit', description:'Development team objects', path:'ITEC_Import/Development' },

      { name:'Managed Service Accounts', type:'Container', description:'Default container for managed service accounts', path:'Managed Service Accounts' },
      { name:'Users', type:'Container', description:'Default container for upgraded user accounts', path:'Users' },

      // Group targets used in validation (exist anywhere logically)
      { name:'GRP-Sales-Share-RO', type:'Security Group', description:'Read-only access to Sales share', path:'Corporate/Finance/GRP-Sales-Share-RO' },
      { name:'GRP-Sales-Share-RW', type:'Security Group', description:'Read/write access to Sales share', path:'Corporate/Finance/GRP-Sales-Share-RW' },
      { name:'Domain Admins', type:'Security Group', description:'Designated administrators of the domain', path:'Administration/Domain Admins' },
      { name:'Domain Users', type:'Security Group', description:'All domain users', path:'Users/Domain Users' },
      { name:'Domain Computers', type:'Security Group', description:'All domain-joined computers', path:'Computers/Domain Computers' }
    ];

    const userState = {
      'Liam Carter': { 
        memberOf: ['Domain Users'], 
        dept:'Finance', 
        office:'London',
        firstName:'Liam',
        lastName:'Carter',
        displayName:'Liam Carter',
        email:'liam.carter@blockshell.app',
        phone:'+1-555-0101',
        logonName:'liam.carter',
        preWinLogon:'BLOCKSHELL\\liamc'
      },
      'Amelia Hughes': { 
        memberOf: ['Domain Users'], 
        dept:'Finance', 
        office:'London',
        firstName:'Amelia',
        lastName:'Hughes',
        displayName:'Amelia Hughes',
        email:'amelia.hughes@blockshell.app',
        phone:'+1-555-0102',
        logonName:'amelia.hughes',
        preWinLogon:'BLOCKSHELL\\ameliah'
      },
      'Noah Patel': { 
        memberOf: ['Domain Users'], 
        dept:'HR', 
        office:'London',
        firstName:'Noah',
        lastName:'Patel',
        displayName:'Noah Patel',
        email:'noah.patel@blockshell.app',
        phone:'+1-555-0103',
        logonName:'noah.patel',
        preWinLogon:'BLOCKSHELL\\noahp'
      }
    };

    // ---------- ENHANCED NAVIGATION ----------
    const backBtn = document.getElementById('backBtn');
    const forwardBtn = document.getElementById('forwardBtn');
    const upBtn = document.getElementById('upBtn');

    function updateNavButtons() {
      backBtn.disabled = historyIndex <= 0;
      forwardBtn.disabled = historyIndex >= history.length - 1;
      upBtn.disabled = !currentPath || currentPath.split('/').length <= 1;
    }

    backBtn.addEventListener('click', () => {
      if (historyIndex > 0) {
        historyIndex--;
        currentPath = history[historyIndex];
        navigateToPath(currentPath);
        updateNavButtons();
      }
    });

    forwardBtn.addEventListener('click', () => {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        currentPath = history[historyIndex];
        navigateToPath(currentPath);
        updateNavButtons();
      }
    });

    upBtn.addEventListener('click', () => {
      if (currentPath && currentPath.includes('/')) {
        const pathParts = currentPath.split('/');
        pathParts.pop();
        const newPath = pathParts.join('/');
        navigateToPath(newPath);
      }
    });

    function navigateToPath(path) {
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      const node = document.querySelector(`.tree-node[data-path="${path}"]`);
      if (node) {
        node.classList.add('active');
        // Ensure path is expanded
        let current = path;
        while (current) {
          const childDiv = document.querySelector(`[data-child="${current}"]`);
          if (childDiv) childDiv.classList.remove('hidden');
          const parts = current.split('/');
          parts.pop();
          current = parts.join('/');
        }
      }
      updateObjectTable();
      updateNavButtons();
    }

    // ---------- ENHANCED TREE & TABLE ----------
    function toggleNode(el) {
      const childDiv = document.querySelector(`[data-child="${el.dataset.path}"]`);
      if (childDiv) { childDiv.classList.toggle('hidden'); }
      selectNode(el);
    }

    function selectNode(el) {
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      currentPath = el.dataset.path === '' ? '' : el.dataset.path;
      history = history.slice(0, historyIndex + 1);
      history.push(currentPath);
      historyIndex++;
      updateObjectTable();
      updateNavButtons();
    }

    document.getElementById('treeView').addEventListener('click', (e) => {
      const node = e.target.closest('.tree-node');
      if (!node) return;
      // root node toggles expansion
      if (node.dataset.expandRoot) {
        const childDiv = document.querySelector('[data-child=""]');
        if (childDiv) childDiv.classList.toggle('hidden');
        selectNode(node);
        return;
      }
      // if node has children container, toggle open/close
      const hasChildContainer = document.querySelector(`[data-child="${node.dataset.path}"]`);
      if (hasChildContainer) {
        hasChildContainer.classList.toggle('hidden');
      }
      selectNode(node);
    });

    function updateObjectTable() {
      const tbody = document.getElementById('objectTableBody');
      const objectCount = document.getElementById('objectCount');
      tbody.innerHTML = '';
      if (!currentPath) {
        objectCount.textContent = 'Select a container to view its contents.';
        return;
      }
      const filtered = objects.filter(o => o.path.startsWith(currentPath) && o.path !== currentPath && o.path.split('/').length === currentPath.split('/').length + 1);
      filtered.forEach(obj => {
        const row = document.createElement('tr');
        row.className = 'table-row';
        row.dataset.name = obj.name;
        row.dataset.path = obj.path;
        const icon = obj.type === 'User' ? 'üë§' : obj.type === 'Computer' ? 'üíª' : obj.type === 'Security Group' ? 'üë•' : 'üìÅ';
        row.innerHTML = `<td class="p-2">${icon} ${obj.name}</td><td class="p-2">${obj.type}</td><td class="p-2">${obj.description || ''}</td>`;
        row.addEventListener('click', () => {
          document.querySelectorAll('.table-row').forEach(r => r.classList.remove('bg-blue-100'));
          row.classList.add('bg-blue-100');
        });
        row.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (obj.type === 'User') {
            showContextMenu(e, obj);
          }
        });
        row.addEventListener('dblclick', () => {
          if (obj.type === 'User') openProperties(obj.name);
        });
        tbody.appendChild(row);
      });
      objectCount.textContent = `${filtered.length} object(s)`;
    }

    // ---------- ENHANCED CONTEXT MENU ----------
    const contextMenu = document.getElementById('contextMenu');
    function showContextMenu(e, obj) {
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.display = 'block';
      contextMenu.dataset.user = obj.name;
      document.addEventListener('click', hideContextMenu, { once:true });
    }
    function hideContextMenu() { contextMenu.style.display = 'none'; }
    contextMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.context-menu-item');
      if (!item) return;
      const uname = contextMenu.dataset.user;
      if (item.dataset.action === 'properties') {
        openProperties(uname);
      } else if (item.dataset.action === 'addToGroup') {
        openProperties(uname);
        setTimeout(() => selectTab('memberof'), 100);
        setTimeout(() => document.getElementById('addGroup').click(), 200);
      } else if (item.dataset.action === 'disableAccount') {
        showToast('Account disable feature would be available in real ADUC');
      } else if (item.dataset.action === 'resetPassword') {
        showToast('Password reset feature would be available in real ADUC');
      }
      hideContextMenu();
    });

    // ---------- ENHANCED PROPERTIES MODAL ----------
    const propertiesModal = document.getElementById('propertiesModal');
    const propUserSpan = document.getElementById('propUser');
    const genFirstName = document.getElementById('genFirstName');
    const genLastName = document.getElementById('genLastName');
    const genDisplayName = document.getElementById('genDisplayName');
    const genDescription = document.getElementById('genDescription');
    const genOffice = document.getElementById('genOffice');
    const genPhone = document.getElementById('genPhone');
    const genEmail = document.getElementById('genEmail');
    const genDept = document.getElementById('genDept');
    const accLogonName = document.getElementById('accLogonName');
    const accPreWinLogon = document.getElementById('accPreWinLogon');
    const memberList = document.getElementById('memberList');
    const propApplyBtn = document.getElementById('propApply');
    const primaryGroupSpan = document.getElementById('primaryGroup');

    let currentUser = null;

    function openProperties(uname) {
      currentUser = uname;
      const user = userState[uname];
      propUserSpan.textContent = uname;
      
      // General tab
      genFirstName.textContent = user?.firstName || '‚Äî';
      genLastName.textContent = user?.lastName || '‚Äî';
      genDisplayName.textContent = user?.displayName || '‚Äî';
      genDescription.textContent = objects.find(o => o.name === uname)?.description || '‚Äî';
      genOffice.textContent = user?.office || '‚Äî';
      genPhone.textContent = user?.phone || '‚Äî';
      genEmail.textContent = user?.email || '‚Äî';
      genDept.textContent = user?.dept || '‚Äî';
      
      // Account tab
      accLogonName.textContent = (user?.logonName || '‚Äî') + '@blockshell.app';
      accPreWinLogon.textContent = user?.preWinLogon || '‚Äî';
      
      selectTab('general');
      renderMemberList();
      propertiesModal.style.display = 'flex';
    }

    function closeProperties() {
      propertiesModal.style.display = 'none';
    }
    document.getElementById('propCloseX').addEventListener('click', closeProperties);
    document.getElementById('propCancel').addEventListener('click', closeProperties);
    document.getElementById('propOK').addEventListener('click', () => { 
      closeProperties(); 
      showToast('User properties updated'); 
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => selectTab(tab.dataset.tab));
    });
    function selectTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
      document.querySelectorAll('.tabpanel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + name));
    }

    function renderMemberList() {
      const groups = userState[currentUser]?.memberOf || [];
      memberList.innerHTML = '';
      groups.forEach(g => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center border-b border-gray-100 py-1';
        row.innerHTML = `<div>${g}</div>
                         <div title="Primary group"><input type="radio" name="primary" ${g === 'Domain Users' ? 'checked' : ''} onchange="setPrimaryGroup('${g}')"></div>`;
        memberList.appendChild(row);
      });
      primaryGroupSpan.textContent = userState[currentUser]?.memberOf.includes('Domain Users') ? 'Domain Users' : (groups[0] || 'None');
      document.getElementById('removeGroup').disabled = true;
      propApplyBtn.disabled = true;
    }

    function setPrimaryGroup(group) {
      primaryGroupSpan.textContent = group;
      propApplyBtn.disabled = false;
    }

    // ---------- ENHANCED OBJECT PICKER ----------
    const objectPickerModal = document.getElementById('objectPickerModal');
    const selectedGroupsList = document.getElementById('selectedGroupsList');
    let selectedGroups = [];

    document.getElementById('addGroup').addEventListener('click', () => {
      selectedGroups = [];
      document.getElementById('groupInput').value = '';
      document.getElementById('selectedGroupsList').innerHTML = '';
      document.getElementById('groupError').classList.add('hidden');
      document.getElementById('selectedCount').textContent = '0 item(s) selected';
      objectPickerModal.style.display = 'flex';
    });

    document.getElementById('pickerCancel').addEventListener('click', () => objectPickerModal.style.display = 'none');
    
    document.getElementById('pickerOK').addEventListener('click', () => {
      const input = document.getElementById('groupInput').value.trim();
      if (!input) {
        objectPickerModal.style.display = 'none';
        return;
      }

      const enteredNames = input.split('\n').map(name => name.trim()).filter(name => name);
      const notFound = [];
      const foundGroups = [];

      enteredNames.forEach(name => {
        const exists = objects.some(o => o.type === 'Security Group' && o.name.toLowerCase() === name.toLowerCase());
        if (exists && !selectedGroups.includes(name)) {
          foundGroups.push(name);
        } else if (!exists) {
          notFound.push(name);
        }
      });

      if (notFound.length > 0) {
        document.getElementById('notFoundNames').textContent = notFound.join(', ');
        document.getElementById('groupError').classList.remove('hidden');
        return;
      }

      selectedGroups = [...new Set([...selectedGroups, ...foundGroups])];
      
      if (selectedGroups.length > 0) {
        const groups = userState[currentUser].memberOf;
        selectedGroups.forEach(group => {
          if (!groups.includes(group)) {
            groups.push(group);
          }
        });
        propApplyBtn.disabled = false;
        renderMemberList();
        objectPickerModal.style.display = 'none';
      }
    });

    document.getElementById('groupInput').addEventListener('input', function() {
      const names = this.value.split('\n').map(name => name.trim()).filter(name => name);
      selectedGroups = names.filter(name => 
        objects.some(o => o.type === 'Security Group' && o.name.toLowerCase() === name.toLowerCase())
      );
      
      selectedGroupsList.innerHTML = selectedGroups.map(group => 
        `<div class="border-b border-gray-100 py-1">${group}</div>`
      ).join('');
      
      document.getElementById('selectedCount').textContent = `${selectedGroups.length} item(s) selected`;
    });

    document.getElementById('advancedFindBtn').addEventListener('click', () => {
      document.getElementById('advancedFindModal').style.display = 'flex';
    });

    function addFromAdvancedFind() {
      const selected = document.querySelectorAll('.object-picker-item.selected');
      selected.forEach(item => {
        const group = item.dataset.group;
        if (!selectedGroups.includes(group)) {
          selectedGroups.push(group);
        }
      });
      
      document.getElementById('groupInput').value = selectedGroups.join('\n');
      selectedGroupsList.innerHTML = selectedGroups.map(group => 
        `<div class="border-b border-gray-100 py-1">${group}</div>`
      ).join('');
      
      document.getElementById('selectedCount').textContent = `${selectedGroups.length} item(s) selected`;
      document.getElementById('advancedFindModal').style.display = 'none';
    }

    // Advanced find selection
    document.querySelectorAll('.object-picker-item').forEach(item => {
      item.addEventListener('click', function() {
        this.classList.toggle('selected');
      });
    });

    document.getElementById('propApply').addEventListener('click', () => {
      propApplyBtn.disabled = true;
      showToast('Group membership updated');
    });

    // ---------- RESET / CLOSE ----------
    document.getElementById('resetLab').addEventListener('click', () => {
      userState['Liam Carter'] = { 
        memberOf:['Domain Users'], 
        dept:'Finance', 
        office:'London',
        firstName:'Liam',
        lastName:'Carter',
        displayName:'Liam Carter',
        email:'liam.carter@blockshell.app',
        phone:'+1-555-0101',
        logonName:'liam.carter',
        preWinLogon:'BLOCKSHELL\\liamc'
      };
      currentPath = '';
      history = ['']; historyIndex = 0;
      document.querySelectorAll('[data-child]').forEach(div => div.classList.add('hidden'));
      // Re-select root
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      document.querySelector('.tree-node[data-path=""]').classList.add('active');
      updateObjectTable();
      updateNavButtons();
      closeProperties();
      objectPickerModal.style.display = 'none';
      showToast('Lab reset to initial state');
    });

    document.getElementById('closeLab').addEventListener('click', () => {
      window.close();
      setTimeout(() => { window.location.href = 'about:blank'; }, 300);
    });

    // ---------- TIME & CALENDAR ----------
    const timeWidget = document.getElementById('timeWidget');
    const currentTimeSpan = document.getElementById('currentTime');
    const currentDateSpan = document.getElementById('currentDate');
    const calendarModal = document.getElementById('calendarModal');
    const calendarBody = document.getElementById('calendarBody');
    const calendarMonthYear = document.getElementById('calendarMonthYear');

    function updateTime() {
      const now = new Date();
      currentTimeSpan.textContent = now.toLocaleTimeString('en-GB', { hour12: true, hour: '2-digit', minute: '2-digit' });
      currentDateSpan.textContent = now.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    }
    setInterval(updateTime, 1000); updateTime();

    let calMonth = (new Date()).getMonth();
    let calYear = (new Date()).getFullYear();

    function updateCalendar() {
      calendarMonthYear.textContent = new Date(calYear, calMonth).toLocaleString('en-GB', { month:'long', year:'numeric' });
      calendarBody.innerHTML = '';
      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
      let row = document.createElement('tr');
      for (let i = 0; i < firstDay; i++) row.innerHTML += '<td></td>';
      for (let day = 1; day <= daysInMonth; day++) {
        if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
          calendarBody.appendChild(row);
          row = document.createElement('tr');
        }
        const isToday = (day === (new Date()).getDate() && calMonth === (new Date()).getMonth() && calYear === (new Date()).getFullYear());
        row.innerHTML += `<td class="p-1 text-center ${isToday ? 'bg-blue-200' : ''}">${day}</td>`;
      }
      calendarBody.appendChild(row);
    }

    function toggleCalendar() {
      const vis = calendarModal.style.display === 'flex';
      calendarModal.style.display = vis ? 'none' : 'flex';
      if (!vis) updateCalendar();
    }

    document.getElementById('prevMonthBtn').addEventListener('click', () => { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } updateCalendar(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } updateCalendar(); });
    document.getElementById('closeCalendar').addEventListener('click', () => calendarModal.style.display = 'none');
    timeWidget.addEventListener('click', toggleCalendar);

    // ---------- INIT ----------
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg || 'Done';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 1800);
    }

    // start collapsed with root selected, like dev
    updateObjectTable();
    updateNavButtons();
  </script>
</body>
</html>