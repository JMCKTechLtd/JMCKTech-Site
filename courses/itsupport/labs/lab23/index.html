<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lab 23: Add User to Security Group</title>
  <!-- Match dev lab: Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f0f0; }
    .sidebar { background-color:#ffffff; border-right:1px solid #d1d5db; height:calc(100vh - 6rem); overflow-y:auto; }
    .tree-node { padding:4px 8px; cursor:pointer; user-select:none; }
    .tree-node:hover { background-color:#e5f0ff; }
    .tree-node.active { background-color:#0078d4; color:white; }
    .table-header { background-color:#f8f9fa; border-bottom:1px solid #d1d5db; }
    .table-row:hover { background-color:#f1f5f9; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);
             justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background-color:white; padding:20px; border-radius:6px; width:520px; max-width:95vw; }
    .small-modal .modal-content { width:420px; }
    .toast { display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
             background-color:#16a34a; color:white; padding:10px 16px; border-radius:6px; z-index:1100; }
    .instructions-panel { background-color:#ffffff; border:1px solid #d1d5db; border-radius:6px; padding:16px; margin:16px; }
    .task-list li { margin-bottom:10px; }
    .context-menu { position:absolute; background-color:white; border:1px solid #d1d5db; 
                    box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1050; min-width:160px; display:none; }
    .context-menu-item { padding:8px 12px; cursor:pointer; }
    .context-menu-item:hover { background-color:#e5f0ff; }
    /* Tabs (Properties) */
    .tabs { display:flex; gap:8px; border-bottom:1px solid #e5e7eb; margin-top:8px; }
    .tab { padding:6px 10px; border-radius:6px 6px 0 0; border:1px solid transparent; cursor:pointer; font-size:14px; }
    .tab.active { border-color:#e5e7eb; border-bottom-color:white; background:white; }
    .tabpanel { display:none; }
    .tabpanel.active { display:block; }
    .listbox { border:1px solid #e5e7eb; border-radius:6px; padding:6px; max-height:220px; overflow:auto; }
    .row-between { display:flex; justify-content:space-between; align-items:center; gap:8px; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm p-3">
    <h1 class="text-lg font-semibold text-gray-800">Active Directory Users and Computers - Blockshell.app</h1>
  </header>

  <!-- Toolbar (kept minimal, like dev lab) -->
  <div class="bg-gray-100 p-2 border-b border-gray-300"></div>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar: Instructions (match dev lab look) -->
    <aside class="w-96 sidebar">
      <div class="instructions-panel">
        <h2 class="text-lg font-semibold mb-3">Lab Instructions ‚Äî Add User to Security Group</h2>
        <p class="mb-4">Use <strong>Active Directory Users and Computers (ADUC)</strong> to add <strong>Liam Carter</strong> to the security group <strong>GRP-Sales-Share-RW</strong>.</p>
        <ul class="task-list list-disc pl-5">
          <li>Click <strong>Blockshell.app</strong> to expand the domain structure.</li>
          <li>Expand <strong>Corporate &gt; Finance</strong> in the tree view.</li>
          <li>Right-click <strong>Liam Carter</strong> in the object list and select <em>Properties</em>.</li>
          <li>Open the <strong>Member Of</strong> tab ‚Üí click <strong>Add‚Ä¶</strong>, enter <code>GRP-Sales-Share-RW</code>, and confirm.</li>
          <li>Click <strong>Apply</strong> ‚Üí <strong>OK</strong>. Verify the group appears in the list.</li>
        </ul>
        <div class="flex justify-between mt-4">
          <button id="resetLab" class="bg-blue-600 text-white px-4 py-2 rounded">Reset Lab</button>
          <button id="closeLab" class="bg-gray-300 px-4 py-2 rounded">Close Lab</button>
        </div>
        <p class="mt-3 text-xs text-gray-600">Tip: Click the time at the bottom-right to open the popup calendar.</p>
      </div>
    </aside>

    <!-- AD App Panel -->
    <main class="flex-1 p-4 bg-white">
      <div class="flex h-full">
        <!-- AD Tree -->
        <div class="w-1/3 border-r border-gray-300 pr-4 overflow-y-auto" id="treeContainer">
          <div id="treeView" class="select-none">
            <div class="tree-node active" data-path="" data-expand-root="1">üìÅ Blockshell.app</div>
            <div class="pl-4 hidden" data-child="">
              <div class="tree-node" data-path="Administration">üìÅ Administration</div>
              <div class="pl-8 hidden" data-child="Administration">
                <div class="tree-node" data-path="Administration/Service Accounts">üìÅ Service Accounts</div>
              </div>

              <div class="tree-node" data-path="Corporate">üìÅ Corporate</div>
              <div class="pl-8 hidden" data-child="Corporate">
                <div class="tree-node" data-path="Corporate/Finance">üìÅ Finance</div>
                <div class="tree-node" data-path="Corporate/Human Resources">üìÅ Human Resources</div>
              </div>

              <div class="tree-node" data-path="Builtin">üìÅ Builtin</div>

              <div class="tree-node" data-path="Computers">üìÅ Computers</div>
              <div class="pl-8 hidden" data-child="Computers">
                <div class="tree-node" data-path="Computers/Workstations">üìÅ Workstations</div>
                <div class="tree-node" data-path="Computers/Servers">üìÅ Servers</div>
              </div>

              <div class="tree-node" data-path="Domain Controllers">üìÅ Domain Controllers</div>
              <div class="tree-node" data-path="ForeignSecurityPrincipals">üìÅ ForeignSecurityPrincipals</div>

              <div class="tree-node" data-path="ITEC_Import">üìÅ ITEC_Import</div>
              <div class="pl-8 hidden" data-child="ITEC_Import">
                <div class="tree-node" data-path="ITEC_Import/Development">üìÅ Development</div>
              </div>

              <div class="tree-node" data-path="Managed Service Accounts">üìÅ Managed Service Accounts</div>
              <div class="tree-node" data-path="Users">üìÅ Users</div>
            </div>
          </div>
        </div>

        <!-- Object List -->
        <div class="flex-1 pl-4 overflow-y-auto">
          <table id="objectTable" class="w-full text-sm text-left text-gray-700">
            <thead class="table-header">
              <tr>
                <th class="p-2">Name</th>
                <th class="p-2">Type</th>
                <th class="p-2">Description</th>
              </tr>
            </thead>
            <tbody id="objectTableBody"></tbody>
          </table>
          <div id="objectCount" class="mt-2 text-sm text-gray-600">Select a container to view its contents.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Context Menu -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" data-action="properties">Properties‚Ä¶</div>
  </div>

  <!-- Properties Modal -->
  <div id="propertiesModal" class="modal">
    <div class="modal-content">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Properties ‚Äî <span id="propUser">User</span></h2>
        <button class="px-2 py-1 bg-gray-200 rounded" id="propCloseX">‚úï</button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="general">General</div>
        <div class="tab" data-tab="memberof">Member Of</div>
      </div>

      <!-- Panels -->
      <div id="tab-general" class="tabpanel active">
        <div class="grid grid-cols-2 gap-2 mt-3">
          <div class="text-gray-600">Name:</div>
          <div id="genName" class="font-medium">User</div>
          <div class="text-gray-600">Department:</div>
          <div id="genDept">‚Äî</div>
          <div class="text-gray-600">Office:</div>
          <div id="genOffice">‚Äî</div>
        </div>
      </div>

      <div id="tab-memberof" class="tabpanel">
        <div class="row-between mt-3">
          <div class="font-semibold">Group memberships</div>
          <div class="flex gap-2">
            <button id="removeGroup" class="bg-gray-200 px-3 py-1 rounded text-sm" disabled>Remove</button>
            <button id="addGroup" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Add‚Ä¶</button>
          </div>
        </div>
        <div class="listbox mt-2" id="memberList"></div>
        <p class="text-xs text-gray-500 mt-2">Target: <code>GRP-Sales-Share-RW</code></p>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button id="propCancel" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
        <button id="propApply" class="bg-blue-600 text-white px-4 py-2 rounded" disabled>Apply</button>
        <button id="propOK" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <!-- Add Group Modal -->
  <div id="addGroupModal" class="modal small-modal">
    <div class="modal-content">
      <h3 class="text-md font-semibold mb-3">Select Groups</h3>
      <label class="block text-sm mb-2">Enter group name:</label>
      <input id="groupInput" type="text" placeholder="GRP-Sales-Share-RW" class="w-full border border-gray-300 rounded px-2 py-1 mb-2"/>
      <p id="groupError" class="text-red-600 text-sm hidden">Group not found. Try <code>GRP-Sales-Share-RO</code> or <code>GRP-Sales-Share-RW</code>.</p>
      <div class="mt-3 flex justify-end gap-2">
        <button id="grpCancel" class="bg-gray-200 px-4 py-2 rounded">Cancel</button>
        <button id="grpOK" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">User added to group</div>

  <!-- Date/Time (match dev placement) -->
  <div class="fixed bottom-4 right-4 text-sm text-gray-600 cursor-pointer select-none" id="timeWidget">
    <span id="currentTime">--:--</span>
    <span id="currentDate">-- ---, ----</span>
  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between mb-4">
        <button id="prevMonthBtn">‚Äπ</button>
        <span id="calendarMonthYear">Month Year</span>
        <button id="nextMonthBtn">‚Ä∫</button>
      </div>
      <table class="w-full text-sm">
        <thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead>
        <tbody id="calendarBody"></tbody>
      </table>
      <div class="flex justify-end mt-4">
        <button class="bg-gray-300 px-4 py-2 rounded" id="closeCalendar">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- DATA ----------
    let currentPath = '';
    let history = [''];
    let historyIndex = 0;

    const objects = [
      { name:'Administration', type:'Organizational Unit', description:'Administrative accounts and groups', path:'Administration' },
      { name:'Service Accounts', type:'Organizational Unit', description:'Service account management', path:'Administration/Service Accounts' },

      { name:'Corporate', type:'Organizational Unit', description:'Corporate Domain Objects', path:'Corporate' },
      { name:'Finance', type:'Organizational Unit', description:'Finance department objects', path:'Corporate/Finance' },
      { name:'Liam Carter', type:'User', description:'Finance Director', path:'Corporate/Finance/Liam Carter' },
      { name:'Amelia Hughes', type:'User', description:'Finance Manager', path:'Corporate/Finance/Amelia Hughes' },
      { name:'Finance Admins', type:'Security Group', description:'Finance department administrators', path:'Corporate/Finance/Finance Admins' },

      { name:'Human Resources', type:'Organizational Unit', description:'HR department objects', path:'Corporate/Human Resources' },
      { name:'Noah Patel', type:'User', description:'HR Director', path:'Corporate/Human Resources/Noah Patel' },
      { name:'HR Staff', type:'Security Group', description:'HR department staff group', path:'Corporate/Human Resources/HR Staff' },

      { name:'Builtin', type:'builtinDomain', description:'Built-in security principals', path:'Builtin' },
      { name:'Administrators', type:'Security Group', description:'Built-in Administrators group', path:'Builtin/Administrators' },

      { name:'Computers', type:'Container', description:'Default container for upgraded computer accounts', path:'Computers' },
      { name:'Workstations', type:'Organizational Unit', description:'Workstation computers', path:'Computers/Workstations' },
      { name:'Servers', type:'Organizational Unit', description:'Server computers', path:'Computers/Servers' },

      { name:'Domain Controllers', type:'Organizational Unit', description:'Default container for domain controllers', path:'Domain Controllers' },
      { name:'ForeignSecurityPrincipals', type:'Container', description:'Default container for security principals', path:'ForeignSecurityPrincipals' },

      { name:'ITEC_Import', type:'Organizational Unit', description:'Imported IT objects', path:'ITEC_Import' },
      { name:'Development', type:'Organizational Unit', description:'Development team objects', path:'ITEC_Import/Development' },

      { name:'Managed Service Accounts', type:'Container', description:'Default container for managed service accounts', path:'Managed Service Accounts' },
      { name:'Users', type:'Container', description:'Default container for upgraded user accounts', path:'Users' },

      // Group targets used in validation (exist anywhere logically)
      { name:'GRP-Sales-Share-RO', type:'Security Group', description:'Read-only access to Sales share', path:'Corporate/Finance/GRP-Sales-Share-RO' },
      { name:'GRP-Sales-Share-RW', type:'Security Group', description:'Read/write access to Sales share', path:'Corporate/Finance/GRP-Sales-Share-RW' }
    ];

    const userState = {
      'Liam Carter': { memberOf: ['Domain Users'], dept:'Finance', office:'London' },
      'Amelia Hughes': { memberOf: ['Domain Users'], dept:'Finance', office:'London' },
      'Noah Patel': { memberOf: ['Domain Users'], dept:'HR', office:'London' }
    };

    // ---------- TREE & TABLE ----------
    function toggleNode(el) {
      const childDiv = document.querySelector(`[data-child="${el.dataset.path}"]`);
      if (childDiv) { childDiv.classList.toggle('hidden'); }
      selectNode(el);
    }

    function selectNode(el) {
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      currentPath = el.dataset.path === '' ? '' : el.dataset.path;
      history = history.slice(0, historyIndex + 1);
      history.push(currentPath);
      historyIndex++;
      updateObjectTable();
    }

    document.getElementById('treeView').addEventListener('click', (e) => {
      const node = e.target.closest('.tree-node');
      if (!node) return;
      // root node toggles expansion
      if (node.dataset.expandRoot) {
        const childDiv = document.querySelector('[data-child=""]');
        if (childDiv) childDiv.classList.toggle('hidden');
        selectNode(node);
        return;
      }
      // if node has children container, toggle open/close
      const hasChildContainer = document.querySelector(`[data-child="${node.dataset.path}"]`);
      if (hasChildContainer) {
        hasChildContainer.classList.toggle('hidden');
      }
      selectNode(node);
    });

    function updateObjectTable() {
      const tbody = document.getElementById('objectTableBody');
      const objectCount = document.getElementById('objectCount');
      tbody.innerHTML = '';
      if (!currentPath) {
        objectCount.textContent = 'Select a container to view its contents.';
        return;
      }
      const filtered = objects.filter(o => o.path.startsWith(currentPath) && o.path !== currentPath && o.path.split('/').length === currentPath.split('/').length + 1);
      filtered.forEach(obj => {
        const row = document.createElement('tr');
        row.className = 'table-row';
        row.dataset.name = obj.name;
        row.dataset.path = obj.path;
        const icon = obj.type === 'User' ? 'üë§' : obj.type === 'Computer' ? 'üíª' : obj.type === 'Security Group' ? 'üë•' : 'üìÅ';
        row.innerHTML = `<td class="p-2">${icon} ${obj.name}</td><td class="p-2">${obj.type}</td><td class="p-2">${obj.description || ''}</td>`;
        row.addEventListener('click', () => {
          document.querySelectorAll('.table-row').forEach(r => r.classList.remove('bg-blue-100'));
          row.classList.add('bg-blue-100');
        });
        row.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (obj.type === 'User') {
            showContextMenu(e, obj);
          }
        });
        row.addEventListener('dblclick', () => {
          if (obj.type === 'User') openProperties(obj.name);
        });
        tbody.appendChild(row);
      });
      objectCount.textContent = `${filtered.length} object(s)`;
    }

    // ---------- CONTEXT MENU ----------
    const contextMenu = document.getElementById('contextMenu');
    function showContextMenu(e, obj) {
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.display = 'block';
      contextMenu.dataset.user = obj.name;
      document.addEventListener('click', hideContextMenu, { once:true });
    }
    function hideContextMenu() { contextMenu.style.display = 'none'; }
    contextMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.context-menu-item');
      if (!item) return;
      if (item.dataset.action === 'properties') {
        const uname = contextMenu.dataset.user;
        openProperties(uname);
      }
      hideContextMenu();
    });

    // ---------- PROPERTIES MODAL ----------
    const propertiesModal = document.getElementById('propertiesModal');
    const propUserSpan = document.getElementById('propUser');
    const genName = document.getElementById('genName');
    const genDept = document.getElementById('genDept');
    const genOffice = document.getElementById('genOffice');
    const memberList = document.getElementById('memberList');
    const propApplyBtn = document.getElementById('propApply');

    let currentUser = null;

    function openProperties(uname) {
      currentUser = uname;
      propUserSpan.textContent = uname;
      genName.textContent = uname;
      genDept.textContent = userState[uname]?.dept || '‚Äî';
      genOffice.textContent = userState[uname]?.office || '‚Äî';
      selectTab('general');
      renderMemberList();
      propertiesModal.style.display = 'flex';
    }

    function closeProperties() {
      propertiesModal.style.display = 'none';
    }
    document.getElementById('propCloseX').addEventListener('click', closeProperties);
    document.getElementById('propCancel').addEventListener('click', closeProperties);
    document.getElementById('propOK').addEventListener('click', () => { closeProperties(); showToast('User added to group'); });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => selectTab(tab.dataset.tab));
    });
    function selectTab(name) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
      document.querySelectorAll('.tabpanel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + name));
    }

    function renderMemberList() {
      const groups = userState[currentUser]?.memberOf || [];
      memberList.innerHTML = '';
      groups.forEach(g => {
        const row = document.createElement('div');
        row.className = 'flex justify-between items-center border-b border-gray-100 py-1';
        row.innerHTML = `<div>${g}</div>
                         <div title="Primary group"><input type="radio" name="primary" ${g === 'Domain Users' ? 'checked' : ''}></div>`;
        memberList.appendChild(row);
      });
      document.getElementById('removeGroup').disabled = true;
      propApplyBtn.disabled = true;
    }

    // Add Group flow
    const addGroupModal = document.getElementById('addGroupModal');
    document.getElementById('addGroup').addEventListener('click', () => {
      document.getElementById('groupInput').value = '';
      document.getElementById('groupError').classList.add('hidden');
      addGroupModal.style.display = 'flex';
    });
    document.getElementById('grpCancel').addEventListener('click', () => addGroupModal.style.display = 'none');
    document.getElementById('grpOK').addEventListener('click', () => {
      const val = (document.getElementById('groupInput').value || '').trim();
      const exists = objects.some(o => o.type === 'Security Group' && o.name.toLowerCase() === val.toLowerCase());
      if (!exists) {
        document.getElementById('groupError').classList.remove('hidden');
        return;
      }
      const groups = userState[currentUser].memberOf;
      if (!groups.includes(val)) {
        groups.push(val);
        propApplyBtn.disabled = false;
      }
      renderMemberList();
      addGroupModal.style.display = 'none';
    });

    document.getElementById('propApply').addEventListener('click', () => {
      propApplyBtn.disabled = true;
      showToast('Group membership updated');
    });

    // ---------- RESET / CLOSE ----------
    document.getElementById('resetLab').addEventListener('click', () => {
      userState['Liam Carter'] = { memberOf:['Domain Users'], dept:'Finance', office:'London' };
      currentPath = '';
      history = ['']; historyIndex = 0;
      document.querySelectorAll('[data-child]').forEach(div => div.classList.add('hidden'));
      // Re-select root
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      document.querySelector('.tree-node[data-path=""]').classList.add('active');
      updateObjectTable();
      closeProperties();
      addGroupModal.style.display = 'none';
      showToast('Lab reset to initial state');
    });

    document.getElementById('closeLab').addEventListener('click', () => {
      window.close();
      setTimeout(() => { window.location.href = 'about:blank'; }, 300);
    });

    // ---------- TIME & CALENDAR (match dev placement/feel) ----------
    const timeWidget = document.getElementById('timeWidget');
    const currentTimeSpan = document.getElementById('currentTime');
    const currentDateSpan = document.getElementById('currentDate');
    const calendarModal = document.getElementById('calendarModal');
    const calendarBody = document.getElementById('calendarBody');
    const calendarMonthYear = document.getElementById('calendarMonthYear');

    function updateTime() {
      const now = new Date();
      currentTimeSpan.textContent = now.toLocaleTimeString('en-GB', { hour12: true, hour: '2-digit', minute: '2-digit' });
      currentDateSpan.textContent = now.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    }
    setInterval(updateTime, 1000); updateTime();

    let calMonth = (new Date()).getMonth();
    let calYear = (new Date()).getFullYear();

    function updateCalendar() {
      calendarMonthYear.textContent = new Date(calYear, calMonth).toLocaleString('en-GB', { month:'long', year:'numeric' });
      calendarBody.innerHTML = '';
      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
      let row = document.createElement('tr');
      for (let i = 0; i < firstDay; i++) row.innerHTML += '<td></td>';
      for (let day = 1; day <= daysInMonth; day++) {
        if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
          calendarBody.appendChild(row);
          row = document.createElement('tr');
        }
        const isToday = (day === (new Date()).getDate() && calMonth === (new Date()).getMonth() && calYear === (new Date()).getFullYear());
        row.innerHTML += `<td class="p-1 text-center ${isToday ? 'bg-blue-200' : ''}">${day}</td>`;
      }
      calendarBody.appendChild(row);
    }

    function toggleCalendar() {
      const vis = calendarModal.style.display === 'flex';
      calendarModal.style.display = vis ? 'none' : 'flex';
      if (!vis) updateCalendar();
    }

    document.getElementById('prevMonthBtn').addEventListener('click', () => { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } updateCalendar(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } updateCalendar(); });
    document.getElementById('closeCalendar').addEventListener('click', () => calendarModal.style.display = 'none');
    timeWidget.addEventListener('click', toggleCalendar);

    // ---------- INIT ----------
    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg || 'Done';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 1800);
    }

    // start collapsed with root selected, like dev
    updateObjectTable();
  </script>
</body>
</html>
