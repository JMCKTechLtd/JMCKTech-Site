<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lab 26: OneDrive Sync (SharePoint Shortcut Path Too Long)</title>
<style>
/* Realistic Windows 10/11 + OneDrive styling */
html, body { height: 100%; margin: 0; font-family: "Segoe UI", Arial, sans-serif; background: #f3f3f3; color: #1f1f1f; overflow: hidden; }
#desktop { position: absolute; inset: 0 0 48px 0; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==') #f3f3f3; padding: 12px; }

/* Windows */
.window { position: absolute; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none; flex-direction: column; overflow: hidden; min-width: 300px; min-height: 200px; resize: both; }
.window-header { background: #f3f3f3; padding: 4px 8px; display: flex; align-items: center; gap: 4px; cursor: move; border-bottom: 1px solid #ddd; user-select: none; }
.window-title { font-weight: 600; flex: 1; font-size: 12px; }
.window-controls { display: flex; gap: 4px; }
.window-control { width: 24px; height: 24px; border-radius: 50%; background: transparent; display: grid; place-items: center; cursor: pointer; font-size: 12px; color: #666; transition: background 0.2s; }
.window-control:hover { background: #e5e5e5; }
.window-control[data-close]:hover { background: #c75050; color: #fff; }
.window-body { padding: 12px; overflow: auto; flex: 1; font-size: 13px; line-height: 1.5; }

/* Start Menu */
.start-menu { position: absolute; bottom: 52px; left: 8px; width: 520px; height: 420px; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; overflow: hidden; z-index: 200; }
.start-menu-header { padding: 12px 16px; background: #f3f3f3; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 14px; color: #1f1f1f; }
.start-menu-body { display: grid; grid-template-columns: 1fr 1fr; height: calc(100% - 48px); }
.start-menu-left { padding: 12px; }
.app-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
.app-item:hover { background: #f0f0f0; }
.app-item .icon { width: 28px; height: 28px; border-radius: 4px; background: #0078d4; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #fff; }
.instructions-icon { background: #ff6b35 !important; }

/* Taskbar */
.taskbar { position: absolute; bottom: 0; width: 100%; height: 48px; background: #f3f3f3; border-top: 1px solid #ddd; display: flex; align-items: center; padding: 0 8px; z-index: 100; box-shadow: 0 -1px 4px rgba(0,0,0,0.1); }
.start-button { color: #1f1f1f; font-weight: 600; display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; font-size: 13px; background: transparent; cursor: pointer; }
.start-button:hover { background: #e5e5e5; }
.windows-logo { width: 18px; height: 18px; }
.system-tray { display: flex; align-items: center; color: #1f1f1f; font-size: 12px; gap: 8px; margin-left: auto; }
.tray-chip { display: flex; align-items: center; gap: 4px; height: 28px; padding: 0 8px; background: transparent; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
.tray-chip:hover { background: #e5e5e5; }
.tray-time { min-width: 100px; justify-content: center; font-variant-numeric: tabular-nums; }

/* Context menus */
.context-menu { position: absolute; display: none; background: #fff; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 400; min-width: 220px; }
.context-menu-item { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 13px; transition: background 0.2s; border-bottom: 1px solid #eee; }
.context-menu-item:last-child { border-bottom: none; }
.context-menu-item:hover { background: #f0f0f0; }
.context-menu-item .icon { width: 16px; height: 16px; margin-right: 8px; }

/* Toast */
#toast { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 8px 12px; border-radius: 4px; display: none; z-index: 500; font-size: 13px; }

/* Modal */
.sim-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 520; }
.sim-dialog { width: 360px; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; }
.sim-dialog-header { padding: 8px 12px; background: #f3f3f3; font-weight: 600; border-bottom: 1px solid #ddd; }
.sim-dialog-body { padding: 12px; font-size: 13px; line-height: 1.4; }
.sim-dialog-actions { display: flex; gap: 8px; justify-content: flex-end; padding: 8px 12px; background: #f9f9f9; border-top: 1px solid #ddd; }
.sim-btn { background: #f3f3f3; border: 1px solid #ccc; color: #1f1f1f; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
.sim-btn:hover { background: #e5e5e5; }
.sim-btn-primary { background: #0078d4; border-color: #0078d4; color: #fff; }
.sim-btn-primary:hover { background: #0067b8; }

/* Tray Popover */
.tray-popover { position: absolute; display: none; min-width: 280px; background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 400; overflow: hidden; }
.pop-header { padding: 8px 12px; background: #f3f3f3; border-bottom: 1px solid #ddd; font-weight: 600; font-size: 12px; }
.pop-body { padding: 12px; font-size: 13px; }

/* Lists / banners */
.toolbar { display: flex; gap: 8px; margin: 8px 0; }
.badge { padding: 2px 8px; border-radius: 12px; border: 1px solid #ddd; background: #f3f3f3; font-size: 12px; color: #333; }
.list { border: 1px solid #ddd; border-radius: 4px; background: #fff; }
.item { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 8px 12px; border-bottom: 1px solid #eee; transition: background 0.2s; }
.item:last-child { border-bottom: none; }
.item:hover { background: #f9f9f9; }
.name { display: flex; align-items: center; gap: 8px; }
.ell { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 580px; }
.banner { padding: 8px 12px; border-radius: 4px; margin: 8px 0; font-size: 13px; }
.banner-warn { background: #fff8e1; border: 1px solid #ffb900; color: #8a6100; }
.banner-ok { background: #e8f5e8; border: 1px solid #b7f0d0; color: #0b5d3b; }
.banner-info { background: #e3f2fd; border: 1px solid #91caff; color: #0050b3; }
.small { font-size: 12px; color: #666; }

/* Progress */
.progress-bar { width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; background: #0078d4; transition: width 0.3s ease; width: 0%; }
.syncing { animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

/* Error details */
.error-details { background: #fff5f5; border: 1px solid #ffcdd2; border-radius: 4px; padding: 8px; margin: 8px 0; font-size: 12px; }
.error-code { font-family: monospace; background: #ffebee; padding: 2px 6px; border-radius: 3px; }
</style>
</head>
<body>
  <div id="desktop">
    <!-- Instructions -->
    <div class="window" id="instructionsWindow" style="left:20px;top:20px;width:520px;height:420px;display:flex;">
      <div class="window-header">
        <div class="window-title">Lab Instructions ‚Äî OneDrive Sync (SharePoint Shortcut Path Too Long)</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="task-title" style="font-weight:600;color:#fff;background:#0078d4;padding:8px 12px;border-radius:4px;display:inline-block;margin-bottom:10px;">Goal: Resolve sync failure by removing an over-length SharePoint shortcut</div>
        <ol style="margin:0 0 10px 18px; line-height:1.6; color: #333;">
          <li><input type="checkbox" id="s1"> Open the <b>OneDrive tray</b> (click the OneDrive chip).</li>
          <li><input type="checkbox" id="s2"> Click <b>View sync problems</b>.</li>
          <li><input type="checkbox" id="s3"> Try <b>Sync now</b> ‚Äî observe it still fails.</li>
          <li><input type="checkbox" id="s4"> In <b>OneDrive (Local)</b>, <b>right-click &gt; Delete</b> the shortcut ‚Äî see <b>Unable to delete</b>.</li>
          <li><input type="checkbox" id="s5"> Open <b>OneDrive Online</b> (Start ‚Üí Browser).</li>
          <li><input type="checkbox" id="s6"> Right-click the <b>shortcut</b> online.</li>
          <li><input type="checkbox" id="s7"> <b>Delete</b> the shortcut online.</li>
          <li><input type="checkbox" id="s8"> Verify the tray reads <b>Up to date</b> and the local shortcut vanishes.</li>
        </ol>
        <div class="note" style="font-size:12px;color:#666;">Modern OneDrive/SharePoint path limit ‚âà <b>400</b> characters. The target here intentionally exceeds it.</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="resetLab" class="sim-btn">Reset Lab</button>
          <button id="closeLab" class="sim-btn">Close Lab</button>
        </div>
      </div>
    </div>

    <!-- Sync Problems -->
    <div class="window" id="syncWindow" style="left:280px;top:80px;width:740px;height:360px;">
      <div class="window-header">
        <div class="window-title">OneDrive ‚Äî Sync Problems</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="banner banner-warn" id="bannerWarn">
          <b>SharePoint shortcut can't sync ‚Äî full path is too long.</b> 
          <div class="error-details">
            <div><b>Error 0x80010135 (PathTooLongException)</b></div>
            <div>Target path exceeds 400 character limit: <span class="error-code">\\sharepoint\sites\ProjectX\VeryLongFolderNameThatExceedsMaximumPathLength\AnotherExtremelyLongSubfolderName\EvenMoreCharactersAddedHere\FinalSubfolderWithExcessiveLength\TheActualTargetDocument.pdf</span></div>
          </div>
          Open OneDrive Online from the <b>Start menu</b> to remove the shortcut.
        </div>
        <div class="banner banner-ok" id="bannerOk" style="display:none">‚úî No sync issues. OneDrive is <b>Up to date</b>.</div>
        <div class="banner banner-info" id="bannerSyncing" style="display:none">
          <div class="syncing">üîÑ Syncing changes...</div>
          <div class="progress-bar"><div class="progress-fill" id="syncProgress"></div></div>
        </div>
        <div class="small" style="margin:6px 0 10px"><b>Item:</b> Project X (SharePoint shortcut)</div>
        <div class="toolbar">
          <button id="btnSyncNow" class="sim-btn sim-btn-primary">Sync now</button>
          <button id="btnViewDetails" class="sim-btn">View error details</button>
        </div>
      </div>
    </div>

    <!-- OneDrive Online -->
    <div class="window" id="webWindow" style="left:180px;top:70px;width:880px;height:520px;">
      <div class="window-header">
        <div class="window-title">OneDrive Online ‚Äî blockshell.app</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="toolbar" style="justify-content:space-between">
          <div>
            <span class="badge">Signed in: joel@blockshell.app</span>
            <span class="badge" style="background:#e8f5e8;border-color:#c8e6c9;color:#2e7d32">Connected</span>
          </div>
          <div class="right">
            <button id="btnRefresh" class="sim-btn">Refresh</button>
            <button id="btnHelp" class="sim-btn">?</button>
          </div>
        </div>

        <div class="list" id="webList">
          <div class="small" style="margin:2px 0 6px"><b>My files</b> (12 items, 2.4 GB used of 5 GB)</div>
          <div class="item"><div class="name"><svg width="24" height="24" viewBox="0 0 24 24" fill="#ffb900"><path d="M20 22H4C2.9 22 2 21.1 2 20V4C2 2.9 2.9 2 4 2H20C21.1 2 22 2.9 22 4V20C22 21.1 21.1 22 20 22ZM5 6H19V4H5V6ZM5 8V20H19V8H5ZM8 18H16V16H8V18ZM8 14H16V12H8V14ZM8 10H16V8H8V10Z"/></svg><div>Documents</div></div><div class="small">Modified 2 days ago ¬∑ 12 items</div></div>
          <div class="item"><div class="name"><svg width="24" height="24" viewBox="0 0 24 24" fill="#ffb900"><path d="M20 22H4C2.9 22 2 21.1 2 20V4C2 2.9 2.9 2 4 2H20C21.1 2 22 2.9 22 4V20C22 21.1 21.1 22 20 22ZM5 6H19V4H5V6ZM5 8V20H19V8H5ZM8 18H16V16H8V18ZM8 14H16V12H8V14ZM8 10H16V8H8V10Z"/></svg><div>Pictures</div></div><div class="small">Modified 1 week ago ¬∑ 5 items</div></div>
          <!-- Problem Shortcut -->
          <div class="item" id="rowShortcut" title="Right-click for options">
            <div class="name">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="#00a4ef"><path d="M3.9 12C3.9 10.29 5.29 8.9 7 8.9H11V7H7C4.79 7 3 8.79 3 11 3 13.21 4.79 15 7 15H11V13.1H7C5.29 13.1 3.9 12.71 3.9 12ZM8 13H16V11H8V13ZM17 9H13V11H17C18.71 11 20.1 11.29 20.1 12 20.1 12.71 18.71 13.1 17 13.1H13V15H17C19.21 15 21 13.21 21 11 21 8.79 19.21 7 17 7H13V8.9H17C18.71 8.9 20.1 10.29 20.1 12Z"/></svg>
              <div class="ell"><b>Project X</b> (SharePoint shortcut)</div>
            </div>
            <div class="badge" style="background:#fff0f0;border-color:#ffcdd2;color:#c62828">Sync error</div>
          </div>
        </div>
      </div>
    </div>

    <!-- File Explorer -->
    <div class="window" id="localWindow" style="left:160px;top:70px;width:760px;height:440px;display:none;">
      <div class="window-header">
        <div class="window-title">File Explorer ‚Äî OneDrive - blockshell.app</div>
        <div class="window-controls">
          <div class="window-control" data-minimize>‚àí</div>
          <div class="window-control" data-maximize>‚ñ°</div>
          <div class="window-control" data-close>‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="toolbar">
          <div class="small"><b>Status:</b> <span id="localStatus">Connected</span> ¬∑ <b>Last sync:</b> <span id="lastSync">2 minutes ago</span></div>
        </div>
        <div class="list" id="localList">
          <div class="small" style="margin:2px 0 6px"><b>OneDrive ‚Äî blockshell.app</b> (Files available online only)</div>
          <div class="item"><div class="name"><svg width="24" height="24" viewBox="0 0 24 24" fill="#ffb900"><path d="M20 22H4C2.9 22 2 21.1 2 20V4C2 2.9 2.9 2 4 2H20C21.1 2 22 2.9 22 4V20C22 21.1 21.1 22 20 22ZM5 6H19V4H5V6ZM5 8V20H19V8H5ZM8 18H16V16H8V18ZM8 14H16V12H8V14ZM8 10H16V8H8V10Z"/></svg><div>Documents</div></div><div class="small">3 items ¬∑ Online</div></div>
          <div class="item"><div class="name"><svg width="24" height="24" viewBox="0 0 24 24" fill="#ffb900"><path d="M20 22H4C2.9 22 2 21.1 2 20V4C2 2.9 2.9 2 4 2H20C21.1 2 22 2.9 22 4V20C22 21.1 21.1 22 20 22ZM5 6H19V4H5V6ZM5 8V20H19V8H5ZM8 18H16V16H8V18ZM8 14H16V12H8V14ZM8 10H16V8H8V10Z"/></svg><div>Pictures</div></div><div class="small">2 items ¬∑ Online</div></div>
          <div class="item" id="localShortcut" title="Right-click for options">
            <div class="name">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="#00a4ef"><path d="M3.9 12C3.9 10.29 5.29 8.9 7 8.9H11V7H7C4.79 7 3 8.79 3 11 3 13.21 4.79 15 7 15H11V13.1H7C5.29 13.1 3.9 12.71 3.9 12ZM8 13H16V11H8V13ZM17 9H13V11H17C18.71 11 20.1 11.29 20.1 12 20.1 12.71 18.71 13.1 17 13.1H13V15H17C19.21 15 21 13.21 21 11 21 8.79 19.21 7 17 7H13V8.9H17C18.71 8.9 20.1 10.29 20.1 12Z"/></svg>
              <div class="ell"><b>Project X</b> (SharePoint shortcut)</div>
            </div>
            <div class="badge" style="background:#fff0f0;border-color:#ffcdd2;color:#c62828">Sync error</div>
          </div>
        </div>
        <div class="banner banner-info" style="margin-top:12px">
          <small>Some files are available online only to save space. <a href="#" style="color:#0078d4">Change settings</a></small>
        </div>
      </div>
    </div>

    <!-- Context menus -->
    <div class="context-menu" id="shortcutMenuWeb">
      <div class="context-menu-item" id="ctxOpenWeb"><span class="icon">üìÇ</span> Open</div>
      <div class="context-menu-item" id="ctxRenameWeb"><span class="icon">‚úèÔ∏è</span> Rename</div>
      <div class="context-menu-item" id="ctxDeleteWeb"><span class="icon">üóëÔ∏è</span> Delete</div>
      <div class="context-menu-item"><span class="icon">üìã</span> Copy link</div>
      <div class="context-menu-item"><span class="icon">üë•</span> Share</div>
      <div class="context-menu-item" id="ctxDetailsWeb"><span class="icon">‚ÑπÔ∏è</span> Properties</div>
    </div>

    <div class="context-menu" id="shortcutMenuLocal">
      <div class="context-menu-item" id="ctxOpenLocal"><span class="icon">üìÇ</span> Open</div>
      <div class="context-menu-item" id="ctxRenameLocal"><span class="icon">‚úèÔ∏è</span> Rename</div>
      <div class="context-menu-item" id="ctxDeleteLocal"><span class="icon">üóëÔ∏è</span> Delete</div>
      <div class="context-menu-item"><span class="icon">‚≠ê</span> Always keep on this device</div>
      <div class="context-menu-item"><span class="icon">üìä</span> Free up space</div>
      <div class="context-menu-item" id="ctxDetailsLocal"><span class="icon">‚ÑπÔ∏è</span> Properties</div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start-button" id="startButton" title="Start">
      <span class="windows-logo">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="1" y="11" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="11" width="8" height="8" fill="#00BCF9"/>
        </svg>
      </span>
      Start
    </div>
    <div class="taskbar-icons"></div>
    <div class="system-tray" id="systemTray">
      <div class="tray-chip" id="oneDriveChip" title="OneDrive status">
        <span style="width:16px;height:16px;border-radius:3px;background:#00a4ef;display:inline-block"></span>
        <span id="chipText">OneDrive</span>
        <span id="chipDot" style="width:8px;height:8px;border-radius:50%;background:#ffb020;display:inline-block"></span>
      </div>
      <div class="tray-chip tray-time" id="trayTimeChip" title="Date and time">
        <div class="tray-time-col">
          <span id="trayTime">--:--</span>
          <span id="trayDate">-- ---</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">Start</div>
    <div class="start-menu-body">
      <div class="start-menu-left">
        <div class="app-item" data-app="instructions">
          <div class="icon instructions-icon">üìã</div>
          <span>Instructions</span>
        </div>
        <div class="app-item" data-app="onedrive-local">
          <div class="icon" style="background:#00a4ef">‚òÅÔ∏è</div>
          <span>OneDrive (Local)</span>
        </div>
        <div class="app-item" data-app="browser-onedrive">
          <div class="icon" style="background:#4caf50">üåê</div>
          <span>Browser ‚Äî OneDrive Online</span>
        </div>
        <div class="app-item" data-app="file-explorer">
          <div class="icon" style="background:#607d8b">üìÅ</div>
          <span>File Explorer</span>
        </div>
      </div>
      <div class="start-menu-right"><div class="app-list"></div></div>
    </div>
  </div>

  <!-- In-sim modal -->
  <div class="sim-modal" id="simModal">
    <div class="sim-dialog">
      <div class="sim-dialog-header" id="simModalTitle">Notice</div>
      <div class="sim-dialog-body" id="simModalBody">Message</div>
      <div class="sim-dialog-actions">
        <button class="sim-btn" id="simCancel">Cancel</button>
        <button class="sim-btn sim-btn-primary" id="simOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

<script>
// Original logic preserved, with enhancements for smoothness (e.g., drag bounds, resize, random sync delay)
const state = {
  shortcutPresent: true,
  isSyncing: false,
  syncAttempts: 0,
  lastSyncTime: new Date(Date.now() - 120000)
};

const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

function flashToast(msg) {
  const t = $('#toast'); t.textContent = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1400);
}

function showDialog(message, {title = 'Confirm', okText = 'OK', cancelText = 'Cancel', showCancel = true} = {}) {
  return new Promise(resolve => {
    const modal = $('#simModal'), ttl = $('#simModalTitle'), body = $('#simModalBody'), ok = $('#simOk'), cancel = $('#simCancel');
    ttl.textContent = title; body.textContent = message;
    cancel.style.display = showCancel ? 'inline-block' : 'none';
    ok.textContent = okText; cancel.textContent = cancelText;
    const cleanup = () => { modal.style.display = 'none'; ok.onclick = null; cancel.onclick = null; };
    ok.onclick = () => { cleanup(); resolve(true); };
    cancel.onclick = () => { cleanup(); resolve(false); };
    modal.style.display = 'flex';
  });
}

/* Time */
const trayTime = $('#trayTime'), trayDate = $('#trayDate');
function updateTime() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = String(now.getMinutes()).padStart(2, '0');
  trayTime.textContent = h + ':' + m;
  trayDate.textContent = now.toLocaleDateString(undefined, { day: '2-digit', month: 'short' }).replace(' ', ' ');
}
updateTime(); setInterval(updateTime, 60000);

/* Sync Simulation */
function simulateSync() {
  if (state.isSyncing) return;
  state.isSyncing = true;
  state.syncAttempts++;
  const progressBar = $('#syncProgress');
  const syncingBanner = $('#bannerSyncing');
  const warnBanner = $('#bannerWarn');
  syncingBanner.style.display = 'block';
  warnBanner.style.display = 'none';
  progressBar.style.width = '0%';
  setTraySyncing();
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 15 + 5; // Smoother, random progress
    progressBar.style.width = Math.min(progress, 100) + '%';
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        state.isSyncing = false;
        state.lastSyncTime = new Date();
        updateLastSyncTime();
        syncingBanner.style.display = 'none';
        if (state.shortcutPresent) {
          warnBanner.style.display = 'block';
          setTrayIssue();
          flashToast(`Sync failed (attempt ${state.syncAttempts}) - Path too long`);
        } else {
          setTrayOk();
          $('#bannerOk').style.display = 'block';
          flashToast('Sync complete - Up to date');
        }
      }, Math.random() * 500 + 500); // Random delay for realism
    }
  }, 100);
}

function updateLastSyncTime() {
  const lastSync = $('#lastSync');
  if (lastSync) {
    const now = new Date();
    const diff = Math.floor((now - state.lastSyncTime) / 60000);
    if (diff === 0) lastSync.textContent = 'Just now';
    else if (diff === 1) lastSync.textContent = '1 minute ago';
    else lastSync.textContent = `${diff} minutes ago`;
  }
}

/* Start Menu */
const startButton = $('#startButton'), startMenu = $('#startMenu');
startButton.addEventListener('click', (e) => {
  e.stopPropagation();
  startMenu.style.display = startMenu.style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click', (e) => {
  if (!startMenu.contains(e.target) && e.target !== startButton) {
    startMenu.style.display = 'none';
  }
});

$$('.app-item').forEach(el => {
  el.addEventListener('click', (e) => {
    e.stopPropagation();
    startMenu.style.display = 'none';
    const app = el.getAttribute('data-app');
    if (app === 'instructions') $('#instructionsWindow').style.display = 'flex';
    if (app === 'onedrive-local') $('#localWindow').style.display = 'flex';
    if (app === 'browser-onedrive') {
      $('#webWindow').style.display = 'flex';
      const s5 = $('#s5');
      if (s5) s5.checked = true;
    }
    if (app === 'file-explorer') {
      $('#localWindow').style.display = 'flex';
      flashToast('Opening File Explorer...');
    }
  });
});

/* Window controls / drag / resize */
document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); btn.closest('.window').style.display = 'none'; }));
document.querySelectorAll('[data-minimize]').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); btn.closest('.window').style.display = 'none'; }));
document.querySelectorAll('[data-maximize]').forEach(btn => btn.addEventListener('click', e => {
  e.stopPropagation(); const w = btn.closest('.window');
  if (w.style.width === '100%') {
    if (w.id === 'instructionsWindow') Object.assign(w.style, {width: '520px', height: '420px', top: '20px', left: '20px'});
    else if (w.id === 'syncWindow') Object.assign(w.style, {width: '740px', height: '360px', top: '80px', left: '280px'});
    else if (w.id === 'localWindow') Object.assign(w.style, {width: '760px', height: '440px', top: '70px', left: '160px'});
    else Object.assign(w.style, {width: '880px', height: '520px', top: '70px', left: '180px'});
  } else Object.assign(w.style, {width: '100%', height: 'calc(100% - 48px)', top: '0', left: '0'});
}));
let dragWin = null, sx = 0, sy = 0, ix = 0, iy = 0, dragging = false;
document.querySelectorAll('.window-header').forEach(h => {
  h.addEventListener('mousedown', e => {
    if (e.target.closest('.window-control')) return;
    e.preventDefault(); dragWin = h.closest('.window'); dragging = true; sx = e.clientX; sy = e.clientY;
    ix = parseInt(dragWin.style.left || getComputedStyle(dragWin).left); iy = parseInt(dragWin.style.top || getComputedStyle(dragWin).top);
    document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag);
  });
});
function onDrag(e) {
  if (!dragging || !dragWin) return;
  let newLeft = ix + (e.clientX - sx);
  let newTop = iy + (e.clientY - sy);
  newLeft = Math.max(0, Math.min(window.innerWidth - dragWin.offsetWidth, newLeft));
  newTop = Math.max(0, Math.min(window.innerHeight - dragWin.offsetHeight - 48, newTop)); // Bound to desktop
  dragWin.style.left = newLeft + 'px';
  dragWin.style.top = newTop + 'px';
}
function stopDrag() { dragging = false; dragWin = null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }

/* Tray popovers */
const systemTray = $('#systemTray'), trayTimeChip = $('#trayTimeChip');
function makePopover(html) { const el = document.createElement('div'); el.className = 'tray-popover'; el.innerHTML = html; document.body.appendChild(el); return el; }
function togglePopover(pop, anchor) {
  const r = anchor.getBoundingClientRect();
  pop.style.right = (window.innerWidth - r.right) + 'px';
  pop.style.bottom = (window.innerHeight - r.top + 8) + 'px';
  const open = pop.style.display === 'block';
  $$('.tray-popover').forEach(p => p.style.display = 'none');
  if (!open) pop.style.display = 'block';
}
document.addEventListener('click', e => {
  if (!systemTray.contains(e.target) && !e.target.closest('.tray-popover')) {
    $$('.tray-popover').forEach(p => { p.style.display = 'none'; p.classList.remove('syncing'); });
  }
});

/* Calendar popover (simplified) */
const timePopover = makePopover(`
  <div class="pop-header">Date & time</div>
  <div class="pop-body">
    <div class="calendar">
      <div class="big-clock" id="bigClock">--:--</div>
      <div class="small-date" id="smallDate">-- ---, ----</div>
      <div class="cal-header"><span id="prevMonth" style="cursor:pointer">‚Äπ</span><span class="month" id="monthLabel">Month Year</span><span id="nextMonth" style="cursor:pointer">‚Ä∫</span></div>
      <div class="grid" id="calGrid"><div class="dow">Su</div><div class="dow">Mo</div><div class="dow">Tu</div><div class="dow">We</div><div class="dow">Th</div><div class="dow">Fr</div><div class="dow">Sa</div></div>
    </div>
  </div>
`);
function updateClockAndDate() { const now = new Date(); $('#bigClock').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; $('#smallDate').textContent = now.toLocaleDateString(undefined, {weekday: 'short', day: '2-digit', month: 'short', year: 'numeric'}); }
let calRef = new Date();
function renderCalendar(ref) {
  const monthLabel = $('#monthLabel'), grid = $('#calGrid');
  Array.from(grid.querySelectorAll('.day')).forEach(d => d.remove());
  const y = ref.getFullYear(), m = ref.getMonth();
  monthLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, {month: 'long', year: 'numeric'});
  const first = new Date(y, m, 1), startDow = first.getDay(), daysIn = new Date(y, m + 1, 0).getDate(), prevDays = new Date(y, m, 0).getDate();
  for (let i = startDow - 1; i >= 0; i--) {
    const el = document.createElement('div');
    el.className = 'day other';
    el.textContent = (prevDays - i);
    grid.appendChild(el);
  }
  const today = new Date();
  const highlight = (today.getFullYear() === y && today.getMonth() === m) ? today.getDate() : -1;
  for (let d = 1; d <= daysIn; d++) {
    const el = document.createElement('div');
    el.className = 'day';
    el.textContent = d;
    if (d === highlight) el.classList.add('today');
    grid.appendChild(el);
  }
  const total = grid.querySelectorAll('.dow').length + grid.querySelectorAll('.day').length;
  const rem = total % 7;
  if (rem !== 0) {
    const need = 7 - rem;
    for (let d = 1; d <= need; d++) {
      const el = document.createElement('div');
      el.className = 'day other';
      el.textContent = d;
      grid.appendChild(el);
    }
  }
}
document.addEventListener('click', e => {
  if (e.target && e.target.id === 'prevMonth') {
    e.stopPropagation();
    calRef = new Date(calRef.getFullYear(), calRef.getMonth() - 1, 1);
    renderCalendar(calRef);
  }
  if (e.target && e.target.id === 'nextMonth') {
    e.stopPropagation();
    calRef = new Date(calRef.getFullYear(), calRef.getMonth() + 1, 1);
    renderCalendar(calRef);
  }
});
if (trayTimeChip) {
  trayTimeChip.addEventListener('click', e => {
    e.stopPropagation();
    updateClockAndDate();
    renderCalendar(calRef);
    togglePopover(timePopover, trayTimeChip);
  });
}

/* OneDrive State */
const chipText = $('#chipText'), chipDot = $('#chipDot');
const oneDriveChip = $('#oneDriveChip');
const bannerOk = $('#bannerOk'), bannerWarn = $('#bannerWarn');
const localShortcut = $('#localShortcut'), webShortcut = $('#rowShortcut');

function setTrayIssue() {
  chipText.textContent = 'OneDrive - Attention needed';
  chipDot.style.background = '#ffb020';
  oneDriveChip.classList.add('syncing');
}

function setTraySyncing() {
  chipText.textContent = 'OneDrive - Syncing...';
  chipDot.style.background = '#1976d2';
  oneDriveChip.classList.add('syncing');
}

function setTrayOk() {
  chipText.textContent = 'OneDrive - Up to date';
  chipDot.style.background = '#1ec776';
  oneDriveChip.classList.remove('syncing');
}

function paint() {
  updateLastSyncTime();
  if (state.shortcutPresent) {
    setTrayIssue();
    bannerOk.style.display = 'none';
    bannerWarn.style.display = 'block';
    webShortcut.style.display = 'flex';
    localShortcut.style.display = 'flex';
  } else {
    setTrayOk();
    bannerWarn.style.display = 'none';
    bannerOk.style.display = 'block';
    webShortcut.style.display = 'none';
    localShortcut.style.display = 'none';
  }
}

/* OneDrive Popover */
const oneDrivePopover = makePopover(`
  <div class="pop-header">OneDrive ‚Äî blockshell.app</div>
  <div class="pop-body" id="odPopBody"></div>
`);
function fillOneDrivePopover() {
  const body = oneDrivePopover.querySelector('#odPopBody');
  if (state.shortcutPresent) {
    body.innerHTML = `
      <div class="row" style="margin-bottom:8px">
        <div style="width:9px;height:9px;border-radius:50%;background:#ffb020"></div>
        <div><b>Sync issue</b> ¬∑ ${state.syncAttempts} failed attempts</div>
      </div>
      <div class="row" style="align-items:flex-start;margin-bottom:8px">
        <div style="width:18px;height:18px;border-radius:4px;background:#00a4ef"></div>
        <div>
          <div><b>SharePoint shortcut can't sync</b></div>
          <div class="muted">Path exceeds 400 character limit ¬∑ 0x80010135</div>
          <div class="muted">Delete the shortcut online to resolve.</div>
        </div>
      </div>
      <div style="margin:12px 0; padding:8px; background:#f9f9f9; border-radius:4px;">
        <div class="small"><b>Last sync:</b> ${Math.floor((new Date() - state.lastSyncTime) / 60000)} minutes ago</div>
        <div class="small"><b>Files synced:</b> 147 of 148</div>
      </div>
      <div class="row" style="gap:8px;margin-top:8px">
        <button id="popView" class="sim-btn">View sync problems</button>
        <button id="popSync" class="sim-btn">Sync now</button>
        <button id="popDismiss" class="sim-btn">Dismiss</button>
      </div>`;
  } else {
    body.innerHTML = `
      <div class="row" style="margin-bottom:8px">
        <div style="width:9px;height:9px;border-radius:50%;background:#1ec776"></div>
        <div><b>Up to date</b></div>
      </div>
      <div class="muted" style="margin-bottom:10px">All files are synced.</div>
      <div style="margin:12px 0; padding:8px; background:#f9f9f9; border-radius:4px;">
        <div class="small"><b>Last sync:</b> Just now</div>
        <div class="small"><b>Files synced:</b> 147 of 147</div>
        <div class="small"><b>Storage:</b> 2.4 GB of 5 GB used</div>
      </div>
      <div class="row" style="gap:8px;margin-top:4px">
        <button id="popSync" class="sim-btn">Sync now</button>
        <button id="popDismiss" class="sim-btn">Close</button>
      </div>`;
  }
  const dis = oneDrivePopover.querySelector('#popDismiss');
  if (dis) dis.addEventListener('click', () => oneDrivePopover.style.display = 'none');
  const view = oneDrivePopover.querySelector('#popView');
  if (view) view.addEventListener('click', () => {
    oneDrivePopover.style.display = 'none';
    $('#syncWindow').style.display = 'flex';
    const s2 = $('#s2');
    if (s2) s2.checked = true;
  });
  const sync = oneDrivePopover.querySelector('#popSync');
  if (sync) sync.addEventListener('click', () => {
    oneDrivePopover.style.display = 'none';
    simulateSync();
    if (state.shortcutPresent) {
      const s3 = $('#s3');
      if (s3) s3.checked = true;
    }
  });
}
oneDriveChip.addEventListener('click', e => {
  e.stopPropagation();
  fillOneDrivePopover();
  togglePopover(oneDrivePopover, oneDriveChip);
  const s1 = $('#s1');
  if (s1) s1.checked = true;
});

/* Sync Problems Buttons */
$('#btnSyncNow').addEventListener('click', () => {
  simulateSync();
  if (state.shortcutPresent) {
    const s3 = $('#s3');
    if (s3) s3.checked = true;
  }
});

$('#btnViewDetails').addEventListener('click', () => {
  showDialog(
    `Error Details:\n\n` +
    `Error Code: 0x80010135 (PathTooLongException)\n` +
    `File: Project X (SharePoint shortcut)\n` +
    `Issue: Target path exceeds 400 character limit\n\n` +
    `Full target path:\n` +
    `\\\\sharepoint\\sites\\ProjectX\\VeryLongFolderNameThatExceedsMaximumPathLength\\AnotherExtremelyLongSubfolderName\\EvenMoreCharactersAddedHere\\FinalSubfolderWithExcessiveLength\\TheActualTargetDocument.pdf\n\n` +
    `Resolution: Delete the shortcut from OneDrive Online.`,
    {title: 'Sync Error Details', okText: 'OK', showCancel: false}
  );
});

/* Context Menus: Web */
const menuWeb = $('#shortcutMenuWeb');
if (webShortcut) {
  webShortcut.addEventListener('contextmenu', e => {
    e.preventDefault();
    menuWeb.style.left = e.pageX + 'px';
    menuWeb.style.top = e.pageY + 'px';
    menuWeb.style.display = 'block';
    const s6 = $('#s6');
    if (s6) s6.checked = true;
  });
}
document.addEventListener('click', e => {
  if (!menuWeb.contains(e.target) && e.target !== webShortcut) menuWeb.style.display = 'none';
});

$('#ctxOpenWeb').addEventListener('click', () => { menuWeb.style.display = 'none'; flashToast('Redirecting to SharePoint...'); });
$('#ctxRenameWeb').addEventListener('click', () => { menuWeb.style.display = 'none'; flashToast('Renaming alias won\'t change the long SharePoint target path.'); });
$('#ctxDetailsWeb').addEventListener('click', () => {
  menuWeb.style.display = 'none';
  showDialog(
    'Properties:\n\n' +
    'Name: Project X\n' +
    'Type: SharePoint Shortcut\n' +
    'Location: OneDrive - blockshell.app\n' +
    'Target: (Path exceeds 400 characters)\n' +
    'Status: Sync error - Path too long\n' +
    'Created: 2 weeks ago\n' +
    'Modified: 3 days ago',
    {title: 'Properties', okText: 'OK', showCancel: false}
  );
});
$('#ctxDeleteWeb').addEventListener('click', async () => {
  menuWeb.style.display = 'none';
  const yes = await showDialog('Delete "Project X" shortcut? This will remove the shortcut from your OneDrive. The original file in SharePoint will not be affected.', {title: 'Delete Shortcut', okText: 'Delete'});
  if (!yes) return;
  flashToast('Deleting shortcut...');
  oneDriveChip.classList.add('syncing');
  setTimeout(() => {
    state.shortcutPresent = false;
    paint();
    const s7 = $('#s7');
    if (s7) s7.checked = true;
    flashToast('Shortcut deleted. Syncing changes...');
    setTimeout(() => {
      simulateSync();
      setTimeout(() => { 
        flashToast('Up to date'); 
        const s8 = $('#s8');
        if (s8) s8.checked = true; 
      }, 1500);
    }, 800);
  }, 1000);
});

/* Context Menus: Local */
const menuLocal = $('#shortcutMenuLocal');
if (localShortcut) {
  localShortcut.addEventListener('contextmenu', e => {
    e.preventDefault();
    menuLocal.style.left = e.pageX + 'px';
    menuLocal.style.top = e.pageY + 'px';
    menuLocal.style.display = 'block';
  });
}
document.addEventListener('click', e => {
  if (!menuLocal.contains(e.target) && e.target !== localShortcut) menuLocal.style.display = 'none';
});

$('#ctxOpenLocal').addEventListener('click', () => { menuLocal.style.display = 'none'; flashToast('This shortcut cannot open - sync error'); });
$('#ctxRenameLocal').addEventListener('click', () => { menuLocal.style.display = 'none'; flashToast('Cannot rename - managed from SharePoint/Online'); });
$('#ctxDetailsLocal').addEventListener('click', () => {
  menuLocal.style.display = 'none';
  showDialog(
    'Properties:\n\n' +
    'Name: Project X\n' +
    'Type: SharePoint Shortcut\n' +
    'Status: Sync error\n' +
    'Location: This device only\n' +
    'Size: Not available\n' +
    'Date modified: Not available\n\n' +
    'This item is managed by SharePoint Online.\nTo resolve sync issues, delete it from OneDrive Online.',
    {title: 'Properties', okText: 'OK', showCancel: false}
  );
});
$('#ctxDeleteLocal').addEventListener('click', async () => {
  menuLocal.style.display = 'none';
  const s4 = $('#s4');
  if (s4) s4.checked = true;
  flashToast('Attempting to delete...');
  await new Promise(resolve => setTimeout(resolve, 800));
  await showDialog(
    'Unable to delete this SharePoint shortcut locally.\n\n' +
    'This shortcut is managed by SharePoint Online. To remove it, please:\n\n' +
    '1. Open OneDrive Online\n' +
    '2. Locate the "Project X" shortcut\n' +
    '3. Right-click and select "Delete"\n\n' +
    'The change will sync to this device automatically.',
    {title: 'Unable to delete', okText: 'OK', showCancel: false}
  );
});

/* Reset & Close */
const resetLab = $('#resetLab'), closeLabBtn = $('#closeLab');

function attemptCloseWindow() {
  window.close();
  try {
    const selfWin = window.open('', '_self');
    if (selfWin) { selfWin.opener = null; selfWin.close(); }
  } catch (e) {}
  setTimeout(() => {
    try { window.location.replace('about:blank'); } catch (e) { window.location.href = 'about:blank'; }
  }, 300);
}

resetLab.addEventListener('click', () => {
  state.shortcutPresent = true;
  state.syncAttempts = 0;
  state.isSyncing = false;
  state.lastSyncTime = new Date(Date.now() - 120000);
  paint();
  $('#instructionsWindow').style.display = 'flex';
  Object.assign($('#instructionsWindow').style, {left: '20px', top: '20px', width: '520px', height: '420px'});
  $('#syncWindow').style.display = 'none';
  $('#webWindow').style.display = 'none';
  $('#localWindow').style.display = 'none';
  $$('.tray-popover').forEach(p => { p.style.display = 'none'; p.classList.remove('syncing'); });
  for (let i = 1; i <= 8; i++) {
    const checkbox = $('#s' + i);
    if (checkbox) checkbox.checked = false;
  }
  flashToast('Lab reset to initial state');
});

closeLabBtn.addEventListener('click', async () => {
  const yes = await showDialog('Are you sure you want to close this browser window?', {title: 'Exit Lab', okText: 'Close'});
  if (!yes) return;
  flashToast('Closing lab...');
  setTimeout(attemptCloseWindow, 200);
});

/* Initialization */
function initializeLab() {
  $('#instructionsWindow').style.display = 'flex';
  paint();
  updateClockAndDate();
  renderCalendar(calRef);
  setInterval(() => updateClockAndDate(), 60000);
  setInterval(() => updateLastSyncTime(), 30000);
  // Auto-sync every 5 minutes
  setInterval(() => {
    if (!state.isSyncing && state.shortcutPresent) {
      state.lastSyncTime = new Date();
      updateLastSyncTime();
    }
  }, 300000);
}

// Start
initializeLab();
</script>
</body>
</html>