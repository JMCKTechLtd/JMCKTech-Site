<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lab 25: Microsoft 365 Admin Center - License Management</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .drawer-enter { transform: translateX(100%); opacity: 0; }
    .drawer-enter-active { transform: translateX(0); opacity: 1; transition: all .25s ease; }
    .drawer-leave { transform: translateX(0); opacity: 1; }
    .drawer-leave-active { transform: translateX(100%); opacity: 0; transition: all .2s ease; }
    .tag { font-size: .70rem; padding:.1rem .4rem; border-radius:.35rem; }
    .toast { animation: fade 2s ease; }
    @keyframes fade { 0%{opacity:0;transform:translateY(-4px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0;transform:translateY(-4px)}}
    .license-component { border-left: 3px solid #e5e7eb; }
    .license-component.enabled { border-left-color: #10b981; }
    .service-plan-toggle { transform: scale(0.8); }
    .service-plan-mandatory { background-color: #f3f4f6; }
    .conflict-warning { border-left: 3px solid #ef4444; }
    .geo-restricted { opacity: 0.6; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Top Bar -->
  <header class="bg-[#0078d4] text-white px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm4 0h-2v-6h2v6z"/>
      </svg>
      <h1 class="font-semibold">Microsoft 365 admin center</h1>
    </div>
    <div class="flex items-center gap-2 text-sm">
      <span class="hidden sm:inline">Signed in as</span>
      <span class="font-medium">admin@blockshell.app</span>
      <div class="w-8 h-8 rounded-full bg-blue-300 flex items-center justify-center text-xs font-semibold">A</div>
    </div>
  </header>

  <div class="flex h-[calc(100vh-56px)]">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r hidden md:flex flex-col">
      <div class="p-4 border-b">
        <p class="text-xs uppercase tracking-wide text-gray-500 mb-2">Admin centers</p>
        <nav class="space-y-1">
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Azure Active Directory</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Exchange</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">SharePoint</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Teams</a>
        </nav>
      </div>
      <div class="p-4">
        <p class="text-xs uppercase tracking-wide text-gray-500 mb-2">Users</p>
        <nav class="space-y-1">
          <a class="block rounded px-3 py-2 bg-blue-50 text-blue-700 font-medium">Active users</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Groups</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Contacts</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Guest users</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Deleted users</a>
        </nav>
      </div>
      <div class="p-4">
        <p class="text-xs uppercase tracking-wide text-gray-500 mb-2">Billing</p>
        <nav class="space-y-1">
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Licenses</a>
          <a class="block rounded px-3 py-2 hover:bg-gray-50">Billing accounts</a>
        </nav>
      </div>
      <div class="px-4 mt-auto mb-4">
        <button id="resetBtn" class="w-full px-3 py-2 rounded bg-orange-500 text-white hover:bg-orange-600">Reset Lab</button>
        <button id="closeBtn" class="w-full mt-2 px-3 py-2 rounded bg-gray-500 text-white hover:bg-gray-600">Close Lab</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-auto p-4">
      <!-- Instructions -->
      <section class="bg-white rounded shadow p-4 mb-4">
        <h2 class="text-lg font-semibold">Lab Goal — Assign Microsoft 365 Licenses</h2>
        <p class="text-gray-600 mt-1">
          Using the Active users view, assign applicable licenses to selected users. You can assign one user at a time by opening their profile, or perform a bulk license assignment.
        </p>
        <ul class="list-disc list-inside text-gray-700 mt-3 space-y-1">
          <li>Task A: Assign <b>Exchange Online (Plan 1)</b> to <b>App Mailbox</b>.</li>
          <li>Task B: Assign <b>Microsoft 365 Apps for enterprise</b> to <b>Katie Jordan</b> and <b>Owen Patel</b>.</li>
          <li>Task C: Ensure <b>Teams Essentials</b> is enabled for <b>Customer Support</b>.</li>
        </ul>
      </section>

      <!-- Toolbar -->
      <section class="bg-white rounded shadow p-4 mb-4">
        <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
          <div class="flex items-center gap-2">
            <button id="addUserBtn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add a user
            </button>
            <button id="mfaBtn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">Multi-factor authentication</button>
            <button id="refreshBtn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Refresh
            </button>
            <button id="deleteBtn" class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200">Delete users</button>
          </div>
          <div class="flex items-center gap-2">
            <div class="relative">
              <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input id="searchBox" type="search" placeholder="Search users" class="border rounded pl-10 pr-3 py-2 w-64" />
            </div>
            <button id="bulkAssignBtn" class="px-3 py-2 bg-[#0078d4] text-white rounded hover:bg-[#106ebe] disabled:opacity-40 flex items-center gap-2" disabled>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              Assign licenses
            </button>
          </div>
        </div>
      </section>

      <!-- Users Table -->
      <section class="bg-white rounded shadow">
        <div class="p-4 border-b flex items-center justify-between">
          <h3 class="font-semibold text-gray-800">Active users</h3>
          <div class="text-sm text-gray-600">
            <span id="selectedCount">0</span> of <span id="totalCount">0</span> selected
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-50 text-left">
              <tr>
                <th class="px-4 py-2 w-10"><input id="selectAll" type="checkbox"></th>
                <th class="px-4 py-2">Display name</th>
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Licenses</th>
                <th class="px-4 py-2">Roles</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody id="userTbody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Drawer (Profile) -->
  <div id="drawerMask" class="hidden fixed inset-0 bg-black/40"></div>
  <aside id="drawer"
         class="hidden fixed right-0 top-0 h-full w-[520px] bg-white shadow-xl overflow-y-auto">
    <div class="p-4 border-b flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div id="avatar" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-semibold">AM</div>
        <div>
          <h4 id="drawerName" class="font-semibold">App Mailbox</h4>
          <p id="drawerUPN" class="text-sm text-gray-500">app.mailbox@blockshell.app</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-sm">Reset password</button>
        <button class="px-3 py-2 bg-gray-100 rounded hover:bg-gray-200 text-sm">Block sign-in</button>
      </div>
    </div>

    <div class="px-4 pt-3 flex flex-col h-[calc(100%-80px)]">
      <div class="flex gap-1 border-b">
        <button data-tab="account" class="tab px-3 py-2 rounded-t text-sm text-gray-700 hover:bg-gray-100">Account</button>
        <button data-tab="devices" class="tab px-3 py-2 rounded-t text-sm text-gray-700 hover:bg-gray-100">Devices</button>
        <button data-tab="licenses" class="tab px-3 py-2 rounded-t text-sm bg-[#0078d4] text-white">Licenses</button>
        <button data-tab="mail" class="tab px-3 py-2 rounded-t text-sm text-gray-700 hover:bg-gray-100">Mail</button>
        <button data-tab="onedrive" class="tab px-3 py-2 rounded-t text-sm text-gray-700 hover:bg-gray-100">OneDrive</button>
      </div>

      <!-- Licenses Tab -->
      <div id="tab-licenses" class="pt-4 flex-1 overflow-y-auto">
        <div class="mb-4">
          <h5 class="font-medium text-gray-800 mb-2">Product licenses</h5>
          <p class="text-sm text-gray-600">Assign or remove licenses for this user. Changes may take a few minutes to apply.</p>
        </div>

        <div class="mb-4">
          <label class="text-sm font-medium text-gray-700">Location *</label>
          <select id="locSelect" class="w-full mt-1 border rounded px-3 py-2 text-sm">
            <option>United States</option>
            <option>United Kingdom</option>
            <option selected>Denmark</option>
            <option>France</option>
            <option>Germany</option>
          </select>
        </div>

        <div id="licenseConflictWarning" class="hidden mb-4 p-3 rounded bg-yellow-50 border border-yellow-200">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <div class="text-sm text-yellow-700">
              <p class="font-medium">License conflict detected</p>
              <p class="mt-1" id="conflictMessage">Some licenses cannot be assigned together due to service conflicts.</p>
            </div>
          </div>
        </div>

        <div class="border rounded mb-4">
          <div class="px-4 py-3 bg-gray-50 border-b">
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-gray-700">Licenses</span>
              <span class="text-xs text-gray-500">Available: <span id="totalAvailable">13</span></span>
            </div>
          </div>
          <div id="licenseList" class="p-4 space-y-4 max-h-96 overflow-y-auto"></div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
          <div class="flex items-start gap-2">
            <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <div class="text-sm text-blue-700">
              <p class="font-medium">License assignment</p>
              <p class="mt-1">When you assign a license, all services included in that license are automatically assigned to the user. You can turn individual services on or off.</p>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="saveUser" class="px-4 py-2 bg-[#0078d4] text-white rounded hover:bg-[#106ebe] text-sm">Save changes</button>
          <button id="closeDrawer" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 text-sm">Discard</button>
        </div>

        <div id="userToast" class="hidden mt-4 p-3 rounded text-green-800 bg-green-100 toast text-sm">✓ Changes saved successfully.</div>
        <div id="userError" class="hidden mt-4 p-3 rounded text-red-800 bg-red-100 text-sm">Please select at least one license to save.</div>
      </div>

      <!-- Other tabs -->
      <div id="tab-account" class="hidden py-6 text-sm text-gray-600">Account settings and properties.</div>
      <div id="tab-devices" class="hidden py-6 text-sm text-gray-600">Managed devices and enrollment restrictions.</div>
      <div id="tab-mail" class="hidden py-6 text-sm text-gray-600">Mailbox settings and configurations.</div>
      <div id="tab-onedrive" class="hidden py-6 text-sm text-gray-600">OneDrive storage and sharing settings.</div>
    </div>
  </aside>

  <!-- Bulk Assignment Modal -->
  <div id="bulkMask" class="hidden fixed inset-0 bg-black/40"></div>
  <div id="bulkModal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white w-[540px] max-w-[95vw] max-h-[90vh] rounded shadow-xl flex flex-col">
    <div class="p-4 border-b flex items-center justify-between">
      <h4 class="font-semibold">Assign licenses</h4>
      <button id="bulkClose" class="px-2 py-1 rounded hover:bg-gray-100">✕</button>
    </div>
    <div class="p-4 flex-1 overflow-y-auto">
      <p class="text-sm text-gray-600 mb-3" id="bulkCount">Selected users: 0</p>
      
      <div class="mb-4">
        <label class="text-sm font-medium text-gray-700">Usage location</label>
        <select class="w-full mt-1 border rounded px-3 py-2 text-sm">
          <option>United States</option>
          <option>United Kingdom</option>
          <option selected>Denmark</option>
        </select>
      </div>

      <div id="bulkConflictWarning" class="hidden mb-4 p-3 rounded bg-yellow-50 border border-yellow-200">
        <div class="flex items-start gap-2">
          <svg class="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <div class="text-sm text-yellow-700">
            <p class="font-medium">License conflict detected</p>
            <p class="mt-1">Some selected licenses cannot be assigned together.</p>
          </div>
        </div>
      </div>

      <div class="border rounded">
        <div class="px-4 py-3 bg-gray-50 border-b">
          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-gray-700">Licenses</span>
            <span class="text-xs text-gray-500">Available licenses shown</span>
          </div>
        </div>
        <div id="bulkLicenseList" class="p-4 space-y-4 max-h-64 overflow-y-auto"></div>
      </div>

      <div class="mt-4 flex gap-2">
        <button id="bulkSave" class="px-4 py-2 bg-[#0078d4] text-white rounded hover:bg-[#106ebe] text-sm">Assign</button>
        <button id="bulkCancel" class="px-4 py-2 bg-gray-100 rounded hover:bg-gray-200 text-sm">Cancel</button>
      </div>
      <div id="bulkToast" class="hidden mt-4 p-3 rounded text-green-800 bg-green-100 toast text-sm">✓ Licenses assigned successfully.</div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="pageToast" class="pointer-events-none fixed top-4 right-4 space-y-2"></div>

  <script>
    // -------------------- Enhanced Data --------------------
    const LICENSE_POOL = {
      "EXO_P1": { 
        name: "Exchange Online (Plan 1)", 
        available: 2, 
        total: 2,
        servicePlans: [
          { id: "EXCHANGE_S_FOUNDATION", name: "Exchange Foundation", enabled: true, mandatory: true },
          { id: "EXCHANGESTANDARD", name: "Exchange Online", enabled: true, mandatory: true }
        ],
        geoRestrictions: [] // Available everywhere
      },
      "M365_APPS": { 
        name: "Microsoft 365 Apps for enterprise", 
        available: 3, 
        total: 3,
        servicePlans: [
          { id: "OFFICESUBSCRIPTION", name: "Microsoft 365 Apps", enabled: true, mandatory: true },
          { id: "SHAREPOINTWAC", name: "Office for the web", enabled: true, mandatory: false },
          { id: "ONEDRIVESTANDARD", name: "OneDrive for Business", enabled: true, mandatory: false }
        ],
        geoRestrictions: ["United States", "United Kingdom", "Germany"] // Not available in Denmark
      },
      "TEAMS_ESS": { 
        name: "Teams Essentials", 
        available: 4, 
        total: 4,
        servicePlans: [
          { id: "TEAMS1", name: "Microsoft Teams", enabled: true, mandatory: true },
          { id: "MCOEV", name: "Microsoft 365 Phone System", enabled: false, mandatory: false }
        ],
        geoRestrictions: []
      },
      "ONEDRIVE_P1": { 
        name: "OneDrive for Business (Plan 1)", 
        available: 4, 
        total: 4,
        servicePlans: [
          { id: "SHAREPOINTSTANDARD", name: "SharePoint Online", enabled: true, mandatory: true },
          { id: "ONEDRIVESTANDARD", name: "OneDrive for Business", enabled: true, mandatory: true }
        ],
        geoRestrictions: []
      },
      "AAD_P1": { 
        name: "Azure Active Directory P1", 
        available: 2, 
        total: 2,
        servicePlans: [
          { id: "AAD_PREMIUM", name: "Azure Active Directory Premium P1", enabled: true, mandatory: true },
          { id: "MFA_PREMIUM", name: "Azure Multi-Factor Authentication", enabled: true, mandatory: false }
        ],
        geoRestrictions: ["France", "Germany"] // Not available in Denmark
      }
    };

    // License conflicts - licenses that cannot be assigned together
    const LICENSE_CONFLICTS = {
      "ONEDRIVE_P1": ["M365_APPS"], // OneDrive P1 conflicts with M365 Apps (which includes OneDrive)
      "M365_APPS": ["ONEDRIVE_P1"]
    };

    const USERS = [
      { id:"u1", name:"App Mailbox", upn:"app.mailbox@blockshell.app", initials:"AM", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u2", name:"Customer Support", upn:"support@blockshell.app", initials:"CS", licenses:{ TEAMS_ESS: { assigned: true, services: { TEAMS1: true, MCOEV: false } } }, roles: "User", location: "Denmark" },
      { id:"u3", name:"Katie Jordan", upn:"katie.jordan@blockshell.app", initials:"KJ", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u4", name:"Owen Patel", upn:"owen.patel@blockshell.app", initials:"OP", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u5", name:"Hans Ussing", upn:"hans.ussing@blockshell.app", initials:"HU", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u6", name:"Jonas Boolsen", upn:"jonas.boolsen@blockshell.app", initials:"JB", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u7", name:"Morten Skrubbeltrang", upn:"morten.s@blockshell.app", initials:"MS", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u8", name:"Customer Feedback", upn:"feedback@blockshell.app", initials:"CF", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u9", name:"Hans Ørsted", upn:"hans.orsted@blockshell.app", initials:"HØ", licenses:{}, roles: "User", location: "Denmark" },
      { id:"u10", name:"Help Desk", upn:"helpdesk@blockshell.app", initials:"HD", licenses:{}, roles: "Global Admin", location: "Denmark" },
    ];

    // -------------------- State --------------------
    let filter = "";
    let selectedIds = new Set();
    let currentUserId = null;
    let drawerAnimationTimeout = null;
    let currentUserLocation = "Denmark";

    // -------------------- DOM helpers --------------------
    const el = sel => document.querySelector(sel);
    const els = sel => [...document.querySelectorAll(sel)];

    function toast(msg, type="success") {
      const wrap = el("#pageToast");
      const div = document.createElement("div");
      div.className = `toast px-3 py-2 rounded shadow text-sm ${type==="success" ? "bg-green-600 text-white" : "bg-red-600 text-white"}`;
      div.textContent = msg;
      wrap.appendChild(div);
      setTimeout(()=>{ div.remove(); }, 2200);
    }

    function updateSelectedCount() {
      el("#selectedCount").textContent = selectedIds.size;
      el("#totalCount").textContent = USERS.length;
    }

    // -------------------- Enhanced License Management --------------------
    function checkLicenseConflicts(selectedLicenses) {
      const conflicts = [];
      selectedLicenses.forEach(licenseId => {
        if (LICENSE_CONFLICTS[licenseId]) {
          LICENSE_CONFLICTS[licenseId].forEach(conflictingId => {
            if (selectedLicenses.includes(conflictingId)) {
              conflicts.push({ license1: licenseId, license2: conflictingId });
            }
          });
        }
      });
      return conflicts;
    }

    function isLicenseAvailableInLocation(licenseId, location) {
      const license = LICENSE_POOL[licenseId];
      return !license.geoRestrictions.length || license.geoRestrictions.includes(location);
    }

    // -------------------- Enhanced Rendering --------------------
    function renderUsers() {
      const tbody = el("#userTbody");
      tbody.innerHTML = "";

      const rows = USERS
        .filter(u => u.name.toLowerCase().includes(filter) || u.upn.toLowerCase().includes(filter))
        .map(u => {
          const tr = document.createElement("tr");
          tr.className = "border-b hover:bg-gray-50";
          const assignedLicenses = Object.keys(u.licenses).filter(k => u.licenses[k]?.assigned).map(k => LICENSE_POOL[k].name);
          const tags = assignedLicenses.length
            ? `<span class="tag bg-green-100 text-green-700">Licensed</span>`
            : `<span class="tag bg-gray-100 text-gray-600">Unlicensed</span>`;

          tr.innerHTML = `
            <td class="px-4 py-2"><input type="checkbox" data-sel="${u.id}" ${selectedIds.has(u.id)?"checked":""}></td>
            <td class="px-4 py-2">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-xs">${u.initials}</div>
                <button class="text-blue-700 hover:underline text-left" data-open="${u.id}">${u.name}</button>
              </div>
            </td>
            <td class="px-4 py-2">${u.upn}</td>
            <td class="px-4 py-2">${assignedLicenses.length ? assignedLicenses.join(", ") : "-"}</td>
            <td class="px-4 py-2"><span class="text-xs ${u.roles === 'Global Admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'} px-2 py-1 rounded">${u.roles}</span></td>
            <td class="px-4 py-2">${tags}</td>
            <td class="px-4 py-2"><button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-xs" data-open="${u.id}">Manage</button></td>
          `;
          return tr;
        });

      rows.forEach(r => tbody.appendChild(r));

      // checkbox wiring
      els("input[type=checkbox][data-sel]").forEach(c => {
        c.addEventListener("change", (e)=>{
          const id = e.target.getAttribute("data-sel");
          if (e.target.checked) selectedIds.add(id); else selectedIds.delete(id);
          el("#bulkAssignBtn").disabled = selectedIds.size===0;
          el("#selectAll").checked = selectedIds.size>0 && selectedIds.size===rows.length;
          updateSelectedCount();
        });
      });

      // open profile
      els("[data-open]").forEach(btn => btn.addEventListener("click", ()=> openDrawer(btn.getAttribute("data-open"))));

      // header select-all checkbox after list rendered
      el("#selectAll").addEventListener("change", (e)=>{
        const visibleIds = rows.map(r => r.querySelector("button[data-open]").getAttribute("data-open"));
        if (e.target.checked) visibleIds.forEach(id => selectedIds.add(id));
        else visibleIds.forEach(id => selectedIds.delete(id));
        renderUsers();
        el("#bulkAssignBtn").disabled = selectedIds.size===0;
        updateSelectedCount();
      });

      el("#bulkAssignBtn").disabled = selectedIds.size===0;
      updateSelectedCount();
    }

    function licenseCheckbox(id, label, available, total, servicePlans = [], isAssigned = false, location = "Denmark", hasConflict = false) {
      const isGeoRestricted = !isLicenseAvailableInLocation(id, location);
      const geoRestrictedClass = isGeoRestricted ? "geo-restricted" : "";
      const conflictClass = hasConflict ? "conflict-warning" : "";
      
      const servicePlansHtml = servicePlans.map(plan => `
        <div class="license-component ${plan.enabled ? 'enabled' : ''} ${plan.mandatory ? 'service-plan-mandatory' : ''} pl-3 py-2 border-b last:border-b-0">
          <div class="flex items-center justify-between">
            <span class="text-sm ${plan.enabled ? 'text-gray-800' : 'text-gray-500'} ${plan.mandatory ? 'font-medium' : ''}">
              ${plan.name}
              ${plan.mandatory ? '<span class="text-xs text-gray-500 ml-1">(required)</span>' : ''}
            </span>
            <label class="inline-flex items-center">
              <input type="checkbox" data-service="${plan.id}" ${plan.enabled ? 'checked' : ''} 
                     class="service-plan-toggle h-4 w-4 text-blue-600 rounded" 
                     ${!isAssigned || plan.mandatory ? 'disabled' : ''}>
            </label>
          </div>
        </div>
      `).join('');

      const geoWarning = isGeoRestricted ? `
        <div class="px-3 py-1 bg-red-50 border-t border-red-200 text-xs text-red-700">
          ⚠️ Not available in ${location}
        </div>
      ` : '';

      return `
        <div class="license-item border rounded overflow-hidden ${geoRestrictedClass} ${conflictClass}">
          <div class="bg-gray-50 px-3 py-2 border-b">
            <label class="flex items-center gap-2">
              <input type="checkbox" data-lic="${id}" class="h-4 w-4 text-blue-600 rounded" 
                     ${isGeoRestricted ? 'disabled' : ''}>
              <span class="font-medium">${label}</span>
              <span class="ml-auto text-xs text-gray-500">${available}/${total} available</span>
            </label>
          </div>
          <div class="service-plans">
            ${servicePlansHtml}
          </div>
          ${geoWarning}
        </div>`;
    }

    function renderLicenseList(container, userLicenses = {}, location = "Denmark", isBulk = false) {
      const totalAvailable = Object.values(LICENSE_POOL).reduce((sum, lic) => sum + lic.available, 0);
      
      if (!isBulk) {
        el("#totalAvailable").textContent = totalAvailable;
      }

      // Get currently selected licenses to check for conflicts
      const selectedLicenses = Object.keys(userLicenses).filter(k => userLicenses[k]?.assigned);
      const conflicts = checkLicenseConflicts(selectedLicenses);
      const hasConflicts = conflicts.length > 0;

      if (!isBulk) {
        const conflictWarning = el("#licenseConflictWarning");
        if (hasConflicts) {
          conflictWarning.classList.remove("hidden");
          const conflictNames = conflicts.map(c => 
            `${LICENSE_POOL[c.license1].name} and ${LICENSE_POOL[c.license2].name}`
          ).join(", ");
          el("#conflictMessage").textContent = `Conflicting licenses: ${conflictNames}. These cannot be used together.`;
        } else {
          conflictWarning.classList.add("hidden");
        }
      } else {
        const bulkConflictWarning = el("#bulkConflictWarning");
        if (hasConflicts) {
          bulkConflictWarning.classList.remove("hidden");
        } else {
          bulkConflictWarning.classList.add("hidden");
        }
      }

      container.innerHTML = `
        ${licenseCheckbox("EXO_P1", LICENSE_POOL.EXO_P1.name, LICENSE_POOL.EXO_P1.available, LICENSE_POOL.EXO_P1.total, LICENSE_POOL.EXO_P1.servicePlans, userLicenses.EXO_P1?.assigned, location, conflicts.some(c => c.license1 === "EXO_P1" || c.license2 === "EXO_P1"))}
        ${licenseCheckbox("M365_APPS", LICENSE_POOL.M365_APPS.name, LICENSE_POOL.M365_APPS.available, LICENSE_POOL.M365_APPS.total, LICENSE_POOL.M365_APPS.servicePlans, userLicenses.M365_APPS?.assigned, location, conflicts.some(c => c.license1 === "M365_APPS" || c.license2 === "M365_APPS"))}
        ${licenseCheckbox("TEAMS_ESS", LICENSE_POOL.TEAMS_ESS.name, LICENSE_POOL.TEAMS_ESS.available, LICENSE_POOL.TEAMS_ESS.total, LICENSE_POOL.TEAMS_ESS.servicePlans, userLicenses.TEAMS_ESS?.assigned, location, conflicts.some(c => c.license1 === "TEAMS_ESS" || c.license2 === "TEAMS_ESS"))}
        ${licenseCheckbox("ONEDRIVE_P1", LICENSE_POOL.ONEDRIVE_P1.name, LICENSE_POOL.ONEDRIVE_P1.available, LICENSE_POOL.ONEDRIVE_P1.total, LICENSE_POOL.ONEDRIVE_P1.servicePlans, userLicenses.ONEDRIVE_P1?.assigned, location, conflicts.some(c => c.license1 === "ONEDRIVE_P1" || c.license2 === "ONEDRIVE_P1"))}
        ${licenseCheckbox("AAD_P1", LICENSE_POOL.AAD_P1.name, LICENSE_POOL.AAD_P1.available, LICENSE_POOL.AAD_P1.total, LICENSE_POOL.AAD_P1.servicePlans, userLicenses.AAD_P1?.assigned, location, conflicts.some(c => c.license1 === "AAD_P1" || c.license2 === "AAD_P1"))}
      `;

      // Set prechecked licenses
      Object.keys(userLicenses).forEach(k => {
        const c = container.querySelector(`input[data-lic="${k}"]`);
        if (c && userLicenses[k]?.assigned && !c.disabled) {
          c.checked = true;
          // Enable service plan toggles for assigned licenses (except mandatory ones)
          const servicePlans = container.querySelectorAll(`input[data-service]`);
          servicePlans.forEach(toggle => {
            if (toggle.closest(`.license-item`).querySelector(`input[data-lic="${k}"]`)) {
              const serviceId = toggle.getAttribute('data-service');
              const licenseData = LICENSE_POOL[k];
              const servicePlan = licenseData.servicePlans.find(sp => sp.id === serviceId);
              if (servicePlan && !servicePlan.mandatory) {
                toggle.disabled = false;
              }
            }
          });
        }
      });

      // License checkbox change handler
      container.querySelectorAll('input[data-lic]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const licenseId = e.target.getAttribute('data-lic');
          const licenseItem = e.target.closest('.license-item');
          const serviceToggles = licenseItem.querySelectorAll('input[data-service]');
          
          serviceToggles.forEach(toggle => {
            const serviceId = toggle.getAttribute('data-service');
            const licenseData = LICENSE_POOL[licenseId];
            const servicePlan = licenseData.servicePlans.find(sp => sp.id === serviceId);
            
            if (servicePlan.mandatory) {
              toggle.disabled = true;
              toggle.checked = true;
            } else {
              toggle.disabled = !e.target.checked;
              if (!e.target.checked) {
                toggle.checked = false;
              } else {
                // Restore default service plan states for non-mandatory services
                toggle.checked = servicePlan.enabled;
              }
            }
          });

          // Update conflicts in real-time
          if (!isBulk) {
            const user = USERS.find(u => u.id === currentUserId);
            const selected = getSelectedLicensesFromUI();
            const newConflicts = checkLicenseConflicts(selected);
            const conflictWarning = el("#licenseConflictWarning");
            
            if (newConflicts.length > 0) {
              conflictWarning.classList.remove("hidden");
              const conflictNames = newConflicts.map(c => 
                `${LICENSE_POOL[c.license1].name} and ${LICENSE_POOL[c.license2].name}`
              ).join(", ");
              el("#conflictMessage").textContent = `Conflicting licenses: ${conflictNames}. These cannot be used together.`;
            } else {
              conflictWarning.classList.add("hidden");
            }
          }
        });
      });
    }

    function getSelectedLicensesFromUI() {
      const selected = [];
      el("#licenseList").querySelectorAll('input[data-lic]:checked').forEach(c => {
        selected.push(c.getAttribute('data-lic'));
      });
      return selected;
    }

    // -------------------- Drawer (per-user) --------------------
    function openDrawer(id) {
      if (drawerAnimationTimeout) {
        clearTimeout(drawerAnimationTimeout);
        drawerAnimationTimeout = null;
      }
      
      currentUserId = id;
      const user = USERS.find(u => u.id===id);
      el("#drawerName").textContent = user.name;
      el("#drawerUPN").textContent = user.upn;
      el("#avatar").textContent = user.initials;
      
      currentUserLocation = user.location;
      el("#locSelect").value = user.location;

      renderLicenseList(el("#licenseList"), user.licenses, user.location);

      const d = el("#drawer");
      const m = el("#drawerMask");
      
      d.classList.remove("drawer-enter", "drawer-enter-active", "drawer-leave", "drawer-leave-active");
      d.classList.remove("hidden");
      m.classList.remove("hidden");
      
      drawerAnimationTimeout = setTimeout(() => {
        d.classList.add("drawer-enter-active");
        drawerAnimationTimeout = null;
      }, 10);
    }

    function closeDrawer() {
      if (drawerAnimationTimeout) {
        clearTimeout(drawerAnimationTimeout);
        drawerAnimationTimeout = null;
      }
      
      const d = el("#drawer");
      const m = el("#drawerMask");
      
      d.classList.remove("drawer-enter", "drawer-enter-active", "drawer-leave", "drawer-leave-active");
      d.classList.add("drawer-leave-active");
      
      drawerAnimationTimeout = setTimeout(() => {
        d.classList.add("hidden");
        d.classList.remove("drawer-leave-active");
        m.classList.add("hidden");
        drawerAnimationTimeout = null;
      }, 200);
    }

    // -------------------- Save operations --------------------
    function applyUserSave() {
      const user = USERS.find(u => u.id===currentUserId);
      const selected = {};
      
      // Update user location
      user.location = el("#locSelect").value;
      currentUserLocation = user.location;
      
      el("#licenseList").querySelectorAll('input[data-lic]').forEach(c => {
        const licenseId = c.getAttribute('data-lic');
        const isChecked = c.checked;
        
        if (isChecked && isLicenseAvailableInLocation(licenseId, user.location)) {
          selected[licenseId] = {
            assigned: true,
            services: {}
          };
          
          // Get service plan states
          const licenseItem = c.closest('.license-item');
          licenseItem.querySelectorAll('input[data-service]').forEach(toggle => {
            selected[licenseId].services[toggle.getAttribute('data-service')] = toggle.checked;
          });
        }
      });

      // Check for conflicts
      const selectedLicenseIds = Object.keys(selected);
      const conflicts = checkLicenseConflicts(selectedLicenseIds);
      
      if (conflicts.length > 0) {
        const conflictNames = conflicts.map(c => 
          `${LICENSE_POOL[c.license1].name} and ${LICENSE_POOL[c.license2].name}`
        ).join(", ");
        toast(`Cannot assign conflicting licenses: ${conflictNames}`, "error");
        return;
      }

      if (!Object.keys(selected).length) {
        el("#userError").classList.remove("hidden");
        setTimeout(()=>el("#userError").classList.add("hidden"), 1800);
        return;
      }

      const before = user.licenses;
      
      // Update pools and user licenses
      Object.keys(selected).forEach(k => {
        if (selected[k].assigned && (!before[k] || !before[k].assigned)) {
          LICENSE_POOL[k].available = Math.max(0, LICENSE_POOL[k].available - 1);
        }
      });

      // Return licenses to pool if they were removed
      Object.keys(before).forEach(k => {
        if (before[k].assigned && !selected[k]?.assigned) {
          LICENSE_POOL[k].available += 1;
        }
      });

      user.licenses = selected;

      // Update availability display
      Object.keys(LICENSE_POOL).forEach(k => {
        const b = el(`#licenseList [data-avail="${k}"]`);
        if (b) b.textContent = LICENSE_POOL[k].available;
      });

      renderUsers();
      el("#userToast").classList.remove("hidden");
      setTimeout(()=>el("#userToast").classList.add("hidden"), 1500);
      toast(`Saved license changes for ${user.name}`);
    }

    function openBulkModal() {
      renderLicenseList(el("#bulkLicenseList"), {}, currentUserLocation, true);
      el("#bulkCount").textContent = `Selected users: ${selectedIds.size}`;
      el("#bulkMask").classList.remove("hidden");
      el("#bulkModal").classList.remove("hidden");
    }

    function closeBulkModal() {
      el("#bulkMask").classList.add("hidden");
      el("#bulkModal").classList.add("hidden");
    }

    function applyBulkSave() {
      const toApply = {};
      el("#bulkLicenseList").querySelectorAll('input[data-lic]').forEach(c => {
        const licenseId = c.getAttribute('data-lic');
        toApply[licenseId] = c.checked && !c.disabled;
      });

      const appliedLicenses = Object.keys(toApply).filter(k => toApply[k]);
      const conflicts = checkLicenseConflicts(appliedLicenses);
      
      if (conflicts.length > 0) {
        const conflictNames = conflicts.map(c => 
          `${LICENSE_POOL[c.license1].name} and ${LICENSE_POOL[c.license2].name}`
        ).join(", ");
        toast(`Cannot assign conflicting licenses: ${conflictNames}`, "error");
        return;
      }

      const targets = USERS.filter(u => selectedIds.has(u.id));
      let assignedCount = 0;
      
      appliedLicenses.forEach(k => {
        if (LICENSE_POOL[k].available >= targets.length) {
          targets.forEach(u => {
            if (!u.licenses[k]?.assigned && isLicenseAvailableInLocation(k, u.location)) {
              u.licenses[k] = {
                assigned: true,
                services: {}
              };
              // Set default service plan states
              LICENSE_POOL[k].servicePlans.forEach(plan => {
                u.licenses[k].services[plan.id] = plan.enabled;
              });
              assignedCount++;
            }
          });
          LICENSE_POOL[k].available = Math.max(0, LICENSE_POOL[k].available - targets.length);
        } else {
          toast(`Not enough ${LICENSE_POOL[k].name} licenses for all selected users`, "error");
        }
      });

      Object.keys(LICENSE_POOL).forEach(k => {
        const b = el(`#bulkLicenseList [data-avail="${k}"]`);
        if (b) b.textContent = LICENSE_POOL[k].available;
      });

      renderUsers();
      closeBulkModal();
      toast(`Licenses assigned to ${targets.length} users (${assignedCount} assignments)`);
      selectedIds.clear();
      renderUsers();
    }

    // -------------------- Reset / Close --------------------
    function resetLab() {
      Object.keys(LICENSE_POOL).forEach(k => {
        LICENSE_POOL[k].available = LICENSE_POOL[k].total;
      });
      
      USERS.forEach(u => {
        u.licenses = {};
        u.location = "Denmark";
      });
      USERS.find(u => u.name==="Customer Support").licenses = { 
        TEAMS_ESS: { 
          assigned: true, 
          services: { TEAMS1: true, MCOEV: false } 
        } 
      };
      
      selectedIds.clear();
      filter = "";
      el("#searchBox").value = "";
      renderUsers();
      toast("Lab has been reset to initial state");
      closeDrawer();
      closeBulkModal();
    }

    function closeLab() {
      window.close();
    }

    // -------------------- Event Listeners --------------------
    el("#searchBox").addEventListener("input", (e)=>{
      filter = e.target.value.trim().toLowerCase();
      renderUsers();
    });

    // Location change handler
    el("#locSelect").addEventListener("change", (e) => {
      if (currentUserId) {
        const user = USERS.find(u => u.id === currentUserId);
        user.location = e.target.value;
        currentUserLocation = e.target.value;
        renderLicenseList(el("#licenseList"), user.licenses, user.location);
      }
    });

    el("#saveUser").addEventListener("click", applyUserSave);
    el("#closeDrawer").addEventListener("click", closeDrawer);
    el("#drawerMask").addEventListener("click", closeDrawer);

    el("#bulkAssignBtn").addEventListener("click", openBulkModal);
    el("#bulkClose").addEventListener("click", closeBulkModal);
    el("#bulkCancel").addEventListener("click", closeBulkModal);
    el("#bulkMask").addEventListener("click", closeBulkModal);
    el("#bulkSave").addEventListener("click", applyBulkSave);

    el("#resetBtn").addEventListener("click", resetLab);
    el("#closeBtn").addEventListener("click", closeLab);
    el("#refreshBtn").addEventListener("click", ()=> { renderUsers(); toast("User list refreshed"); });

    // Tab switching
    els(".tab").forEach(tab => {
      tab.addEventListener("click", (e) => {
        const tabName = e.target.getAttribute("data-tab");
        
        // Update tab styles
        els(".tab").forEach(t => {
          t.classList.remove("bg-[#0078d4]", "text-white");
          t.classList.add("text-gray-700", "hover:bg-gray-100");
        });
        e.target.classList.add("bg-[#0078d4]", "text-white");
        e.target.classList.remove("text-gray-700", "hover:bg-gray-100");
        
        // Show selected tab content
        els("[id^='tab-']").forEach(content => {
          content.classList.add("hidden");
        });
        el(`#tab-${tabName}`).classList.remove("hidden");
      });
    });

    // Placeholder buttons
    el("#addUserBtn").addEventListener("click", ()=> toast("Add user functionality not simulated","error"));
    el("#mfaBtn").addEventListener("click", ()=> toast("MFA settings not simulated","error"));
    el("#deleteBtn").addEventListener("click", ()=> toast("Delete user functionality not simulated","error"));

    // Initial render
    renderUsers();
  </script>
</body>
</html>