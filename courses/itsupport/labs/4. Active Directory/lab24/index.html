<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lab 24: Disable / Enable a User Account</title>
  <!-- Match dev lab: Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f0f0; }
    .sidebar { background-color:#ffffff; border-right:1px solid #d1d5db; height:calc(100vh - 6rem); overflow-y:auto; }
    .tree-node { padding:4px 8px; cursor:pointer; user-select:none; }
    .tree-node:hover { background-color:#e5f0ff; }
    .tree-node.active { background-color:#0078d4; color:white; }
    .table-header { background-color:#f8f9fa; border-bottom:1px solid #d1d5db; }
    .table-row:hover { background-color:#f1f5f9; }
    .disabled-row { color:#9aa0a6; background:#f7f7f7; }
    .badge { display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#d32f2f; color:#fff; margin-left:6px; }
    .badge-enabled { background:#16a34a; }
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);
             justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background-color:white; padding:20px; border-radius:6px; width:520px; max-width:95vw; }
    .toast { display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
             background-color:#16a34a; color:white; padding:10px 16px; border-radius:6px; z-index:1100; }
    .instructions-panel { background-color:#ffffff; border:1px solid #d1d5db; border-radius:6px; padding:16px; margin:16px; }
    .task-list li { margin-bottom:10px; }
    .context-menu { position:absolute; background-color:white; border:1px solid #d1d5db; 
                    box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1050; min-width:180px; display:none; }
    .context-menu-item { padding:8px 12px; cursor:pointer; }
    .context-menu-item:hover { background-color:#e5f0ff; }
    .context-menu-item.danger:hover { background-color:#fee2e2; color:#dc2626; }
    .properties-panel { max-height:400px; overflow-y:auto; }
    .attribute-row { display:flex; border-bottom:1px solid #e5e5e5; padding:8px 0; }
    .attribute-name { width:40%; font-weight:600; color:#333; }
    .attribute-value { width:60%; color:#666; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm p-3">
    <h1 class="text-lg font-semibold text-gray-800">Active Directory Users and Computers - Blockshell.app</h1>
  </header>

  <!-- Toolbar (kept minimal, like dev lab) -->
  <div class="bg-gray-100 p-2 border-b border-gray-300"></div>

  <!-- Main Layout -->
  <div class="flex flex-1 overflow-hidden">
    <!-- Sidebar: Instructions (match dev lab look) -->
    <aside class="w-96 sidebar">
      <div class="instructions-panel">
        <h2 class="text-lg font-semibold mb-3">Lab Instructions ‚Äî Disable / Enable a User Account</h2>
        <ol class="list-decimal pl-6 space-y-2">
          <li>Click <strong>Blockshell.app</strong> to expand the domain structure.</li>
          <li>Select <strong>Users</strong> in the tree view.</li>
          <li>Right-click <strong>Alex.Reed</strong> in the object list and choose <em>Disable account</em>.</li>
          <li>Verify the row greys out and a <em>Disabled</em> badge appears.</li>
          <li>(Optional) Right-click again and choose <em>Enable account</em> to restore.</li>
        </ol>
        <div class="flex justify-between mt-4">
          <button id="resetLab" class="bg-blue-600 text-white px-4 py-2 rounded">Reset Lab</button>
          <button id="closeLab" class="bg-gray-300 px-4 py-2 rounded">Close Lab</button>
        </div>
        <p class="mt-3 text-xs text-gray-600">Tip: Click the time at the bottom-right to open the popup calendar.</p>
      </div>
    </aside>

    <!-- AD App Panel -->
    <main class="flex-1 p-4 bg-white">
      <div class="flex h-full">
        <!-- AD Tree -->
        <div class="w-1/3 border-r border-gray-300 pr-4 overflow-y-auto" id="treeContainer">
          <div id="treeView" class="select-none">
            <div class="tree-node active" data-path="" data-expand-root="1">üìÅ Blockshell.app</div>
            <div class="pl-4 hidden" data-child="">
              <div class="tree-node" data-path="Administration">üìÅ Administration</div>
              <div class="pl-8 hidden" data-child="Administration">
                <div class="tree-node" data-path="Administration/Service Accounts">üìÅ Service Accounts</div>
              </div>

              <div class="tree-node" data-path="Corporate">üìÅ Corporate</div>
              <div class="pl-8 hidden" data-child="Corporate">
                <div class="tree-node" data-path="Corporate/Finance">üìÅ Finance</div>
                <div class="tree-node" data-path="Corporate/Human Resources">üìÅ Human Resources</div>
              </div>

              <div class="tree-node" data-path="Builtin">üìÅ Builtin</div>

              <div class="tree-node" data-path="Computers">üìÅ Computers</div>
              <div class="pl-8 hidden" data-child="Computers">
                <div class="tree-node" data-path="Computers/Workstations">üìÅ Workstations</div>
                <div class="tree-node" data-path="Computers/Servers">üìÅ Servers</div>
              </div>

              <div class="tree-node" data-path="Domain Controllers">üìÅ Domain Controllers</div>
              <div class="tree-node" data-path="ForeignSecurityPrincipals">üìÅ ForeignSecurityPrincipals</div>
              <div class="tree-node" data-path="ITEC_Import">üìÅ ITEC_Import</div>
              <div class="pl-8 hidden" data-child="ITEC_Import">
                <div class="tree-node" data-path="ITEC_Import/Development">üìÅ Development</div>
              </div>
              <div class="tree-node" data-path="Managed Service Accounts">üìÅ Managed Service Accounts</div>

              <div class="tree-node" data-path="Users">üìÅ Users</div>
            </div>
          </div>
        </div>

        <!-- Object List -->
        <div class="flex-1 pl-4 overflow-y-auto">
          <table id="objectTable" class="w-full text-sm text-left text-gray-700">
            <thead class="table-header">
              <tr>
                <th class="p-2">Name</th>
                <th class="p-2">Type</th>
                <th class="p-2">Description</th>
                <th class="p-2">Last Logon</th>
                <th class="p-2">Account Status</th>
              </tr>
            </thead>
            <tbody id="objectTableBody"></tbody>
          </table>
          <div id="objectCount" class="mt-2 text-sm text-gray-600">Select a container to view its contents.</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Context Menu for users -->
  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" data-action="toggle">Disable account</div>
    <div class="context-menu-item" data-action="reset">Reset password‚Ä¶</div>
    <div class="context-menu-item" data-action="properties">Properties</div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">Done</div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-semibold mb-4" id="confirmTitle">Confirm Action</h3>
      <p id="confirmMessage" class="mb-6">Are you sure you want to perform this action?</p>
      <div class="flex justify-end space-x-3">
        <button id="confirmCancel" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        <button id="confirmOk" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
      </div>
    </div>
  </div>

  <!-- Properties Modal -->
  <div id="propertiesModal" class="modal">
    <div class="modal-content" style="width: 600px;">
      <h3 class="text-lg font-semibold mb-4" id="propertiesTitle">User Properties</h3>
      <div class="properties-panel mb-6" id="propertiesContent">
        <!-- Properties will be populated dynamically -->
      </div>
      <div class="flex justify-end">
        <button id="propertiesClose" class="bg-gray-300 px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Date/Time (match dev placement) -->
  <div class="fixed bottom-4 right-4 text-sm text-gray-600 cursor-pointer select-none" id="timeWidget">
    <span id="currentTime">--:--</span>
    <span id="currentDate">-- ---, ----</span>
  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal" class="modal">
    <div class="modal-content">
      <div class="flex justify-between mb-4">
        <button id="prevMonthBtn">‚Äπ</button>
        <span id="calendarMonthYear">Month Year</span>
        <button id="nextMonthBtn">‚Ä∫</button>
      </div>
      <table class="w-full text-sm">
        <thead><tr><th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th></tr></thead>
        <tbody id="calendarBody"></tbody>
      </table>
      <div class="flex justify-end mt-4">
        <button class="bg-gray-300 px-4 py-2 rounded" id="closeCalendar">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- ENHANCED DATA ----------
    let currentPath = '';
    let history = [''];
    let historyIndex = 0;
    let pendingAction = null;
    let selectedUser = null;

    const objects = [
      { name:'Administration', type:'Organizational Unit', description:'Administrative accounts and groups', path:'Administration' },
      { name:'Service Accounts', type:'Organizational Unit', description:'Service account management', path:'Administration/Service Accounts' },

      { name:'Corporate', type:'Organizational Unit', description:'Corporate Domain Objects', path:'Corporate' },
      { name:'Finance', type:'Organizational Unit', description:'Finance department objects', path:'Corporate/Finance' },
      { name:'Ethan Cooper', type:'User', description:'Finance Director', path:'Corporate/Finance/Ethan Cooper' },
      { name:'Maya Singh', type:'User', description:'Finance Manager', path:'Corporate/Finance/Maya Singh' },

      { name:'Human Resources', type:'Organizational Unit', description:'HR department objects', path:'Corporate/Human Resources' },
      { name:'Luca Romano', type:'User', description:'HR Director', path:'Corporate/Human Resources/Luca Romano' },

      { name:'Builtin', type:'builtinDomain', description:'Built-in security principals', path:'Builtin' },

      { name:'Computers', type:'Container', description:'Default container for upgraded computer accounts', path:'Computers' },
      { name:'Workstations', type:'Organizational Unit', description:'Workstation computers', path:'Computers/Workstations' },
      { name:'Servers', type:'Organizational Unit', description:'Server computers', path:'Computers/Servers' },

      { name:'Domain Controllers', type:'Organizational Unit', description:'Default container for domain controllers', path:'Domain Controllers' },
      { name:'ForeignSecurityPrincipals', type:'Container', description:'Default container for security principals', path:'ForeignSecurityPrincipals' },
      { name:'ITEC_Import', type:'Organizational Unit', description:'Imported IT objects', path:'ITEC_Import' },
      { name:'Development', type:'Organizational Unit', description:'Development team objects', path:'ITEC_Import/Development' },
      { name:'Managed Service Accounts', type:'Container', description:'Default container for managed service accounts', path:'Managed Service Accounts' },

      { name:'Users', type:'Container', description:'Default container for upgraded user accounts', path:'Users' },
      { name:'Alex.Reed', type:'User', description:'Sales - London', path:'Users/Alex.Reed' },
      { name:'Zoe.Walker', type:'User', description:'HR - Manchester', path:'Users/Zoe.Walker' },
      { name:'IT.Helpdesk', type:'Group', description:'IT Support Group', path:'Users/IT.Helpdesk' },
      { name:'Guest', type:'User', description:'Built-in account for guest access', path:'Users/Guest', disabled:true }
    ];

    // Enhanced user state with AD attributes
    const userState = {
      'Alex.Reed': { 
        disabled: false, 
        desc: 'Sales - London',
        lastLogon: '2024-01-15 09:23:45',
        logonCount: 142,
        passwordLastSet: '2024-01-01',
        memberOf: ['Domain Users', 'Sales Team'],
        samAccountName: 'Alex.Reed',
        userPrincipalName: 'Alex.Reed@blockshell.app',
        distinguishedName: 'CN=Alex.Reed,CN=Users,DC=blockshell,DC=app'
      },
      'Zoe.Walker': { 
        disabled: false, 
        desc: 'HR - Manchester',
        lastLogon: '2024-01-14 14:12:33',
        logonCount: 89,
        passwordLastSet: '2023-12-15',
        memberOf: ['Domain Users', 'HR Team'],
        samAccountName: 'Zoe.Walker',
        userPrincipalName: 'Zoe.Walker@blockshell.app',
        distinguishedName: 'CN=Zoe.Walker,CN=Users,DC=blockshell,DC=app'
      },
      'Guest': { 
        disabled: true,  
        desc: 'Built-in account for guest access',
        lastLogon: 'Never',
        logonCount: 0,
        passwordLastSet: 'Never',
        memberOf: ['Guests'],
        samAccountName: 'Guest',
        userPrincipalName: '',
        distinguishedName: 'CN=Guest,CN=Users,DC=blockshell,DC=app'
      },
      'Ethan Cooper': { 
        disabled: false, 
        desc: 'Finance Director',
        lastLogon: '2024-01-16 08:45:12',
        logonCount: 203,
        passwordLastSet: '2024-01-02',
        memberOf: ['Domain Users', 'Finance Team', 'Management'],
        samAccountName: 'Ethan.Cooper',
        userPrincipalName: 'Ethan.Cooper@blockshell.app',
        distinguishedName: 'CN=Ethan Cooper,OU=Finance,OU=Corporate,DC=blockshell,DC=app'
      },
      'Maya Singh': { 
        disabled: false, 
        desc: 'Finance Manager',
        lastLogon: '2024-01-15 11:34:22',
        logonCount: 156,
        passwordLastSet: '2023-12-20',
        memberOf: ['Domain Users', 'Finance Team'],
        samAccountName: 'Maya.Singh',
        userPrincipalName: 'Maya.Singh@blockshell.app',
        distinguishedName: 'CN=Maya Singh,OU=Finance,OU=Corporate,DC=blockshell,DC=app'
      },
      'Luca Romano': { 
        disabled: false, 
        desc: 'HR Director',
        lastLogon: '2024-01-16 10:15:08',
        logonCount: 178,
        passwordLastSet: '2024-01-05',
        memberOf: ['Domain Users', 'HR Team', 'Management'],
        samAccountName: 'Luca.Romano',
        userPrincipalName: 'Luca.Romano@blockshell.app',
        distinguishedName: 'CN=Luca Romano,OU=Human Resources,OU=Corporate,DC=blockshell,DC=app'
      }
    };

    // ---------- TREE & TABLE ----------
    function toggleNode(el) {
      const childDiv = document.querySelector(`[data-child="${el.dataset.path}"]`);
      if (childDiv) { childDiv.classList.toggle('hidden'); }
      selectNode(el);
    }

    function selectNode(el) {
      document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
      currentPath = el.dataset.path === '' ? '' : el.dataset.path;
      history = history.slice(0, historyIndex + 1);
      history.push(currentPath);
      historyIndex++;
      updateObjectTable();
    }

    document.getElementById('treeView').addEventListener('click', (e) => {
      const node = e.target.closest('.tree-node');
      if (!node) return;
      if (node.dataset.expandRoot) {
        const childDiv = document.querySelector('[data-child=""]');
        if (childDiv) childDiv.classList.toggle('hidden');
        selectNode(node);
        return;
      }
      const hasChildContainer = document.querySelector(`[data-child="${node.dataset.path}"]`);
      if (hasChildContainer) {
        hasChildContainer.classList.toggle('hidden');
      }
      selectNode(node);
    });

    function updateObjectTable() {
      const tbody = document.getElementById('objectTableBody');
      const objectCount = document.getElementById('objectCount');
      tbody.innerHTML = '';
      if (!currentPath) {
        objectCount.textContent = 'Select a container to view its contents.';
        return;
      }
      const depth = currentPath.split('/').filter(Boolean).length;
      const filtered = objects.filter(o => o.path.startsWith(currentPath) && o.path !== currentPath && o.path.split('/').length === depth + 1);
      filtered.forEach(obj => {
        const row = document.createElement('tr');
        row.className = 'table-row';
        row.dataset.name = obj.name;
        row.dataset.path = obj.path;
        
        const icon = obj.type === 'User' ? 'üë§' : obj.type === 'Computer' ? 'üíª' : (obj.type === 'Security Group' || obj.type === 'Group') ? 'üë•' : 'üìÅ';
        const isDisabled = userState[obj.name]?.disabled;
        const statusBadge = isDisabled ? 
          '<span class="badge">Disabled</span>' : 
          '<span class="badge badge-enabled">Enabled</span>';
        
        const lastLogon = userState[obj.name]?.lastLogon || 'N/A';
        const accountStatus = isDisabled ? 'Account disabled' : 'Account enabled';
        
        row.innerHTML = `
          <td class="p-2">${icon} ${obj.name}</td>
          <td class="p-2">${obj.type}</td>
          <td class="p-2">${userState[obj.name]?.desc || obj.description || ''}</td>
          <td class="p-2">${lastLogon}</td>
          <td class="p-2">${accountStatus}</td>
        `;

        if (isDisabled) row.classList.add('disabled-row');

        row.addEventListener('click', () => {
          document.querySelectorAll('.table-row').forEach(r => r.classList.remove('bg-blue-100'));
          row.classList.add('bg-blue-100');
        });
        row.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (obj.type === 'User') showContextMenu(e, obj);
        });
        tbody.appendChild(row);
      });
      objectCount.textContent = `${filtered.length} object(s)`;
    }

    // ---------- CONTEXT MENU ----------
    const contextMenu = document.getElementById('contextMenu');
    function showContextMenu(e, obj) {
      contextMenu.style.top = e.pageY + 'px';
      contextMenu.style.left = e.pageX + 'px';
      contextMenu.style.display = 'block';
      contextMenu.dataset.user = obj.name;
      const disabled = !!userState[obj.name]?.disabled;
      contextMenu.querySelector('[data-action="toggle"]').textContent = disabled ? 'Enable account' : 'Disable account';
      document.addEventListener('click', hideContextMenu, { once:true });
    }
    function hideContextMenu() { contextMenu.style.display = 'none'; }

    contextMenu.addEventListener('click', (e) => {
      const item = e.target.closest('.context-menu-item');
      if (!item) return;
      const act = item.dataset.action;
      const uname = contextMenu.dataset.user;
      if (!uname) return;
      
      selectedUser = uname;
      
      if (act === 'toggle') {
        const disabled = userState[uname]?.disabled;
        showConfirmation(
          disabled ? 'Enable Account' : 'Disable Account',
          `Are you sure you want to ${disabled ? 'enable' : 'disable'} the account for ${uname}?`,
          () => toggleUser(uname)
        );
      }
      if (act === 'reset') {
        showConfirmation(
          'Reset Password',
          `Reset password for ${uname}? The user will be required to change password at next logon.`,
          () => toastMsg(`Password reset for ${uname} - User must change password at next logon`)
        );
      }
      if (act === 'properties') {
        showUserProperties(uname);
      }
      hideContextMenu();
    });

    // ---------- CONFIRMATION MODAL ----------
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmCancel = document.getElementById('confirmCancel');
    const confirmOk = document.getElementById('confirmOk');

    function showConfirmation(title, message, callback) {
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      confirmModal.style.display = 'flex';
      pendingAction = callback;
    }

    confirmOk.addEventListener('click', () => {
      if (pendingAction) {
        pendingAction();
        pendingAction = null;
      }
      confirmModal.style.display = 'none';
    });

    confirmCancel.addEventListener('click', () => {
      pendingAction = null;
      confirmModal.style.display = 'none';
    });

    // ---------- PROPERTIES MODAL ----------
    const propertiesModal = document.getElementById('propertiesModal');
    const propertiesTitle = document.getElementById('propertiesTitle');
    const propertiesContent = document.getElementById('propertiesContent');
    const propertiesClose = document.getElementById('propertiesClose');

    function showUserProperties(username) {
      const user = userState[username];
      if (!user) return;

      propertiesTitle.textContent = `${username} Properties`;
      
      propertiesContent.innerHTML = `
        <div class="attribute-row">
          <div class="attribute-name">First name:</div>
          <div class="attribute-value">${username.split('.')[0] || username}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Last name:</div>
          <div class="attribute-value">${username.split('.')[1] || 'N/A'}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Display name:</div>
          <div class="attribute-value">${username}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Description:</div>
          <div class="attribute-value">${user.desc}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">User logon name:</div>
          <div class="attribute-value">${user.userPrincipalName || `${username}@blockshell.app`}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">User logon name (pre-Windows 2000):</div>
          <div class="attribute-value">${user.samAccountName || username}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Account is disabled</div>
          <div class="attribute-value">${user.disabled ? 'Yes' : 'No'}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Last logon:</div>
          <div class="attribute-value">${user.lastLogon}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Logon count:</div>
          <div class="attribute-value">${user.logonCount}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Password last set:</div>
          <div class="attribute-value">${user.passwordLastSet}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Member of:</div>
          <div class="attribute-value">${user.memberOf?.join(', ') || 'Domain Users'}</div>
        </div>
        <div class="attribute-row">
          <div class="attribute-name">Distinguished name:</div>
          <div class="attribute-value">${user.distinguishedName}</div>
        </div>
      `;

      propertiesModal.style.display = 'flex';
    }

    propertiesClose.addEventListener('click', () => {
      propertiesModal.style.display = 'none';
    });

    // ---------- DISABLE / ENABLE ----------
    function toggleUser(uname) {
      if (!userState[uname]) return;
      
      // Simulate AD replication delay
      toastMsg(`Processing... ${uname}`);
      
      setTimeout(() => {
        userState[uname].disabled = !userState[uname].disabled;
        
        // Update last logon timestamp when enabling
        if (!userState[uname].disabled) {
          const now = new Date();
          userState[uname].lastLogon = now.toLocaleString('en-GB', { 
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
        }
        
        updateObjectTable();
        toastMsg(`${uname} ${userState[uname].disabled ? 'disabled' : 'enabled'}`);
      }, 800);
    }

    // ---------- RESET / CLOSE ----------
    document.getElementById('resetLab').addEventListener('click', () => {
      showConfirmation(
        'Reset Lab',
        'Are you sure you want to reset the lab to its initial state? All changes will be lost.',
        () => {
          // Reset all users to initial state
          Object.keys(userState).forEach(username => {
            if (username === 'Guest') {
              userState[username].disabled = true;
            } else {
              userState[username].disabled = false;
            }
          });
          
          currentPath = '';
          history = ['']; historyIndex = 0;
          document.querySelectorAll('[data-child]').forEach(div => div.classList.add('hidden'));
          document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
          document.querySelector('.tree-node[data-path=""]').classList.add('active');
          updateObjectTable();
          toastMsg('Lab reset to initial state');
        }
      );
    });

    document.getElementById('closeLab').addEventListener('click', () => {
      window.close();
      setTimeout(() => { window.location.href = 'about:blank'; }, 300);
    });

    // ---------- TIME & CALENDAR ----------
    const currentTimeSpan = document.getElementById('currentTime');
    const currentDateSpan = document.getElementById('currentDate');
    const calendarModal = document.getElementById('calendarModal');
    const calendarBody = document.getElementById('calendarBody');
    const calendarMonthYear = document.getElementById('calendarMonthYear');

    function updateTime() {
      const now = new Date();
      currentTimeSpan.textContent = now.toLocaleTimeString('en-GB', { hour12: true, hour: '2-digit', minute: '2-digit' });
      currentDateSpan.textContent = now.toLocaleDateString('en-GB', { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
    }
    setInterval(updateTime, 1000); updateTime();

    let calMonth = (new Date()).getMonth();
    let calYear = (new Date()).getFullYear();

    function updateCalendar() {
      calendarMonthYear.textContent = new Date(calYear, calMonth).toLocaleString('en-GB', { month:'long', year:'numeric' });
      calendarBody.innerHTML = '';
      const firstDay = new Date(calYear, calMonth, 1).getDay();
      const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
      let row = document.createElement('tr');
      for (let i = 0; i < firstDay; i++) row.innerHTML += '<td></td>';
      for (let day = 1; day <= daysInMonth; day++) {
        if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
          calendarBody.appendChild(row);
          row = document.createElement('tr');
        }
        const isToday = (day === (new Date()).getDate() && calMonth === (new Date()).getMonth() && calYear === (new Date()).getFullYear());
        row.innerHTML += `<td class="p-1 text-center ${isToday ? 'bg-blue-200' : ''}">${day}</td>`;
      }
      calendarBody.appendChild(row);
    }

    function toggleCalendar() {
      const vis = calendarModal.style.display === 'flex';
      calendarModal.style.display = vis ? 'none' : 'flex';
      if (!vis) updateCalendar();
    }

    document.getElementById('prevMonthBtn').addEventListener('click', () => { calMonth--; if (calMonth < 0) { calMonth = 11; calYear--; } updateCalendar(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { calMonth++; if (calMonth > 11) { calMonth = 0; calYear++; } updateCalendar(); });
    document.getElementById('closeCalendar').addEventListener('click', () => calendarModal.style.display = 'none');
    document.getElementById('timeWidget').addEventListener('click', toggleCalendar);

    // ---------- TOAST ----------
    function toastMsg(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg || 'Done';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 1800);
    }

    // ---------- INIT ----------
    updateObjectTable();
  </script>
</body>
</html>