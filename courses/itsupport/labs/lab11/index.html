<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 11: Task Manager</title>
<style>
/* ==== Desktop background (from template) ==== */
html,body{height:100%;margin:0;font-family:Segoe UI, Roboto, Arial, Helvetica, sans-serif;}
body{background:linear-gradient(120deg,#1976d2,#0d47a1);color:#111;overflow:hidden;}
#desktop{position:absolute;inset:0 0 48px 0;padding:14px;}

/* ==== Windows (simulation windows) ==== */
.window{
  position:absolute;background:#fff;border:1px solid #c9c9c9;border-radius:10px;
  box-shadow:0 14px 40px rgba(0,0,0,.35);display:none;flex-direction:column;overflow:hidden;
}
.window-header{
  background:#e9e9e9;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:move;
  border-bottom:1px solid #cfcfcf;user-select:none;
}
.window-title{font-weight:600;flex:1}
.window-controls{display:flex;gap:6px}
.window-control{width:24px;height:24px;border-radius:6px;background:#dcdcdc;display:grid;place-items:center;cursor:pointer}
.window-control:hover{background:#cfcfcf}
.window-body{padding:10px;overflow:auto;background:#fff;flex:1}

/* ==== Start Menu (template style) ==== */
.start-menu {
  position: absolute;
  bottom: 52px;
  left: 12px;
  width: 520px;
  height: 420px;
  background: rgba(30,30,30,0.97);
  color: white;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4);
  backdrop-filter: blur(16px);
  display: none;
  overflow: hidden;
  z-index: 200;
}
.start-menu-header {
  padding: 16px 20px;
  background: rgba(255,255,255,0.06);
  border-bottom: 1px solid rgba(255,255,255,0.1);
  font-weight: 600;
  font-size: 16px;
}
.start-menu-body {
  display: grid;
  grid-template-columns: 1fr 1fr;
  height: calc(100% - 60px);
}
.start-menu-left {
  padding: 16px;
  background: rgba(255,255,255,0.02);
  border-right: 1px solid rgba(255,255,255,0.08);
}
.start-menu-right { padding: 16px; }
.app-list { max-height: 100%; overflow-y: auto; }
.app-item {
  display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; cursor:pointer;
  transition:background .2s ease; margin-bottom:8px;
}
.app-item:hover { background: rgba(255,255,255,0.08); }
.app-item .icon {
  width:32px;height:32px;border-radius:6px;background:#0078d4;display:flex;align-items:center;justify-content:center;font-size:16px;
}
.instructions-icon { background: linear-gradient(45deg, #ff6b35, #f7931e) !important; }

/* ==== Taskbar + refined tray (template style) ==== */
.taskbar {
  position: absolute; bottom: 0; width: 100%; height: 48px;
  background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px);
  display: flex; align-items: center; padding: 0 12px; z-index: 100;
  border-top: 1px solid rgba(255,255,255,0.1);
}
.start-button {
  color: white; font-weight: 600; display: flex; align-items: center; gap: 8px;
  padding: 6px 10px; border-radius: 8px; transition: all 0.2s ease; font-size: 14px;
  background: rgba(255,255,255,0.22); border: 1px solid rgba(255,255,255,0.35); cursor:pointer;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06);
}
.start-button:hover { background-color: rgba(255,255,255,0.32); border-color: rgba(255,255,255,0.5); }
.windows-logo { width: 20px; height: 20px; margin-right: 2px; display:inline-block; }
.taskbar-icons { display:flex; gap:8px; margin-left:10px; } /* empty, kept for alignment */

/* Time-only tray */
.system-tray { display:flex; align-items:center; color:white; font-size:13px; padding:0 6px; white-space:nowrap; gap:6px; margin-left:auto; }
.tray-chip {
  display:inline-flex; align-items:center; gap:8px; height:32px; padding:0 10px;
  background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2);
  border-radius:10px; cursor:pointer; user-select:none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);
  transition: transform .12s ease, background .15s ease, border-color .15s ease;
}
.tray-chip:hover { background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.35); transform: translateY(-1px); }
.tray-time { min-width: 110px; justify-content:center; font-variant-numeric: tabular-nums; }

/* ==== Start button context menu (for Task Manager) ==== */
.context-menu{position:absolute;display:none;background:rgba(30,30,30,0.97);color:#fff;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.4);z-index:400;overflow:hidden;backdrop-filter:blur(16px);min-width:260px;}
.context-menu-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;color:white;font-size:14px;transition:all .2s ease;border-bottom:1px solid rgba(255,255,255,0.05);user-select:none;}
.context-menu-item:last-child{border-bottom:none;}
.context-menu-item:hover{background:rgba(255,255,255,0.08);}
.context-menu-item .icon{width:20px;height:20px;margin-right:12px;display:inline-block}

/* ==== Task Manager specifics (from Lab 1, adapted) ==== */
.task-manager-tabs{display:flex;background:#f8f8f8;border-bottom:1px solid #ddd;}
.task-manager-tab{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s ease;font-size:13px;user-select:none;}
.task-manager-tab.active{background:#fff;border-bottom-color:#1976d2;color:#1976d2;}
.process-list{width:100%;border-collapse:collapse;font-size:13px;}
.process-list th{padding:12px 16px;text-align:left;background:#f8f8f8;border-bottom:1px solid #ddd;font-weight:600;color:#333;position:sticky;top:0;}
.process-list td{padding:8px 16px;border-bottom:1px solid #f0f0f0;}
.process-list tr:hover{background:#f0f8ff;}
.process-list tr.unresponsive{background:#fff8f0;color:#d83b01;}
.process-list tr.unresponsive:hover{background:#ffe6cc;}
.process-list tr.selected{background:#1976d2 !important;color:white !important;}
.end-task-btn{background:#d83b01;color:#fff;border:none;padding:8px 16px;margin:16px;border-radius:4px;cursor:pointer;font-size:14px;transition:all .2s ease;}
.end-task-btn:hover:not(:disabled){background:#c73400;transform:translateY(-1px);}
.end-task-btn:disabled{background:#ccc;cursor:not-allowed;transform:none;}

/* Toast (template style) */
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:500}

/* Simple helper */
.hidden{display:none!important;}

.tray-time-col{display:flex;flex-direction:column;line-height:1.05;align-items:center}
#trayTime{font-weight:600;font-size:14px}
#trayDate{font-size:12px;opacity:.9}

/* Unified button style (match template aesthetic) */
button{
  background: rgba(255,255,255,0.22);
  border: 1px solid rgba(0,0,0,0.15);
  color: #111;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background .15s ease, border-color .15s ease, transform .12s ease, box-shadow .15s ease;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 2px 8px rgba(0,0,0,.12);
}
button:hover{ background: rgba(255,255,255,0.32); border-color: rgba(0,0,0,0.25); transform: translateY(-1px); }
button:active{ transform: translateY(0); }
button:disabled{ opacity:.6; cursor:not-allowed; transform:none; }

/* Keep the distinct warning color for End task while adopting the same shape/shadow */
.end-task-btn{
  background:#d83b01; color:#fff; border:none; padding:8px 16px; margin:16px; border-radius:8px;
  cursor:pointer; font-size:14px; transition:all .2s ease; box-shadow: 0 2px 8px rgba(0,0,0,.12);
}
.end-task-btn:hover:not(:disabled){ background:#c73400; transform:translateY(-1px); }
.end-task-btn:disabled{ background:#ccc; color:#555; }

/* Loading animation for Task Manager */
.task-manager-loading {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Unresponsive app window simulation */
.unresponsive-window {
  position: absolute;
  width: 400px;
  height: 300px;
  background: #fff;
  border: 1px solid #c9c9c9;
  border-radius: 10px;
  box-shadow: 0 14px 40px rgba(0,0,0,.35);
  left: 500px;
  top: 150px;
  z-index: 50;
}
.unresponsive-window .window-header {
  background: #ffebee;
  cursor: move; /* Changed from not-allowed to move for draggable */
}
.unresponsive-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #d83b01;
  font-weight: 600;
  pointer-events: none; /* Allow clicking through to drag */
}
.unresponsive-overlay::before {
  content: "‚è≥";
  margin-right: 8px;
  font-size: 16px;
}

/* Process termination animation */
.process-terminating {
  animation: fadeOut 0.5s ease forwards;
}
@keyframes fadeOut {
  to {
    opacity: 0;
    transform: translateX(-20px);
  }
}

/* === Tray Popover + Calendar (ported from template) === */
.tray-popover {
  position: absolute; display: none; min-width: 300px;
  background: rgba(30,30,30,0.97); color: white;
  border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4); z-index: 400; overflow: hidden; backdrop-filter: blur(16px);
}
.tray-popover .pop-header { padding: 12px 16px; background: rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 13px; }
.tray-popover .pop-body { padding: 14px 16px; font-size: 13px; max-height: 380px; overflow:auto; }
.row { display:flex; align-items:center; gap:10px; }
.muted { opacity:0.85; }

.calendar{ width:100%; user-select:none; }
.calendar .big-clock{ font-size:28px; font-weight:700; margin-bottom:6px; }
.calendar .small-date{ opacity:.9; margin-bottom:10px; }
.calendar .cal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.calendar .month{ font-weight:600; }
.calendar .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px; }
.calendar .dow{ text-align:center; opacity:.8; padding:4px 0; }
.calendar .day{ text-align:center; padding:6px 0; border-radius:6px; }
.calendar .day.today{ background:#1976d2; color:#fff; }
.calendar .day.other{ opacity:.35; }
</style>
</head>
<body>
  <div id="desktop">
    <!-- Unresponsive application window simulation -->
    <div class="unresponsive-window" id="photoViewerWindow">
      <div class="window-header">
        <div class="window-title">Photo Viewer - beach_vacation.jpg</div>
        <div class="window-controls">
          <div class="window-control">‚àí</div>
          <div class="window-control">‚¨ú</div>
          <div class="window-control">‚úï</div>
        </div>
      </div>
      <div class="window-body" style="display:flex;align-items:center;justify-content:center;background:#f5f5f5;">
        <div style="text-align:center;color:#666;">
          <div style="font-size:48px;margin-bottom:10px;">üñºÔ∏è</div>
          <div>Loading image...</div>
        </div>
      </div>
      <div class="unresponsive-overlay">Not responding</div>
    </div>

    <!-- Instructions window (template style) -->
    <div class="window" id="instructionsWindow" style="left:20px;top:20px;width:420px;height:340px;display:flex;">
      <div class="window-header">
        <div class="window-title">Lab Instructions</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚¨ú</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="task-title" style="font-weight:600;color:#fff;background:linear-gradient(135deg,#0078d4 0%,#005a9e 100%);padding:8px 12px;border-radius:6px;display:inline-block;margin-bottom:10px;">Lab 1: End an Unresponsive App ‚Äì Instructions</div>
        <div class="task-description" style="color:#1e1e1e;line-height:1.5;font-size:14px;">
          <strong>Goal:</strong> Use Task Manager to end <em>PhotoViewer.exe</em> (Not responding).
          <ol style="margin:12px 0 0 20px;">
            <li><strong>Right‚Äëclick</strong> the <strong>Start</strong> button and choose <strong>Task Manager</strong>.</li>
            <li>Wait for Task Manager to load and find the <strong>PhotoViewer.exe</strong> process (marked <em>Not responding</em>).</li>
            <li>Click <strong>End task</strong> to terminate the unresponsive application.</li>
          </ol>
          <div style="margin-top:15px;padding:10px;background:#fff3cd;border-radius:6px;border:1px solid #ffeaa7;">
            <strong>Note:</strong> The Photo Viewer window above is currently frozen and unresponsive. You can drag it to move it out of the way if needed.
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="resetLab">Reset Lab</button>
          <button id="closeBrowser">Close Lab</button>
        </div>
      </div>
    </div>

    <!-- Task Manager window -->
    <div class="window" id="taskManagerWindow" style="left:260px;top:90px;width:760px;height:500px;">
      <div class="window-header">
        <div class="window-title">Task Manager</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚¨ú</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="task-manager-tabs">
        <div class="task-manager-tab active">Processes</div>
        <div class="task-manager-tab">Performance</div>
        <div class="task-manager-tab">App history</div>
        <div class="task-manager-tab">Startup</div>
        <div class="task-manager-tab">Users</div>
        <div class="task-manager-tab">Details</div>
        <div class="task-manager-tab">Services</div>
      </div>
      <div class="window-body">
        <div class="task-manager-loading" id="taskManagerLoading">
          <div class="loading-spinner"></div>
        </div>
        <div style="padding: 16px; overflow-y: auto; height: calc(100% - 50px);">
          <table class="process-list">
            <thead>
              <tr><th>Name</th><th>Status</th><th>CPU</th><th>Memory</th><th>Disk</th><th>Network</th></tr>
            </thead>
            <tbody id="processTbody">
              <!-- Processes will be populated dynamically -->
            </tbody>
          </table>
          <button class="end-task-btn" disabled id="endTaskBtn">Select a process first</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Taskbar (template style) -->
  <div class="taskbar">
    <div class="start-button" id="startButton" title="Start">
      <span class="windows-logo">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="1" y="11" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="11" width="8" height="8" fill="#00BCF9"/>
        </svg>
      </span>
      Start
    </div>
    <div class="taskbar-icons"></div>
    <div class="system-tray" id="systemTray">
      <div class="tray-chip tray-time" id="trayTimeChip" title="Date and time">
        <div class="tray-time-col">
          <span id="trayTime">--:--</span>
          <span id="trayDate">-- ---</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Menu (Instructions only) -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">Start</div>
    <div class="start-menu-body">
      <div class="start-menu-left">
        <div class="app-item" data-app="instructions">
          <div class="icon instructions-icon">üìã</div>
          <span>Instructions</span>
        </div>
      </div>
      <div class="start-menu-right">
        <div class="app-list">
          <!-- Right column intentionally empty for this lab -->
        </div>
      </div>
    </div>
  </div>

  <!-- Start Button Context Menu -->
  <div class="context-menu" id="startContext">
    <div class="context-menu-item" data-app="taskmgr">
      <span class="icon">üß∞</span> Task Manager
    </div>
    <div class="context-menu-item" data-app="settings">
      <span class="icon">‚öôÔ∏è</span> Settings (disabled in this lab)
    </div>
  </div>

  <div id="toast"></div>

<script>
/* ==== Utilities ==== */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
function flashToast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1200); }

/* ==== DOM ==== */
const startButton = $('#startButton');
const startMenu = $('#startMenu');
const startContext = $('#startContext');
const instructionsWindow = $('#instructionsWindow');
const taskManagerWindow = $('#taskManagerWindow');
const taskManagerLoading = $('#taskManagerLoading');
const resetLab = $('#resetLab');
const closeBrowser = $('#closeBrowser');
const endTaskBtn = $('#endTaskBtn');
const trayTime = $('#trayTime');
const trayDate = $('#trayDate');
const photoViewerWindow = $('#photoViewerWindow');
const processTbody = $('#processTbody');

/* ==== Enhanced Process Data ==== */
const processData = [
  { name: 'Windows Explorer', status: 'Running', cpu: '0.1%', memory: '45.2 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true },
  { name: 'System', status: 'Running', cpu: '0.2%', memory: '120.5 MB', disk: '0.1 MB/s', network: '0 Mbps', responsive: true },
  { name: 'Microsoft Edge', status: 'Running', cpu: '1.5%', memory: '230.8 MB', disk: '0 MB/s', network: '0.2 Mbps', responsive: true },
  { name: 'Antimalware Service', status: 'Running', cpu: '0.8%', memory: '156.3 MB', disk: '0.3 MB/s', network: '0 Mbps', responsive: true },
  { name: 'Runtime Broker', status: 'Running', cpu: '0.3%', memory: '42.1 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true },
  { name: 'PhotoViewer.exe', status: 'Not responding', cpu: '95.2%', memory: '512.3 MB', disk: '15.2 MB/s', network: '0 Mbps', responsive: false },
  { name: 'Windows Security', status: 'Running', cpu: '0.3%', memory: '89.1 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true },
  { name: 'Cortana', status: 'Running', cpu: '0.1%', memory: '67.4 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true },
  { name: 'Service Host', status: 'Running', cpu: '0.4%', memory: '34.2 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true },
  { name: 'Font Driver Host', status: 'Running', cpu: '0.1%', memory: '12.8 MB', disk: '0 MB/s', network: '0 Mbps', responsive: true }
];

/* ==== Time chip ==== */
function updateTime(){
  const now=new Date();
  const h=String(now.getHours()).padStart(2,'0');
  const m=String(now.getMinutes()).padStart(2,'0');
  trayTime.textContent = h+':'+m;
  const opts = { day:'2-digit', month:'short' };
  trayDate.textContent = now.toLocaleDateString(undefined, opts).replace(' ', ' ');
}
updateTime(); setInterval(updateTime, 60000);

/* ==== Start menu behavior ==== */
startButton.addEventListener('click', (e) => {
  e.stopPropagation();
  startMenu.style.display = (startMenu.style.display==='block') ? 'none' : 'block';
  startContext.style.display = 'none';
});
// Right-click for context (Task Manager)
startButton.addEventListener('contextmenu', (e)=>{
  e.preventDefault(); e.stopPropagation();
  startMenu.style.display='none';
  // position context above taskbar, near start button
  const rect = startButton.getBoundingClientRect();
  startContext.style.left = rect.left + 'px';
  startContext.style.bottom = '52px';
  startContext.style.display = 'block';
});
document.addEventListener('click', (e) => {
  if (!startMenu.contains(e.target) && e.target !== startButton) startMenu.style.display = 'none';
  if (!startContext.contains(e.target) && e.target !== startButton) startContext.style.display = 'none';
});

// Start menu app: Instructions only
$$('.app-item').forEach(el => {
  el.addEventListener('click', () => {
    startMenu.style.display='none';
    const app = el.dataset.app;
    if (app === 'instructions') { instructionsWindow.style.display='flex'; }
  });
});

// Context menu -> Task Manager with realistic delay
$('#startContext [data-app="taskmgr"]').addEventListener('click', ()=>{
  startContext.style.display='none';
  
  // Show loading state
  taskManagerLoading.style.display = 'flex';
  taskManagerWindow.style.display='flex';
  
  // Simulate Task Manager loading time
  setTimeout(() => {
    taskManagerLoading.style.display = 'none';
    populateProcessList();
    flashToast('Task Manager is ready');
  }, 1500);
});

/* ==== Process List Management ==== */
function populateProcessList() {
  processTbody.innerHTML = '';
  processData.forEach((process, index) => {
    const tr = document.createElement('tr');
    if (!process.responsive) {
      tr.id = 'unresponsiveApp';
      tr.className = 'unresponsive';
    }
    tr.innerHTML = `
      <td>${process.name}</td>
      <td>${process.status}</td>
      <td>${process.cpu}</td>
      <td>${process.memory}</td>
      <td>${process.disk}</td>
      <td>${process.network}</td>
    `;
    processTbody.appendChild(tr);
  });
}

/* ==== Window controls & dragging ==== */
document.querySelectorAll('[data-close]').forEach(btn => {
  btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.window').style.display='none'; });
});
document.querySelectorAll('[data-minimize]').forEach(btn => {
  btn.addEventListener('click', (e) => { e.stopPropagation(); btn.closest('.window').style.display='none'; });
});
document.querySelectorAll('[data-maximize]').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    const w = btn.closest('.window');
    if (w.style.width === '100%') {
      if (w.id === 'instructionsWindow') { w.style.width='420px'; w.style.height='340px'; w.style.top='20px'; w.style.left='20px'; }
      else { w.style.width='760px'; w.style.height='500px'; w.style.top='90px'; w.style.left='260px'; }
    } else { w.style.width='100%'; w.style.height='calc(100% - 48px)'; w.style.top='0'; w.style.left='0'; }
  });
});

// Enhanced dragging for ALL windows including unresponsive one
let dragWin=null, sx=0, sy=0, ix=0, iy=0, dragging=false;

// Apply dragging to ALL window headers (including unresponsive window)
document.querySelectorAll('.window-header, .unresponsive-window .window-header').forEach(h => {
  h.addEventListener('mousedown', e => {
    // Don't start drag if clicking on window controls (except for unresponsive window where controls don't work)
    if (e.target.closest('.window-control') && !h.closest('.unresponsive-window')) return;
    
    e.preventDefault();
    dragWin = h.closest('.window, .unresponsive-window'); 
    dragging=true;
    sx=e.clientX; sy=e.clientY;
    
    // Get current position
    const currentLeft = parseInt(dragWin.style.left || getComputedStyle(dragWin).left);
    const currentTop = parseInt(dragWin.style.top || getComputedStyle(dragWin).top);
    
    ix = isNaN(currentLeft) ? 0 : currentLeft;
    iy = isNaN(currentTop) ? 0 : currentTop;
    
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
  });
});

function onDrag(e){ 
  if(!dragging||!dragWin) return; 
  dragWin.style.left=(ix + (e.clientX-sx))+'px'; 
  dragWin.style.top=(iy + (e.clientY-sy))+'px'; 
}

function stopDrag(){ 
  dragging=false; 
  dragWin=null; 
  document.removeEventListener('mousemove', onDrag); 
  document.removeEventListener('mouseup', stopDrag); 
}

/* ==== Enhanced Task Manager interactions ==== */
let selectedProcess = null;
processTbody.addEventListener('click', (e)=>{
  const row = e.target.closest('tr'); 
  if (!row) return;
  
  $$('#processTbody tr').forEach(r=>r.classList.remove('selected'));
  row.classList.add('selected');
  selectedProcess = row;
  endTaskBtn.disabled = false;
  endTaskBtn.textContent = 'End task';
});

function endTask(){
  if (!selectedProcess) return;
  
  // Add termination animation
  selectedProcess.classList.add('process-terminating');
  
  setTimeout(() => {
    if (selectedProcess.id === 'unresponsiveApp'){
      selectedProcess.remove();
      photoViewerWindow.style.display = 'none';
      flashToast('PhotoViewer.exe has been terminated');
    } else {
      flashToast('Process ended successfully');
      selectedProcess.remove();
    }
    
    endTaskBtn.disabled = true;
    endTaskBtn.textContent = 'Select a process first';
    selectedProcess = null;
    
    // Check if lab is complete
    if (!$('#unresponsiveApp')) {
      setTimeout(() => {
        flashToast('‚úÖ Lab completed successfully! The unresponsive app has been terminated.');
      }, 500);
    }
  }, 500);
}
endTaskBtn.addEventListener('click', endTask);

/* ==== Reset & Close Lab ==== */
resetLab.addEventListener('click', ()=>{
  // Reset process list
  populateProcessList();
  
  // Show the unresponsive window again at original position
  photoViewerWindow.style.display = 'block';
  photoViewerWindow.style.left = '500px';
  photoViewerWindow.style.top = '150px';
  
  // Clear selection/button
  $$('#processTbody tr').forEach(r=>r.classList.remove('selected'));
  endTaskBtn.disabled = true; 
  endTaskBtn.textContent = 'Select a process first';
  selectedProcess = null;
  
  // Hide menus/windows except instructions and unresponsive window
  startMenu.style.display='none'; 
  startContext.style.display='none';
  document.querySelectorAll('.window').forEach(w=>{ 
    if(w.id!=='instructionsWindow' && w.id!=='photoViewerWindow') w.style.display='none'; 
  });
  
  // Ensure instructions visible at default size/pos
  Object.assign(instructionsWindow.style,{display:'flex',width:'420px',height:'340px',left:'20px',top:'20px'});
  flashToast('Lab reset to initial state');
});

closeBrowser.addEventListener('click', ()=>{
  flashToast('Closing lab...');
  window.close();
  setTimeout(()=>{ window.location.href='about:blank'; }, 300);
});

// Show instructions by default
instructionsWindow.style.display='flex';

/* ==== Tray/Popover helpers (ported from template) ==== */
const systemTray = document.getElementById('systemTray');
const trayTimeChip = document.getElementById('trayTimeChip');

function makePopover(html){
  const el = document.createElement('div');
  el.className = 'tray-popover';
  el.innerHTML = html;
  document.body.appendChild(el);
  return el;
}
function togglePopover(popover, anchor){
  const r = anchor.getBoundingClientRect();
  popover.style.right  = (window.innerWidth - r.right) + 'px';
  popover.style.bottom = (window.innerHeight - r.top + 8) + 'px';
  const open = popover.style.display === 'block';
  document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  if (!open) popover.style.display='block';
}

/* ==== Time / Calendar popover ==== */
const timePopover = makePopover(`
  <div class="pop-header">Date & time</div>
  <div class="pop-body">
    <div class="calendar">
      <div class="big-clock" id="bigClock">--:--</div>
      <div class="small-date" id="smallDate">-- ---, ----</div>
      <div class="cal-header">
        <span id="prevMonth" style="cursor:pointer">‚Äπ</span>
        <span class="month" id="monthLabel">Month Year</span>
        <span id="nextMonth" style="cursor:pointer">‚Ä∫</span>
      </div>
      <div class="grid" id="calGrid">
        <div class="dow">Su</div><div class="dow">Mo</div><div class="dow">Tu</div>
        <div class="dow">We</div><div class="dow">Th</div><div class="dow">Fr</div><div class="dow">Sa</div>
      </div>
    </div>
  </div>
`);

/* Click binding for tray time chip */
if (trayTimeChip) {
  trayTimeChip.addEventListener('click', (e)=>{
    e.stopPropagation();
    updateClockAndDate();
    ensureCalendarRendered();
    togglePopover(timePopover, trayTimeChip);
  });
}

/* Click-away hide for popovers */
document.addEventListener('click', (e)=>{
  if (!systemTray.contains(e.target) && !e.target.closest('.tray-popover')) {
    document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  }
});
document.querySelectorAll('.tray-popover').forEach(p => p.addEventListener('click', e => e.stopPropagation()));

/* ==== Big clock + calendar rendering ==== */
function updateClockAndDate(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const bigClock = document.getElementById('bigClock');
  const smallDate = document.getElementById('smallDate');
  if (bigClock) bigClock.textContent = `${hh}:${mm}`;
  if (smallDate) smallDate.textContent = now.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
}

/* Calendar state + renderer */
let calRef = new Date(); // current month
function ensureCalendarRendered(){ renderCalendar(calRef); }
function renderCalendar(refDate){
  const monthLabel = document.getElementById('monthLabel');
  const grid = document.getElementById('calGrid');
  if (!monthLabel || !grid) return;

  // wipe previous days
  Array.from(grid.querySelectorAll('.day')).forEach(d=>d.remove());

  const y = refDate.getFullYear(), m = refDate.getMonth();
  monthLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, {month:'long', year:'numeric'});

  const first    = new Date(y, m, 1);
  const startDow = first.getDay();
  const daysIn   = new Date(y, m+1, 0).getDate();
  const prevDays = new Date(y, m, 0).getDate();

  // leading days
  for(let i=startDow-1; i>=0; i--){
    const el=document.createElement('div'); el.className='day other'; el.textContent=(prevDays - i); grid.appendChild(el);
  }

  // current month days with "today" highlight
  const today = new Date();
  const highlight = (today.getFullYear()===y && today.getMonth()===m) ? today.getDate() : -1;
  for(let d=1; d<=daysIn; d++){
    const el=document.createElement('div'); el.className='day'; el.textContent=d;
    if(d===highlight) el.classList.add('today');
    grid.appendChild(el);
  }

  // trailing days to complete the last week
  const totalCells = grid.querySelectorAll('.dow').length + grid.querySelectorAll('.day').length;
  const rem = totalCells % 7;
  if (rem !== 0){
    const need = 7 - rem;
    for(let d=1; d<=need; d++){
      const el=document.createElement('div'); el.className='day other'; el.textContent=d; grid.appendChild(el);
    }
  }
}

// month navigation (global click handler so it works inside popover)
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'prevMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1); ensureCalendarRendered(); }
  if (e.target && e.target.id === 'nextMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1); ensureCalendarRendered(); }
});
</script>
</body>
</html>