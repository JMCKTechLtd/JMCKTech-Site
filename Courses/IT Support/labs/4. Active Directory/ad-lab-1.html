<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab 22: Reset a User Password</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f0f0;
        }
        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid #d1d5db;
            height: calc(100vh - 6rem);
            overflow-y: auto;
        }
        .tree-node {
            padding: 4px 8px;
            cursor: pointer;
            user-select: none;
        }
        .tree-node:hover {
            background-color: #e5f0ff;
        }
        .tree-node.active {
            background-color: #0078d4;
            color: white;
        }
        .table-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #d1d5db;
        }
        .table-row:hover {
            background-color: #f1f5f9;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
        }
        .toast {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        .toast.success {
            background-color: #28a745;
            color: white;
        }
        .toast.error {
            background-color: #dc3545;
            color: white;
        }
        .toast.warning {
            background-color: #ffc107;
            color: black;
        }
        .instructions-panel {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .task-list li {
            margin-bottom: 10px;
        }
        .context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 150px;
        }
        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .context-menu-item:hover {
            background-color: #e5f0ff;
        }
        .context-menu-item.disabled {
            color: #999;
            cursor: not-allowed;
        }
        .context-menu-item.disabled:hover {
            background-color: white;
        }
        .search-box {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            margin-bottom: 10px;
            width: 100%;
        }
        .password-strength {
            height: 4px;
            margin-top: 4px;
            border-radius: 2px;
        }
        .password-weak { background-color: #dc3545; width: 25%; }
        .password-medium { background-color: #ffc107; width: 50%; }
        .password-strong { background-color: #28a745; width: 100%; }
        .account-locked {
            color: #dc3545;
            font-weight: bold;
        }
        .permission-denied {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm p-2">
        <h1 class="text-lg font-semibold text-gray-800">Active Directory Users and Computers - Blockshell.app</h1>
    </header>

    <!-- Toolbar -->
    <div class="bg-gray-100 p-2 border-b border-gray-300 flex items-center space-x-2">
        <button class="bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="openFindUserModal()">Find Users</button>
        <button class="bg-gray-300 px-3 py-1 rounded text-sm" onclick="refreshView()">Refresh</button>
        <div class="flex-1"></div>
        <span class="text-sm text-gray-600">Logged in as: <strong id="currentUser">ADMIN\jsmith</strong></span>
    </div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar: Instructions -->
        <div class="w-1/4 sidebar p-4">
            <div class="instructions-panel">
                <h2 class="text-lg font-semibold mb-4">Lab Instructions ‚Äî Reset a User Password</h2>
                <p class="mb-4">Use Active Directory Users and Computers (ADUC) to reset the password for <strong>Ethan Carter</strong> (Corporate > Finance) and require a password change at next logon (include Unlock account if needed).</p>
                <ul class="task-list list-disc pl-5">
                    <li>Click Blockshell.app to expand the domain structure.</li>
                    <li>Expand Corporate > Finance in the tree view.</li>
                    <li>Right-click <strong>Ethan Carter</strong> in the object list and select "Reset Password‚Ä¶".</li>
                    <li>Enter and confirm a new password. Check "User must change password at next logon" (and "Unlock account" if required). Click OK.</li>
                    <li>Observe the green success toast at the bottom.</li>
                </ul>
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <h3 class="font-semibold text-yellow-800">Password Policy Requirements:</h3>
                    <ul class="text-sm text-yellow-700 mt-1 list-disc pl-5">
                        <li>Minimum 8 characters</li>
                        <li>At least one uppercase letter</li>
                        <li>At least one lowercase letter</li>
                        <li>At least one number</li>
                        <li>At least one special character (!@#$%^&*)</li>
                    </ul>
                </div>
                <div class="flex justify-between mt-4">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="resetLab()">Reset Lab</button>
                    <button class="bg-gray-300 px-4 py-2 rounded" onclick="closeLab()">Close Lab</button>
                </div>
            </div>
            <div class="text-sm text-gray-600 mt-4">Tip: Click the time at the bottom-right to open the popup calendar.</div>
        </div>

        <!-- Main Panel: AD Tree and Object List -->
        <div class="flex-1 p-4 bg-white">
            <div class="flex h-full">
                <!-- AD Tree -->
                <div class="w-1/3 border-r border-gray-300 pr-4">
                    <div id="treeView">
                        <div class="tree-node active" data-path="" onclick="toggleNode(this)">üìÅ Blockshell.app</div>
                        <div class="pl-4 hidden" data-child="">
                            <div class="tree-node" data-path="Administration" onclick="toggleNode(this)">üìÅ Administration</div>
                            <div class="pl-8 hidden" data-child="Administration">
                                <div class="tree-node" data-path="Administration/Service Accounts" onclick="selectNode(this)">üìÅ Service Accounts</div>
                            </div>
                            <div class="tree-node" data-path="Corporate" onclick="toggleNode(this)">üìÅ Corporate</div>
                            <div class="pl-8 hidden" data-child="Corporate">
                                <div class="tree-node" data-path="Corporate/Finance" onclick="selectNode(this)">üìÅ Finance</div>
                                <div class="tree-node" data-path="Corporate/Human Resources" onclick="selectNode(this)">üìÅ Human Resources</div>
                            </div>
                            <div class="tree-node" data-path="Builtin" onclick="selectNode(this)">üìÅ Builtin</div>
                            <div class="tree-node" data-path="Computers" onclick="toggleNode(this)">üìÅ Computers</div>
                            <div class="pl-8 hidden" data-child="Computers">
                                <div class="tree-node" data-path="Computers/Workstations" onclick="selectNode(this)">üìÅ Workstations</div>
                                <div class="tree-node" data-path="Computers/Servers" onclick="selectNode(this)">üìÅ Servers</div>
                            </div>
                            <div class="tree-node" data-path="Domain Controllers" onclick="selectNode(this)">üìÅ Domain Controllers</div>
                            <div class="tree-node" data-path="ForeignSecurityPrincipals" onclick="selectNode(this)">üìÅ ForeignSecurityPrincipals</div>
                            <div class="tree-node" data-path="ITEC_Import" onclick="toggleNode(this)">üìÅ ITEC_Import</div>
                            <div class="pl-8 hidden" data-child="ITEC_Import">
                                <div class="tree-node" data-path="ITEC_Import/Development" onclick="selectNode(this)">üìÅ Development</div>
                            </div>
                            <div class="tree-node" data-path="Managed Service Accounts" onclick="selectNode(this)">üìÅ Managed Service Accounts</div>
                            <div class="tree-node" data-path="Users" onclick="selectNode(this)">üìÅ Users</div>
                        </div>
                    </div>
                </div>

                <!-- Object List -->
                <div class="flex-1 pl-4">
                    <input type="text" id="searchBox" class="search-box" placeholder="Search objects..." onkeyup="filterObjects()">
                    <table id="objectTable" class="w-full text-sm text-left text-gray-700">
                        <thead class="table-header">
                            <tr>
                                <th class="p-2">Name</th>
                                <th class="p-2">Type</th>
                                <th class="p-2">Description</th>
                                <th class="p-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="objectTableBody"></tbody>
                    </table>
                    <div id="objectCount" class="mt-2 text-sm text-gray-600">Select a container to view its contents.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu hidden">
        <div class="context-menu-item" onclick="openResetPasswordModal()">Reset Password‚Ä¶</div>
        <div class="context-menu-item" onclick="openPropertiesModal()">Properties</div>
        <div class="context-menu-item disabled">Move‚Ä¶</div>
        <hr class="my-1">
        <div class="context-menu-item">Cut</div>
        <div class="context-menu-item">Copy</div>
        <div class="context-menu-item disabled">Paste</div>
        <hr class="my-1">
        <div class="context-menu-item">Delete</div>
        <div class="context-menu-item">Rename</div>
        <hr class="my-1">
        <div class="context-menu-item">Refresh</div>
        <div class="context-menu-item">Properties</div>
    </div>

    <!-- Modal for Find User -->
    <div id="findUserModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Find Users, Contacts, and Groups</h2>
            <div class="mb-4">
                <label class="block mb-2">Name:</label>
                <input type="text" id="findUserName" class="w-full border border-gray-300 rounded px-2 py-1 mb-2">
                <label class="block mb-2">Description:</label>
                <input type="text" id="findUserDescription" class="w-full border border-gray-300 rounded px-2 py-1">
            </div>
            <div class="flex justify-end space-x-2">
                <button class="bg-gray-300 px-4 py-2 rounded" onclick="closeFindUserModal()">Cancel</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="findUsers()">Find Now</button>
            </div>
            <div id="findResults" class="mt-4 max-h-60 overflow-y-auto hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2">Name</th>
                            <th class="p-2">Type</th>
                        </tr>
                    </thead>
                    <tbody id="findResultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for Reset Password -->
    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <h2 class="text-lg font-semibold mb-4">Reset Password for <span id="resetUserName"></span></h2>
            <label class="block mb-2">New password:</label>
            <input id="newPassword" type="password" class="w-full border border-gray-300 rounded px-2 py-1 mb-2" onkeyup="checkPasswordStrength()">
            <div id="passwordStrength" class="password-strength hidden"></div>
            <label class="block mb-2">Confirm password:</label>
            <input id="confirmPassword" type="password" class="w-full border border-gray-300 rounded px-2 py-1 mb-4" onkeyup="checkPasswordMatch()">
            <label class="flex items-center mb-4">
                <input id="changePasswordNextLogon" type="checkbox" class="mr-2">
                User must change password at next logon
            </label>
            <label class="flex items-center mb-4">
                <input id="unlockAccount" type="checkbox" class="mr-2">
                Unlock account
            </label>
            <div id="passwordRequirements" class="text-xs text-gray-600 mb-4">
                <div>Password must meet complexity requirements:</div>
                <div id="lengthReq" class="text-red-500">‚Ä¢ At least 8 characters</div>
                <div id="upperReq" class="text-red-500">‚Ä¢ At least one uppercase letter (A-Z)</div>
                <div id="lowerReq" class="text-red-500">‚Ä¢ At least one lowercase letter (a-z)</div>
                <div id="numberReq" class="text-red-500">‚Ä¢ At least one number (0-9)</div>
                <div id="specialReq" class="text-red-500">‚Ä¢ At least one special character (!@#$%^&*)</div>
            </div>
            <p id="passwordError" class="text-red-500 text-sm hidden"></p>
            <div class="flex justify-end space-x-2">
                <button class="bg-gray-300 px-4 py-2 rounded" onclick="closeResetPasswordModal()">Cancel</button>
                <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="resetPassword()">OK</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Date and Time Display -->
    <div class="fixed bottom-4 right-4 text-sm text-gray-600 cursor-pointer" onclick="toggleCalendar()">
        <span id="currentTime">--:--</span>
        <span id="currentDate">-- ---, ----</span>
    </div>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between mb-4">
                <button onclick="prevMonth()">‚Äπ</button>
                <span id="calendarMonthYear">Month Year</span>
                <button onclick="nextMonth()">‚Ä∫</button>
            </div>
            <table class="w-full text-sm">
                <thead>
                    <tr>
                        <th>Su</th><th>Mo</th><th>Tu</th><th>We</th><th>Th</th><th>Fr</th><th>Sa</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button class="bg-gray-300 px-4 py-2 rounded" onclick="toggleCalendar()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced data structure with more realistic properties
        let currentPath = '';
        let history = [''];
        let historyIndex = 0;
        let currentUser = 'ADMIN\\jsmith';
        let userPermissions = {
            'ADMIN\\jsmith': { canResetPasswords: true, canUnlockAccounts: true },
            'CORP\\helpdesk': { canResetPasswords: true, canUnlockAccounts: false }
        };

        let objects = [
            { name: 'Administration', type: 'Organizational Unit', description: 'Administrative accounts and groups', path: 'Administration' },
            { name: 'Service Accounts', type: 'Organizational Unit', description: 'Service account management', path: 'Administration/Service Accounts' },
            { name: 'svc_sql', type: 'User', description: 'SQL Server service account', path: 'Administration/Service Accounts/svc_sql', locked: false, lastPasswordSet: '2025-01-15' },
            { name: 'svc_web', type: 'User', description: 'Web server service account', path: 'Administration/Service Accounts/svc_web', locked: false, lastPasswordSet: '2025-02-20' },
            { name: 'Corporate', type: 'Organizational Unit', description: 'Corporate Domain Objects', path: 'Corporate' },
            { name: 'Finance', type: 'Organizational Unit', description: 'Finance department objects', path: 'Corporate/Finance' },
            { name: 'Ethan Carter', type: 'User', description: 'Finance Director', path: 'Corporate/Finance/Ethan Carter', locked: true, lastPasswordSet: '2024-12-01', loginAttempts: 5 },
            { name: 'Marcus Patel', type: 'User', description: 'Finance Manager', path: 'Corporate/Finance/Marcus Patel', locked: false, lastPasswordSet: '2025-08-15' },
            { name: 'Finance Admins', type: 'Security Group', description: 'Finance department administrators', path: 'Corporate/Finance/Finance Admins' },
            { name: 'Human Resources', type: 'Organizational Unit', description: 'HR department objects', path: 'Corporate/Human Resources' },
            { name: 'Daniel Novak', type: 'User', description: 'HR Director', path: 'Corporate/Human Resources/Daniel Novak', locked: false, lastPasswordSet: '2025-07-10' },
            { name: 'Sophia Kim', type: 'User', description: 'HR Manager', path: 'Corporate/Human Resources/Sophia Kim', locked: false, lastPasswordSet: '2025-08-22' },
            { name: 'HR Staff', type: 'Security Group', description: 'HR department staff group', path: 'Corporate/Human Resources/HR Staff' },
            { name: 'Builtin', type: 'builtinDomain', description: 'Built-in security principals', path: 'Builtin' },
            { name: 'Administrators', type: 'Security Group', description: 'Built-in Administrators group', path: 'Builtin/Administrators' },
            { name: 'Guests', type: 'Security Group', description: 'Built-in Guests group', path: 'Builtin/Guests' },
            { name: 'Computers', type: 'Container', description: 'Default container for upgraded computer accounts', path: 'Computers' },
            { name: 'Workstations', type: 'Organizational Unit', description: 'Workstation computers', path: 'Computers/Workstations' },
            { name: 'WKSTN001', type: 'Computer', description: 'Employee Workstation', path: 'Computers/Workstations/WKSTN001' },
            { name: 'WKSTN002', type: 'Computer', description: 'Employee Workstation', path: 'Computers/Workstations/WKSTN002' },
            { name: 'Servers', type: 'Organizational Unit', description: 'Server computers', path: 'Computers/Servers' },
            { name: 'SRV001', type: 'Computer', description: 'File Server', path: 'Computers/Servers/SRV001' },
            { name: 'SRV002', type: 'Computer', description: 'Application Server', path: 'Computers/Servers/SRV002' },
            { name: 'Domain Controllers', type: 'Organizational Unit', description: 'Default container for domain controllers', path: 'Domain Controllers' },
            { name: 'DC01', type: 'Computer', description: 'Primary Domain Controller', path: 'Domain Controllers/DC01' },
            { name: 'DC02', type: 'Computer', description: 'Secondary Domain Controller', path: 'Domain Controllers/DC02' },
            { name: 'ForeignSecurityPrincipals', type: 'Container', description: 'Default container for security principals', path: 'ForeignSecurityPrincipals' },
            { name: 'ExtPartner1', type: 'Security Group', description: 'External Partner Group', path: 'ForeignSecurityPrincipals/ExtPartner1' },
            { name: 'ITEC_Import', type: 'Organizational Unit', description: 'Imported IT objects', path: 'ITEC_Import' },
            { name: 'Development', type: 'Organizational Unit', description: 'Development team objects', path: 'ITEC_Import/Development' },
            { name: 'Oliver Rossi', type: 'User', description: 'Lead Developer', path: 'ITEC_Import/Development/Oliver Rossi', locked: false, lastPasswordSet: '2025-08-18' },
            { name: 'Layla Ahmed', type: 'User', description: 'Senior Developer', path: 'ITEC_Import/Development/Layla Ahmed', locked: false, lastPasswordSet: '2025-08-12' },
            { name: 'Chloe Bennett', type: 'User', description: 'Developer', path: 'ITEC_Import/Development/Chloe Bennett', locked: true, lastPasswordSet: '2024-11-30', loginAttempts: 3 },
            { name: 'Ryan Fischer', type: 'User', description: 'Developer', path: 'ITEC_Import/Development/Ryan Fischer', locked: false, lastPasswordSet: '2025-08-25' },
            { name: 'Dev Team', type: 'Security Group', description: 'Development team group', path: 'ITEC_Import/Development/Dev Team' },
            { name: 'Managed Service Accounts', type: 'Container', description: 'Default container for managed service accounts', path: 'Managed Service Accounts' },
            { name: 'msa_app1', type: 'User', description: 'Managed Service Account for App1', path: 'Managed Service Accounts/msa_app1' },
            { name: 'Users', type: 'Container', description: 'Default container for upgraded user accounts', path: 'Users' },
            { name: 'Guest', type: 'User', description: 'Default Guest Account', path: 'Users/Guest', locked: true, lastPasswordSet: '2020-01-01' }
        ];

        // Password policy simulation
        const passwordPolicy = {
            minLength: 8,
            requireUppercase: true,
            requireLowercase: true,
            requireNumbers: true,
            requireSpecial: true,
            passwordHistory: 3
        };

        function toggleNode(element) {
            const childDiv = document.querySelector(`[data-child="${element.dataset.path}"]`);
            if (childDiv) {
                childDiv.classList.toggle('hidden');
            }
            selectNode(element);
        }

        function selectNode(element) {
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
            element.classList.add('active');
            currentPath = element.dataset.path === '' ? '' : element.dataset.path;
            history = history.slice(0, historyIndex + 1);
            history.push(currentPath);
            historyIndex++;
            updateObjectTable();
        }

        function updateObjectTable() {
            const tbody = document.getElementById('objectTableBody');
            const objectCount = document.getElementById('objectCount');
            tbody.innerHTML = '';
            if (!currentPath) {
                objectCount.textContent = 'Select a container to view its contents.';
                return;
            }
            const filteredObjects = objects.filter(obj => {
                const objPath = obj.path;
                const isDirectChild = objPath.startsWith(currentPath) && 
                                    objPath !== currentPath && 
                                    objPath.split('/').length === currentPath.split('/').length + 1;
                return isDirectChild;
            });
            
            filteredObjects.forEach(obj => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.dataset.name = obj.name;
                row.dataset.path = obj.path;
                
                const icon = obj.type === 'User' ? 'üë§' : obj.type === 'Computer' ? 'üíª' : obj.type === 'Security Group' ? 'üë•' : 'üìÅ';
                const status = obj.locked ? '<span class="account-locked">Locked</span>' : (obj.type === 'User' ? 'Active' : '');
                
                row.innerHTML = `
                    <td class="p-2">${icon} ${obj.name}</td>
                    <td class="p-2">${obj.type}</td>
                    <td class="p-2">${obj.description}</td>
                    <td class="p-2">${status}</td>
                `;
                
                row.addEventListener('click', () => {
                    document.querySelectorAll('.table-row').forEach(r => r.classList.remove('bg-blue-100'));
                    row.classList.add('bg-blue-100');
                });
                
                row.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, obj);
                });
                
                tbody.appendChild(row);
            });
            objectCount.textContent = `${filteredObjects.length} object(s)`;
        }

        function filterObjects() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const tbody = document.getElementById('objectTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const name = row.dataset.name.toLowerCase();
                const description = row.cells[2].textContent.toLowerCase();
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        function showContextMenu(e, obj) {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.classList.remove('hidden');
            contextMenu.dataset.path = obj.path;
            
            // Enable/disable menu items based on permissions and object type
            const resetPasswordItem = contextMenu.querySelector('.context-menu-item');
            if (obj.type !== 'User' || !userPermissions[currentUser].canResetPasswords) {
                resetPasswordItem.classList.add('disabled');
            } else {
                resetPasswordItem.classList.remove('disabled');
            }
            
            document.addEventListener('click', hideContextMenu, { once: true });
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
        }

        function openFindUserModal() {
            document.getElementById('findUserModal').style.display = 'flex';
            document.getElementById('findUserName').value = '';
            document.getElementById('findUserDescription').value = '';
            document.getElementById('findResults').classList.add('hidden');
        }

        function closeFindUserModal() {
            document.getElementById('findUserModal').style.display = 'none';
        }

        function findUsers() {
            const name = document.getElementById('findUserName').value.toLowerCase();
            const description = document.getElementById('findUserDescription').value.toLowerCase();
            const resultsBody = document.getElementById('findResultsBody');
            const resultsDiv = document.getElementById('findResults');
            
            resultsBody.innerHTML = '';
            
            const filteredUsers = objects.filter(obj => 
                obj.type === 'User' && 
                (!name || obj.name.toLowerCase().includes(name)) &&
                (!description || obj.description.toLowerCase().includes(description))
            );
            
            if (filteredUsers.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="2" class="p-2 text-center">No users found</td></tr>';
            } else {
                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = 'cursor-pointer hover:bg-gray-100';
                    row.innerHTML = `
                        <td class="p-2">${user.name}</td>
                        <td class="p-2">${user.type}</td>
                    `;
                    row.addEventListener('click', () => {
                        // Navigate to the user's location
                        const pathParts = user.path.split('/').slice(0, -1);
                        const containerPath = pathParts.join('/');
                        navigateToPath(containerPath);
                        closeFindUserModal();
                    });
                    resultsBody.appendChild(row);
                });
            }
            
            resultsDiv.classList.remove('hidden');
        }

        function navigateToPath(path) {
            // Expand tree nodes to reveal the path
            const pathParts = path.split('/').filter(p => p);
            let currentTreePath = '';
            
            pathParts.forEach(part => {
                currentTreePath = currentTreePath ? `${currentTreePath}/${part}` : part;
                const node = document.querySelector(`.tree-node[data-path="${currentTreePath}"]`);
                if (node) {
                    toggleNode(node);
                }
            });
            
            // Select the final container
            const finalNode = document.querySelector(`.tree-node[data-path="${path}"]`);
            if (finalNode) {
                selectNode(finalNode);
            }
        }

        function openResetPasswordModal() {
            const contextMenu = document.getElementById('contextMenu');
            const selectedRow = document.querySelector('.table-row.bg-blue-100') || 
                              document.querySelector(`tr[data-path="${contextMenu.dataset.path || ''}"]`);
            if (selectedRow) {
                const path = selectedRow.dataset.path;
                const obj = objects.find(o => o.path === path);
                if (obj && obj.type === 'User') {
                    // Check permissions
                    if (!userPermissions[currentUser].canResetPasswords) {
                        showToast('Access Denied: You do not have permission to reset passwords.', 'error');
                        return;
                    }
                    
                    document.getElementById('resetUserName').textContent = obj.name;
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('changePasswordNextLogon').checked = false;
                    document.getElementById('unlockAccount').checked = obj.locked || false;
                    document.getElementById('unlockAccount').disabled = !userPermissions[currentUser].canUnlockAccounts;
                    document.getElementById('passwordError').classList.add('hidden');
                    document.getElementById('passwordStrength').classList.add('hidden');
                    resetPasswordRequirements();
                    document.getElementById('resetPasswordModal').style.display = 'flex';
                    hideContextMenu();
                }
            }
        }

        function resetPasswordRequirements() {
            const reqs = ['lengthReq', 'upperReq', 'lowerReq', 'numberReq', 'specialReq'];
            reqs.forEach(req => {
                document.getElementById(req).classList.add('text-red-500');
                document.getElementById(req).classList.remove('text-green-500');
            });
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthBar.classList.add('hidden');
                resetPasswordRequirements();
                return;
            }
            
            strengthBar.classList.remove('hidden');
            
            // Check requirements
            const hasLength = password.length >= passwordPolicy.minLength;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*]/.test(password);
            
            // Update requirement indicators
            document.getElementById('lengthReq').classList.toggle('text-green-500', hasLength);
            document.getElementById('upperReq').classList.toggle('text-green-500', hasUpper);
            document.getElementById('lowerReq').classList.toggle('text-green-500', hasLower);
            document.getElementById('numberReq').classList.toggle('text-green-500', hasNumber);
            document.getElementById('specialReq').classList.toggle('text-green-500', hasSpecial);
            
            // Calculate strength
            let strength = 0;
            if (hasLength) strength++;
            if (hasUpper) strength++;
            if (hasLower) strength++;
            if (hasNumber) strength++;
            if (hasSpecial) strength++;
            
            // Update strength bar
            strengthBar.className = 'password-strength';
            if (strength <= 2) {
                strengthBar.classList.add('password-weak');
            } else if (strength <= 4) {
                strengthBar.classList.add('password-medium');
            } else {
                strengthBar.classList.add('password-strong');
            }
        }

        function checkPasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            if (confirm && password !== confirm) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
            }
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').style.display = 'none';
        }

        function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const changeAtNextLogon = document.getElementById('changePasswordNextLogon').checked;
            const unlockAccount = document.getElementById('unlockAccount').checked;
            const errorDiv = document.getElementById('passwordError');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Validate password meets policy
            const hasLength = newPassword.length >= passwordPolicy.minLength;
            const hasUpper = /[A-Z]/.test(newPassword);
            const hasLower = /[a-z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);
            const hasSpecial = /[!@#$%^&*]/.test(newPassword);
            
            if (!hasLength || !hasUpper || !hasLower || !hasNumber || !hasSpecial) {
                errorDiv.textContent = 'Password does not meet complexity requirements.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Check unlock permissions
            if (unlockAccount && !userPermissions[currentUser].canUnlockAccounts) {
                errorDiv.textContent = 'Access Denied: You do not have permission to unlock accounts.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Perform the reset
            const contextMenu = document.getElementById('contextMenu');
            const selectedRow = document.querySelector('.table-row.bg-blue-100') || 
                              document.querySelector(`tr[data-path="${contextMenu.dataset.path || ''}"]`);
            if (selectedRow) {
                const path = selectedRow.dataset.path;
                const objIndex = objects.findIndex(o => o.path === path);
                if (objIndex !== -1) {
                    // Update the user object
                    objects[objIndex].locked = unlockAccount ? false : objects[objIndex].locked;
                    objects[objIndex].lastPasswordSet = new Date().toISOString().split('T')[0];
                    if (objects[objIndex].loginAttempts) {
                        objects[objIndex].loginAttempts = 0;
                    }
                    
                    showToast(`Password for ${objects[objIndex].name} has been reset successfully${unlockAccount ? ' and account unlocked' : ''}.`, 'success');
                    closeResetPasswordModal();
                    updateObjectTable();
                }
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }

        function resetLab() {
            // Reset all users to their initial state
            objects = objects.map(obj => {
                if (obj.type === 'User') {
                    // Reset Ethan Carter and Chloe Bennett to locked state
                    if (obj.name === 'Ethan Carter') {
                        return { ...obj, locked: true, lastPasswordSet: '2024-12-01', loginAttempts: 5 };
                    } else if (obj.name === 'Chloe Bennett') {
                        return { ...obj, locked: true, lastPasswordSet: '2024-11-30', loginAttempts: 3 };
                    } else if (obj.name === 'Guest') {
                        return { ...obj, locked: true, lastPasswordSet: '2020-01-01' };
                    }
                }
                return obj;
            });
            
            currentPath = '';
            history = [''];
            historyIndex = 0;
            document.querySelectorAll('[data-child]').forEach(child => child.classList.add('hidden'));
            document.getElementById('searchBox').value = '';
            updateTreeSelection();
            updateObjectTable();
            showToast('Lab has been reset to initial state.', 'warning');
        }

        function closeLab() {
            if (confirm('Are you sure you want to close the lab?')) {
                window.close();
            }
        }

        function refreshView() {
            updateObjectTable();
            showToast('View refreshed.', 'success');
        }

        // Date and Time
        function updateTime() {
            const now = new Date('2025-09-20T20:58:00Z'); // 09:58 PM BST
            const timeString = now.toLocaleTimeString('en-GB', { hour12: true, hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }

        let currentMonth = 8; // September
        let currentYear = 2025;

        function updateCalendar() {
            const monthYear = document.getElementById('calendarMonthYear');
            const calendarBody = document.getElementById('calendarBody');
            monthYear.textContent = `${new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long' })} ${currentYear}`;
            calendarBody.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let row = document.createElement('tr');
            for (let i = 0; i < firstDay; i++) {
                row.innerHTML += '<td></td>';
            }
            for (let day = 1; day <= daysInMonth; day++) {
                if ((firstDay + day - 1) % 7 === 0 && day !== 1) {
                    calendarBody.appendChild(row);
                    row = document.createElement('tr');
                }
                const cellClass = day === 20 ? ' bg-blue-200' : '';
                row.innerHTML += `<td class="p-1 text-center${cellClass}">${day}</td>`;
            }
            calendarBody.appendChild(row);
        }

        function toggleCalendar() {
            const calendarModal = document.getElementById('calendarModal');
            calendarModal.style.display = calendarModal.style.display === 'flex' ? 'none' : 'flex';
            if (calendarModal.style.display === 'flex') updateCalendar();
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        }

        // Initialize
        document.getElementById('currentUser').textContent = currentUser;
        updateTime();
        updateObjectTable();
        
        // Set up proper right-click behavior
        document.addEventListener('contextmenu', (e) => {
            if (!e.target.closest('.table-row')) {
                hideContextMenu();
            }
        });
    </script>
</body>
</html>