<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 15: IP Configuration</title>
<style>
/* ==== Desktop background (matches template) ==== */
html,body{height:100%;margin:0;font-family:Segoe UI, Roboto, Arial, Helvetica, sans-serif}
body{background:linear-gradient(120deg,#1976d2,#0d47a1);color:#111;overflow:hidden}
#desktop{position:absolute;inset:0 0 48px 0;padding:14px}

/* ==== Windows (simulation) ==== */
.window{position:absolute;background:#fff;border:1px solid #c9c9c9;border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,.35);display:none;flex-direction:column;overflow:hidden}
.window-header{background:#e9e9e9;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:move;border-bottom:1px solid #cfcfcf;user-select:none}
.window-title{font-weight:600;flex:1}
.window-controls{display:flex;gap:6px}
.window-control{width:24px;height:24px;border-radius:6px;background:#dcdcdc;display:grid;place-items:center;cursor:pointer}
.window-control:hover{background:#cfcfcf}
.window-body{padding:10px;overflow:auto;background:#fff;flex:1}

/* ==== Instructions window ==== */
#instructionsWindow{left:20px;top:20px;width:500px;height:420px;display:flex}
#instructionsWindow .window-body ol{margin:0 0 6px 18px}
#instructionsWindow .window-body ol li{margin:6px 0}
#instructionsWindow .window-body .btnrow{margin-top:10px;display:flex;gap:8px}
button{border:1px solid #c9c9c9;background:#efefef;padding:6px 10px;border-radius:6px;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

/* ==== Command Prompt window ==== */
#cmdWindow{left:260px;top:90px;width:760px;height:480px}
#cmdWindow .window-body{padding:0;background:#0c0c0c;color:#0f0;font-family:Consolas, "Courier New", monospace;font-size:14px;display:flex;flex-direction:column}
.cmd-output{white-space:pre-wrap;line-height:1.35;padding:12px;flex:1;overflow:auto}
.cmd-prompt{color:#0f0;white-space:pre}
.caret{display:inline-block;width:10px;height:1em;background:#0f0;margin-left:2px;animation:blink 1s steps(1,end) infinite;vertical-align:bottom}
@keyframes blink{50%{opacity:0}}

/* ==== Network Status Window ==== */
#networkWindow{left:540px;top:20px;width:480px;height:300px;display:none}
.network-status{padding:10px;border-radius:6px;margin:8px 0;font-weight:600}
.status-apipa{background:#fff3cd;border:1px solid #ffeaa7;color:#856404}
.status-released{background:#f8d7da;border:1px solid #f5c6cb;color:#721c24}
.status-dhcp{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460}
.status-disconnected{background:#e2e3e5;border:1px solid #d6d8db;color:#383d41}
.interface-details{margin-top:15px;padding:10px;background:#f8f9fa;border-radius:6px;border:1px solid #dee2e6}
.dhcp-process{background:#e8f5e8;padding:8px;border-radius:4px;margin:5px 0;font-size:12px;border-left:3px solid #28a745}

/* ==== Toast ==== */
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#2e7d32;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:500;box-shadow:0 8px 24px rgba(0,0,0,.35)}

/* ==== Taskbar + tray ==== */
.taskbar{position:absolute;bottom:0;width:100vw;height:48px;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:flex;align-items:center;padding:0 10px;z-index:100;border-top:1px solid rgba(255,255,255,0.1);overflow:hidden;box-sizing:border-box}
.start-button{color:white;font-weight:600;display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;transition:all 0.2s ease;font-size:14px;background:rgba(255,255,255,0.22);border:1px solid rgba(255,255,255,0.35);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06)}
.start-button:hover{background-color:rgba(255,255,255,0.32);border-color:rgba(255,255,255,0.5)}
.windows-logo{width:20px;height:20px;margin-right:2px;display:inline-block}
.taskbar-icons{display:flex;gap:8px;margin-left:10px}
.system-tray{display:flex;align-items:center;color:white;font-size:13px;padding:0 6px;white-space:nowrap;gap:6px;margin-left:auto}
.tray-chip{display:inline-flex;align-items:center;gap:8px;height:32px;padding:0 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:10px;cursor:pointer;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);transition:transform .12s ease, background .15s ease, border-color .15s ease}
.tray-chip:hover{background:rgba(255,255,255,0.16);border-color:rgba(255,255,255,0.35);transform:translateY(-1px)}
.tray-time{min-width:78px;justify-content:center;font-variant-numeric:tabular-nums}

/* ==== Start Menu ==== */
.start-menu{position:absolute;bottom:52px;left:12px;width:520px;height:360px;background:rgba(30,30,30,0.97);color:white;border:1px solid rgba(255,255,255,0.12);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.4);backdrop-filter:blur(16px);display:none;overflow:hidden auto;z-index:200}
.start-menu-header{padding:16px 20px;background:rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:16px}
.start-menu-body{display:grid;grid-template-columns:1fr 1fr;height:calc(100% - 60px)}
.start-menu-left{padding:16px;background:rgba(255,255,255,0.02);border-right:1px solid rgba(255,255,255,0.08)}
.start-menu-right{padding:16px}
.app-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;transition:background 0.2s ease;margin-bottom:8px}
.app-item:hover{background:rgba(255,255,255,0.08)}
.app-item .icon{width:32px;height:32px;border-radius:6px;background:#0078d4;display:flex;align-items:center;justify-content:center;font-size:16px}
.instructions-icon{background:linear-gradient(45deg,#ff6b35,#f7931e)!important}
.network-icon{background:linear-gradient(45deg,#4caf50,#8bc34a)!important}
.app-list{max-height:100%;overflow-y:auto}

/* Utilities */
.hidden{display:none!important}
.success{color:#4caf50}
.error{color:#f44336}
.warning{color:#ff9800}

/* === Tray Popover + Calendar === */
.tray-popover {
  position: absolute; display: none; min-width: 300px;
  background: rgba(30,30,30,0.97); color: white;
  border: 1px solid rgba(255,255,255,0.12); border-radius: 12px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.4); z-index: 400; overflow: hidden; backdrop-filter: blur(16px);
}
.tray-popover .pop-header { padding: 12px 16px; background: rgba(255,255,255,0.06); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; font-size: 13px; }
.tray-popover .pop-body { padding: 14px 16px; font-size: 13px; max-height: 380px; overflow:auto; }
.row { display:flex; align-items:center; gap:10px; }
.muted { opacity:0.85; }

.calendar{ width:100%; user-select:none; }
.calendar .big-clock{ font-size:28px; font-weight:700; margin-bottom:6px; }
.calendar .small-date{ opacity:.9; margin-bottom:10px; }
.calendar .cal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
.calendar .month{ font-weight:600; }
.calendar .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:12px; }
.calendar .dow{ text-align:center; opacity:.8; padding:4px 0; }
.calendar .day{ text-align:center; padding:6px 0; border-radius:6px; }
.calendar .day.today{ background:#1976d2; color:#fff; }
.calendar .day.other{ opacity:.35; }

</style>
</head>
<body>
  <div id="desktop">
    <!-- Instructions window -->
    <div class="window" id="instructionsWindow" style="display:flex">
      <div class="window-header">
        <div class="window-title">Lab 15: IP Configuration</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <p><strong>Goal:</strong> Diagnose network issues and restore proper DHCP configuration.</p>
        <ol>
          <li>Open <strong>Command Prompt</strong> and <strong>Network Status</strong> windows</li>
          <li>Run <code>ipconfig /all</code> ‚Äî observe the <strong>APIPA</strong> address</li>
          <li>Test connectivity with <code>ping 192.168.1.1</code> ‚Äî note failures</li>
          <li>Run <code>ipconfig /release</code> ‚Äî clear current configuration</li>
          <li>Run <code>ipconfig /renew</code> ‚Äî obtain valid DHCP lease</li>
          <li>Test connectivity again ‚Äî verify network functionality</li>
          <li>Observe DHCP process in Network Status window</li>
        </ol>
        <div class="btnrow">
          <button id="resetLab">Reset Lab</button>
          <button id="closeBrowser">Close Lab</button>
        </div>
      </div>
    </div>

    <!-- Command Prompt window -->
    <div class="window" id="cmdWindow">
      <div class="window-header">
        <div class="window-title">Command Prompt</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="cmd-output" id="cmdOut">Microsoft Windows [Version 10.0.19045.4529]
(c) Microsoft Corporation. All rights reserved.

</div>
      </div>
    </div>

    <!-- Network Status Window -->
    <div class="window" id="networkWindow">
      <div class="window-header">
        <div class="window-title">Network Status - Ethernet</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div id="networkStatusDisplay">
          <div class="network-status status-apipa" id="statusIndicator">
            ‚ö†Ô∏è APIPA Address Assigned (169.254.x.x)
          </div>
          <div class="interface-details">
            <strong>Interface Status:</strong> <span id="interfaceStatus">Operational</span><br>
            <strong>Media State:</strong> <span id="mediaState">Connected</span><br>
            <strong>DHCP Server:</strong> <span id="dhcpServerStatus" class="error">Unreachable</span>
          </div>
          <div id="dhcpProcess" style="display:none">
            <strong>DHCP Process:</strong>
            <div class="dhcp-process" id="dhcpStep1">1. DHCP Discover - Broadcasting request...</div>
            <div class="dhcp-process" id="dhcpStep2" style="display:none">2. DHCP Offer - Server 192.168.1.1 responding...</div>
            <div class="dhcp-process" id="dhcpStep3" style="display:none">3. DHCP Request - Accepting offer...</div>
            <div class="dhcp-process" id="dhcpStep4" style="display:none">4. DHCP Acknowledge - Lease granted!</div>
          </div>
          <div id="connectivityTest" style="margin-top:15px">
            <strong>Connectivity Test:</strong><br>
            <span id="gatewayPing" class="error">Gateway: No route to host</span><br>
            <span id="internetPing" class="error">Internet: No connectivity</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start-button" id="startButton" title="Start">
      <span class="windows-logo">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="1" y="11" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="11" width="8" height="8" fill="#00BCF9"/>
        </svg>
      </span>
      Start
    </div>
    <div class="taskbar-icons"></div>
    <div class="system-tray" id="systemTray">
      <div class="tray-chip" id="networkTrayIcon" title="Network status">
        <span id="trayNetworkIcon">üåê</span>
      </div>
      <div class="tray-chip tray-time" id="trayTimeChip" title="Date and time">
        <span id="trayTime">--:--</span>
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">Start</div>
    <div class="start-menu-body">
      <div class="start-menu-left">
        <div class="app-item" data-app="instructions">
          <div class="icon instructions-icon">üìã</div>
          <span>Instructions</span>
        </div>
      </div>
      <div class="start-menu-right">
        <div class="app-list">
          <div class="app-item" data-app="cmd">
            <div class="icon">‚å®Ô∏è</div>
            <span>Command Prompt</span>
          </div>
          <div class="app-item" data-app="network">
            <div class="icon network-icon">üì∂</div>
            <span>Network Status</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  /* ===== Enhanced Network Simulation ===== */
  const networkState = {
    current: 'apipa', // 'apipa', 'released', 'dhcp', 'disconnected'
    dhcpServerAvailable: false,
    interfaceOperational: true,
    gatewayReachable: false,
    internetReachable: false,
    
    // Update connectivity based on current state
    updateConnectivity: function() {
      this.gatewayReachable = (this.current === 'dhcp');
      this.internetReachable = (this.current === 'dhcp');
    }
  };

  /* ===== Helpers ===== */
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  /* ===== Elements ===== */
  const startButton = $('#startButton');
  const startMenu = $('#startMenu');
  const instructionsWindow = $('#instructionsWindow');
  const cmdWindow = $('#cmdWindow');
  const networkWindow = $('#networkWindow');
  const cmdOut = $('#cmdOut');
  const resetLab = $('#resetLab');
  const closeBrowser = $('#closeBrowser');
  const toast = $('#toast');

  /* ===== Network Status Elements ===== */
  const statusIndicator = $('#statusIndicator');
  const interfaceStatus = $('#interfaceStatus');
  const mediaState = $('#mediaState');
  const dhcpServerStatus = $('#dhcpServerStatus');
  const dhcpProcess = $('#dhcpProcess');
  const gatewayPing = $('#gatewayPing');
  const internetPing = $('#internetPing');
  const networkTrayIcon = $('#networkTrayIcon');
  const trayNetworkIcon = $('#trayNetworkIcon');

  /* ===== Start Menu toggle ===== */
  function toggleStart(){ startMenu.style.display = (startMenu.style.display==='block') ? 'none' : 'block'; }
  function hideStart(){ startMenu.style.display = 'none'; }
  startButton.addEventListener('click', (e)=>{ e.stopPropagation(); toggleStart(); });
  document.addEventListener('click', (e)=>{ if (!startMenu.contains(e.target) && e.target!==startButton) hideStart(); });
  startButton.addEventListener('contextmenu', (e)=>{ e.preventDefault(); hideStart(); });

  /* ===== Launchers ===== */
  function showWin(w){
    $$('.window').forEach(win => { if (win!==instructionsWindow && win!==w) win.style.display = 'none'; });
    w.style.display='flex';
  }
  
  function openCmd(){
    showWin(cmdWindow);
    setTimeout(()=>renderLive(), 50);
  }
  
  function openNetworkStatus(){
    showWin(networkWindow);
    updateNetworkDisplay();
  }

  $$('.app-item').forEach(el => {
    el.addEventListener('click', () => {
      const app = el.dataset.app; hideStart();
      if (app==='instructions') instructionsWindow.style.display='flex';
      if (app==='cmd') openCmd();
      if (app==='network') openNetworkStatus();
    });
  });

  /* ===== Enhanced Network Display ===== */
  function updateNetworkDisplay() {
    // Update status indicator
    statusIndicator.className = 'network-status ';
    switch(networkState.current) {
      case 'apipa':
        statusIndicator.classList.add('status-apipa');
        statusIndicator.innerHTML = '‚ö†Ô∏è APIPA Address Assigned (169.254.x.x)';
        dhcpServerStatus.textContent = 'Unreachable';
        dhcpServerStatus.className = 'error';
        break;
      case 'released':
        statusIndicator.classList.add('status-released');
        statusIndicator.innerHTML = '‚ùå IP Address Released';
        dhcpServerStatus.textContent = 'Searching...';
        dhcpServerStatus.className = 'warning';
        break;
      case 'dhcp':
        statusIndicator.classList.add('status-dhcp');
        statusIndicator.innerHTML = '‚úÖ DHCP Address Assigned (192.168.1.x)';
        dhcpServerStatus.textContent = '192.168.1.1';
        dhcpServerStatus.className = 'success';
        break;
      case 'disconnected':
        statusIndicator.classList.add('status-disconnected');
        statusIndicator.innerHTML = 'üîå Media Disconnected';
        break;
    }

    // Update connectivity
    networkState.updateConnectivity();
    gatewayPing.textContent = `Gateway: ${networkState.gatewayReachable ? 'Reachable' : 'No route to host'}`;
    gatewayPing.className = networkState.gatewayReachable ? 'success' : 'error';
    internetPing.textContent = `Internet: ${networkState.internetReachable ? 'Connected' : 'No connectivity'}`;
    internetPing.className = networkState.internetReachable ? 'success' : 'error';

    // Update tray icon
    trayNetworkIcon.textContent = networkState.gatewayReachable ? 'üåê' : '‚ö†Ô∏è';
  }

  /* ===== Simulate DHCP Process ===== */
  function simulateDhcpRenewal() {
    dhcpProcess.style.display = 'block';
    
    // Step 1: Discover
    $('#dhcpStep1').style.display = 'block';
    write('Broadcasting DHCP Discover...');
    
    setTimeout(() => {
      // Step 2: Offer
      $('#dhcpStep2').style.display = 'block';
      write('DHCP Offer received from 192.168.1.1');
      
      setTimeout(() => {
        // Step 3: Request
        $('#dhcpStep3').style.display = 'block';
        write('Sending DHCP Request...');
        
        setTimeout(() => {
          // Step 4: Acknowledge
          $('#dhcpStep4').style.display = 'block';
          write('DHCP Acknowledge received');
          networkState.current = 'dhcp';
          updateNetworkDisplay();
          
          setTimeout(() => {
            dhcpProcess.style.display = 'none';
            $$('.dhcp-process').forEach(step => step.style.display = 'none');
            $('#dhcpStep1').style.display = 'block';
          }, 2000);
          
        }, 800);
      }, 800);
    }, 800);
  }

  /* ===== Window controls & dragging ===== */
  document.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); btn.closest('.window').style.display='none'; });
  });
  document.querySelectorAll('[data-minimize]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); btn.closest('.window').style.display='none'; });
  });
  document.querySelectorAll('[data-maximize]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      const w = btn.closest('.window');
      const maximized = w.dataset.max === '1';
      if (maximized){
        if (w.id==='instructionsWindow') { w.style.width='500px'; w.style.height='420px'; w.style.top='20px'; w.style.left='20px'; }
        if (w.id==='cmdWindow') { w.style.width='760px'; w.style.height='480px'; w.style.top='90px'; w.style.left='260px'; }
        if (w.id==='networkWindow') { w.style.width='480px'; w.style.height='300px'; w.style.top='20px'; w.style.left='540px'; }
        w.dataset.max = '0';
      } else {
        w.style.width='100%'; w.style.height='calc(100% - 48px)'; w.style.top='0'; w.style.left='0';
        w.dataset.max = '1';
      }
    });
  });
  
  let dragWin=null, sx=0, sy=0, ix=0, iy=0, dragging=false;
  document.querySelectorAll('.window-header').forEach(h=>{
    h.addEventListener('mousedown', e=>{
      if (e.target.closest('.window-control')) return;
      e.preventDefault(); dragWin = h.closest('.window'); dragging=true;
      sx=e.clientX; sy=e.clientY; ix=parseInt(dragWin.style.left||getComputedStyle(dragWin).left); iy=parseInt(dragWin.style.top||getComputedStyle(dragWin).top);
      document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag);
    });
  });
  function onDrag(e){ if(!dragging||!dragWin) return; dragWin.style.left=(ix + (e.clientX-sx))+'px'; dragWin.style.top=(iy + (e.clientY-sy))+'px'; }
  function stopDrag(){ dragging=false; dragWin=null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }

  /* ===== Toast ===== */
  function flash(msg, ms=1600){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', ms); }

  /* ===== Enhanced CMD Simulation ===== */
  const promptText = 'C\\Users\\Administrator>';
  let buffer = '';

  function write(line=''){ 
    cmdOut.textContent += line + '\n'; 
    cmdOut.scrollTop = cmdOut.scrollHeight; 
  }

  function renderLive(){
    let live = document.getElementById('liveLine');
    if(!live){
      live = document.createElement('div');
      live.id='liveLine';
      live.innerHTML = `<span class="cmd-prompt">${promptText}</span><span id="cmdTyped"></span><span class="caret" id="cmdCaret"></span>`;
      cmdOut.appendChild(live);
    }
    const typed = document.getElementById('cmdTyped');
    if (typed) typed.textContent = buffer;
    cmdOut.scrollTop = cmdOut.scrollHeight;
  }
  
  function ready(){ buffer=''; renderLive(); }

  function ipconfigAll(){
    const host = 'LABWIN10';
    if (networkState.current==='apipa'){
      return `Windows IP Configuration

   Host Name . . . . . . . . . . . . : ${host}
   Primary Dns Suffix  . . . . . . . :
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No

Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . :
   Description . . . . . . . . . . . : Intel(R) Ethernet Connection
   Physical Address. . . . . . . . . : 00-15-5D-01-02-03
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::1111:2222:3333:4444%12
   IPv4 Address. . . . . . . . . . . : 169.254.88.10(Preferred)
   Subnet Mask . . . . . . . . . . . : 255.255.0.0
   Default Gateway . . . . . . . . . :
   DHCPv6 IAID . . . . . . . . . . . : 123456789
   DNS Servers . . . . . . . . . . . : 0.0.0.0
   NetBIOS over Tcpip. . . . . . . . : Enabled`;
    }
    if (networkState.current==='released'){
      return `Windows IP Configuration

   Host Name . . . . . . . . . . . . : ${host}
   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :`;
    }
    // dhcp
    return `Windows IP Configuration

   Host Name . . . . . . . . . . . . : ${host}
   Primary Dns Suffix  . . . . . . . :
   Node Type . . . . . . . . . . . . : Hybrid
   IP Routing Enabled. . . . . . . . : No
   WINS Proxy Enabled. . . . . . . . : No

Ethernet adapter Ethernet:

   Connection-specific DNS Suffix  . :
   Description . . . . . . . . . . . : Intel(R) Ethernet Connection
   Physical Address. . . . . . . . . : 00-15-5D-01-02-03
   DHCP Enabled. . . . . . . . . . . : Yes
   Autoconfiguration Enabled . . . . : Yes
   Link-local IPv6 Address . . . . . : fe80::aaaa:bbbb:cccc:dddd%12
   IPv4 Address. . . . . . . . . . . : 192.168.1.100(Preferred)
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.1.1
   DHCP Server . . . . . . . . . . . : 192.168.1.1
   DNS Servers . . . . . . . . . . . : 8.8.8.8
   Lease Obtained. . . . . . . . . . : ${new Date().toLocaleString()}
   Lease Expires . . . . . . . . . . : ${new Date(Date.now()+8*3600*1000).toLocaleString()}
   NetBIOS over Tcpip. . . . . . . . : Enabled`;
  }

  function runIpconfigRelease(){
    document.getElementById('liveLine')?.remove();
    networkState.current = 'released';
    updateNetworkDisplay();
    const seq = [
      'Windows IP Configuration\n',
      'Successfully released the IP address for adapter Ethernet.\n'
    ];
    let i=0; const step=()=>{ write(seq[i]); i++; if(i<seq.length){ setTimeout(step, 400);} else { flash('IP address released'); ready(); } };
    step();
  }

  function runIpconfigRenew(){
    document.getElementById('liveLine')?.remove();
    write('Windows IP Configuration\n');
    write('Attempting to renew the IP address for adapter Ethernet...\n');
    
    // Always assume DHCP server becomes available for renewal
    networkState.dhcpServerAvailable = true;
    simulateDhcpRenewal();
    setTimeout(()=>{
      flash('DHCP lease obtained successfully');
      ready();
    }, 3500);
  }

  function pingTest(target){
    document.getElementById('liveLine')?.remove();
    write(`Pinging ${target} with 32 bytes of data:`);
    
    if (networkState.current !== 'dhcp') {
      write('Request timed out.');
      write('Request timed out.');
      write('Request timed out.');
      write('Request timed out.');
      write('\nPing statistics for ' + target + ':');
      write('    Packets: Sent = 4, Received = 0, Lost = 4 (100% loss)');
    } else {
      write('Reply from ' + target + ': bytes=32 time=1ms TTL=64');
      write('Reply from ' + target + ': bytes=32 time=2ms TTL=64');
      write('Reply from ' + target + ': bytes=32 time=1ms TTL=64');
      write('Reply from ' + target + ': bytes=32 time=3ms TTL=64');
      write('\nPing statistics for ' + target + ':');
      write('    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss)');
      write('Approximate round trip times in milli-seconds:');
      write('    Minimum = 1ms, Maximum = 3ms, Average = 1ms');
    }
    ready();
  }

  function handle(cmd){
    const c = cmd.trim();
    if (!c) { write(''); return ready(); }
    const lc = c.toLowerCase();
    
    if (lc === 'cls') { cmdOut.textContent=''; return ready(); }
    if (lc === 'help') { 
      write('Commands: ipconfig, ipconfig /all, ipconfig /release, ipconfig /renew, ping, cls, help'); 
      return ready(); 
    }
    if (lc === 'ipconfig' || lc === 'ipconfig /all') { 
      document.getElementById('liveLine')?.remove();
      write(promptText + buffer);
      write(ipconfigAll());
      return ready(); 
    }
    if (lc === 'ipconfig /release') { 
      write(promptText + buffer);
      return runIpconfigRelease(); 
    }
    if (lc === 'ipconfig /renew') { 
      write(promptText + buffer);
      return runIpconfigRenew(); 
    }
    if (lc.startsWith('ping ')) {
      const target = cmd.substring(5).trim();
      write(promptText + buffer);
      return pingTest(target);
    }
    
    write(`'${cmd}' is not recognized as an internal or external command,
operable program or batch file.`);
    return ready();
  }

  // Global key handler
  document.addEventListener('keydown', (e)=>{
    if (cmdWindow.style.display !== 'flex') return;
    if (e.key === 'Enter'){
      e.preventDefault(); document.getElementById('liveLine')?.remove();
      write(promptText + buffer);
      const line = buffer; buffer='';
      handle(line);
      return;
    }
    if (e.key === 'Backspace'){
      e.preventDefault(); buffer = buffer.slice(0,-1); renderLive(); return;
    }
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey){
      e.preventDefault(); buffer += e.key; renderLive(); return;
    }
  });

  cmdOut.addEventListener('mousedown', ()=>{ renderLive(); });

  // Reset & Close
  resetLab.addEventListener('click', ()=>{
    cmdOut.textContent = 'Microsoft Windows [Version 10.0.19045.4529]\n(c) Microsoft Corporation. All rights reserved.\n\n';
    buffer='';
    networkState.current = 'apipa';
    networkState.dhcpServerAvailable = false;
    cmdWindow.style.display='none';
    networkWindow.style.display='none';
    instructionsWindow.style.display='flex';
    updateNetworkDisplay();
    flash('Lab reset to initial APIPA state');
  });

  closeBrowser.addEventListener('click', ()=>{ 
    flash('Closing lab...'); 
    setTimeout(()=>{ window.location.href='about:blank'; }, 300); 
  });

  /* ===== Time ===== */
  const trayTime = document.getElementById('trayTime');
  function two(n){ return n.toString().padStart(2,'0'); }
  function updateTime(){ const d=new Date(); trayTime.textContent = two(d.getHours()) + ':' + two(d.getMinutes()); }
  setInterval(updateTime, 60000); updateTime();

  // Initialize network state
  updateNetworkDisplay();
  instructionsWindow.style.display='flex';
});

/* ==== Tray/Popover helpers ==== */
const systemTray = document.getElementById('systemTray');
const trayTimeChipExisting = document.getElementById('trayTimeChip');

function makePopover(html){
  const el = document.createElement('div');
  el.className = 'tray-popover';
  el.innerHTML = html;
  document.body.appendChild(el);
  return el;
}
function togglePopover(popover, anchor){
  const r = anchor.getBoundingClientRect();
  popover.style.right  = (window.innerWidth - r.right) + 'px';
  popover.style.bottom = (window.innerHeight - r.top + 8) + 'px';
  const open = popover.style.display === 'block';
  document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  if (!open) popover.style.display='block';
}

/* ==== Time / Calendar popover ==== */
const timePopover = makePopover(`
  <div class="pop-header">Date & time</div>
  <div class="pop-body">
    <div class="calendar">
      <div class="big-clock" id="bigClock">--:--</div>
      <div class="small-date" id="smallDate">-- ---, ----</div>
      <div class="cal-header">
        <span id="prevMonth" style="cursor:pointer">‚Äπ</span>
        <span class="month" id="monthLabel">Month Year</span>
        <span id="nextMonth" style="cursor:pointer">‚Ä∫</span>
      </div>
      <div class="grid" id="calGrid">
        <div class="dow">Su</div><div class="dow">Mo</div><div class="dow">Tu</div>
        <div class="dow">We</div><div class="dow">Th</div><div class="dow">Fr</div><div class="dow">Sa</div>
      </div>
    </div>
  </div>
`);

if (trayTimeChipExisting) {
  trayTimeChipExisting.addEventListener('click', (e)=>{
    e.stopPropagation();
    updateClockAndDate();
    ensureCalendarRendered();
    togglePopover(timePopover, trayTimeChipExisting);
  });
}

document.addEventListener('click', (e)=>{
  if (!systemTray.contains(e.target) && !e.target.closest('.tray-popover')) {
    document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  }
});
document.querySelectorAll('.tray-popover').forEach(p => p.addEventListener('click', e => e.stopPropagation()));

/* ==== Big clock + calendar rendering ==== */
function updateClockAndDate(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const bigClock = document.getElementById('bigClock');
  const smallDate = document.getElementById('smallDate');
  if (bigClock) bigClock.textContent = `${hh}:${mm}`;
  if (smallDate) smallDate.textContent = now.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
}

let calRef = new Date();
function ensureCalendarRendered(){ renderCalendar(calRef); }
function renderCalendar(refDate){
  const monthLabel = document.getElementById('monthLabel');
  const grid = document.getElementById('calGrid');
  if (!monthLabel || !grid) return;
  Array.from(grid.querySelectorAll('.day')).forEach(d=>d.remove());
  const y = refDate.getFullYear(), m = refDate.getMonth();
  monthLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, {month:'long', year:'numeric'});
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  const daysIn = new Date(y, m+1, 0).getDate();
  const prevDays = new Date(y, m, 0).getDate();
  for(let i=startDow-1; i>=0; i--){ const el=document.createElement('div'); el.className='day other'; el.textContent=(prevDays - i); grid.appendChild(el); }
  const today = new Date();
  const highlight = (today.getFullYear()===y && today.getMonth()===m) ? today.getDate() : -1;
  for(let d=1; d<=daysIn; d++){ const el=document.createElement('div'); el.className='day'; el.textContent=d; if(d===highlight) el.classList.add('today'); grid.appendChild(el); }
  const totalCells = grid.querySelectorAll('.dow').length + grid.querySelectorAll('.day').length;
  const rem = totalCells % 7;
  if (rem !== 0){ const need = 7 - rem; for(let d=1; d<=need; d++){ const el=document.createElement('div'); el.className='day other'; el.textContent=d; grid.appendChild(el); } }
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'prevMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1); ensureCalendarRendered(); }
  if (e.target && e.target.id === 'nextMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1); ensureCalendarRendered(); }
});

</script>
</body>
</html>