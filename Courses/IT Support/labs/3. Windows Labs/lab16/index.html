<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lab 16: Flush DNS Cache - Enhanced</title>
<style>
/* ==== Desktop background (matches template) ==== */
html,body{height:100%;margin:0;font-family:Segoe UI, Roboto, Arial, Helvetica, sans-serif}
body{background:linear-gradient(120deg,#1976d2,#0d47a1);color:#111;overflow:hidden}
#desktop{position:absolute;inset:0 0 48px 0;padding:14px}

/* ==== Windows (simulation) ==== */
.window{position:absolute;background:#fff;border:1px solid #c9c9c9;border-radius:10px;box-shadow:0 14px 40px rgba(0,0,0,.35);display:none;flex-direction:column;overflow:hidden}
.window-header{background:#e9e9e9;padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:move;border-bottom:1px solid #cfcfcf;user-select:none}
.window-title{font-weight:600;flex:1}
.window-controls{display:flex;gap:6px}
.window-control{width:24px;height:24px;border-radius:6px;background:#dcdcdc;display:grid;place-items:center;cursor:pointer}
.window-control:hover{background:#cfcfcf}
.window-body{padding:10px;overflow:auto;background:#fff;flex:1}

/* ==== Instructions window ==== */
#instructionsWindow{left:20px;top:20px;width:420px;height:340px;display:flex}
#instructionsWindow .window-body ol{margin:0 0 6px 18px}
#instructionsWindow .window-body ol li{margin:6px 0}
#instructionsWindow .window-body .btnrow{margin-top:10px;display:flex;gap:8px}
button{border:1px solid #c9c9c9;background:#efefef;padding:6px 10px;border-radius:6px;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

/* ==== Command Prompt window (inline input like real cmd) ==== */
#cmdWindow{left:260px;top:90px;width:760px;height:480px}
#cmdWindow .window-body{padding:0;background:#0c0c0c;color:#0f0;font-family:Consolas,"Courier New",monospace;font-size:14px;display:flex;flex-direction:column}
.cmd-output{white-space:pre-wrap;line-height:1.35;padding:12px;flex:1;overflow:auto}
.cmd-prompt{color:#0f0;white-space:pre}
/* Blinking block caret */
.caret{display:inline-block;width:10px;height:1em;background:#0f0;margin-left:2px;animation:blink 1s steps(1,end) infinite;vertical-align:bottom}
@keyframes blink{50%{opacity:0}}

/* ==== Context menu (Run as administrator) ==== */
.context-menu{position:absolute;display:none;background:rgba(30,30,30,0.97);color:#fff;border:1px solid rgba(255,255,255,0.12);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.4);z-index:400;overflow:hidden;backdrop-filter:blur(16px);min-width:220px}
.context-menu-item{padding:12px 16px;cursor:pointer;display:flex;align-items:center;color:white;font-size:14px;transition:all .2s ease;border-bottom:1px solid rgba(255,255,255,0.05);user-select:none}
.context-menu-item:last-child{border-bottom:none}
.context-menu-item:hover{background:rgba(255,255,255,0.08)}

/* ==== Toast ==== */
#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#2e7d32;color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:500;box-shadow:0 8px 24px rgba(0,0,0,.35)}

/* ==== Taskbar + tray ==== */
.taskbar{position:absolute;bottom:0;width:100vw;height:48px;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:flex;align-items:center;padding:0 10px;z-index:100;border-top:1px solid rgba(255,255,255,0.1);overflow:hidden;box-sizing:border-box}
.start-button{color:white;font-weight:600;display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:8px;transition:all 0.2s ease;font-size:14px;background:rgba(255,255,255,0.22);border:1px solid rgba(255,255,255,0.35);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.06)}
.start-button:hover{background-color:rgba(255,255,255,0.32);border-color:rgba(255,255,255,0.5)}
.windows-logo{width:20px;height:20px;margin-right:2px;display:inline-block}
.taskbar-icons{display:flex;gap:8px;margin-left:10px}
.system-tray{display:flex;align-items:center;color:white;font-size:13px;padding:0 6px;white-space:nowrap;gap:6px;margin-left:auto}
.tray-chip{display:inline-flex;align-items:center;gap:8px;height:32px;padding:0 10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:10px;user-select:none;box-shadow:0 2px 8px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.06);cursor:pointer;transition:transform .12s ease, background .15s ease, border-color .15s ease}
.tray-chip:hover{background:rgba(255,255,255,0.16);border-color:rgba(255,255,255,0.35);transform:translateY(-1px)}
.tray-time{min-width:78px;justify-content:center;font-variant-numeric:tabular-nums}

/* ==== Start Menu (reduced height only) ==== */
.start-menu{position:absolute;bottom:52px;left:12px;width:520px;height:360px;background:rgba(30,30,30,0.97);color:white;border:1px solid rgba(255,255,255,0.12);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.4);backdrop-filter:blur(16px);display:none;overflow:hidden auto;z-index:200}
.start-menu-header{padding:16px 20px;background:rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:16px}
.start-menu-body{display:grid;grid-template-columns:1fr 1fr;height:calc(100% - 60px)}
.start-menu-left{padding:16px;background:rgba(255,255,255,0.02);border-right:1px solid rgba(255,255,255,0.08)}
.start-menu-right{padding:16px}
.app-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:8px;cursor:pointer;transition:background 0.2s ease;margin-bottom:8px}
.app-item:hover{background:rgba(255,255,255,0.08)}
.app-item .icon{width:32px;height:32px;border-radius:6px;background:#0078d4;display:flex;align-items:center;justify-content:center;font-size:16px}
.instructions-icon{background:linear-gradient(45deg,#ff6b35,#f7931e)!important}
.app-list{max-height:100%;overflow-y:auto}

/* Utilities */
.hidden{display:none!important}

/* === Tray Popover + Calendar (ported from template) === */
.tray-popover{position:absolute;display:none;min-width:300px;background:rgba(30,30,30,0.97);color:white;border:1px solid rgba(255,255,255,0.12);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.4);z-index:400;overflow:hidden;backdrop-filter:blur(16px)}
.tray-popover .pop-header{padding:12px 16px;background:rgba(255,255,255,0.06);border-bottom:1px solid rgba(255,255,255,0.1);font-weight:600;font-size:13px}
.tray-popover .pop-body{padding:14px 16px;font-size:13px;max-height:380px;overflow:auto}
.row{display:flex;align-items:center;gap:10px}
.muted{opacity:0.85}

.calendar{width:100%;user-select:none}
.calendar .big-clock{font-size:28px;font-weight:700;margin-bottom:6px}
.calendar .small-date{opacity:.9;margin-bottom:10px}
.calendar .cal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.calendar .month{font-weight:600}
.calendar .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;font-size:12px}
.calendar .dow{text-align:center;opacity:.8;padding:4px 0}
.calendar .day{text-align:center;padding:6px 0;border-radius:6px}
.calendar .day.today{background:#1976d2;color:#fff}
.calendar .day.other{opacity:.35}

/* ==== NEW: Enhanced DNS Status Window ==== */
#dnsStatusWindow {
    left: 460px;
    top: 20px;
    width: 380px;
    height: 200px;
    display: none;
}

.dns-status-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.dns-status-item:last-child {
    border-bottom: none;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-active {
    background: #4caf50;
}

.status-inactive {
    background: #f44336;
}

.status-warning {
    background: #ff9800;
}

.cache-entry {
    font-family: Consolas, monospace;
    font-size: 12px;
    background: #f5f5f5;
    padding: 4px 8px;
    border-radius: 4px;
    margin: 2px 0;
}

/* ==== NEW: Network Troubleshooting Window ==== */
#networkWindow {
    left: 460px;
    top: 240px;
    width: 380px;
    height: 200px;
    display: none;
}

.network-test {
    margin: 8px 0;
    padding: 8px;
    background: #f8f8f8;
    border-radius: 4px;
}

.test-result {
    font-family: Consolas, monospace;
    margin-top: 4px;
    font-size: 12px;
}

/* ==== NEW: Enhanced Command Output Styles ==== */
.cmd-output .dns-record {
    color: #87ceeb;
}

.cmd-output .dns-error {
    color: #ff6b6b;
}

.cmd-output .dns-success {
    color: #90ee90;
}

.cmd-output .timestamp {
    color: #888;
    font-size: 0.8em;
}
</style>
</head>
<body>
  <div id="desktop">
    <!-- Instructions window (open by default) -->
    <div class="window" id="instructionsWindow" style="display:flex">
      <div class="window-header">
        <div class="window-title">Lab 16: Flush DNS Cache ‚Äì Enhanced Instructions</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <ol>
          <li>Open <strong>DNS Status Monitor</strong> to view current cache state</li>
          <li>Open <strong>Command Prompt</strong> and type <code>nslookup google.com</code> - note the response time</li>
          <li>Type <code>ipconfig /displaydns</code> to see cached entries</li>
          <li>Type <code>ipconfig /flushdns</code> to clear the DNS cache</li>
          <li>Check DNS Status Monitor again - cache should be empty</li>
          <li>Run <code>nslookup google.com</code> again - note slower response (uncached)</li>
          <li>Run it once more - response should be faster (re-cached)</li>
          <li>Use <strong>Network Troubleshooting</strong> window to test connectivity</li>
        </ol>
        <div class="btnrow">
          <button id="resetLab">Reset Lab</button>
          <button id="showAllWindows">Show All Tools</button>
          <button id="closeBrowser">Close Lab</button>
        </div>
      </div>
    </div>

    <!-- NEW: DNS Status Monitor Window -->
    <div class="window" id="dnsStatusWindow">
      <div class="window-header">
        <div class="window-title">DNS Status Monitor</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="dns-status-item">
          <span><span class="status-indicator" id="dnsServiceStatus"></span>DNS Client Service</span>
          <span id="dnsServiceText">Running</span>
        </div>
        <div class="dns-status-item">
          <span><span class="status-indicator" id="cacheStatus"></span>DNS Cache</span>
          <span id="cacheStatusText">Active</span>
        </div>
        <div class="dns-status-item">
          <span>Cache Entries:</span>
          <span id="cacheEntryCount">0</span>
        </div>
        <div class="dns-status-item">
          <span>Last Flush:</span>
          <span id="lastFlushTime">Never</span>
        </div>
        <div id="cacheEntries">
          <div style="margin-top: 10px; font-weight: bold;">Cached Domains:</div>
          <div id="cacheEntriesList"></div>
        </div>
      </div>
    </div>

    <!-- NEW: Network Troubleshooting Window -->
    <div class="window" id="networkWindow">
      <div class="window-header">
        <div class="window-title">Network Troubleshooting</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="network-test">
          <button id="testPing">Test Ping to Google</button>
          <div class="test-result" id="pingResult"></div>
        </div>
        <div class="network-test">
          <button id="testDNS">Test Multiple DNS Servers</button>
          <div class="test-result" id="dnsTestResult"></div>
        </div>
        <div class="network-test">
          <button id="testBrowser">Simulate Browser Request</button>
          <div class="test-result" id="browserResult"></div>
        </div>
      </div>
    </div>

    <!-- Command Prompt window (opens from Start Menu) -->
    <div class="window" id="cmdWindow">
      <div class="window-header">
        <div class="window-title" id="cmdTitle">Command Prompt</div>
        <div class="window-controls">
          <div class="window-control" data-minimize title="Minimize">‚àí</div>
          <div class="window-control" data-maximize title="Maximize">‚ñ°</div>
          <div class="window-control" data-close title="Close">‚úï</div>
        </div>
      </div>
      <div class="window-body">
        <div class="cmd-output" id="cmdOut">Microsoft Windows [Version 10.0.19045.4529]
(c) Microsoft Corporation. All rights reserved.

</div>
      </div>
    </div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start-button" id="startButton" title="Start">
      <span class="windows-logo">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <rect x="1" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="1" width="8" height="8" fill="#00BCF9"/>
          <rect x="1" y="11" width="8" height="8" fill="#00BCF9"/>
          <rect x="11" y="11" width="8" height="8" fill="#00BCF9"/>
        </svg>
      </span>
      Start
    </div>
    <div class="taskbar-icons"></div>
    <div class="system-tray" id="systemTray">
      <div class="tray-chip tray-time" id="trayTimeChip" title="Date and time">
        <span id="trayTime">--:--</span>
      </div>
    </div>
  </div>

  <!-- Start Menu -->
  <div class="start-menu" id="startMenu">
    <div class="start-menu-header">Start</div>
    <div class="start-menu-body">
      <div class="start-menu-left">
        <div class="app-item" data-app="instructions">
          <div class="icon instructions-icon">üìã</div>
          <span>Instructions</span>
        </div>
      </div>
      <div class="start-menu-right">
        <div class="app-list">
          <div class="app-item" data-app="cmd" id="cmdApp">
            <div class="icon">&gt;_</div>
            <span>Command Prompt</span>
          </div>
          <!-- NEW: DNS Status Monitor App -->
          <div class="app-item" data-app="dnsStatus">
            <div class="icon" style="background: #4caf50;">üìä</div>
            <span>DNS Status Monitor</span>
          </div>
          <!-- NEW: Network Troubleshooting App -->
          <div class="app-item" data-app="network">
            <div class="icon" style="background: #2196f3;">üåê</div>
            <span>Network Troubleshooting</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Context menu for Command Prompt app -->
  <div class="context-menu" id="cmdContext">
    <div class="context-menu-item" data-action="runAdmin">Run as administrator</div>
  </div>

  <div id="toast"></div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  /* ===== Helpers ===== */
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

  /* ===== Elements ===== */
  const startButton = $('#startButton');
  const startMenu = $('#startMenu');
  const instructionsWindow = $('#instructionsWindow');
  const cmdWindow = $('#cmdWindow');
  const cmdApp = $('#cmdApp');
  const cmdContext = $('#cmdContext');
  const cmdTitle = $('#cmdTitle');
  const cmdOut = $('#cmdOut');
  const resetLab = $('#resetLab');
  const closeBrowser = $('#closeBrowser');
  const toast = $('#toast');
  const showAllWindows = $('#showAllWindows');
  const dnsStatusWindow = $('#dnsStatusWindow');
  const networkWindow = $('#networkWindow');

  /* ===== Enhanced DNS Lab State ===== */
  let taskCompleted = false;
  let dnsFlushed = false;
  let dnsResolved = false;
  
  let dnsCache = {
    entries: new Map(),
    lastFlush: null,
    enabled: true
  };

  let dnsStatistics = {
    queries: 0,
    cacheHits: 0,
    cacheMisses: 0,
    responseTimes: []
  };

  // Simulated DNS records for various domains
  const simulatedDNS = {
    'google.com': {
      ipv4: '172.217.9.142',
      ipv6: '2607:f8b0:4004:c1b::8a',
      ttl: 300,
      authoritative: false
    },
    'microsoft.com': {
      ipv4: '20.112.52.29',
      ipv6: '2603:1020:400:1::',
      ttl: 600,
      authoritative: false
    },
    'github.com': {
      ipv4: '140.82.121.4',
      ipv6: '2606:50c0:8002::154',
      ttl: 1800,
      authoritative: false
    },
    'stackoverflow.com': {
      ipv4: '151.101.193.69',
      ipv6: '2606:4700:3034::ac43:9845',
      ttl: 900,
      authoritative: false
    }
  };

  /* ===== Enhanced DNS Cache Management ===== */
  function addToCache(domain, record) {
    if (!dnsCache.enabled) return;
    
    const expiry = Date.now() + (record.ttl * 1000);
    dnsCache.entries.set(domain, {
      ...record,
      expiry: expiry,
      created: Date.now()
    });
    updateDNSStatus();
  }

  function getFromCache(domain) {
    if (!dnsCache.enabled) return null;
    
    const entry = dnsCache.entries.get(domain);
    if (entry && entry.expiry > Date.now()) {
      dnsStatistics.cacheHits++;
      return entry;
    }
    
    if (entry) {
      // Expired entry
      dnsCache.entries.delete(domain);
    }
    
    dnsStatistics.cacheMisses++;
    return null;
  }

  function flushDNSCache() {
    const previousSize = dnsCache.entries.size;
    dnsCache.entries.clear();
    dnsCache.lastFlush = new Date();
    dnsStatistics.queries = 0;
    dnsStatistics.cacheHits = 0;
    dnsStatistics.cacheMisses = 0;
    updateDNSStatus();
    return previousSize;
  }

  function simulateDNSQuery(domain) {
    dnsStatistics.queries++;
    
    // Check cache first
    const cached = getFromCache(domain);
    if (cached) {
      // Simulate faster response from cache
      return {
        ...cached,
        responseTime: 15 + Math.random() * 10,
        source: 'cache'
      };
    }
    
    // Simulate actual DNS lookup
    const record = simulatedDNS[domain];
    if (record) {
      // Add to cache for future requests
      addToCache(domain, record);
      
      // Simulate network latency for uncached requests
      return {
        ...record,
        responseTime: 80 + Math.random() * 50,
        source: 'network'
      };
    }
    
    // Domain not found
    return {
      error: 'DNS request timed out',
      responseTime: 2000,
      source: 'timeout'
    };
  }

  /* ===== Enhanced UI Updates ===== */
  function updateDNSStatus() {
    const serviceStatus = $('#dnsServiceStatus');
    const serviceText = $('#dnsServiceText');
    const cacheStatus = $('#cacheStatus');
    const cacheText = $('#cacheStatusText');
    const entryCount = $('#cacheEntryCount');
    const lastFlush = $('#lastFlushTime');
    const entriesList = $('#cacheEntriesList');
    
    // Update service status
    serviceStatus.className = 'status-indicator status-active';
    serviceText.textContent = 'Running';
    
    // Update cache status
    if (dnsCache.enabled) {
      cacheStatus.className = 'status-indicator status-active';
      cacheText.textContent = 'Active';
    } else {
      cacheStatus.className = 'status-indicator status-inactive';
      cacheText.textContent = 'Disabled';
    }
    
    // Update cache info
    const validEntries = Array.from(dnsCache.entries.entries())
      .filter(([_, entry]) => entry.expiry > Date.now());
    
    entryCount.textContent = validEntries.length;
    
    // Update last flush time
    if (dnsCache.lastFlush) {
      lastFlush.textContent = dnsCache.lastFlush.toLocaleTimeString();
    } else {
      lastFlush.textContent = 'Never';
    }
    
    // Update cache entries list
    entriesList.innerHTML = '';
    validEntries.forEach(([domain, entry]) => {
      const div = document.createElement('div');
      div.className = 'cache-entry';
      div.textContent = `${domain} ‚Üí ${entry.ipv4} (TTL: ${Math.round((entry.expiry - Date.now()) / 1000)}s)`;
      entriesList.appendChild(div);
    });
  }

  /* ===== Start Menu toggle ===== */
  function toggleStart(){ startMenu.style.display = (startMenu.style.display==='block') ? 'none' : 'block'; hideContext(); }
  function hideStart(){ startMenu.style.display = 'none'; }
  startButton.addEventListener('click', (e)=>{ e.stopPropagation(); toggleStart(); });
  document.addEventListener('click', (e)=>{ if (!startMenu.contains(e.target) && e.target!==startButton) hideStart(); hideContext(); });
  startButton.addEventListener('contextmenu', (e)=>{ e.preventDefault(); hideStart(); });

  /* ===== Launchers ===== */
  function showWin(w){
    $$('.window').forEach(win => { if (win!==instructionsWindow && win!==w) win.style.display = 'none'; });
    w.style.display='flex';
  }
  function openCmd(elevated=false){
    showWin(cmdWindow);
    cmdTitle.textContent = elevated ? 'Administrator: Command Prompt' : 'Command Prompt';
    setTimeout(()=>renderLive(), 50);
  }
  $$('.app-item').forEach(el => {
    el.addEventListener('click', () => {
      const app = el.dataset.app; hideStart();
      if (app==='instructions') instructionsWindow.style.display='flex';
      if (app==='cmd') openCmd(false);
      if (app==='dnsStatus') dnsStatusWindow.style.display='flex';
      if (app==='network') networkWindow.style.display='flex';
    });
  });

  /* ===== Context menu for Command Prompt app (Run as admin) ===== */
  function hideContext(){ cmdContext.style.display='none'; }
  cmdApp.addEventListener('contextmenu', (e)=>{
    e.preventDefault(); e.stopPropagation();
    let x = e.clientX, y = e.clientY;
    const mw = 240, mh = 56, tb = 48, m = 8;
    x = clamp(x, m, window.innerWidth - mw - m);
    y = clamp(y, m, window.innerHeight - tb - mh - m);
    cmdContext.style.left = x + 'px';
    cmdContext.style.top = y + 'px';
    cmdContext.style.display='block';
  });
  cmdContext.addEventListener('click', (e)=>{
    const act = e.target.closest('.context-menu-item')?.dataset.action;
    if (!act) return; hideContext(); hideStart();
    if (act==='runAdmin') openCmd(true);
  });

  /* ===== Window controls & dragging ===== */
  document.querySelectorAll('[data-close]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); btn.closest('.window').style.display='none'; });
  });
  document.querySelectorAll('[data-minimize]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{ e.stopPropagation(); btn.closest('.window').style.display='none'; });
  });
  document.querySelectorAll('[data-maximize]').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.preventDefault(); e.stopPropagation();
      const w = btn.closest('.window');
      const maximized = w.dataset.max === '1';
      if (maximized){
        if (w.id==='instructionsWindow') { w.style.width='420px'; w.style.height='340px'; w.style.top='20px'; w.style.left='20px'; }
        if (w.id==='cmdWindow') { w.style.width='760px'; w.style.height='480px'; w.style.top='90px'; w.style.left='260px'; }
        if (w.id==='dnsStatusWindow') { w.style.width='380px'; w.style.height='200px'; w.style.top='20px'; w.style.left='460px'; }
        if (w.id==='networkWindow') { w.style.width='380px'; w.style.height='200px'; w.style.top='240px'; w.style.left='460px'; }
        w.dataset.max = '0';
      } else {
        w.style.width='100%'; w.style.height='calc(100% - 48px)'; w.style.top='0'; w.style.left='0';
        w.dataset.max = '1';
      }
    });
  });
  let dragWin=null, sx=0, sy=0, ix=0, iy=0, dragging=false;
  document.querySelectorAll('.window-header').forEach(h=>{
    h.addEventListener('mousedown', e=>{
      if (e.target.closest('.window-control')) return;
      e.preventDefault(); dragWin = h.closest('.window'); dragging=true;
      sx=e.clientX; sy=e.clientY; ix=parseInt(dragWin.style.left||getComputedStyle(dragWin).left); iy=parseInt(dragWin.style.top||getComputedStyle(dragWin).top);
      document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', stopDrag);
    });
  });
  function onDrag(e){ if(!dragging||!dragWin) return; dragWin.style.left=(ix + (e.clientX-sx))+'px'; dragWin.style.top=(iy + (e.clientY-sy))+'px'; }
  function stopDrag(){ dragging=false; dragWin=null; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', stopDrag); }

  /* ===== Toast ===== */
  function flash(msg, ms=1600){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', ms); }

  /* ===== CMD (inline input with blinking caret) ===== */
  const promptText = 'C\\Users\\Administrator>';
  function write(line=''){ cmdOut.textContent += line + '\n'; cmdOut.scrollTop = cmdOut.scrollHeight; }
  let buffer = '';
  function renderLive(){
    // ensure one live line at the end
    let live = document.getElementById('liveLine');
    if(!live){
      live = document.createElement('div');
      live.id='liveLine';
      live.innerHTML = `<span class="cmd-prompt">${promptText}</span><span id="cmdTyped"></span><span class="caret" id="cmdCaret"></span>`;
      cmdOut.appendChild(live);
    }
    const typed = document.getElementById('cmdTyped');
    if (typed) typed.textContent = buffer;
    cmdOut.scrollTop = cmdOut.scrollHeight;
  }
  function ready(){ buffer=''; renderLive(); }

  /* ===== Enhanced DNS Commands Processing ===== */
  function runEnhancedNslookup(domain) {
    document.getElementById('liveLine')?.remove();
    
    const startTime = Date.now();
    const result = simulateDNSQuery(domain);
    const totalTime = Date.now() - startTime;
    
    let output = '';
    
    if (result.error) {
      output = `DNS request timed out.
timeout was 2 seconds.
Server:  UnKnown
Address:  192.168.1.1

*** Request to UnKnown timed-out
`;
      write(output);
    } else {
      output = `Server:  dns.google
Address:  8.8.8.8

${result.authoritative ? 'Authoritative' : 'Non-authoritative'} answer:
Name:    ${domain}
Address:  ${result.ipv4}
Address:  ${result.ipv6}

Query time: ${Math.round(result.responseTime)} msec
When:       ${new Date().toLocaleTimeString()}
`;
      write(output);
      
      // Add visual indication of cache hit/miss
      const indicator = document.createElement('div');
      indicator.className = result.source === 'cache' ? 'dns-success' : 'dns-record';
      indicator.textContent = `[${result.source === 'cache' ? 'CACHED' : 'NETWORK'}] Response time: ${Math.round(result.responseTime)}ms`;
      cmdOut.appendChild(indicator);
      cmdOut.appendChild(document.createElement('br'));
    }
    
    ready();
  }

  function runEnhancedFlushDns() {
    document.getElementById('liveLine')?.remove();
    
    const flushedCount = flushDNSCache();
    const output = `Windows IP Configuration

Successfully flushed the DNS Resolver Cache.
Flushed ${flushedCount} entr${flushedCount === 1 ? 'y' : 'ies'}.

`;
    write(output);
    flash(`DNS cache flushed successfully. ${flushedCount} entries removed.`);
    ready();
  }

  function displayDNSCache() {
    document.getElementById('liveLine')?.remove();
    
    const validEntries = Array.from(dnsCache.entries.entries())
      .filter(([_, entry]) => entry.expiry > Date.now());
    
    if (validEntries.length === 0) {
      write(`Windows IP Configuration

    Could not display the DNS Resolver Cache.
    
`);
    } else {
      let output = `Windows IP Configuration

`;
      
      validEntries.forEach(([domain, entry]) => {
        output += `    ${domain}
    ----------------------------------------
    Record Name . . . . . : ${domain}
    Record Type . . . . . : 1
    Time To Live  . . . . : ${Math.round((entry.expiry - Date.now()) / 1000)}
    Data Length . . . . . : 4
    Section . . . . . . . : Answer
    A (Host) Record . . . : ${entry.ipv4}

`;
      });
      
      write(output);
    }
    
    ready();
  }

  /* ===== Network Testing Functions ===== */
  function simulatePingTest() {
    const result = $('#pingResult');
    result.innerHTML = '<span class="timestamp">Pinging 172.217.9.142 with 32 bytes of data:</span><br>';
    
    // Simulate ping packets with realistic timing
    for (let i = 1; i <= 4; i++) {
      setTimeout(() => {
        const time = 15 + Math.random() * 10;
        result.innerHTML += `<span class="dns-success">Reply from 172.217.9.142: bytes=32 time=${Math.round(time)}ms TTL=116</span><br>`;
        
        if (i === 4) {
          result.innerHTML += `<br><span class="timestamp">Ping statistics for 172.217.9.142:</span><br>`;
          result.innerHTML += `<span class="timestamp">    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss)</span><br>`;
        }
      }, i * 300);
    }
  }

  function simulateDNSServerTest() {
    const result = $('#dnsTestResult');
    const servers = [
      { name: 'Google DNS', ip: '8.8.8.8', working: true },
      { name: 'Cloudflare', ip: '1.1.1.1', working: true },
      { name: 'ISP DNS', ip: '192.168.1.1', working: false },
      { name: 'OpenDNS', ip: '208.67.222.222', working: true }
    ];
    
    result.innerHTML = '';
    
    servers.forEach((server, index) => {
      setTimeout(() => {
        if (server.working) {
          result.innerHTML += `<span class="dns-success">‚úì ${server.name} (${server.ip}): Responding</span><br>`;
        } else {
          result.innerHTML += `<span class="dns-error">‚úó ${server.name} (${server.ip}): Timeout</span><br>`;
        }
      }, index * 500);
    });
  }

  function simulateBrowserRequest() {
    const result = $('#browserResult');
    result.innerHTML = '<span class="timestamp">Requesting https://google.com...</span><br>';
    
    setTimeout(() => {
      result.innerHTML += '<span class="timestamp">DNS Lookup: 45ms</span><br>';
    }, 300);
    
    setTimeout(() => {
      result.innerHTML += '<span class="timestamp">TCP Handshake: 23ms</span><br>';
    }, 600);
    
    setTimeout(() => {
      result.innerHTML += '<span class="timestamp">TLS Negotiation: 120ms</span><br>';
    }, 900);
    
    setTimeout(() => {
      result.innerHTML += '<span class="dns-success">Page loaded: 1.2s total</span><br>';
    }, 1200);
  }

  /* ===== Enhanced Command Handler ===== */
  function handleEnhancedCommand(cmd) {
    const c = cmd.trim();
    if (!c) { write(''); return ready(); }
    
    const lc = c.toLowerCase();
    
    if (lc === 'cls') { 
      cmdOut.textContent=''; 
      return ready(); 
    }
    
    if (lc === 'help') {
      write('Commands: ipconfig /flushdns, nslookup <domain>, ipconfig /displaydns, cls, help, exit');
      return ready();
    }
    
    if (lc === 'ipconfig /flushdns') { 
      return runEnhancedFlushDns(); 
    }
    
    if (lc.startsWith('nslookup')) {
      const parts = c.split(' ');
      const domain = parts[1] || 'google.com';
      return runEnhancedNslookup(domain);
    }
    
    if (lc === 'ipconfig /displaydns') {
      return displayDNSCache();
    }
    
    if (lc === 'exit') { 
      cmdWindow.style.display='none'; 
      return; 
    }
    
    write(`'${cmd}' is not recognized as an internal or external command,
operable program or batch file.`);
    return ready();
  }

  /* ===== Updated Event Listeners ===== */
  
  // Replace the existing command handler with enhanced version
  document.addEventListener('keydown', (e)=>{
    if (cmdWindow.style.display !== 'flex') return;
    if (e.key === 'Enter'){
      e.preventDefault(); 
      document.getElementById('liveLine')?.remove();
      write(promptText + buffer);
      const line = buffer; 
      buffer='';
      handleEnhancedCommand(line);  // Use enhanced handler
      return;
    }
    if (e.key === 'Backspace'){
      e.preventDefault(); buffer = buffer.slice(0,-1); renderLive(); return;
    }
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey){
      e.preventDefault(); buffer += e.key; renderLive(); return;
    }
  });

  // Clicking inside the output focuses the live line
  cmdOut.addEventListener('mousedown', ()=>{ renderLive(); });

  // Add event listeners for new buttons
  showAllWindows.addEventListener('click', () => {
    instructionsWindow.style.display = 'flex';
    dnsStatusWindow.style.display = 'flex';
    networkWindow.style.display = 'flex';
    cmdWindow.style.display = 'flex';
  });

  $('#testPing').addEventListener('click', simulatePingTest);
  $('#testDNS').addEventListener('click', simulateDNSServerTest);
  $('#testBrowser').addEventListener('click', simulateBrowserRequest);

  // Enhanced reset function
  resetLab.addEventListener('click', () => {
    cmdOut.textContent = 'Microsoft Windows [Version 10.0.19045.4529]\n(c) Microsoft Corporation. All rights reserved.\n\n';
    buffer = '';
    
    // Reset DNS cache state
    dnsCache.entries.clear();
    dnsCache.lastFlush = null;
    dnsCache.enabled = true;
    
    dnsStatistics.queries = 0;
    dnsStatistics.cacheHits = 0;
    dnsStatistics.cacheMisses = 0;
    dnsStatistics.responseTimes = [];
    
    cmdWindow.style.display = 'none';
    instructionsWindow.style.display = 'flex';
    dnsStatusWindow.style.display = 'none';
    networkWindow.style.display = 'none';
    
    updateDNSStatus();
    flash('Lab reset to initial state');
  });

  closeBrowser.addEventListener('click', ()=>{ flash('Closing lab...'); window.close(); setTimeout(()=>{ window.location.href='about:blank'; }, 300); });

  /* ===== Time only (no calendar popover) ===== */
  const trayTime = document.getElementById('trayTime');
  function two(n){ return n.toString().padStart(2,'0'); }
  function updateTime(){ const d=new Date(); trayTime.textContent = two(d.getHours()) + ':' + two(d.getMinutes()); }
  setInterval(updateTime, 60000); updateTime();

  // Initialize DNS status
  updateDNSStatus();

  // Init: show instructions
  instructionsWindow.style.display='flex';
});

/* ==== Tray/Popover helpers (ported from template) ==== */
const systemTray = document.getElementById('systemTray');
const trayTimeChipExisting = document.getElementById('trayTimeChip');

function makePopover(html){
  const el = document.createElement('div');
  el.className = 'tray-popover';
  el.innerHTML = html;
  document.body.appendChild(el);
  return el;
}
function togglePopover(popover, anchor){
  const r = anchor.getBoundingClientRect();
  popover.style.right  = (window.innerWidth - r.right) + 'px';
  popover.style.bottom = (window.innerHeight - r.top + 8) + 'px';
  const open = popover.style.display === 'block';
  document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  if (!open) popover.style.display='block';
}

/* ==== Time / Calendar popover ==== */
const timePopover = makePopover(`
  <div class="pop-header">Date & time</div>
  <div class="pop-body">
    <div class="calendar">
      <div class="big-clock" id="bigClock">--:--</div>
      <div class="small-date" id="smallDate">-- ---, ----</div>
      <div class="cal-header">
        <span id="prevMonth" style="cursor:pointer">‚Äπ</span>
        <span class="month" id="monthLabel">Month Year</span>
        <span id="nextMonth" style="cursor:pointer">‚Ä∫</span>
      </div>
      <div class="grid" id="calGrid">
        <div class="dow">Su</div><div class="dow">Mo</div><div class="dow">Tu</div>
        <div class="dow">We</div><div class="dow">Th</div><div class="dow">Fr</div><div class="dow">Sa</div>
      </div>
    </div>
  </div>
`);

/* Click binding for tray time chip */
if (trayTimeChipExisting) {
  trayTimeChipExisting.addEventListener('click', (e)=>{
    e.stopPropagation();
    updateClockAndDate();
    ensureCalendarRendered();
    togglePopover(timePopover, trayTimeChipExisting);
  });
}

/* Click-away hide for popovers */
document.addEventListener('click', (e)=>{
  if (!systemTray.contains(e.target) && !e.target.closest('.tray-popover')) {
    document.querySelectorAll('.tray-popover').forEach(p=>p.style.display='none');
  }
});
document.querySelectorAll('.tray-popover').forEach(p => p.addEventListener('click', e => e.stopPropagation()));

/* ==== Big clock + calendar rendering ==== */
function updateClockAndDate(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const bigClock = document.getElementById('bigClock');
  const smallDate = document.getElementById('smallDate');
  if (bigClock) bigClock.textContent = `${hh}:${mm}`;
  if (smallDate) smallDate.textContent = now.toLocaleDateString(undefined, { weekday:'short', day:'2-digit', month:'short', year:'numeric' });
}

/* Calendar state + renderer */
let calRef = new Date();
function ensureCalendarRendered(){ renderCalendar(calRef); }
function renderCalendar(refDate){
  const monthLabel = document.getElementById('monthLabel');
  const grid = document.getElementById('calGrid');
  if (!monthLabel || !grid) return;
  Array.from(grid.querySelectorAll('.day')).forEach(d=>d.remove());
  const y = refDate.getFullYear(), m = refDate.getMonth();
  monthLabel.textContent = new Date(y, m, 1).toLocaleString(undefined, {month:'long', year:'numeric'});
  const first = new Date(y, m, 1);
  const startDow = first.getDay();
  const daysIn = new Date(y, m+1, 0).getDate();
  const prevDays = new Date(y, m, 0).getDate();
  for(let i=startDow-1; i>=0; i--){ const el=document.createElement('div'); el.className='day other'; el.textContent=(prevDays - i); grid.appendChild(el); }
  const today = new Date();
  const highlight = (today.getFullYear()===y && today.getMonth()===m) ? today.getDate() : -1;
  for(let d=1; d<=daysIn; d++){ const el=document.createElement('div'); el.className='day'; el.textContent=d; if(d===highlight) el.classList.add('today'); grid.appendChild(el); }
  const totalCells = grid.querySelectorAll('.dow').length + grid.querySelectorAll('.day').length;
  const rem = totalCells % 7;
  if (rem !== 0){ const need = 7 - rem; for(let d=1; d<=need; d++){ const el=document.createElement('div'); el.className='day other'; el.textContent=d; grid.appendChild(el); } }
}
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'prevMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()-1, 1); ensureCalendarRendered(); }
  if (e.target && e.target.id === 'nextMonth'){ e.stopPropagation(); calRef = new Date(calRef.getFullYear(), calRef.getMonth()+1, 1); ensureCalendarRendered(); }
});
</script>
</body>
</html>